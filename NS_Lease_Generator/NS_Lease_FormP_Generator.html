<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NS Lease Form P Generator</title>
<!-- Updated: Property and Landlord selectors in one row -->

<style>
    * {
        box-sizing: border-box;
    }

    @keyframes flash {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    @keyframes dropdownFadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .flashing-text {
        animation: flash 1s infinite;
    }

    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 0; 
        padding: 0; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
    }

    .header-image {
        flex-shrink: 0;
        max-height: 80px;
        width: auto;
    }

    .header-image img {
        height: 80px;
        width: auto;
        display: block;
    }

    .header h1 {
        margin: 0;
        color: #333;
        font-size: 32px;
        font-weight: 600;
        text-align: right;
        flex: 1;
    }

    .control-panel {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .control-panel h2 {
        margin-top: 0;
        color: #333;
        font-size: 24px;
        font-weight: 600;
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
    }

    .control-panel h3 {
        color: #555;
        font-size: 18px;
        font-weight: 600;
        margin-top: 25px;
        margin-bottom: 15px;
    }

    .control-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 14px;
        color: white;
        text-align: center;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 12px;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        border: none;
        white-space: nowrap;
        min-height: 40px;
        flex-shrink: 0;
    }

    .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        filter: brightness(1.05);
    }

    .control-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .upload-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .upload-box {
        display: inline-block;
        padding: 10px 20px;
        border: 2px solid #667eea;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-align: center;
        cursor: pointer;
        margin-bottom: 15px;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .upload-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    .upload-box.has-file {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #10b981;
    }

    .upload-info {
        margin-top: 10px;
        font-size: 13px;
        color: #666;
        font-weight: 500;
    }

    .upload-info.has-file {
        color: #10b981;
    }

    select {
        width: 100%;
        padding: 12px 15px;
        margin: 8px 0;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 15px;
        background: white;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    select:hover {
        border-color: #667eea;
    }

    select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .selector-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .selector-item {
        display: flex;
        flex-direction: column;
    }

    .selector-item label {
        font-weight: 600;
        color: #555;
        margin-bottom: 5px;
        font-size: 14px;
    }

    #excelWarnings {
        margin-top: 15px;
        padding: 15px;
        background: #fef2f2;
        border-left: 4px solid #ef4444;
        color: #991b1b;
        font-weight: 500;
        white-space: pre-wrap;
        border-radius: 4px;
    }

    .pdf-button {
        padding: 15px 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        margin: 15px;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .pdf-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
    }

    .pdf-button:active {
        transform: translateY(0);
    }

    .tenancy-tab-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }

    .button-container {
        text-align: center;
        margin: 30px 0;
    }

    .page {
        width: 210mm;
        min-height: 297mm;
        padding: 10mm;
        margin: 20px auto;
        background: white;
        border: 1px solid #ddd;
        position: relative;
        page-break-after: always;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        font-size: 1.05em;
    }
    
    .page:last-of-type {
        page-break-after: auto;
    }
    
    .page[data-page="1"] {
        padding-bottom: 12mm;
    }
    
    .page[data-page="2"] {
        padding-bottom: 15mm;
    }
    
    .page[data-page="3"] {
        padding-bottom: 12mm;
    }
    
    .page[data-page="6"] {
        page-break-after: always;
        min-height: 297mm;
        padding-top: 10mm;
        padding-bottom: 10mm;
    }
    
    .page[data-page="6"] .page-footer {
        position: absolute;
        bottom: 10mm;
    }
    
    .page[data-page="7"] {
        page-break-after: auto;
    }

    .page-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 8px;
        margin-top: 15px;
        border-top: 1px solid #ccc;
        font-size: 11px;
        color: #333;
        position: absolute;
        bottom: 10mm;
        left: 10mm;
        right: 10mm;
    }

    .page-footer-left {
        text-align: left;
        flex: 1;
    }

    .page-footer-right {
        text-align: right;
        font-weight: bold;
    }

    .section-title {
        font-size: 19px;
        font-weight: bold;
        margin-top: 18px;
        border-bottom: 2px solid black;
        padding-bottom: 4px;
    }

    .field-label {
        font-weight: bold;
        margin-top: 8px;
    }

    .input-line {
        border: 1px solid #000;
        padding: 7px 9px;
        margin: 4px 0;
        width: 100%;
        min-height: 26px;
        font-size: 15px;
    }

    .input-line input {
        border: none;
        outline: none;
        width: 100%;
        padding: 4px;
        font-size: 14px;
        background: transparent;
    }

    .emergency-field-group {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin: 4px 0;
    }

    .emergency-field-item {
        display: flex;
        flex-direction: column;
    }

    .emergency-field-item label {
        font-size: 13px;
        font-weight: bold;
        margin-bottom: 4px;
        color: #555;
    }

    .emergency-field-item input {
        border: 1px solid #000;
        padding: 7px 9px;
        font-size: 15px;
        width: 100%;
    }

    .info-label {
        font-size: 14px;
        font-style: italic;
        color: #333;
        margin-top: 8px;
        margin-bottom: 4px;
        padding: 4px 0;
        line-height: 1.5;
        text-align: justify;
    }

    .formatted-text {
        font-size: 15px;
        line-height: 1.6;
        color: #333;
    }

    .formatted-text .bold {
        font-weight: bold;
    }

    .formatted-text .paragraph {
        margin-bottom: 10px;
    }

    .formatted-text .list-item {
        margin-left: 20px;
        margin-bottom: 5px;
        list-style-type: disc;
    }

    .formatted-text .list-item::before {
        content: "‚Ä¢ ";
        font-weight: bold;
        margin-right: 5px;
    }

    .small-input {
        border: 1px solid #000;
        padding: 3px;
        width: 180px;
    }

    .headerTagBox {
        position: absolute;
        top: 6px;
        right: 10px;
        text-align: right;
        z-index: 2;
    }
    #leaseTag {
        position: static;
        font-size: 11px;
        font-weight: normal;
        font-style: italic;
        color: black;
    }
    
    .leaseDatesTag {
        position: static;
        display: block;
        margin-top: 2px;
        font-size: 11px;
        font-style: italic;
        color: #555;
        font-weight: normal;
    }

    .success-message {
        padding: 12px 20px;
        background: #d1fae5;
        border-left: 4px solid #10b981;
        color: #065f46;
        border-radius: 4px;
        margin-top: 15px;
        font-weight: 500;
    }

    /* ====== OFFICIAL FORM P HEADER (ON PAGE 1) ====== */
    .ns-form-header {
        margin-bottom: 6mm;
        text-align: left;
    }
    .ns-form-header-image {
        height: 48px;
        width: auto;
        display: block;
    }

    /* Excel-like table styling with column resizers */
    .excel-table-container {
        border: 1px solid #d1d5db;
        border-radius: 4px;
        overflow: auto;
        background: #fff;
        position: relative;
    }
    
    .excel-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 13px;
        font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    .excel-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #f3f4f6;
    }
    
    .excel-table th {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-bottom: 2px solid #9ca3af;
        padding: 6px 8px;
        text-align: left;
        font-weight: 600;
        color: #111827;
        position: relative;
        user-select: none;
        white-space: nowrap;
        min-width: 80px;
    }
    
    .excel-table th.resizable {
        padding-right: 18px;
    }
    
    .excel-table td {
        border: 1px solid #d1d5db;
        padding: 4px 6px;
        background: #fff;
        vertical-align: middle;
    }
    
    .excel-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .excel-table tbody tr:nth-child(even) {
        background: #fafafa;
    }
    
    .excel-table tbody tr:nth-child(even):hover {
        background: #f3f4f6;
    }
    
    .excel-table input,
    .excel-table textarea {
        width: 100%;
        border: none;
        padding: 4px 6px;
        background: transparent;
        font-size: 13px;
        font-family: inherit;
        outline: none;
    }
    
    .excel-table input:focus,
    .excel-table textarea:focus {
        background: #fff3cd;
        border: 1px solid #ffc107;
    }
    
    .excel-table .inspection-comment1,
    .excel-table .inspection-comment2 {
        resize: none;
        overflow: hidden;
        white-space: pre-wrap;
        word-wrap: break-word;
        min-height: 24px;
        line-height: 1.4;
    }
    
    .column-resizer {
        position: absolute;
        top: 0;
        right: 0;
        width: 4px;
        height: 100%;
        cursor: col-resize;
        background: transparent;
        z-index: 1;
    }
    
    .column-resizer:hover {
        background: #3b82f6;
    }
    
    .column-resizer.active {
        background: #2563eb;
    }

    @media print {
        @page {
            size: A4;
            /* 12mm top/left/right, 16mm bottom */
            margin: 12mm 12mm 16mm 12mm;
        }
        body {
            background: white;
            margin: 0;
            padding: 0;
        }
        /* Hide UI elements so they don't create an extra (blank) first page in the PDF */
        .header,
        .control-panel,
        .button-container {
            display: none;
        }
        .page {
            page-break-after: always;
            page-break-inside: avoid;
            margin: 0;
            padding: 10mm;
            width: 210mm;
            min-height: 297mm;
            box-shadow: none;
            border: none;
        }
        .page[data-page="1"] {
            padding-bottom: 12mm;
        }
        .page[data-page="2"] {
            padding-bottom: 15mm;
        }
        .page[data-page="3"] {
            padding-bottom: 12mm;
        }
        .page[data-page="6"] {
            page-break-after: always;
            padding-bottom: 10mm;
        }
        .page[data-page="7"] {
            page-break-after: auto;
        }
        .page-footer {
            bottom: 10mm;
            left: 10mm;
            right: 10mm;
        }
        table {
            page-break-inside: auto;
        }
        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }
        thead {
            display: table-header-group;
        }
        tfoot {
            display: table-footer-group;
        }
    }

</style>
</head>

<body>

<div class="container">
    <!-- HEADER -->
    <div class="header">
        <div class="header-image">
            <img src="../ClearView_Icons_Images/formp-header.png" alt="Nova Scotia - Form P: Standard Form of Lease">
        </div>
        <h1 class="flashing-text">Lease Generator</h1>
    </div>

    <!-- CONTROL PANEL -->
    <div class="control-panel">
        <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: center; align-items: center; flex-wrap: nowrap; gap: 8px;">
                <label class="control-btn upload-btn" for="combinedExcelFile" id="combinedUploadLabel" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <span style="font-size: 14px; margin-right: 6px;">üìÑ</span>
                    <span>Upload Master Data</span>
                </label>
                <input type="file" id="combinedExcelFile" accept=".xlsx,.xls,.csv" style="display:none;">
                <button class="control-btn" onclick="generateExcelTemplate()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <span style="font-size: 14px; margin-right: 6px;">üìä</span>
                    <span>Download Master Data</span>
                </button>
                <button class="control-btn" onclick="openTenancyDataManager()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    <span style="font-size: 14px; margin-right: 6px;">üìÅ</span>
                    <span>Manage Tenancy Data</span>
                </button>
                <div style="position: relative;">
                    <button class="control-btn" onclick="toggleMasterDropdown(); return false;" style="background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);" id="manageMasterBtn">
                        <span style="font-size: 14px; margin-right: 6px;">‚öô</span>
                        <span>Manage Master Records</span>
                        <span style="margin-left: 4px; font-size: 10px;">‚ñæ</span>
                    </button>
                    <div id="masterDropdown" style="display:none; position:absolute; right:0; top:calc(100% + 8px); background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.2); min-width:280px; z-index:40; overflow: hidden; animation: dropdownFadeIn 0.2s ease-out;">
                        <div style="padding:12px 16px; font-size:11px; color:#6b7280; font-weight:700; background:linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-bottom:2px solid #e5e7eb; text-transform:uppercase; letter-spacing:0.5px;">Manage Records</div>
                        <button class="pdf-button dropdown-item" style="width:100%; background:#fff; color:#111827; text-align:left; padding:14px 18px; border:none; border-bottom:1px solid #f3f4f6; transition:all 0.2s ease; display:flex; align-items:center; gap:12px; font-size:14px; font-weight:500;" onmouseover="this.style.background='linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%)'; this.style.color='#0369a1'; this.style.paddingLeft='22px';" onmouseout="this.style.background='#fff'; this.style.color='#111827'; this.style.paddingLeft='18px';" onclick="toggleMasterDropdown(); openPropertiesCRUD();"><span style="font-size:18px;">üè†</span><span>Properties</span></button>
                        <button class="pdf-button dropdown-item" style="width:100%; background:#fff; color:#111827; text-align:left; padding:14px 18px; border:none; border-bottom:1px solid #f3f4f6; transition:all 0.2s ease; display:flex; align-items:center; gap:12px; font-size:14px; font-weight:500;" onmouseover="this.style.background='linear-gradient(90deg, #fef3c7 0%, #fde68a 100%)'; this.style.color='#92400e'; this.style.paddingLeft='22px';" onmouseout="this.style.background='#fff'; this.style.color='#111827'; this.style.paddingLeft='18px';" onclick="toggleMasterDropdown(); openTenantsCRUD();"><span style="font-size:18px;">üë•</span><span>Tenants</span></button>
                        <button class="pdf-button dropdown-item" style="width:100%; background:#fff; color:#111827; text-align:left; padding:14px 18px; border:none; border-bottom:1px solid #f3f4f6; transition:all 0.2s ease; display:flex; align-items:center; gap:12px; font-size:14px; font-weight:500;" onmouseover="this.style.background='linear-gradient(90deg, #e0e7ff 0%, #c7d2fe 100%)'; this.style.color='#3730a3'; this.style.paddingLeft='22px';" onmouseout="this.style.background='#fff'; this.style.color='#111827'; this.style.paddingLeft='18px';" onclick="toggleMasterDropdown(); openManagersCRUD();"><span style="font-size:18px;">üëî</span><span>Managers</span></button>
                        <button class="pdf-button dropdown-item" style="width:100%; background:#fff; color:#111827; text-align:left; padding:14px 18px; border:none; border-bottom:1px solid #f3f4f6; transition:all 0.2s ease; display:flex; align-items:center; gap:12px; font-size:14px; font-weight:500;" onmouseover="this.style.background='linear-gradient(90deg, #fce7f3 0%, #fbcfe8 100%)'; this.style.color='#9f1239'; this.style.paddingLeft='22px';" onmouseout="this.style.background='#fff'; this.style.color='#111827'; this.style.paddingLeft='18px';" onclick="toggleMasterDropdown(); openLeasesCRUD();"><span style="font-size:18px;">üìã</span><span>Leases</span></button>
                        <button class="pdf-button dropdown-item" style="width:100%; background:#fff; color:#111827; text-align:left; padding:14px 18px; border:none; transition:all 0.2s ease; display:flex; align-items:center; gap:12px; font-size:14px; font-weight:500;" onmouseover="this.style.background='linear-gradient(90deg, #d1fae5 0%, #a7f3d0 100%)'; this.style.color='#065f46'; this.style.paddingLeft='22px';" onmouseout="this.style.background='#fff'; this.style.color='#111827'; this.style.paddingLeft='18px';" onclick="toggleMasterDropdown(); openInspectionReportCRUD();"><span style="font-size:18px;">üìù</span><span>Inspection Report</span></button>
                    </div>
                </div>
                <a href="NS_Lease_Generator_Documentation.html" target="_blank" class="control-btn" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); text-decoration: none; display: inline-flex; align-items: center;">
                    <span style="font-size: 14px; margin-right: 6px;">üìö</span>
                    <span>Documentation</span>
                </a>
            </div>
        </div>
        <div class="upload-info" id="combinedUploadInfo" style="margin-bottom: 10px;"></div>
        <div id="excelWarnings"></div>

        <!-- MANAGERS CRUD MODAL -->
        <div id="managersCRUDBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 50;"></div>
        <div id="managersCRUDModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 800px; max-width: 95vw; max-height: 85vh; overflow: auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 51; padding: 18px;">
            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px;">
                <h3 style="margin:0;">Manage Managers & Superintendents</h3>
                <button class="pdf-button" onclick="closeManagersCRUD()" style="background:#ef4444;">‚úñ Close</button>
            </div>
            <div class="excel-table-container" style="max-height: 60vh; margin-bottom: 10px;">
                <table class="excel-table" id="managersTable">
                    <thead>
                        <tr>
                            <th class="resizable" style="width: 200px;">Manager_Name</th>
                            <th class="resizable" style="width: 150px;">Manager_Phone</th>
                            <th class="resizable" style="width: 200px;">Superintendent_Name</th>
                            <th class="resizable" style="width: 150px;">Superintendent_Phone</th>
                            <th style="width: 100px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="managersCRUDBody"></tbody>
                </table>
            </div>
            <div style="display:flex; justify-content: space-between; align-items:center;">
                <button class="pdf-button" onclick="addManagerRow()" style="background:#10b981;">Ôºã Add Row</button>
                <div style="display:flex; gap:8px;">
                    <button class="pdf-button" onclick="saveManagersCRUD()" style="background:#3b82f6;">‚úî Save</button>
                    <button class="pdf-button" onclick="closeManagersCRUD()" style="background:#6b7280;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- INSPECTION REPORT CRUD MODAL -->
        <div id="inspectionReportCRUDBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 50;"></div>
        <div id="inspectionReportCRUDModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95vw; max-width: 1400px; max-height: 75vh; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 51; padding: 18px; flex-direction: column; overflow: hidden;">
            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; flex-shrink: 0;">
                <h3 style="margin:0;">Manage Inspection Report</h3>
                <button class="pdf-button" onclick="closeInspectionReportCRUD()" style="background:#ef4444;">‚úñ Close</button>
            </div>
            <div style="margin-bottom: 10px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 12px; flex-shrink: 0;">
                <strong>Instructions:</strong> Edit sections, comments, and codes. Use "Add Row" to create new entries. Column headers can be resized by dragging the border between columns.
                <br><br>
                <strong class="flashing-text">Conditional Codes: B: Broken, M: Missing, D: Damaged, G: Good, S: Scratched/Marked</strong><br>
                <strong class="flashing-text">Cleanliness Codes: C: Clean, DT: Dirty, ST: Stained</strong>
            </div>
            <div class="excel-table-container" style="flex: 1; overflow: auto; margin-bottom: 10px; min-height: 0;">
                <table class="excel-table" id="inspectionReportTable">
                    <thead>
                        <tr>
                            <th class="resizable" style="width: 200px;">Sections</th>
                            <th class="resizable" style="width: 120px;" title="Condition at Beginning of Tenancy">Comment</th>
                            <th class="resizable" style="width: 80px;" title="Condition at Beginning of Tenancy">Code</th>
                            <th class="resizable" style="width: 120px;" title="Condition at End of Tenancy">Comment</th>
                            <th class="resizable" style="width: 80px;" title="Condition at End of Tenancy">Code</th>
                            <th style="width: 100px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inspectionReportCRUDBody"></tbody>
                </table>
            </div>
            <div style="display:flex; justify-content: space-between; align-items:center; flex-shrink: 0;">
                <button class="pdf-button" onclick="addInspectionRow()" style="background:#10b981;">Ôºã Add Row</button>
                <div style="display:flex; gap:8px;">
                    <button class="pdf-button" onclick="saveInspectionReportCRUD()" style="background:#3b82f6;">‚úî Save</button>
                    <button class="pdf-button" onclick="closeInspectionReportCRUD()" style="background:#6b7280;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- TENANCY DATA MANAGER MODAL -->
        <div id="tenancyDataBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 50;"></div>
        <div id="tenancyDataModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95vw; max-width: 1600px; max-height: 90vh; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 51; padding: 20px; flex-direction: column; overflow: hidden;">
            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 15px; flex-shrink: 0;">
                <h2 style="margin:0; font-size: 24px;">üìÅ Manage Tenancy Data</h2>
                <button class="pdf-button" onclick="closeTenancyDataManager()" style="background:#ef4444;">‚úñ Close</button>
            </div>
            
            <!-- Tabs -->
            <div id="tenancyMainTabs" style="display:flex; gap:8px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; flex-shrink: 0; flex-wrap: wrap;">
                <button class="tenancy-tab-btn active" onclick="switchTenancyTab('leases')" data-tab="leases" style="padding: 10px 20px; border: none; background: #3b82f6; color: white; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 500;">üìã Leases</button>
                <button class="tenancy-tab-btn" onclick="switchTenancyTab('personalIds')" data-tab="personalIds" style="padding: 10px 20px; border: none; background: #e5e7eb; color: #374151; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 500;">üÜî Personal IDs</button>
                <button class="tenancy-tab-btn" onclick="switchTenancyTab('communications')" data-tab="communications" style="padding: 10px 20px; border: none; background: #e5e7eb; color: #374151; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 500;">üìß Communications</button>
                <!-- Property Image Tabs will be dynamically added here -->
            </div>

            <!-- Upload Area (shown for non-image tabs) -->
            <div id="tenancyUploadArea" style="margin-bottom: 6px; padding: 6px 10px; background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: 2px dashed #3b82f6; border-radius: 5px; display: flex; align-items: center; flex-shrink: 0; gap: 10px; cursor: pointer; min-height: 36px;" onclick="document.getElementById('tenancyFileUpload').click()" ondrop="handleTenancyFileDrop(event)" ondragover="event.preventDefault(); this.style.borderColor='#1d4ed8';" ondragleave="this.style.borderColor='#3b82f6';">
                <div style="font-size: 24px; color: #3b82f6; flex-shrink: 0; line-height: 1;">üìÅ</div>
                <div style="flex: 1; display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; min-width: 0;">
                    <span style="font-size: 12px; font-weight: 500; color: #1e40af; white-space: nowrap;">Drag & drop files here or click to browse</span>
                    <span style="font-size: 10px; color: #1e3a8a; white-space: nowrap;">‚Ä¢ Supports: PDF, DOC, DOCX, XLS, XLSX, TXT, Images</span>
                </div>
                <button class="pdf-button" onclick="event.stopPropagation(); document.getElementById('tenancyFileUpload').click()" style="background:#3b82f6; padding: 5px 14px; font-size: 12px; white-space: nowrap; border-radius: 4px; box-shadow: 0 2px 4px rgba(59,130,246,0.3); flex-shrink: 0; height: 28px; line-height: 1;">Choose Files</button>
                <input type="file" id="tenancyFileUpload" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.gif" style="display:none;" onchange="handleTenancyFileUpload(event)">
            </div>
            
            <!-- Project Documents Path Bar -->
            <div id="tenancyPathBar" style="margin-bottom: 8px; padding: 6px 12px; background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border-radius: 5px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
                <div style="display: flex; align-items: center; gap: 6px; color: #1e40af; font-size: 12px; font-weight: 500;">
                    <span style="font-size: 14px;">üìÇ</span>
                    <span>Project Documents Path: <span id="tenancyDocumentsPath" style="color: #1e3a8a;">D:\My_Programs\NS_Lease_Generator</span></span>
                </div>
                <div style="color: #1e40af; font-size: 12px; font-weight: 500;">
                    Your Documents (<span id="tenancyDocumentsCount">0</span>)
                </div>
            </div>

            <!-- Tab Content: Leases -->
            <div id="tenancyTabLeases" class="tenancy-tab-content active" style="flex: 1; overflow: hidden; min-height: 0; display: flex; flex-direction: column;">
                <div id="tenancyLeasesContainer" style="flex: 1; overflow-y: auto; overflow-x: auto; min-height: 0; padding: 0; background: #f9fafb;">
                    <!-- Table will be rendered here -->
                </div>
            </div>

            <!-- Tab Content: Personal IDs -->
            <div id="tenancyTabPersonalIds" class="tenancy-tab-content" style="display:none; flex: 1; overflow: hidden; min-height: 0; display: flex; flex-direction: column;">
                <div id="tenancyPersonalIdsContainer" style="flex: 1; overflow-y: auto; overflow-x: auto; min-height: 0; padding: 20px;">
                    <!-- Grid will be rendered here -->
                </div>
            </div>

            <!-- Property Image Tabs Content (dynamically generated) -->

            <!-- Tab Content: Communications -->
            <div id="tenancyTabCommunications" class="tenancy-tab-content" style="display:none; flex: 1; overflow: hidden; min-height: 0; display: flex; flex-direction: column;">
                <div id="tenancyCommunicationsContainer" style="flex: 1; overflow-y: auto; overflow-x: auto; min-height: 0; padding: 20px;">
                    <!-- Grid will be rendered here -->
                </div>
            </div>
        </div>

        <!-- PROPERTIES CRUD MODAL -->
        <div id="propertiesCRUDBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 50;"></div>
        <div id="propertiesCRUDModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 1200px; max-width: 95vw; max-height: 90vh; overflow: auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 51; padding: 20px;">
            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 15px;">
                <h3 style="margin:0;">üè† Manage Properties</h3>
                <button class="pdf-button" onclick="closePropertiesCRUD()" style="background:#ef4444;">‚úñ Close</button>
            </div>
            <div class="excel-table-container" style="max-height: 60vh; margin-bottom: 10px;">
                <table class="excel-table" id="propertiesTable">
                    <thead>
                        <tr>
                            <th class="resizable" style="width: 150px;">Property_Tag</th>
                            <th class="resizable" style="width: 250px;">Property_Address</th>
                            <th class="resizable" style="width: 200px;">Landlord_Name</th>
                            <th class="resizable" style="width: 250px;">Landlord_Address</th>
                            <th class="resizable" style="width: 150px;">Landlord_Phone</th>
                            <th style="width: 100px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="propertiesCRUDBody"></tbody>
                </table>
            </div>
            <div style="display:flex; justify-content: space-between; align-items:center; margin-top:15px;">
                <button class="pdf-button" onclick="addPropertyRow()" style="background:#10b981;">Ôºã Add Property</button>
                <div style="display:flex; gap:8px;">
                    <button class="pdf-button" onclick="savePropertiesCRUD()" style="background:#3b82f6;">‚úî Save & Apply</button>
                    <button class="pdf-button" onclick="downloadEditedMaster()" style="background:#059669;">üì• Download Master Data</button>
                </div>
            </div>
        </div>

        <!-- TENANTS CRUD MODAL -->
        <div id="tenantsCRUDBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 50;"></div>
        <div id="tenantsCRUDModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95vw; max-width: 1400px; max-height: 75vh; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 51; padding: 18px; flex-direction: column; overflow: hidden;">
            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 15px; flex-shrink: 0;">
                <h3 style="margin:0;">üë• Manage Tenants</h3>
                <button class="pdf-button" onclick="closeTenantsCRUD()" style="background:#ef4444;">‚úñ Close</button>
            </div>
            <div class="excel-table-container" style="flex: 1; overflow: auto; margin-bottom: 10px; min-height: 0;">
                <table class="excel-table" id="tenantsTable">
                    <thead>
                        <tr>
                            <th class="resizable" style="width: 120px; text-align: center;">Active</th>
                            <th class="resizable" style="width: 200px;">Tenant_Name</th>
                            <th class="resizable" style="width: 200px;">Tenant_Email</th>
                            <th class="resizable" style="width: 150px;">Tenant_Phone</th>
                            <th class="resizable" style="width: 250px;">Tenant_Old_Address</th>
                            <th class="resizable" style="width: 200px;">Tenant_Job_Desc</th>
                            <th style="width: 100px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tenantsCRUDBody"></tbody>
                </table>
            </div>
            <div style="display:flex; justify-content: space-between; align-items:center; margin-top:15px; flex-shrink: 0;">
                <button class="pdf-button" onclick="addTenantRow()" style="background:#10b981;">Ôºã Add Tenant</button>
                <div style="display:flex; gap:8px;">
                    <button class="pdf-button" onclick="saveTenantsCRUD()" style="background:#3b82f6;">‚úî Save & Apply</button>
                    <button class="pdf-button" onclick="downloadEditedMaster()" style="background:#059669;">üì• Download Master Data</button>
                </div>
            </div>
        </div>

        <!-- LEASES CRUD MODAL -->
        <div id="leasesCRUDBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 50;"></div>
        <div id="leasesCRUDModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95vw; max-width: 1400px; max-height: 75vh; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 51; padding: 18px; flex-direction: column; overflow: hidden;">
            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 15px; flex-shrink: 0;">
                <h3 style="margin:0;">üìã Manage Leases</h3>
                <button class="pdf-button" onclick="closeLeasesCRUD()" style="background:#ef4444;">‚úñ Close</button>
            </div>
            <div class="excel-table-container" style="flex: 1; overflow: auto; margin-bottom: 10px; min-height: 0;">
                <table class="excel-table" id="leasesTable">
                    <thead>
                        <tr>
                            <th class="resizable" style="width: 150px;">Lease_ID</th>
                            <th class="resizable" style="width: 120px;">Property_Tag</th>
                            <th class="resizable" style="width: 180px;">Landlord</th>
                            <th class="resizable" style="width: 200px;">Tenants</th>
                            <th class="resizable" style="width: 120px;">Lease_Start_Date</th>
                            <th class="resizable" style="width: 120px;">Lease_End_Date</th>
                            <th class="resizable" style="width: 120px;">Monthly_Rent</th>
                            <th class="resizable" style="width: 130px;">Security_Deposit</th>
                            <th class="resizable" style="width: 200px;">Notes</th>
                            <th style="width: 100px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leasesCRUDBody"></tbody>
                </table>
            </div>
            <div style="display:flex; justify-content: space-between; align-items:center; margin-top:15px; flex-shrink: 0;">
                <div style="font-size: 12px; color:#666;">Leases are created when you finalize a lease. You can edit Notes here.</div>
                <div style="display:flex; gap:8px;">
                    <button class="pdf-button" onclick="saveLeasesCRUD()" style="background:#3b82f6;">‚úî Save Changes</button>
                    <button class="pdf-button" onclick="clearAllLeaseRecords()" style="background:#ef4444;">üóë Clear All Records</button>
                </div>
            </div>
        </div>

        <!-- LANDLORD SELECTOR -->
        <h3>1. Select Landlord</h3>
        <div class="selector-group" style="margin-bottom: 20px;">
            <div class="selector-item">
                <select id="landlordSelect">
                    <option value="">-- Select Landlord --</option>
                </select>
            </div>
        </div>

        <!-- PROPERTY SELECTOR AND TYPE -->
        <div class="selector-group" style="margin-bottom: 20px;">
            <div class="selector-item">
                <h3 style="font-size: 18px; margin-bottom: 10px; margin-top: 0;">3A. Property Address</h3>
                <select id="propertySelect">
                    <option value="">-- Select Property --</option>
                </select>
            </div>
            <div class="selector-item">
                <h3 style="font-size: 18px; margin-bottom: 10px; margin-top: 0;">3B. Type of Rental</h3>
                <select id="propertyTypeSelect">
                    <option value="">-- Select Type --</option>
                    <option value="Shared Room in the House">Shared Room in the House</option>
                    <option value="Private Room in the House">Private Room in the House</option>
                    <option value="Basement Floor">Basement Floor</option>
                </select>
            </div>
        </div>

        <!-- EMERGENCY CONTACT FIELDS -->
        <h3>4. Emergency Contact</h3>
        <div class="selector-group" style="margin-bottom: 20px;">
            <div class="selector-item">
                <label for="emergencyNameInput">Name</label>
                <input type="text" id="emergencyNameInput" placeholder="Enter Name" style="padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
            </div>
            <div class="selector-item">
                <label for="emergencyEmailInput">Email</label>
                <input type="email" id="emergencyEmailInput" placeholder="Enter Email" style="padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
            </div>
            <div class="selector-item">
                <label for="emergencyPhoneInput">Phone</label>
                <input type="tel" id="emergencyPhoneInput" placeholder="Enter Phone" style="padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;">
            </div>
        </div>

    <!-- TENANT SELECTORS -->
        <h3>5. Select Tenants (Up to 4)</h3>
        <div class="selector-group" id="tenantSelectors"></div>

    <!-- OCCUPANTS SELECTORS -->
        <h3>6. Select Occupants (Up to 4)</h3>
        <div class="selector-group" id="occupantSelectors"></div>

        <!-- LEASE DATES -->
        <h3>8B. Fixed-Term Lease Dates</h3>
        <div class="selector-group" style="margin-bottom: 20px;">
            <div class="selector-item">
                <label for="leaseStartDate">Start Date</label>
                <input type="date" id="leaseStartDate" style="padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; width: 100%;">
            </div>
            <div class="selector-item">
                <label for="leaseEndDate">End Date</label>
                <input type="date" id="leaseEndDate" style="padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; width: 100%;">
            </div>
        </div>

        <!-- RENT FIELDS -->
        <div class="selector-group" style="margin-bottom: 20px; grid-template-columns: repeat(3, 1fr); gap: 15px; align-items: start;">
            <div class="selector-item" style="display: flex; flex-direction: column; height: 100%;">
                <h3 style="margin: 0 0 10px 0; padding: 0; font-size: 18px; font-weight: bold; line-height: 1.4; min-height: 50px; display: flex; align-items: flex-start;">10. Rent ($)</h3>
                <input type="number" id="monthlyRentInput" placeholder="Enter amount" step="0.01" style="padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; width: 100%; box-sizing: border-box; height: 48px; margin: 0;">
            </div>
            <div class="selector-item" style="display: flex; flex-direction: column; height: 100%;">
                <h3 style="margin: 0 0 10px 0; padding: 0; font-size: 18px; font-weight: bold; line-height: 1.4; min-height: 50px; display: flex; align-items: flex-start;">Payment Frequency</h3>
                <select id="rentFrequencySelect" style="padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; width: 100%; box-sizing: border-box; height: 48px; margin: 0; appearance: none; background-color: white;">
                    <option value="">-- Select Frequency --</option>
                    <option value="Monthly" selected>Monthly</option>
                    <option value="Weekly">Weekly</option>
                    <option value="Bi-weekly">Bi-weekly</option>
                    <option value="Lumpsum for the Period">Lumpsum for the Period</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="selector-item" style="display: flex; flex-direction: column; height: 100%;">
                <h3 style="margin: 0 0 10px 0; padding: 0; font-size: 18px; font-weight: bold; line-height: 1.4; min-height: 50px; display: flex; align-items: flex-start;">15. Security/Damage Deposit ($)</h3>
                <input type="number" id="securityDepositInput" placeholder="Enter amount" step="0.01" style="padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; width: 100%; box-sizing: border-box; height: 48px; margin: 0;">
            </div>
        </div>

        <!-- PARKING FIELD -->
        <h3>13D. Parking</h3>
        <div class="selector-group" style="margin-bottom: 20px;">
            <div class="selector-item">
                <select id="parkingInput" style="padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; width: 100%;">
                    <option value="">-- Select Parking Option --</option>
                    <option value="Only one car can be parked on driveway, no guest parking allowed on driveway.">Only one car can be parked on driveway, no guest parking allowed on driveway.</option>
                    <option value="Each tenant on this lease can park one car on driveway, no guest parking allowed on driveway.">Each tenant on this lease can park one car on driveway, no guest parking allowed on driveway.</option>
                    <option value="Parking spot is not allocated, no guest parking allowed on driveway.">Parking spot is not allocated, no guest parking allowed on driveway.</option>
                </select>
            </div>
        </div>
    </div>

    <!-- BUTTON CONTAINER -->
    <div class="button-container">
        <button class="pdf-button" onclick="generatePDF()">üìÑ Generate PDF</button>
        <button class="pdf-button" onclick="finalizeLease()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">‚úÖ Finalize Lease</button>
    </div>
</div>

<!-- ALL FORM P CONTENT -->
<div id="pdfContent">

<!-- ================= PAGE 1 ================= -->

<div class="page" data-page="1" style="padding-top: 5mm;">
    <!-- Official Form P header as single image (left aligned) -->
    <div class="ns-form-header">
        <!-- IMPORTANT: save your combined header image as 'formp-header.png'
             in the ClearView_Icons_Images folder, or change the filename below -->
        <img src="../ClearView_Icons_Images/formp-header.png" alt="Nova Scotia - Form P: Standard Form of Lease" class="ns-form-header-image">
    </div>

    <div class="headerTagBox">
        <div id="leaseTag" style="margin-top: 0; margin-bottom: 0;">PROPERTY ‚Äî TENANTS HERE</div>
        <div class="leaseDatesTag"></div>
    </div>

    <div class="section-title" style="margin-top: 3px;">1. Parties</div>
    <div style="margin-bottom: 5px;">
        <div style="font-weight: bold; margin-bottom: 3px;">(A) Landlord Details:</div>
        <div class="emergency-field-group" style="grid-template-columns: 1fr 1fr; margin-bottom: 5px;">
            <div class="emergency-field-item">
                <label>Name</label>
                <div class="input-line" id="landlordNameDisplay"></div>
            </div>
            <div class="emergency-field-item">
                <label>Address</label>
                <div class="input-line" id="landlordAddressDisplay"></div>
            </div>
        </div>
        <div style="font-weight: bold; margin-top: 8px; margin-bottom: 3px;">(B) Tenant Names:</div>
        <div id="tenantNamesContainer"></div>
    </div>

    <div class="section-title" style="margin-top: 5px;">2. Occupants</div>
    <div class="input-line" id="occupantsField" style="margin-bottom: 3px;"> </div>
    <div class="info-label" style="margin-bottom: 3px;">Only those tenants and occupants named are allowed to live in the premises without written consent of the landlord.</div>

    <div class="emergency-field-group" style="grid-template-columns: 1fr 1fr;">
        <div class="emergency-field-item">
            <div class="section-title" style="font-size: 16px; margin-top: 8px; margin-bottom: 3px;">3A. Property Address</div>
    <div class="input-line" id="premisesField"> </div>
        </div>
        <div class="emergency-field-item">
            <div class="section-title" style="font-size: 16px; margin-top: 8px; margin-bottom: 3px;">3B. Type of Rental</div>
    <div class="input-line" id="propertyTypeField"> </div>
        </div>
    </div>

    <div class="section-title" style="margin-top: 5px;">4. Emergency Contact</div>
    <div class="emergency-field-group" style="margin-bottom: 3px;">
        <div class="emergency-field-item">
            <label>Name</label>
            <input type="text" id="emergencyNameField" placeholder="Emergency Contact Name">
        </div>
        <div class="emergency-field-item">
            <label>Email</label>
            <input type="email" id="emergencyEmailField" placeholder="Emergency Contact Email">
        </div>
        <div class="emergency-field-item">
            <label>Phone</label>
            <input type="tel" id="emergencyPhoneField" placeholder="Emergency Contact Phone">
        </div>
    </div>

    <div class="emergency-field-group" style="grid-template-columns: 1fr 1fr;">
        <div class="emergency-field-item">
            <div class="section-title" style="font-size: 16px; margin-top: 8px; margin-bottom: 3px;">5. Property Manager</div>
            <div class="input-line" id="managerField"></div>
        </div>
        <div class="emergency-field-item">
            <div class="section-title" style="font-size: 16px; margin-top: 8px; margin-bottom: 3px;">6. Superintendent</div>
            <div class="input-line" id="superField"></div>
        </div>
    </div>

    <div class="section-title" style="margin-top: 5px;">7A. Electronic Address (Landlord to Tenant)</div>
    <div id="emailLTContainer" style="margin-bottom: 3px;"></div>
    <div class="info-label" style="margin-bottom: 0;">The tenant(s) may change the electronic address by serving written notice of the new electronic address to the landlord in accordance with subsection 15(1) of the Act. If the tenant provides an electronic address under this clause, the landlord may use this electronic address to serve to the tenant any Notice to Quit or other documents under the Act, including Applications to the Director.</div>

    <div class="page-footer">
        <div class="page-footer-left">2023-10 Form P Residential Tenancies Program 1-800-670-4357 www.novascotia.ca/rta</div>
        <div class="page-footer-right">Page <span class="page-number">1</span>/<span class="total-pages">7</span></div>
    </div>
</div>

<!-- ================= PAGE 2 ================= -->

<div class="page" data-page="2">
    <div class="headerTagBox">
    <div id="leaseTag">PROPERTY ‚Äî TENANTS HERE</div>
        <div class="leaseDatesTag"></div>
    </div>

    <div class="section-title" style="margin-top: 5px;">7B. Electronic Address (Tenant to Landlord)</div>
    <div class="input-line" id="emailTL">omagarwal.properties@gmail.com</div>
    <div class="info-label" style="margin-bottom: 5px;">The landlord may change the electronic address by serving written notice of the new electronic address on at least one of the tenants listed in this lease in accordance with subsection 15(2) of the act. If the landlord provides an electronic address under this clause, the tenant may use this electronic address to serve the landlord any Notice to Quit or other documents under the act, including Applications to the Director.</div>

    <div class="section-title" style="margin-top: 5px;">7C. How to Serve Notice</div>
    <div class="input-line" id="serveField">All Notices to Quit or service of documents, except Applications to the Director, must be in writing and served in accordance with Section 15 of the Act.<br>Applications to the Director must be served in accordance with subsections 13(2A), (2B) and (2C) of the Act.</div>

    <div class="emergency-field-group" style="grid-template-columns: 1fr 1fr; margin-top: 5px;">
        <div class="emergency-field-item">
            <div class="section-title" style="font-size: 16px; margin-top: 0; margin-bottom: 5px;">8A. Periodic Lease</div>
            <div class="input-line">NOT APPLICABLE</div>
        </div>
        <div class="emergency-field-item">
            <div class="section-title" style="font-size: 16px; margin-top: 0; margin-bottom: 5px;">8B. Fixed-Term Lease Dates</div>
            <div class="emergency-field-group" style="grid-template-columns: 1fr 1fr; margin-top: 0;">
                <div class="emergency-field-item" style="padding: 0;">
                    <label style="font-size: 14px; margin-bottom: 3px;">Start Date</label>
                    <div class="input-line" id="leaseStartDateDisplay"></div>
                </div>
                <div class="emergency-field-item" style="padding: 0;">
                    <label style="font-size: 14px; margin-bottom: 3px;">End Date</label>
                    <div class="input-line" id="leaseEndDateDisplay"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="info-label" style="margin-top: 5px; margin-bottom: 5px;">Any continuation of the tenancy at the end of a fixed-term requires the written consent of the landlord. At the end of the fixed-term, the tenancy is finished and the tenant must vacate.</div>

    <div class="section-title" style="margin-top: 5px;">9. Public Housing</div>
    <div class="input-line">NOT APPLICABLE</div>

    <div class="section-title" style="margin-top: 5px;">10. Rent</div>
    <div class="formatted-text" id="rentFieldCombined" style="padding: 5px 0; margin-bottom: 5px;"></div>
    <div class="info-label" style="margin-bottom: 5px;">A late payment fee, if any, will be charged at no more than 1% per month of the monthly rental.</div>

    <div class="section-title" style="margin-top: 5px;">11. Rent Increases</div>
    <div class="formatted-text" style="padding: 3px 0; font-size: 11px; line-height: 1.4;">
        <div class="paragraph" style="margin-bottom: 3px;"><span class="bold">The landlord shall not increase the rent under this lease for 12 months.</span></div>
        <div class="paragraph" style="margin-bottom: 3px;"><span class="bold">The landlord shall not give a notice of rent increase that provides for a different rent increase amount if the lease is renewed for a different type of term.</span></div>
        <div class="paragraph" style="margin-bottom: 3px;"><span class="bold">The landlord must give a written notice to the tenant of an increase:</span></div>
        <div class="list-item" style="margin-bottom: 1px;">(a) 4 months before the the effective date of the increase for a month-to-month or year-to-year lease</div>
        <div class="list-item" style="margin-bottom: 1px;">(b) 8 weeks before the the effective date of the increase for a week-to-week lease</div>
        <div class="list-item" style="margin-bottom: 3px;">(c) 7 months before the anniversary date of a manufactured home space lease</div>
        <div class="paragraph" style="margin-bottom: 3px;"><span class="bold">Note:</span> The landlord may select a date to be the annual rent increase date for all manufactured home spaces owned or managed by the landlord. If an annual rent increase date is used, notice must be given 7 months before this date. The landlord must serve the notice of rent increase on the tenants of the land-lease community.</div>
        <div class="paragraph" style="margin-bottom: 0;"><span class="bold">If the landlord administers a public housing program and the amount of the tenant's rent is increased solely on the basis of an increase in income, the restrictions on frequency of rental increases and notice requirements do not apply.</span></div>
    </div>

    <div class="page-footer">
        <div class="page-footer-left">2023-10 Form P Residential Tenancies Program 1-800-670-4357 www.novascotia.ca/rta</div>
        <div class="page-footer-right">Page <span class="page-number">2</span>/<span class="total-pages">7</span></div>
    </div>
</div>

<!-- ================= PAGE 3 ================= -->

<div class="page" data-page="3">
    <div class="headerTagBox">
    <div id="leaseTag">PROPERTY ‚Äî TENANTS HERE</div>
        <div class="leaseDatesTag"></div>
    </div>

    <div class="section-title">12. Rental Incentives</div>
    <div class="formatted-text" style="padding: 5px 0;">
        <div class="paragraph" style="margin-bottom: 3px;">In signing this lease, the landlord grants to the tenant the following incentives, which will remain in effect for the duration of the lease:</div>
        <div class="input-line" style="margin-top: 5px; margin-bottom: 5px;">All Utilities are included in monthly rent</div>
        <div class="info-label" style="margin-top: 5px; margin-bottom: 3px;">The tenant is not required to repay or return any rental incentive if he or she terminate the lease before the end of the term in accordance with the Residential Tenancies Act or sublets or assigns the residential premises to a tenant with the consent of the landlord.</div>
    </div>

    <div class="section-title" style="margin-top: 5px;">13. Rent Includes</div>
    
    <div class="section-title" style="font-size: 16px; margin-top: 3px;">13A. Appliances:</div>
    <div class="input-line" style="margin-bottom: 3px;">Stove, Refrigerator, Washer & Dryer, Microwave, and Furniture.</div>

    <div class="emergency-field-group" style="grid-template-columns: 1fr 1fr;">
        <div class="emergency-field-item">
            <div class="section-title" style="font-size: 16px; margin-top: 3px; margin-bottom: 3px;">13B. Utilities:</div>
    <div class="input-line">Heat, Water, Hot Water, Electricity, Wifi</div>
        </div>
        <div class="emergency-field-item">
            <div class="section-title" style="font-size: 16px; margin-top: 3px; margin-bottom: 3px;">13C. Others:</div>
    <div class="input-line">Lawn care</div>
        </div>
    </div>

    <div class="section-title" style="font-size: 16px; margin-top: 3px;">13D. Parking:</div>
    <div class="input-line" id="parkingField" style="margin-bottom: 3px;"></div>
    
    <div class="info-label" style="margin-top: 3px; margin-bottom: 3px;">The landlord is responsible for providing these services and the discontinuance of a service is deemed to be a rental increase.</div>

    <div class="section-title" style="font-size: 16px; margin-top: 3px;">13E. <span class="bold">The tenant is responsible for the following:</span></div>
    <div class="formatted-text" style="padding: 3px 0;">
        <div class="list-item" style="margin-bottom: 1px;"><span class="bold">Late payment charges</span></div>
        <div class="list-item" style="margin-bottom: 1px;"><span class="bold">Snow removal</span></div>
        <div class="list-item" style="margin-bottom: 1px;"><span class="bold">Tenant Insurance</span></div>
        <div class="list-item" style="margin-bottom: 1px;"><span class="bold">Garbage removal and separation of recyclables, organics and refuse</span></div>
        <div class="list-item" style="margin-bottom: 1px;"><span class="bold">Returned cheque charges (not to exceed $75)</span></div>
        <div class="list-item" style="margin-bottom: 1px;"><span class="bold">Assignment/sublet expenses incurred (not to exceed $75)</span></div>
        <div class="list-item" style="margin-bottom: 1px;"><span class="bold">Locked out charges/Lost keys (not to exceed $50)</span></div>
    </div>

    <div class="section-title" style="margin-top: 5px;">14. Additional Obligations</div>
    <div class="formatted-text" style="padding: 3px 0;">
        <div class="paragraph" style="text-align: justify; margin-bottom: 3px;">1. The tenant(s) is/are solely responsible for snow cleanup, shoveling, and salting of all staircases, walkways, and driveways associated with the rental unit.</div>
        <div class="paragraph" style="text-align: justify; margin-bottom: 3px;">2. Follow the municipal (HRM) guidelines to properly separate your garbage, recycling, and organics.</div>
        <div class="paragraph" style="text-align: justify; margin-bottom: 3px;">3. Laundry and Utility room in the basement and will remain shareble among all tenants.</div>
        <div class="paragraph" style="text-align: justify; margin-bottom: 3px;">4. Guest Parking is not allowed at any time on driveway.</div>
        <div class="paragraph" style="text-align: justify; margin-bottom: 3px;">5. Wifi is provided for shared use within the house and not recomended to use it for "WORK FROM HOME".</div>
    </div>

    <div style="margin-top: 8px; margin-bottom: 10px; font-size: 12px; font-weight: bold; display: flex; align-items: flex-start; gap: 8px; flex-wrap: nowrap;">
        <div style="white-space: nowrap;">Tenants on lease to sign:</div>
        <div id="page3TenantNames" style="display: flex; align-items: flex-start; gap: 8px; flex-wrap: wrap;"></div>
    </div>

    <div class="page-footer">
        <div class="page-footer-left">2023-10 Form P Residential Tenancies Program 1-800-670-4357 www.novascotia.ca/rta</div>
        <div class="page-footer-right">Page <span class="page-number">3</span>/<span class="total-pages">7</span></div>
    </div>
</div>

<!-- ================= PAGE 4 ================= -->

<div class="page" data-page="4">
    <div class="headerTagBox">
    <div id="leaseTag">PROPERTY ‚Äî TENANTS HERE</div>
        <div class="leaseDatesTag"></div>
    </div>

    <div class="section-title">15. Security/Damage Deposit</div>
    <div class="input-line" id="depositField"></div>
    <div class="info-label" style="margin-top: 5px;">This security/damage deposit will be deposited in a trust account within 3 days of its receipt, and will be returned to the tenant with interest within 10 days of the termination of this lease.<br>The landlord shall file a claim for unpaid rent and/or damages within 10 days of the termination of the lease if the deposit is not returned.</div>

    <div class="section-title">16. Inspection</div>
    <div class="input-line">
        Move-in inspection form attached and signed by tenants.
    </div>
    <div class="info-label" style="margin-top: 5px;">An inspection of the premises and the preparation of a written inspection report signed by the landlord and tenant no later than 7 days after the start of the tenancy and no later than 7 days after the end of the tenancy is recommended. If a report is prepared it forms part of the lease.<br>An inspection report is attached to the lease.</div>

    <div class="section-title">17A. Statutory Conditions</div>
    <div class="input-line">
        As per Residential Tenancies Act.
    </div>
    <div class="info-label" style="margin-top: 5px;">The landlord and tenant promise to comply with the statutory conditions set out in Schedule A.</div>

    <div class="section-title">17B. Assigning & Subletting</div>
    <div class="input-line" id="subletField">The tenant cannot sublet the premises.</div>
    <div class="info-label" style="margin-top: 5px;">The tenant may assign or sublet the premises, <u>subject to the consent of the landlord</u>. The landlord may not arbitrarily or unreasonably withhold consent or charge for consent unless the landlord has actually incurred expense in granting the consent.</div>

    <div class="section-title" style="margin-top: 5px;">18. Rental Arrears</div>
    <div class="formatted-text" style="padding: 10px 0; font-size: 13px;">
        <div class="paragraph" style="text-align: justify; margin-bottom: 10px;">A landlord may give a Notice to Quit where the tenant has not paid rent on or before the 15<sup>th</sup> day after the rent is due, or on or after the 16<sup>th</sup> day after the rent is due, in a fixed-term, year-to-year or month-to-month tenancy. The Notice to Quit becomes effective not earlier than the 15<sup>th</sup> day after it is given to the tenant. Not later than 15 days after receiving the Notice to Quit, the tenant may</div>
        <div class="paragraph" style="text-align: justify; margin-bottom: 10px;">(a) pay the landlord the rent that is in arrears, in which case the Notice to Quit becomes void and of no effect and the lease continues, or<br>(b) apply to the Director for an order setting aside the Notice to Quit.</div>
        <div class="paragraph" style="text-align: justify; margin-bottom: 10px;">If the tenant does not pay the rental arrears or make an Application to the Director by the end of the 15<sup>th</sup> day after receiving the Notice to Quit, the tenancy is terminated and the tenant must vacate the premises by the effective date of the notice.</div>
        <div class="paragraph" style="text-align: justify;">A landlord may give a Notice to Quit where the tenant has not paid rent on or before the 7<sup>th</sup> day after the rent is due, or on or after the 8<sup>th</sup> day after the rent is due, in a week-to-week tenancy. The Notice to Quit becomes effective not earlier than the 7<sup>th</sup> day after it is given to the tenant.</div>
    </div>

    <div class="page-footer">
        <div class="page-footer-left">2023-10 Form P Residential Tenancies Program 1-800-670-4357 www.novascotia.ca/rta</div>
        <div class="page-footer-right">Page <span class="page-number">4</span>/<span class="total-pages">7</span></div>
    </div>
</div>

<!-- ================= PAGE 5 ================= -->

<div class="page" data-page="5">
    <div class="headerTagBox">
    <div id="leaseTag">PROPERTY ‚Äî TENANTS HERE</div>
        <div class="leaseDatesTag"></div>
    </div>

    <div class="section-title">19. Tenant Notice to Quit</div>
    <div class="formatted-text" style="padding: 10px 0;">
        <div class="list-item" style="text-align: justify; margin-bottom: 5px;">The notice must cover a full month.</div>
        <div class="list-item" style="text-align: justify; margin-bottom: 5px;">The move-out date must be the last day of a rental month.</div>
        <div class="list-item" style="text-align: justify;">If the notice is given after the rental month has already started, the notice applies to the next month.</div>
    </div>

    <div class="section-title">20. Landlord Notice to Quit</div>
    <div class="formatted-text" style="padding: 10px 0;">
        <div class="paragraph" style="text-align: justify; font-size: 12.5px;">A landlord may not give a notice to quit except in accordance with Section 10 of the Residential Tenancies Act.</div>
    </div>

    <div class="section-title">21. General</div>
    <div class="formatted-text" style="padding: 10px 0;">
        <div class="paragraph" style="text-align: justify;">This lease is for the benefit of and is binding on the landlord and tenant and their heirs, executors, administrators, assigns and personal representatives.</div>
    </div>

    <div class="section-title">22A. Tenants responsible for complying with terms and conditions</div>
    <div id="tenantSignaturesContainer"></div>
    <div class="info-label" style="margin-top: 10px; font-size: 13px; font-weight: bold; white-space: nowrap; text-align: center;">Any or all tenants signing this lease take full responsibility for complying with all of its terms and conditions.</div>

    <div class="section-title" style="margin-top: 15px;">22B. Manager's/Landlord's Signature</div>
    <div id="managerSignatureContainer"></div>
    <div class="info-label" style="margin-top: 10px;">Two copies of lease are signed. Paper copy is provided to tenant(s).</div>

    <div class="page-footer">
        <div class="page-footer-left">2023-10 Form P Residential Tenancies Program 1-800-670-4357 www.novascotia.ca/rta</div>
        <div class="page-footer-right">Page <span class="page-number">5</span>/<span class="total-pages">7</span></div>
    </div>
    </div>

<!-- ================= PAGE 6 - INSPECTION REPORT ================= -->

<div class="page" data-page="6">
    <div class="headerTagBox">
    <div id="leaseTag">PROPERTY ‚Äî TENANTS HERE</div>
        <div class="leaseDatesTag"></div>
    </div>

    <div class="section-title" style="font-size: 13px; margin-bottom: 3px; margin-top: 0;">Residential Tenancies - Rental Unit Condition Report</div>
    <div style="font-size: 10px; margin-bottom: 3px; font-style: italic; line-height: 1.3;">Use this report to create a detailed description of the condition of the premises at the start and the end of the lease. It will benefit both the landlord and the tenant at the end of the lease agreement.</div>
    
    <!-- Abbreviations Legend -->
    <div style="margin-top: 2px; margin-bottom: 2px;">
        <div style="background-color: #800020; color: white; padding: 2px 3px; font-size: 9px; font-weight: bold; text-align: center; line-height: 1.3;"><strong class="flashing-text">Conditional Codes: B: Broken, M: Missing, D: Damaged, G: Good, S: Scratched/Marked</strong></div>
        <div style="background-color: #800020; color: white; padding: 2px 3px; font-size: 9px; font-weight: bold; text-align: center; line-height: 1.3;"><strong class="flashing-text">Cleanliness Codes: C: Clean, DT: Dirty, ST: Stained</strong></div>
    </div>
    
    <div id="inspectionReportContainer" style="margin-bottom: 0; max-height: 260mm; overflow: hidden;">
        <!-- Inspection report content from Excel will be inserted here -->
    </div>

    <div class="page-footer">
        <div class="page-footer-left">2023-10 Form P Residential Tenancies Program 1-800-670-4357 www.novascotia.ca/rta</div>
        <div class="page-footer-right">Page <span class="page-number">6</span>/<span class="total-pages">7</span></div>
    </div>
</div>

<!-- ================= PAGE 7 - INSPECTION ACKNOWLEDGMENT ================= -->

<div class="page" data-page="7">
    <div class="headerTagBox">
    <div id="leaseTag">PROPERTY ‚Äî TENANTS HERE</div>
        <div class="leaseDatesTag"></div>
    </div>

    <div class="formatted-text" style="padding: 5px 0; font-size: 15px; text-align: justify; line-height: 1.3; margin-top: 15px;">
        <div class="paragraph" style="margin-bottom: 6px;">I hereby acknowledge and agree that upon taking possession of the premises, the Landlord and I have conducted a thorough inspection and found the property, including all electrical systems, plumbing Ô¨Åxtures, and appliances, to be in good working order, except as explicitly noted in the accompanying inspection report. This acknowledgment covers all rooms and facilities, including living areas, kitchen appliances, bathroom Ô¨Åxtures, and heating and cooling systems.</div>
        <div class="paragraph" style="margin-bottom: 6px;">I understand and accept that it is my responsibility to maintain the premises in the condition it was received, barring normal wear and tear. In the event that any damage occurs to the property as a result of my actions or negligence, or that of my guests, whether directly or indirectly, I understand that it is my responsibility to cover the full cost of necessary repairs and maintenance. This includes, but is not limited to, structural damages, damage to Ô¨Åxtures and appliances, and any harm caused by misuse or neglect.</div>
        <div class="paragraph" style="margin-bottom: 6px;">SpeciÔ¨Åcally, I conÔ¨Årm that all sinks, toilets, and drains are currently in good working order. I acknowledge that any blockages or plumbing issues arising from my negligence or improper use will be rectiÔ¨Åed by the landlord, with all associated costs billed to me. This includes costs related to professional services, parts, and any additional labor required to restore the plumbing to its proper function.</div>
        <div class="paragraph" style="margin-bottom: 6px;">Furthermore, I understand that the landlord's property insurance policy does not extend coverage to my personal belongings. It is my responsibility to secure renter's insurance to protect my personal property against loss or damage due to theft, Ô¨Åre, Ô¨Çood, or other risks. Additionally, I recognize that I am not indemniÔ¨Åed under the landlord's insurance for any damages I may cause to the landlord's property or to adjacent properties.</div>
        <div class="paragraph" style="margin-bottom: 6px;">Should my negligence result in incidents such as a Ô¨Çood or Ô¨Åre, I am aware that I will be held Ô¨Ånancially responsible for the repair and restitution costs to restore the damaged property, including potential damages to neighboring units or properties.</div>
        <div class="paragraph" style="margin-bottom: 10px;">By signing this agreement, I agree to fulÔ¨Åll these responsibilities and to act in a way that prevents damage and ensures the premises remain safe and well-maintained.</div>
    </div>

    <div id="inspectionSignaturesContainer" style="margin-top: 20px;">
        <!-- Tenant signatures will be inserted here -->
    </div>
    <div style="margin-top: 15px;">
        <div class="input-line" style="margin-bottom: 5px; font-size: 15px;">Date (YYYY-MM-DD): _____________________________</div>
    </div>

    <div class="page-footer">
        <div class="page-footer-left">2023-10 Form P Residential Tenancies Program 1-800-670-4357 www.novascotia.ca/rta</div>
        <div class="page-footer-right">Page <span class="page-number">7</span>/<span class="total-pages">7</span></div>
    </div>
</div>

</div> <!-- end pdfContent -->

<!-- BOTTOM PDF BUTTON -->
<div class="button-container">
    <button class="pdf-button" onclick="generatePDF()">üìÑ Generate PDF</button>
    <button class="pdf-button" onclick="generateExcelTemplate()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üìä Download Excel Template</button>
    <button class="pdf-button" onclick="finalizeLease()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">‚úÖ Finalize Lease</button>
</div>

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

let masterData = {};
let inspectionReportData = null; // Store inspection report workbook for export

// ====== HELPER FUNCTION: Add superscripts to duplicate tenant names ======
// Superscript characters: ¬π, ¬≤, ¬≥, ‚Å¥, ‚Åµ, ‚Å∂, ‚Å∑, ‚Å∏, ‚Åπ, ¬π‚Å∞, etc.
function addSuperscriptsToDuplicateNames(tenants) {
    if (!tenants || tenants.length === 0) return tenants;
    
    // Create a map to track name occurrences
    const nameCount = {};
    const nameIndex = {};
    
    // First pass: count occurrences of each name
    tenants.forEach(tenant => {
        const name = (tenant.name || "").trim();
        if (name) {
            nameCount[name] = (nameCount[name] || 0) + 1;
        }
    });
    
    // Second pass: add superscripts to duplicates
    const superscriptChars = ['¬π', '¬≤', '¬≥', '‚Å¥', '‚Åµ', '‚Å∂', '‚Å∑', '‚Å∏', '‚Åπ', '¬π‚Å∞', '¬π¬π', '¬π¬≤'];
    
    return tenants.map(tenant => {
        const originalName = (tenant.name || "").trim();
        if (!originalName) return tenant;
        
        // Only add superscript if name appears more than once
        if (nameCount[originalName] > 1) {
            // Initialize index for this name if not exists
            if (nameIndex[originalName] === undefined) {
                nameIndex[originalName] = 0;
            }
            nameIndex[originalName]++;
            
            // Get superscript character (1-based index)
            const superscriptIndex = nameIndex[originalName] - 1;
            const superscript = superscriptIndex < superscriptChars.length 
                ? superscriptChars[superscriptIndex] 
                : `‚ÅΩ${nameIndex[originalName]}‚Åæ`;
            
            return {
                ...tenant,
                name: originalName + superscript
            };
        }
        
        return tenant;
    });
}

// ====== NORMALIZED DATA CONVERSION FUNCTIONS ======
// Convert normalized Excel sheets to flat key-value format
function convertNormalizedToFlat(propertySheet, tenantSheet, managerSuperSheet) {
    const flatMap = {};
    
    // Convert Property sheet
    if (propertySheet && propertySheet.length > 1) {
        // Find header row (typically first row, but might have empty rows)
        let headerRowIdx = 0;
        for (let i = 0; i < Math.min(5, propertySheet.length); i++) {
            const row = propertySheet[i];
            if (row && row.some(cell => cell && String(cell).trim().length > 0)) {
                const rowText = row.map(c => String(c || '').toLowerCase()).join(' ');
                // Look for property-related headers
                if (rowText.includes('property') || rowText.includes('tag') || rowText.includes('landlord') || 
                    (rowText.includes('name') && rowText.includes('address'))) {
                    headerRowIdx = i;
                    break;
                }
            }
        }
        // If no header found, assume first non-empty row is header
        if (headerRowIdx === 0 && propertySheet[0] && propertySheet[0].some(cell => cell && String(cell).trim().length > 0)) {
            headerRowIdx = 0;
        }
        
        const headers = propertySheet[headerRowIdx] || [];
        // Property sheet structure: Property_Tag, Property_Address, Landlord_Name, Landlord_Address, Landlord_Phone
        const propTagIdx = headers.findIndex(h => h && /property.*tag|^tag$/i.test(String(h)));
        // Handle both "Property_Address" and typo "Propert_Address"
        const propAddrIdx = headers.findIndex(h => h && /propert.*address|^address$/i.test(String(h)) && !/landlord/i.test(String(h)));
        const landlordNameIdx = headers.findIndex(h => h && /landlord.*name/i.test(String(h)));
        const landlordAddrIdx = headers.findIndex(h => h && /landlord.*address/i.test(String(h)));
        const landlordPhoneIdx = headers.findIndex(h => h && /landlord.*phone/i.test(String(h)));
        
        // If we can't find specific columns, try to infer from position
        const dataStartRow = headerRowIdx + 1;
        for (let i = dataStartRow; i < propertySheet.length; i++) {
            const row = propertySheet[i];
            if (!row || row.length === 0) continue;
            
            // Skip empty rows
            if (!row.some(cell => cell && String(cell).trim().length > 0)) continue;
            
            // Extract data - Expected order: Property_Tag, Property_Address, Landlord_Name, Landlord_Address, Landlord_Phone
            let propTag = '';
            let propAddr = '';
            let landlordName = '';
            let landlordAddr = '';
            let landlordPhone = '';
            
            // Property_Tag is typically column 0 (first column)
            if (propTagIdx >= 0 && row[propTagIdx]) {
                propTag = String(row[propTagIdx]).trim();
            } else if (row[0]) {
                propTag = String(row[0]).trim();
            }
            
            // Property_Address is typically column 1
            if (propAddrIdx >= 0 && row[propAddrIdx]) {
                propAddr = String(row[propAddrIdx]).trim();
            } else if (row[1]) {
                propAddr = String(row[1]).trim();
            }
            
            // Landlord_Name is typically column 2
            if (landlordNameIdx >= 0 && row[landlordNameIdx]) {
                landlordName = String(row[landlordNameIdx]).trim();
            } else if (row[2]) {
                landlordName = String(row[2]).trim();
            }
            
            // Landlord_Address is typically column 3
            if (landlordAddrIdx >= 0 && row[landlordAddrIdx]) {
                landlordAddr = String(row[landlordAddrIdx]).trim();
            } else if (row[3]) {
                landlordAddr = String(row[3]).trim();
            }
            
            // Landlord_Phone is typically column 4
            if (landlordPhoneIdx >= 0 && row[landlordPhoneIdx]) {
                landlordPhone = String(row[landlordPhoneIdx]).trim();
            } else if (row[4]) {
                landlordPhone = String(row[4]).trim();
            }
            
            // Use Property_Tag as the identifier (key) instead of Property_Letter
            // Add property if we have at least one field (tag, address, or landlord name)
            if (propTag || propAddr || landlordName) {
                // Sanitize Property_Tag to use as key (remove special chars, spaces)
                const tagKey = propTag ? propTag.replace(/[^A-Za-z0-9]/g, '_') : `PROP_${i - dataStartRow}`;
                
                // Store Property_Address
                if (propAddr) {
                    flatMap[`Property_${tagKey}_Address`] = propAddr;
                }
                // Property_${tagKey} contains the property address (for display in selector)
                const propertyValue = propAddr || propTag || landlordName || "";
                flatMap[`Property_${tagKey}`] = propertyValue;
                // Store the original Property_Tag
                if (propTag) {
                    flatMap[`Property_${tagKey}_Tag`] = propTag;
                }
                // Store landlord information keyed by Property_Tag
                if (landlordName) {
                    flatMap[`Landlord_${tagKey}_Name`] = landlordName;
                    if (landlordAddr) flatMap[`Landlord_${tagKey}_Address`] = landlordAddr;
                    if (landlordPhone) flatMap[`Landlord_${tagKey}_Phone`] = landlordPhone;
                }
            }
        }
    }
    
    // Convert Tenant sheet
    if (tenantSheet && tenantSheet.length > 1) {
        // Find header row
        let headerRowIdx = 0;
        for (let i = 0; i < Math.min(3, tenantSheet.length); i++) {
            const row = tenantSheet[i];
            if (row && row.some(cell => cell && String(cell).trim().length > 0)) {
                const rowText = row.map(c => String(c || '').toLowerCase()).join(' ');
                if (rowText.includes('tenant') || rowText.includes('name') || rowText.includes('email') || rowText.includes('phone')) {
                    headerRowIdx = i;
                    break;
                }
            }
        }
        
        const headers = tenantSheet[headerRowIdx] || [];
        const tenantIdIdx = headers.findIndex(h => h && /id|tenant_id/i.test(String(h)));
        // Name can be "Name", "Tenant_Name", or similar - match any column with "name" that's not email/phone
        const nameIdx = headers.findIndex(h => {
            const hStr = String(h || '').trim().toLowerCase();
            return hStr && /name/i.test(hStr) && !/email|phone/i.test(hStr);
        });
        // Email can be "Email", "Tenant_Email", or similar
        const emailIdx = headers.findIndex(h => {
            const hStr = String(h || '').trim().toLowerCase();
            return hStr && /email/i.test(hStr);
        });
        // Phone can be "Phone", "Tenant_Phone", or similar
        const phoneIdx = headers.findIndex(h => {
            const hStr = String(h || '').trim().toLowerCase();
            return hStr && /phone/i.test(hStr) && !/email/i.test(hStr);
        });
        // Address can be "Address", "Old_Address", "Tenant_Old_Address", or similar
        const addressIdx = headers.findIndex(h => {
            const hStr = String(h || '').trim().toLowerCase();
            return hStr && /address|old_address/i.test(hStr);
        });
        // Job can be "Job", "Job_Desc", "Tenant_Job_Desc", "Occupation", or similar
        const jobIdx = headers.findIndex(h => {
            const hStr = String(h || '').trim().toLowerCase();
            return hStr && /job|occupation|desc/i.test(hStr);
        });
        
        const dataStartRow = headerRowIdx + 1;
        let tenantCounter = 1;
        for (let i = dataStartRow; i < tenantSheet.length; i++) {
            const row = tenantSheet[i];
            if (!row || row.length === 0) continue;
            
            // Skip empty rows
            if (!row.some(cell => cell && String(cell).trim().length > 0)) continue;
            
            let tenantId = '';
            if (tenantIdIdx >= 0 && row[tenantIdIdx]) {
                tenantId = String(row[tenantIdIdx]).trim();
            }
            if (!tenantId) tenantId = String(tenantCounter++);
            
            // Try column indices first, then fallback to positional
            // Expected order: Tenant_ID, Name, Email, Phone, Old_Address, Job
            let name = '';
            let email = '';
            let phone = '';
            let address = '';
            let job = '';
            
            // Name is typically column 1 (after ID in column 0)
            if (nameIdx >= 0 && row[nameIdx]) {
                name = String(row[nameIdx]).trim();
                // Validate it's not an email (contains @)
                if (name.includes('@')) {
                    // This might be wrong column, try positional
                    name = '';
                }
            }
            // Fallback to positional: column 1 should be Name
            if (!name && row[1] && !String(row[1]).includes('@')) {
                name = String(row[1]).trim();
            }
            
            // Email is typically column 2
            if (emailIdx >= 0 && row[emailIdx]) {
                email = String(row[emailIdx]).trim();
            } else if (row[2] && String(row[2]).includes('@')) {
                email = String(row[2]).trim();
            }
            
            // Phone is typically column 3
            if (phoneIdx >= 0 && row[phoneIdx]) {
                phone = String(row[phoneIdx]).trim();
            } else if (row[3] && !String(row[3]).includes('@')) {
                phone = String(row[3]).trim();
            }
            
            if (addressIdx >= 0 && row[addressIdx]) {
                address = String(row[addressIdx]).trim();
            } else if (row[4]) {
                address = String(row[4]).trim();
            }
            
            if (jobIdx >= 0 && row[jobIdx]) {
                job = String(row[jobIdx]).trim();
            } else if (row[5]) {
                job = String(row[5]).trim();
            }
            
            if (name || email || phone) {
                flatMap[`Tenant_${tenantId}_Name`] = name;
                flatMap[`Tenant_${tenantId}_Email`] = email;
                flatMap[`Tenant_${tenantId}_Phone`] = phone;
                if (address) flatMap[`Tenant_${tenantId}_Old_Address`] = address;
                if (job) flatMap[`Tenant_${tenantId}_Job`] = job;
            }
        }
    }
    
    // Convert Manager_Superintendent sheet
    if (managerSuperSheet && managerSuperSheet.length > 1) {
        // Find header row
        let headerRowIdx = 0;
        for (let i = 0; i < Math.min(3, managerSuperSheet.length); i++) {
            const row = managerSuperSheet[i];
            if (row && row.some(cell => cell && String(cell).trim().length > 0)) {
                const rowText = row.map(c => String(c || '').toLowerCase()).join(' ');
                if (rowText.includes('manager') || rowText.includes('superintendent') || rowText.includes('superintendant') || rowText.includes('suprintendent')) {
                    headerRowIdx = i;
                    break;
                }
            }
        }
        
        const headers = managerSuperSheet[headerRowIdx] || [];
        const mgrNameIdx = headers.findIndex(h => h && /manager.*name/i.test(String(h)));
        const mgrPhoneIdx = headers.findIndex(h => h && /manager.*phone/i.test(String(h)));
        const supNameIdx = headers.findIndex(h => h && /super.*name|suprintendent.*name/i.test(String(h)));
        const supPhoneIdx = headers.findIndex(h => h && /super.*phone|suprintendent.*phone/i.test(String(h)));
        const supAddrIdx = headers.findIndex(h => h && /super.*address|suprintendent.*address/i.test(String(h)));
        
        // Expected order: Manager_Name, Manager_Phone, Superintendent_Name, Superintendent_Phone, (Superintendent_Address - optional)
        
        // Get first data row after header
        const dataStartRow = headerRowIdx + 1;
        for (let i = dataStartRow; i < managerSuperSheet.length; i++) {
            const row = managerSuperSheet[i];
            if (!row || row.length === 0) continue;
            if (!row.some(cell => cell && String(cell).trim().length > 0)) continue;
            
            // Try column indices first, then fallback to positional
            if (mgrNameIdx >= 0 && row[mgrNameIdx]) {
                flatMap["Manager_Name"] = String(row[mgrNameIdx]).trim();
            } else if (row[0] && !flatMap["Manager_Name"]) {
                flatMap["Manager_Name"] = String(row[0]).trim();
            }
            
            if (mgrPhoneIdx >= 0 && row[mgrPhoneIdx]) {
                flatMap["Manager_Phone"] = String(row[mgrPhoneIdx]).trim();
            } else if (row[1] && !flatMap["Manager_Phone"]) {
                flatMap["Manager_Phone"] = String(row[1]).trim();
            }
            
            if (supNameIdx >= 0 && row[supNameIdx]) {
                flatMap["Superintendent_Name"] = String(row[supNameIdx]).trim();
            } else if (row[2] && !flatMap["Superintendent_Name"]) {
                flatMap["Superintendent_Name"] = String(row[2]).trim();
            }
            
            if (supPhoneIdx >= 0 && row[supPhoneIdx]) {
                flatMap["Superintendent_Phone"] = String(row[supPhoneIdx]).trim();
            } else if (row[3] && !flatMap["Superintendent_Phone"]) {
                flatMap["Superintendent_Phone"] = String(row[3]).trim();
            }
            
            if (supAddrIdx >= 0 && row[supAddrIdx]) {
                flatMap["Superintendent_Address"] = String(row[supAddrIdx]).trim();
            } else if (row[4] && !flatMap["Superintendent_Address"]) {
                flatMap["Superintendent_Address"] = String(row[4]).trim();
            }
            
            // Only process first data row for manager/superintendent
            break;
        }
    }
    
    return flatMap;
}

// Convert flat key-value format to normalized Excel sheets
function convertFlatToNormalized(flatMap) {
    const propertyRows = [["Property_Tag", "Property_Address", "Landlord_Name", "Landlord_Address", "Landlord_Phone"]];
    const tenantRows = [["Tenant_Name", "Tenant_Email", "Tenant_Phone", "Tenant_Old_Address", "Tenant_Job_Desc"]];
    // Manager_Superintendent sheet structure: Manager_Name, Manager_Phone, Superintendent_Name, Superintendent_Phone, (Superintendent_Address - optional)
    const managerSuperRows = [["Manager_Name", "Manager_Phone", "Superintendent_Name", "Superintendent_Phone"]];
    
    // Extract properties - iterate through all Property_* keys
    const propertyKeys = Object.keys(flatMap).filter(k => k.startsWith('Property_') && !k.includes('_Tag') && !k.includes('_Address'));
    const processedTags = new Set();
    
    propertyKeys.forEach(propKey => {
        // Extract tag key from Property_${tagKey}
        const tagKey = propKey.replace('Property_', '');
        if (processedTags.has(tagKey)) return;
        processedTags.add(tagKey);
        
        const propAddrKey = `Property_${tagKey}_Address`;
        const propTagKey = `Property_${tagKey}_Tag`;
        const landlordNameKey = `Landlord_${tagKey}_Name`;
        const landlordAddrKey = `Landlord_${tagKey}_Address`;
        const landlordPhoneKey = `Landlord_${tagKey}_Phone`;
        
        // Get Property_Tag value (the actual tag like "15SM")
        const propTag = flatMap[propTagKey] || tagKey;
        const propAddress = flatMap[propAddrKey] || flatMap[propKey] || "";
        const landlordName = flatMap[landlordNameKey] || "";
        const landlordAddr = flatMap[landlordAddrKey] || "";
        const landlordPhone = flatMap[landlordPhoneKey] || "";
        
        if (propTag || propAddress || landlordName) {
            propertyRows.push([
                propTag, // Property_Tag
                propAddress, // Property_Address
                landlordName, // Landlord_Name
                landlordAddr, // Landlord_Address
                landlordPhone // Landlord_Phone
            ]);
        }
    });
    
    // Extract tenants
    for (let i = 1; i <= 50; i++) {
        const name = flatMap[`Tenant_${i}_Name`];
        if (name || flatMap[`Tenant_${i}_Email`] || flatMap[`Tenant_${i}_Phone`]) {
            tenantRows.push([
                name || "",
                flatMap[`Tenant_${i}_Email`] || "",
                flatMap[`Tenant_${i}_Phone`] || "",
                flatMap[`Tenant_${i}_Old_Address`] || "",
                flatMap[`Tenant_${i}_Job`] || ""
            ]);
        }
    }
    
    // Extract manager and superintendent
    managerSuperRows.push([
        flatMap["Manager_Name"] || "",
        flatMap["Manager_Phone"] || "",
        flatMap["Superintendent_Name"] || "",
        flatMap["Superintendent_Phone"] || ""
    ]);
    
    return {
        property: propertyRows,
        tenant: tenantRows,
        managerSuper: managerSuperRows
    };
}
// Persisted finalized leases (kept in localStorage and merged from uploads)
function getLeaseRecords() {
    try {
        return JSON.parse(localStorage.getItem("leaseRecords") || "[]");
    } catch (e) {
        return [];
    }
}
function setLeaseRecords(records) {
    try {
        localStorage.setItem("leaseRecords", JSON.stringify(records || []));
    } catch (e) {}
}

function clearAllLeaseRecords() {
    if (confirm("Are you sure you want to delete ALL lease records and reset all lease counters? This cannot be undone.")) {
        // Clear all lease records
        localStorage.setItem("leaseRecords", "[]");
        
        // Clear all lease counter keys from localStorage
        // Lease counters are stored as: leaseCounter:${propertyTag}:${mon}
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith("leaseCounter:")) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        // Also clear current lease ID if stored
        localStorage.removeItem("leaseIdCurrent");
        localStorage.removeItem("leaseGeneratedAt");
        
        alert("All lease records have been deleted and all lease counters have been reset. New leases will start from 001.");
        // If modal is open, refresh it
        const modal = document.getElementById("leasesCRUDModal");
        if (modal && modal.style.display !== "none") {
            openLeasesCRUD();
        }
    }
}

// ====== MASTER DATA EDITOR ======
function toggleMasterDropdown() {
    const dd = document.getElementById("masterDropdown");
    const btn = document.getElementById("manageMasterBtn");
    if (!dd || !btn) return;
    
    const isOpen = dd.style.display === "block";
    dd.style.display = isOpen ? "none" : "block";
    
    // Remove any existing listeners
    if (window.masterDropdownCloseHandler) {
        document.removeEventListener("click", window.masterDropdownCloseHandler);
        window.masterDropdownCloseHandler = null;
    }
    
    // Add listener only when opening
    if (!isOpen) {
        window.masterDropdownCloseHandler = function(e) {
            // Check if click is outside dropdown and button
            if (!dd.contains(e.target) && !btn.contains(e.target)) {
                dd.style.display = "none";
                document.removeEventListener("click", window.masterDropdownCloseHandler);
                window.masterDropdownCloseHandler = null;
            }
        };
        // Use setTimeout to avoid immediate closure when clicking the button
        setTimeout(() => {
            document.addEventListener("click", window.masterDropdownCloseHandler);
        }, 0);
    }
}

// Helper function to download edited master data
function downloadEditedMaster() {
    // Reuse generateExcelTemplate using current masterData map
    generateExcelTemplate();
}

// ====== PROPERTIES CRUD ======
function openPropertiesCRUD() {
    // Ensure masterData is loaded from localStorage
    try {
        const cached = localStorage.getItem("masterDataCache");
        if (cached) {
            masterData = JSON.parse(cached) || {};
        }
    } catch (e) {
        console.error("Error loading masterData:", e);
    }
    
    // Ensure masterData is an object
    if (!masterData || typeof masterData !== 'object') {
        masterData = {};
    }
    
    const tbody = document.getElementById("propertiesCRUDBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    
    // Load existing properties from masterData - now uses Property_Tag as key
    const props = [];
    const propertyKeys = Object.keys(masterData).filter(k => 
        k.startsWith('Property_') && 
        !k.includes('_Tag') && 
        !k.includes('_Address')
    );
    
    propertyKeys.forEach(propKey => {
        const tagKey = propKey.replace('Property_', '');
        const propTag = masterData[`Property_${tagKey}_Tag`] || tagKey;
        const propAddress = masterData[`Property_${tagKey}_Address`] || masterData[propKey] || "";
        const landlordNameKey = `Landlord_${tagKey}_Name`;
        const landlordAddrKey = `Landlord_${tagKey}_Address`;
        const landlordPhoneKey = `Landlord_${tagKey}_Phone`;
        
        props.push({
            tagKey: tagKey,
            tag: propTag,
            address: propAddress,
            landlordName: masterData[landlordNameKey] || "",
            landlordAddress: masterData[landlordAddrKey] || "",
            landlordPhone: masterData[landlordPhoneKey] || ""
        });
    });
    
    // If no properties exist, add one empty row
    if (props.length === 0) {
        props.push({
            tagKey: "",
            tag: "", address: "",
            landlordName: "", landlordAddress: "", landlordPhone: ""
        });
    }
    
    props.forEach(prop => {
        appendPropertyRow(prop);
    });
    
    document.getElementById("propertiesCRUDBackdrop").style.display = "block";
    document.getElementById("propertiesCRUDModal").style.display = "block";
    toggleMasterDropdown(); // Close dropdown
    setTimeout(initColumnResizers, 100);
}

function appendPropertyRow(prop) {
    const tbody = document.getElementById("propertiesCRUDBody");
    const tr = document.createElement("tr");
    tr.dataset.tagKey = prop.tagKey || '';
    tr.innerHTML = `
        <td><input type="text" value="${escapeHtml(prop.tag || "")}" placeholder="Property_Tag" class="prop-tag"></td>
        <td><input type="text" value="${escapeHtml(prop.address || "")}" placeholder="Property_Address" class="prop-address"></td>
        <td><input type="text" value="${escapeHtml(prop.landlordName || "")}" placeholder="Landlord_Name" class="prop-landlord-name"></td>
        <td><input type="text" value="${escapeHtml(prop.landlordAddress || "")}" placeholder="Landlord_Address" class="prop-landlord-addr"></td>
        <td><input type="text" value="${escapeHtml(prop.landlordPhone || "")}" placeholder="Landlord_Phone" class="prop-landlord-phone"></td>
        <td style="text-align:center;">
            <button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove()">üóë</button>
        </td>`;
    tbody.appendChild(tr);
}

function addPropertyRow() {
    appendPropertyRow({
        tagKey: "",
        tag: "", address: "",
        landlordName: "", landlordAddress: "", landlordPhone: ""
    });
}

function savePropertiesCRUD() {
    const rows = Array.from(document.querySelectorAll("#propertiesCRUDBody tr"));
    
    // Clear existing property data - find all Property_* keys
    const propertyKeys = Object.keys(masterData).filter(k => 
        k.startsWith('Property_') || k.startsWith('Landlord_')
    );
    propertyKeys.forEach(key => delete masterData[key]);
    
    // Collect manager and superintendent data (shared across properties)
    let managerName = "";
    let managerPhone = "";
    let superName = "";
    let superPhone = "";
    let superAddress = "";
    
    rows.forEach((row) => {
        const tag = row.querySelector(".prop-tag").value.trim();
        const address = row.querySelector(".prop-address").value.trim();
        const landlordName = row.querySelector(".prop-landlord-name").value.trim();
        const landlordAddr = row.querySelector(".prop-landlord-addr").value.trim();
        const landlordPhone = row.querySelector(".prop-landlord-phone").value.trim();
        // Use Property_Tag as the key identifier
        if (tag || address || landlordName) {
            // Sanitize tag to use as key (remove special chars, spaces)
            const tagKey = tag ? tag.replace(/[^A-Za-z0-9]/g, '_') : `PROP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            // Store property data
            masterData[`Property_${tagKey}`] = address || tag || "";
            if (address) masterData[`Property_${tagKey}_Address`] = address;
            if (tag) masterData[`Property_${tagKey}_Tag`] = tag;
            
            // Store landlord data
            if (landlordName) {
                masterData[`Landlord_${tagKey}_Name`] = landlordName;
                if (landlordAddr) masterData[`Landlord_${tagKey}_Address`] = landlordAddr;
                if (landlordPhone) masterData[`Landlord_${tagKey}_Phone`] = landlordPhone;
            }
        }
    });
    
    try { localStorage.setItem("masterDataCache", JSON.stringify(masterData)); } catch (e) {}
    populateSelectors(masterData);
    populateFormFields();
    closePropertiesCRUD();
    const info = document.getElementById("combinedUploadInfo");
    if (info) {
        info.innerHTML = "‚úì Properties saved. Use 'Download Master Data' to save to Excel.";
        info.style.color = "#059669";
    }
}

function closePropertiesCRUD() {
    document.getElementById("propertiesCRUDBackdrop").style.display = "none";
    document.getElementById("propertiesCRUDModal").style.display = "none";
}

// ====== TENANTS CRUD ======
function openTenantsCRUD() {
    // Ensure masterData is loaded from localStorage
    try {
        const cached = localStorage.getItem("masterDataCache");
        if (cached) {
            masterData = JSON.parse(cached) || {};
        }
    } catch (e) {
        console.error("Error loading masterData:", e);
    }
    
    // Ensure masterData is an object
    if (!masterData || typeof masterData !== 'object') {
        masterData = {};
    }
    
    const tbody = document.getElementById("tenantsCRUDBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    
    // Load existing tenants from masterData
    const tenants = [];
    for (let i = 1; i <= 50; i++) {
        const name = masterData[`Tenant_${i}_Name`];
        if (name || masterData[`Tenant_${i}_Email`] || masterData[`Tenant_${i}_Phone`]) {
            const activeValue = masterData[`Tenant_${i}_Active`];
            const isActive = activeValue === undefined || activeValue === "1" || activeValue === 1 || activeValue === true; // Default to active if not set
            tenants.push({
                id: i,
                name: name || "",
                email: masterData[`Tenant_${i}_Email`] || "",
                phone: masterData[`Tenant_${i}_Phone`] || "",
                address: masterData[`Tenant_${i}_Old_Address`] || "",
                job: masterData[`Tenant_${i}_Job_Desc`] || masterData[`Tenant_${i}_Job`] || "",
                active: isActive
            });
        }
    }
    
    // Sort tenants by name (case-insensitive)
    tenants.sort((a, b) => {
        const nameA = (a.name || "").toLowerCase();
        const nameB = (b.name || "").toLowerCase();
        return nameA.localeCompare(nameB);
    });
    
    // If no tenants, add one empty row
    if (tenants.length === 0) {
        tenants.push({ id: 1, name: "", email: "", phone: "", address: "", job: "", active: true });
    }
    
    // Add superscripts to duplicate tenant names for display
    const tenantsWithSuperscripts = addSuperscriptsToDuplicateNames(tenants);
    
    tenantsWithSuperscripts.forEach(tenant => {
        appendTenantRow(tenant);
    });
    
    document.getElementById("tenantsCRUDBackdrop").style.display = "block";
    document.getElementById("tenantsCRUDModal").style.display = "flex";
    toggleMasterDropdown(); // Close dropdown
    setTimeout(initColumnResizers, 100);
}

function appendTenantRow(tenant) {
    const tbody = document.getElementById("tenantsCRUDBody");
    const tr = document.createElement("tr");
    tr.dataset.tenantId = tenant.id || '';
    const isActive = tenant.active !== undefined ? tenant.active : true; // Default to active
    tr.innerHTML = `
        <td style="text-align:center;">
            <input type="checkbox" class="tenant-active" ${isActive ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;">
        </td>
        <td><input type="text" value="${escapeHtml(tenant.name || "")}" placeholder="Tenant_Name" class="tenant-name"></td>
        <td><input type="email" value="${escapeHtml(tenant.email || "")}" placeholder="Tenant_Email" class="tenant-email"></td>
        <td><input type="tel" value="${escapeHtml(tenant.phone || "")}" placeholder="Tenant_Phone" class="tenant-phone"></td>
        <td><input type="text" value="${escapeHtml(tenant.address || "")}" placeholder="Tenant_Old_Address" class="tenant-address"></td>
        <td><input type="text" value="${escapeHtml(tenant.job || "")}" placeholder="Tenant_Job_Desc" class="tenant-job"></td>
        <td style="text-align:center;">
            <button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove()">üóë</button>
        </td>`;
    tbody.appendChild(tr);
}

function addTenantRow() {
    const tbody = document.getElementById("tenantsCRUDBody");
    const existingIds = Array.from(tbody.querySelectorAll("tr")).map(tr => parseInt(tr.dataset.tenantId) || 0).filter(id => id > 0);
    const nextId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
    
    appendTenantRow({
        id: nextId,
        name: "", email: "", phone: "", address: "", job: "", active: true
    });
}

function saveTenantsCRUD() {
    const rows = Array.from(document.querySelectorAll("#tenantsCRUDBody tr"));
    
    // Clear existing tenant data
    for (let i = 1; i <= 50; i++) {
        delete masterData[`Tenant_${i}_Name`];
        delete masterData[`Tenant_${i}_Email`];
        delete masterData[`Tenant_${i}_Phone`];
        delete masterData[`Tenant_${i}_Old_Address`];
        delete masterData[`Tenant_${i}_Job_Desc`];
        delete masterData[`Tenant_${i}_Job`]; // Legacy support
        delete masterData[`Tenant_${i}_Active`];
    }
    
    // Helper function to strip superscripts from names
    function stripSuperscripts(name) {
        if (!name) return name;
        // Remove superscript characters: ¬π, ¬≤, ¬≥, ‚Å¥, ‚Åµ, ‚Å∂, ‚Å∑, ‚Å∏, ‚Åπ, ¬π‚Å∞, ¬π¬π, ¬π¬≤, and patterns like ‚ÅΩ1‚Åæ
        return name.replace(/[¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ‚Å∞‚ÅΩ‚Åæ]/g, '').trim();
    }
    
    // Save tenant data
    let nextId = 1;
    rows.forEach(row => {
        let name = row.querySelector(".tenant-name").value.trim();
        // Strip superscripts before saving to keep data clean
        name = stripSuperscripts(name);
        const email = row.querySelector(".tenant-email").value.trim();
        const phone = row.querySelector(".tenant-phone").value.trim();
        const address = row.querySelector(".tenant-address").value.trim();
        const job = row.querySelector(".tenant-job").value.trim();
        const active = row.querySelector(".tenant-active").checked;
        
        if (name || email || phone || address || job) {
            if (name) masterData[`Tenant_${nextId}_Name`] = name;
            if (email) masterData[`Tenant_${nextId}_Email`] = email;
            if (phone) masterData[`Tenant_${nextId}_Phone`] = phone;
            if (address) masterData[`Tenant_${nextId}_Old_Address`] = address;
            if (job) masterData[`Tenant_${nextId}_Job_Desc`] = job;
            masterData[`Tenant_${nextId}_Active`] = active ? "1" : "0";
            nextId++;
        }
    });
    
    try { localStorage.setItem("masterDataCache", JSON.stringify(masterData)); } catch (e) {}
    populateSelectors(masterData);
    populateFormFields();
    closeTenantsCRUD();
    const info = document.getElementById("combinedUploadInfo");
    if (info) {
        info.innerHTML = "‚úì Tenants saved. Use 'Download Master Data' to save to Excel.";
        info.style.color = "#059669";
    }
}

function closeTenantsCRUD() {
    document.getElementById("tenantsCRUDBackdrop").style.display = "none";
    document.getElementById("tenantsCRUDModal").style.display = "none";
}

// ====== LEASES CRUD ======
function openLeasesCRUD() {
    const tbody = document.getElementById("leasesCRUDBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    
    // Load lease records from localStorage
    const records = getLeaseRecords();
    
    if (records.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:20px; color:#666;">No lease records found. Finalize a lease to create a record.</td></tr>`;
    } else {
        // Helper function to clean tenant names (remove IDs, numbers, but preserve existing superscripts if present)
        function cleanTenantName(name) {
            if (!name) return '';
            let cleaned = String(name).trim();
            // Remove numbers in parentheses like (108), (84), (28)
            cleaned = cleaned.replace(/\(\s*\d+\s*\)/g, '').trim();
            // Remove trailing numbers (but not superscripts)
            if (cleaned && /[0-9]$/.test(cleaned) && !/[¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ‚Å∞]$/.test(cleaned)) {
                cleaned = cleaned.replace(/\d+$/, '').trim();
            }
            // Remove leading numbers with separators
            cleaned = cleaned.replace(/^\d+\s*[-_]\s*/, '').trim();
            // Normalize whitespace
            cleaned = cleaned.replace(/\s+/g, ' ').trim();
            return cleaned;
        }
        
        // Step 1: Get all tenants from masterData (Tenants sheet) and apply superscripts
        // This is the same logic used in the Tenants modal
        const tenantsFromMaster = [];
        let tenantId = 1;
        while (masterData[`Tenant_${tenantId}_Name`]) {
            const name = masterData[`Tenant_${tenantId}_Name`] || "";
            const email = masterData[`Tenant_${tenantId}_Email`] || "";
            const phone = masterData[`Tenant_${tenantId}_Phone`] || "";
            if (name) {
                tenantsFromMaster.push({
                    id: tenantId,
                    name: name.trim(),
                    email: email.trim(),
                    phone: phone.trim()
                });
            }
            tenantId++;
        }
        
        // Step 2: Apply superscripts to duplicate tenant names in masterData
        // (same name but different email/phone)
        const tenantsWithSuperscripts = addSuperscriptsToDuplicateNames(tenantsFromMaster);
        
        // Step 3: Build a map: cleaned name -> array of {nameWithSuperscript, email, phone}
        // This allows us to match tenant names from lease records to masterData
        const tenantNameMap = {};
        tenantsWithSuperscripts.forEach(tenant => {
            const cleanedName = cleanTenantName(tenant.name).toLowerCase();
            if (!tenantNameMap[cleanedName]) {
                tenantNameMap[cleanedName] = [];
            }
            tenantNameMap[cleanedName].push({
                nameWithSuperscript: tenant.name,
                email: tenant.email,
                phone: tenant.phone
            });
        });
        
        // Step 4: Process each lease record and match tenant names to masterData
        records.forEach((record, recordIndex) => {
            const processedRecord = { ...record };
            if (processedRecord.Tenants) {
                const originalNames = record.Tenants.split(',').map(n => n.trim()).filter(Boolean);
                const names = originalNames.map(originalName => {
                    // Check if name already has a superscript (from when lease was finalized)
                    const hasSuperscript = /[¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ‚Å∞‚ÅΩ‚Åæ]/.test(originalName);
                    
                    if (hasSuperscript) {
                        // Name already has superscript, keep it (it was set when lease was finalized)
                        return originalName;
                    }
                    
                    // Clean the name to match against masterData
                    const cleaned = cleanTenantName(originalName);
                    if (!cleaned) return '';
                    
                    // Try to find in masterData
                    const cleanedLower = cleaned.toLowerCase();
                    const matches = tenantNameMap[cleanedLower];
                    
                    if (matches && matches.length > 0) {
                        // If only one match, use it
                        if (matches.length === 1) {
                            return matches[0].nameWithSuperscript;
                        }
                        // If multiple matches (same name, different email/phone), use the first one
                        // (We can't determine which specific tenant it refers to without email/phone)
                        return matches[0].nameWithSuperscript;
                    }
                    
                    // No match in masterData, return cleaned name without superscript
                    return cleaned;
                }).filter(Boolean);
                processedRecord.Tenants = names.join(", ");
            }
            appendLeaseRow(processedRecord, recordIndex);
        });
    }
    
    document.getElementById("leasesCRUDBackdrop").style.display = "block";
    document.getElementById("leasesCRUDModal").style.display = "flex";
    toggleMasterDropdown(); // Close dropdown
    setTimeout(() => {
        initColumnResizers();
    }, 100);
}

function appendLeaseRow(record, index) {
    const tbody = document.getElementById("leasesCRUDBody");
    const tr = document.createElement("tr");
    tr.dataset.leaseIndex = index;
    
    // Excel-style table cells
    tr.innerHTML = `
        <td style="padding: 4px; border: 1px solid #d1d5db;">
            <input type="text" value="${escapeHtml(record.Lease_ID || "")}" readonly 
                   style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" 
                   class="lease-id">
        </td>
        <td style="padding: 4px; border: 1px solid #d1d5db;">
            <input type="text" value="${escapeHtml(record.Property_Tag || "")}" readonly 
                   style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" 
                   class="lease-property-tag">
        </td>
        <td style="padding: 4px; border: 1px solid #d1d5db;">
            <input type="text" value="${escapeHtml(record.Landlord || "")}" readonly 
                   style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" 
                   class="lease-landlord">
        </td>
        <td style="padding: 4px; border: 1px solid #d1d5db;">
            <textarea readonly 
                      style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; min-height: 40px; resize: vertical; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; box-sizing: border-box; font-family: inherit;" 
                      class="lease-tenants">${escapeHtml(record.Tenants || "")}</textarea>
        </td>
        <td style="padding: 4px; border: 1px solid #d1d5db;">
            <input type="text" value="${escapeHtml(record.Lease_Start_Date || "")}" readonly 
                   style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" 
                   class="lease-start">
        </td>
        <td style="padding: 4px; border: 1px solid #d1d5db;">
            <input type="text" value="${escapeHtml(record.Lease_End_Date || "")}" readonly 
                   style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" 
                   class="lease-end">
        </td>
        <td style="padding: 4px; border: 1px solid #d1d5db;">
            <input type="text" value="${escapeHtml(record.Monthly_Rent || "")}" readonly 
                   style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" 
                   class="lease-rent">
        </td>
        <td style="padding: 4px; border: 1px solid #d1d5db;">
            <input type="text" value="${escapeHtml(record.Security_Deposit || "")}" readonly 
                   style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" 
                   class="lease-deposit">
        </td>
        <td style="padding: 4px; border: 1px solid #d1d5db;">
            <textarea placeholder="Notes" 
                      style="width: 100%; border: none; background: #fff; padding: 4px; font-size: 13px; min-height: 40px; resize: vertical; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; box-sizing: border-box; font-family: inherit;" 
                      class="lease-notes">${escapeHtml(record.Notes || "")}</textarea>
        </td>
        <td style="padding: 4px; border: 1px solid #d1d5db; text-align: center;">
            <button class="pdf-button" style="background:#ef4444; padding: 4px 8px; font-size: 11px; border: none; cursor: pointer;" onclick="deleteLeaseRow(this)">üóë</button>
        </td>`;
    tbody.appendChild(tr);
}

function deleteLeaseRow(btn) {
    if (!confirm("Are you sure you want to delete this lease record?")) return;
    const tr = btn.closest("tr");
    const index = parseInt(tr.dataset.leaseIndex);
    const records = getLeaseRecords();
    records.splice(index, 1);
    setLeaseRecords(records);
    tr.remove();
    
    // Re-index remaining rows
    const remainingRows = Array.from(document.querySelectorAll("#leasesCRUDBody tr"));
    remainingRows.forEach((row, idx) => {
        row.dataset.leaseIndex = idx;
    });
    
    // Reload the modal to refresh superscripts
    openLeasesCRUD();
}

function saveLeasesCRUD() {
    const rows = Array.from(document.querySelectorAll("#leasesCRUDBody tr"));
    const records = getLeaseRecords();
    
    rows.forEach(row => {
        const index = parseInt(row.dataset.leaseIndex);
        if (index >= 0 && index < records.length) {
            const notesTextarea = row.querySelector(".lease-notes");
            if (notesTextarea) {
                records[index].Notes = notesTextarea.value.trim();
            }
        }
    });
    
    setLeaseRecords(records);
    closeLeasesCRUD();
    const info = document.getElementById("combinedUploadInfo");
    if (info) {
        info.innerHTML = "‚úì Lease records updated. Use 'Download Lease Records' to save to Excel.";
        info.style.color = "#059669";
    }
}

function closeLeasesCRUD() {
    document.getElementById("leasesCRUDBackdrop").style.display = "none";
    document.getElementById("leasesCRUDModal").style.display = "none";
}

// ====== MANAGERS CRUD ======
function openManagersCRUD() {
    // Ensure masterData is loaded from localStorage
    try {
        const cached = localStorage.getItem("masterDataCache");
        if (cached) {
            masterData = JSON.parse(cached) || {};
        }
    } catch (e) {
        console.error("Error loading masterData:", e);
    }
    
    // Ensure masterData is an object
    if (!masterData || typeof masterData !== 'object') {
        masterData = {};
    }
    
    const tbody = document.getElementById("managersCRUDBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    
    // Load existing manager/superintendent data
    const manager = {
        managerName: masterData["Manager_Name"] || "",
        managerPhone: masterData["Manager_Phone"] || "",
        superName: masterData["Superintendent_Name"] || "",
        superPhone: masterData["Superintendent_Phone"] || ""
    };
    
    appendManagerRow(manager);
    
    document.getElementById("managersCRUDBackdrop").style.display = "block";
    document.getElementById("managersCRUDModal").style.display = "block";
    toggleMasterDropdown(); // Close dropdown
    setTimeout(initColumnResizers, 100);
}

function appendManagerRow(manager) {
    const tbody = document.getElementById("managersCRUDBody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td><input type="text" value="${escapeHtml(manager.managerName || "")}" placeholder="Manager_Name" class="manager-name"></td>
        <td><input type="text" value="${escapeHtml(manager.managerPhone || "")}" placeholder="Manager_Phone" class="manager-phone"></td>
        <td><input type="text" value="${escapeHtml(manager.superName || "")}" placeholder="Superintendent_Name" class="super-name"></td>
        <td><input type="text" value="${escapeHtml(manager.superPhone || "")}" placeholder="Superintendent_Phone" class="super-phone"></td>
        <td style="text-align:center;">
            <button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove()">üóë</button>
        </td>`;
    tbody.appendChild(tr);
}

function addManagerRow() {
    appendManagerRow({
        managerName: "", managerPhone: "",
        superName: "", superPhone: ""
    });
}

function saveManagersCRUD() {
    const rows = Array.from(document.querySelectorAll("#managersCRUDBody tr"));
    
    // Clear existing manager/superintendent data
    delete masterData["Manager_Name"];
    delete masterData["Manager_Phone"];
    delete masterData["Superintendent_Name"];
    delete masterData["Superintendent_Phone"];
    
    // Save manager/superintendent data (use first row)
    if (rows.length > 0) {
        const row = rows[0];
        const managerName = row.querySelector(".manager-name").value.trim();
        const managerPhone = row.querySelector(".manager-phone").value.trim();
        const superName = row.querySelector(".super-name").value.trim();
        const superPhone = row.querySelector(".super-phone").value.trim();
        
        if (managerName) masterData["Manager_Name"] = managerName;
        if (managerPhone) masterData["Manager_Phone"] = managerPhone;
        if (superName) masterData["Superintendent_Name"] = superName;
        if (superPhone) masterData["Superintendent_Phone"] = superPhone;
    }
    
    try { localStorage.setItem("masterDataCache", JSON.stringify(masterData)); } catch (e) {}
    populateSelectors(masterData);
    populateFormFields();
    closeManagersCRUD();
    const info = document.getElementById("combinedUploadInfo");
    if (info) {
        info.innerHTML = "‚úì Managers & Superintendents saved. Use 'Download Master Data' to save to Excel.";
        info.style.color = "#059669";
    }
}

function closeManagersCRUD() {
    document.getElementById("managersCRUDBackdrop").style.display = "none";
    document.getElementById("managersCRUDModal").style.display = "none";
}

// ====== INSPECTION REPORT CRUD ======
// inspectionReportData is already declared at the top of the file

function openInspectionReportCRUD() {
    const tbody = document.getElementById("inspectionReportCRUDBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    
    // Load inspection report data from stored workbook or create empty structure
    if (inspectionReportData && inspectionReportData.SheetNames && inspectionReportData.SheetNames.length > 0) {
        const sheetName = inspectionReportData.SheetNames.find(n => n.toLowerCase().includes("inspection")) || inspectionReportData.SheetNames[0];
        const sheet = inspectionReportData.Sheets[sheetName];
        if (sheet) {
            const sheetData = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});
            loadInspectionReportData(sheetData);
        }
    } else {
        // Create empty structure
        appendInspectionRow({section: "", comment1: "", code1: "", comment2: "", code2: "", isSectionHeader: false});
    }
    
    document.getElementById("inspectionReportCRUDBackdrop").style.display = "block";
    document.getElementById("inspectionReportCRUDModal").style.display = "flex";
    toggleMasterDropdown(); // Close dropdown
    setTimeout(initColumnResizers, 100);
}

function loadInspectionReportData(sheetData) {
    const tbody = document.getElementById("inspectionReportCRUDBody");
    if (!sheetData || sheetData.length === 0) return;
    
    // Find Row 6 (index 5) which should have headers: Sections, Comment, Code, Comment, Code
    let headerRowIndex = 5; // Row 6 (0-indexed)
    if (sheetData.length <= headerRowIndex) {
        // If not enough rows, try to find header row
        for (let i = 0; i < Math.min(10, sheetData.length); i++) {
            const row = sheetData[i];
            if (row && row.length >= 5) {
                const firstCell = String(row[0] || "").trim().toLowerCase();
                const secondCell = String(row[1] || "").trim().toLowerCase();
                if (firstCell.includes("section") && (secondCell.includes("comment") || secondCell.includes("code"))) {
                    headerRowIndex = i;
                    break;
                }
            }
        }
    }
    
    // Start reading data from row after header (Row 7, index 6)
    let currentSection = "";
    for (let i = headerRowIndex + 1; i < sheetData.length; i++) {
        const row = sheetData[i];
        if (!row || row.length === 0) continue;
        
        // Column structure: Sections, Comment, Code, Comment, Code
        const section = String(row[0] || "").trim();
        const comment1 = String(row[1] || "").trim();
        const code1 = String(row[2] || "").trim();
        const comment2 = String(row[3] || "").trim();
        const code2 = String(row[4] || "").trim();
        
        // Check if this is a section header (has section name but no data in other columns)
        const isSectionHeader = section && section.length > 0 && 
                               (!comment1 && !code1 && !comment2 && !code2) &&
                               (section.toLowerCase().includes("overall") || 
                                section.toLowerCase().includes("kitchen") ||
                                section.toLowerCase().includes("bathroom") ||
                                section.toLowerCase().includes("furniture") ||
                                section.toLowerCase().includes("refrigerator"));
        
        if (isSectionHeader) {
            currentSection = section;
            appendInspectionRow({section: section, comment1: "", code1: "", comment2: "", code2: "", isSectionHeader: true});
        } else if (section || comment1 || code1 || comment2 || code2) {
            // Regular data row
            const fullSection = section || currentSection;
            appendInspectionRow({section: fullSection, comment1: comment1, code1: code1, comment2: comment2, code2: code2, isSectionHeader: false});
        }
    }
    
    if (tbody.children.length === 0) {
        appendInspectionRow({section: "", comment1: "", code1: "", comment2: "", code2: "", isSectionHeader: false});
    }
}

function appendInspectionRow(data) {
    const tbody = document.getElementById("inspectionReportCRUDBody");
    const tr = document.createElement("tr");
    tr.dataset.isSectionHeader = data.isSectionHeader ? "true" : "false";
    
    if (data.isSectionHeader) {
        tr.style.backgroundColor = "#000080";
        tr.style.color = "#fff";
        tr.innerHTML = `
            <td><input type="text" value="${escapeHtml(data.section || "")}" placeholder="Section Name" style="background:#000080; color:#fff; font-weight:bold; border:1px solid #fff;" class="inspection-section"></td>
            <td colspan="4" style="font-style:italic; padding:4px 6px;">Section Header</td>
            <td style="text-align:center;">
                <button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove()">üóë</button>
            </td>`;
    } else {
        tr.innerHTML = `
            <td><input type="text" value="${escapeHtml(data.section || "")}" placeholder="Sections" class="inspection-section"></td>
            <td><textarea placeholder="Comment" class="inspection-comment1">${escapeHtml(data.comment1 || "")}</textarea></td>
            <td><input type="text" value="${escapeHtml(data.code1 || "")}" placeholder="Code" style="text-align:center;" class="inspection-code1"></td>
            <td><textarea placeholder="Comment" class="inspection-comment2">${escapeHtml(data.comment2 || "")}</textarea></td>
            <td><input type="text" value="${escapeHtml(data.code2 || "")}" placeholder="Code" style="text-align:center;" class="inspection-code2"></td>
            <td style="text-align:center;">
                <button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove()">üóë</button>
            </td>`;
    }
    tbody.appendChild(tr);
    
    // Auto-resize textareas for comment columns
    if (!data.isSectionHeader) {
        const comment1Textarea = tr.querySelector('.inspection-comment1');
        const comment2Textarea = tr.querySelector('.inspection-comment2');
        
        const autoResize = (textarea) => {
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(24, textarea.scrollHeight) + 'px';
        };
        
        if (comment1Textarea) {
            autoResize(comment1Textarea);
            comment1Textarea.addEventListener('input', () => autoResize(comment1Textarea));
        }
        if (comment2Textarea) {
            autoResize(comment2Textarea);
            comment2Textarea.addEventListener('input', () => autoResize(comment2Textarea));
        }
    }
}

function addInspectionRow() {
    appendInspectionRow({section: "", comment1: "", code1: "", comment2: "", code2: "", isSectionHeader: false});
}

function addInspectionSection() {
    // Add as section header
    appendInspectionRow({section: "", comment1: "", code1: "", comment2: "", code2: "", isSectionHeader: true});
    // Add one empty data row after section header
    appendInspectionRow({section: "", comment1: "", code1: "", comment2: "", code2: "", isSectionHeader: false});
}

function saveInspectionReportCRUD() {
    const rows = Array.from(document.querySelectorAll("#inspectionReportCRUDBody tr"));
    const sheetData = [];
    
    // Add empty rows 1-5 (to match Excel structure)
    for (let i = 0; i < 5; i++) {
        sheetData.push(["", "", "", "", ""]);
    }
    
    // Add header row at Row 6: Sections, Comment, Code, Comment, Code
    sheetData.push(["Sections", "Comment", "Code", "Comment", "Code"]);
    
    // Process rows
    rows.forEach(row => {
        const isSectionHeader = row.dataset.isSectionHeader === "true";
        const section = row.querySelector(".inspection-section").value.trim();
        
        if (isSectionHeader) {
            // Section header row - just add section name
            if (section) {
                sheetData.push([section, "", "", "", ""]);
            }
        } else {
            const comment1 = row.querySelector(".inspection-comment1").value.trim();
            const code1 = row.querySelector(".inspection-code1").value.trim();
            const comment2 = row.querySelector(".inspection-comment2").value.trim();
            const code2 = row.querySelector(".inspection-code2").value.trim();
            
            // Only add row if there's at least section or some data
            if (section || comment1 || code1 || comment2 || code2) {
                sheetData.push([section, comment1, code1, comment2, code2]);
            }
        }
    });
    
    // Create new workbook with inspection report
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(sheetData);
    
    // Set column widths
    ws['!cols'] = [
        {wch: 40}, // Sections
        {wch: 15}, // Begin Code
        {wch: 30}, // Begin Comment
        {wch: 15}, // End Code
        {wch: 30}  // End Comment
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, "Inspection_Report");
    
    // Store the workbook
    inspectionReportData = wb;
    
    // Save to localStorage for persistence
    try {
        const wbBase64 = XLSX.write(wb, { type: 'base64', bookType: 'xlsx' });
        localStorage.setItem("inspectionReportData", wbBase64);
    } catch (e) {
        console.error("Error saving inspection report to localStorage:", e);
    }
    
    // Update the displayed inspection report
    const inspectionReportContainer = document.getElementById("inspectionReportContainer");
    if (inspectionReportContainer) {
        const html = XLSX.utils.sheet_to_html(ws, {id: "inspection-table", editable: false});
        if (html && html.trim().length > 0) {
            inspectionReportContainer.innerHTML = html;
            // Apply styling (reuse existing styling logic)
            const tables = inspectionReportContainer.querySelectorAll('table');
            tables.forEach(table => {
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.style.fontSize = '10px';
            });
        }
    }
    
    closeInspectionReportCRUD();
    const info = document.getElementById("combinedUploadInfo");
    if (info) {
        info.innerHTML = "‚úì Inspection Report saved. It will be included when you download Master Data or Current Lease.";
        info.style.color = "#059669";
    }
}

function closeInspectionReportCRUD() {
    document.getElementById("inspectionReportCRUDBackdrop").style.display = "none";
    document.getElementById("inspectionReportCRUDModal").style.display = "none";
}

// ====== TENANCY DATA MANAGER ======
let tenancyData = {
    leases: [],
    personalIds: [],
    images: [], // Will store images with propertyTag property
    communications: []
};

function openTenancyDataManager() {
    // Load data from localStorage
    loadTenancyData();
    
    console.log('Opening Tenancy Data Manager. Images loaded:', tenancyData.images ? tenancyData.images.length : 0);
    
    // Create property image tabs
    createPropertyImageTabs();
    
    // Show modal
    document.getElementById("tenancyDataBackdrop").style.display = "block";
    document.getElementById("tenancyDataModal").style.display = "flex";
    
    // Refresh current tab
    const activeTab = document.querySelector('.tenancy-tab-btn.active');
    if (activeTab) {
        switchTenancyTab(activeTab.dataset.tab);
    } else {
        switchTenancyTab('leases');
    }
}

function createPropertyImageTabs() {
    // Get all property tags from masterData
    const propertyTags = [];
    const map = masterData || {};
    const propertyKeys = Object.keys(map).filter(k => k.startsWith('Property_') && k.endsWith('_Tag'));
    
    propertyKeys.forEach(key => {
        const tag = map[key];
        if (tag && !propertyTags.includes(tag)) {
            propertyTags.push(tag);
        }
    });
    
    // Sort property tags
    propertyTags.sort();
    
    // Get main tabs container
    const mainTabsContainer = document.getElementById('tenancyMainTabs');
    if (!mainTabsContainer) return;
    
    // Remove existing property image tabs (those starting with 'images_')
    const existingPropertyTabs = mainTabsContainer.querySelectorAll('[data-tab^="images_"]');
    existingPropertyTabs.forEach(tab => tab.remove());
    
    // Remove existing property image tab content
    const existingPropertyContent = document.querySelectorAll('[id^="tenancyTabImages_"]');
    existingPropertyContent.forEach(content => content.remove());
    
    // Create tabs and content for each property
    propertyTags.forEach(tag => {
        // Create tab button
        const tabButton = document.createElement('button');
        tabButton.className = 'tenancy-tab-btn';
        tabButton.setAttribute('data-tab', `images_${tag}`);
        tabButton.setAttribute('onclick', `switchTenancyTab('images_${tag}')`);
        tabButton.style.cssText = 'padding: 10px 20px; border: none; background: #e5e7eb; color: #374151; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 500;';
        tabButton.textContent = `üè† Images - ${tag}`;
        mainTabsContainer.appendChild(tabButton);
        
        // Create tab content
        const tabContent = document.createElement('div');
        tabContent.id = `tenancyTabImages_${tag}`;
        tabContent.className = 'tenancy-tab-content';
        tabContent.style.cssText = 'display:none; flex: 1; overflow: hidden; min-height: 0; flex-direction: column;';
        
        // Upload area for this property (compact)
        const uploadArea = document.createElement('div');
        uploadArea.style.cssText = 'margin-bottom: 10px; padding: 8px 12px; background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; gap: 10px; flex-wrap: wrap;';
        uploadArea.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 200px;">
                <span style="font-size: 20px;">üì§</span>
                <div>
                    <span style="font-size: 13px; font-weight: 500; color: #374151;">Property: <strong style="color: #3b82f6;">${escapeHtml(tag)}</strong></span>
                    <span style="font-size: 11px; color: #6b7280; margin-left: 8px;">(JPG, PNG, GIF)</span>
                    <div id="storageInfo_${tag}" style="font-size: 10px; color: #6b7280; margin-top: 2px;"></div>
                </div>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="pdf-button" onclick="deleteAllPropertyImages('${escapeHtml(tag)}')" style="background:#dc2626; padding: 6px 12px; font-size: 12px; white-space: nowrap;" title="Delete all images for this property">üóëÔ∏è Delete All</button>
                <button class="pdf-button" onclick="removeDuplicateImages('${escapeHtml(tag)}')" style="background:#f59e0b; padding: 6px 12px; font-size: 12px; white-space: nowrap;" title="Remove duplicate images">üóëÔ∏è Remove Duplicates</button>
                <button class="pdf-button" onclick="document.getElementById('tenancyFileUpload_${tag}').click()" style="background:#3b82f6; padding: 6px 16px; font-size: 13px; white-space: nowrap;">Choose Images</button>
            </div>
            <input type="file" id="tenancyFileUpload_${tag}" multiple accept=".jpg,.jpeg,.png,.gif" style="display:none;" onchange="handlePropertyImageUpload(event, '${escapeHtml(tag)}')">
        `;
        tabContent.appendChild(uploadArea);
        
        // Update storage info
        setTimeout(() => updateStorageInfo(tag), 100);
        
        // Images grid container (takes remaining space)
        const imagesContainer = document.createElement('div');
        imagesContainer.id = `tenancyImagesContainer_${tag}`;
        imagesContainer.style.cssText = 'flex: 1; overflow-y: auto; overflow-x: hidden; padding: 15px; min-height: 0;';
        imagesContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9ca3af;">
                <div style="font-size: 48px; margin-bottom: 10px;">üè†</div>
                <p>No images for ${escapeHtml(tag)} yet. Upload your first image above!</p>
            </div>
        `;
        tabContent.appendChild(imagesContainer);
        
        // Insert before Communications tab content
        const communicationsTab = document.getElementById('tenancyTabCommunications');
        if (communicationsTab && communicationsTab.parentNode) {
            communicationsTab.parentNode.insertBefore(tabContent, communicationsTab);
        } else {
            // Find the last tab content and append after it
            const lastTabContent = document.querySelector('.tenancy-tab-content:last-of-type');
            if (lastTabContent && lastTabContent.parentNode) {
                lastTabContent.parentNode.appendChild(tabContent);
            }
        }
    });
}

function closeTenancyDataManager() {
    document.getElementById("tenancyDataBackdrop").style.display = "none";
    document.getElementById("tenancyDataModal").style.display = "none";
}

function switchTenancyTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tenancy-tab-content').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tenancy-tab-btn').forEach(btn => {
        btn.style.background = '#e5e7eb';
        btn.style.color = '#374151';
        btn.classList.remove('active');
    });
    
    // Show/hide upload area based on tab type
    const uploadArea = document.getElementById('tenancyUploadArea');
    if (uploadArea) {
        // Hide upload area for property image tabs (they have their own)
        if (tabName.startsWith('images_')) {
            uploadArea.style.display = 'none';
        } else {
            uploadArea.style.display = 'block';
        }
    }
    
    // Show selected tab - handle camelCase conversion and property image tabs
    let tabId = '';
    if (tabName.startsWith('images_')) {
        // Property image tab
        const propertyTag = tabName.replace('images_', '');
        tabId = `tenancyTabImages_${propertyTag}`;
    } else if (tabName === 'personalIds') {
        tabId = 'tenancyTabPersonalIds';
    } else {
        tabId = `tenancyTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`;
    }
    
    const tabContent = document.getElementById(tabId);
    const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
    
    if (tabContent) {
        tabContent.style.display = 'flex';
        tabContent.classList.add('active');
    }
    
    if (tabButton) {
        tabButton.style.background = '#3b82f6';
        tabButton.style.color = 'white';
        tabButton.classList.add('active');
    }
    
    // Refresh the tab content
    refreshTenancyTab(tabName);
}

function refreshTenancyTab(tabName) {
    console.log('refreshTenancyTab called with:', tabName);
    
    if (tabName.startsWith('images_')) {
        // Property image tab
        const propertyTag = tabName.replace('images_', '');
        renderPropertyImagesGrid(propertyTag);
        updateStorageInfo(propertyTag);
    } else {
        switch(tabName) {
            case 'leases':
                renderLeasesTable();
                break;
            case 'personalIds':
                renderPersonalIdsTable();
                break;
            case 'communications':
                renderCommunicationsTable();
                break;
        }
    }
}

function loadTenancyData() {
    try {
        const stored = localStorage.getItem('tenancyData');
        if (stored) {
            const loaded = JSON.parse(stored);
            // Restore data and convert base64 back to blob URLs for display
            tenancyData = {
                leases: loaded.leases || [],
                personalIds: loaded.personalIds || [],
                images: (loaded.images || []).map(item => {
                    // Images are already compressed and stored as base64
                    // Optionally create blob for download functionality
                    if (item.base64 && !item.file) {
                        try {
                            // Extract base64 data (remove data:image/...;base64, prefix if present)
                            let base64Data = item.base64;
                            if (base64Data.includes(',')) {
                                base64Data = base64Data.split(',')[1];
                            }
                            const byteCharacters = atob(base64Data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const mimeType = item.type || item.base64.match(/data:([^;]+)/)?.[1] || 'image/jpeg';
                            const blob = new Blob([byteArray], { type: mimeType });
                            item.file = blob; // Store blob for download
                        } catch (e) {
                            console.error('Error converting base64 to blob for', item.name, ':', e);
                            // Keep base64 even if blob conversion fails - we can use it directly
                        }
                    }
                    return item;
                }),
                communications: loaded.communications || []
            };
            console.log('Tenancy data loaded. Images:', tenancyData.images.length);
            const storageUsed = getStorageUsage();
            console.log('Storage used:', formatStorageSize(storageUsed));
            
            // Debug: Check first image if any
            if (tenancyData.images.length > 0) {
                const firstImg = tenancyData.images[0];
                const avgSize = tenancyData.images.reduce((sum, img) => sum + (img.sizeBytes || 0), 0) / tenancyData.images.length;
                console.log('First image sample:', {
                    name: firstImg.name,
                    hasFile: !!firstImg.file,
                    hasBase64: !!firstImg.base64,
                    sizeBytes: firstImg.sizeBytes || 0,
                    avgImageSize: formatStorageSize(avgSize)
                });
            }
        } else {
            console.log('No tenancy data found in localStorage');
        }
    } catch (e) {
        console.error('Error loading tenancy data:', e);
        tenancyData = { leases: [], personalIds: [], images: [], communications: [] };
    }
}

function saveTenancyData() {
    try {
        // Create a copy without File objects for storage (but keep file objects in memory)
        const dataToSave = {
            leases: tenancyData.leases.map(item => {
                const { file, ...rest } = item;
                return rest;
            }),
            personalIds: tenancyData.personalIds.map(item => {
                const { file, ...rest } = item;
                return rest;
            }),
            images: tenancyData.images.map(item => {
                // Only save base64, not file object
                const { file, ...rest } = item;
                return rest;
            }),
            communications: tenancyData.communications.map(item => {
                const { file, ...rest } = item;
                return rest;
            })
        };
        localStorage.setItem('tenancyData', JSON.stringify(dataToSave));
        console.log('Tenancy data saved successfully. Images:', dataToSave.images.length);
        // Note: File objects remain in memory (tenancyData) for immediate display
    } catch (e) {
        console.error('Error saving tenancy data:', e);
        // If storage quota exceeded, try to automatically clean up old files
        if (e.name === 'QuotaExceededError') {
            // Try to remove oldest images first (they take the most space)
            const totalItems = tenancyData.leases.length + tenancyData.personalIds.length + 
                             tenancyData.images.length + tenancyData.communications.length;
            
            if (totalItems > 10) {
                // Remove oldest 20% of images if we have many items
                const imagesToRemove = Math.max(1, Math.floor(tenancyData.images.length * 0.2));
                tenancyData.images.sort((a, b) => {
                    const dateA = new Date(a.added || 0);
                    const dateB = new Date(b.added || 0);
                    return dateA - dateB;
                });
                tenancyData.images.splice(0, imagesToRemove);
                
                // Try saving again
                try {
                    const dataToSave = {
                        leases: tenancyData.leases.map(item => {
                            const { file, ...rest } = item;
                            return rest;
                        }),
                        personalIds: tenancyData.personalIds.map(item => {
                            const { file, ...rest } = item;
                            return rest;
                        }),
                        images: tenancyData.images.map(item => {
                            const { file, ...rest } = item;
                            return rest;
                        }),
                        communications: tenancyData.communications.map(item => {
                            const { file, ...rest } = item;
                            return rest;
                        })
                    };
                    localStorage.setItem('tenancyData', JSON.stringify(dataToSave));
                    if (typeof showUploadNotification === 'function') {
                        showUploadNotification(`‚ö†Ô∏è Storage full. Automatically removed ${imagesToRemove} old image(s) to make space.`, 'warning');
                    }
                    return; // Success after cleanup
                } catch (e2) {
                    // Still failed, show notification
                    if (typeof showUploadNotification === 'function') {
                        showUploadNotification('‚ö†Ô∏è Storage quota exceeded. Please delete some old files manually.', 'warning');
                    } else {
                        console.warn('Storage quota exceeded. Please delete some old files.');
                    }
                }
            } else {
                // Not many items, just show notification
                if (typeof showUploadNotification === 'function') {
                    showUploadNotification('‚ö†Ô∏è Storage quota exceeded. Please delete some old files.', 'warning');
                } else {
                    console.warn('Storage quota exceeded. Please delete some old files.');
                }
            }
        } else {
            console.error('Error saving data:', e);
        }
    }
}

function handleTenancyFileUpload(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) {
        console.log('No files selected');
        return;
    }
    
    console.log('Files selected:', files.length);
    
    const activeTab = document.querySelector('.tenancy-tab-btn.active');
    const tabName = activeTab ? activeTab.dataset.tab : 'leases';
    
    console.log('Active tab:', tabName);
    
    // Estimate file sizes (images will be compressed, others won't)
    const imageFiles = files.filter(f => isImageFile(f.name));
    const nonImageFiles = files.filter(f => !isImageFile(f.name));
    
    // Show upload notification
    const hasImages = imageFiles.length > 0;
    showUploadNotification(`${hasImages ? 'Compressing and ' : ''}Uploading ${files.length} file(s)...`);
    
    // Process files one by one with async conversion to base64
    let processedCount = 0;
    let uploadedCount = 0;
    let totalOriginalSize = 0;
    let totalCompressedSize = 0;
    const uploadedFileIds = []; // Track uploaded file IDs for error cleanup
    
    files.forEach((file, index) => {
        totalOriginalSize += file.size;
        const isImage = isImageFile(file.name);
        const fileId = Date.now() + Math.random() + index;
        uploadedFileIds.push(fileId);
        
        // Process images with compression, others without
        if (isImage && (tabName === 'personalIds' || tabName === 'leases' || tabName === 'communications')) {
            // Compress images for all categories
            compressImage(file, 800, 600, 0.6).then(result => {
                const fileData = {
                    id: fileId,
                    name: file.name,
                    type: 'image/jpeg', // Always save as JPEG after compression
                    size: formatFileSize(result.compressedSize),
                    sizeBytes: result.compressedSize,
                    originalSizeBytes: result.originalSize,
                    added: new Date().toLocaleString(),
                    base64: result.base64
                };
                
                // Determine category
                if (tabName === 'personalIds') {
                    fileData.category = 'personalIds';
                    fileData.tenantName = '';
                    tenancyData.personalIds.push(fileData);
                } else if (tabName === 'communications') {
                    fileData.category = 'communications';
                    fileData.commType = '';
                    fileData.recipient = '';
                    tenancyData.communications.push(fileData);
                } else {
                    fileData.category = 'leases';
                    fileData.leaseId = '';
                    tenancyData.leases.push(fileData);
                }
                
                totalCompressedSize += result.compressedSize;
                uploadedCount++;
                processedCount++;
                
                console.log(`File ${index + 1} compressed: ${file.name} - ${result.compressionRatio}% reduction`);
                
                // Save and refresh when all files are processed
                if (processedCount === files.length) {
                    try {
                        saveTenancyData();
                        refreshTenancyTab(tabName);
                        const savedSpace = hasImages ? ((1 - totalCompressedSize / totalOriginalSize) * 100).toFixed(1) : 0;
                        const storageUsed = formatStorageSize(getStorageUsage());
                        const message = hasImages 
                            ? `‚úì Uploaded ${uploadedCount} file(s)! Saved ${savedSpace}% space. Storage: ${storageUsed}`
                            : `‚úì Successfully uploaded ${uploadedCount} file(s)! Storage: ${storageUsed}`;
                        showUploadNotification(message, 'success');
                        
                        setTimeout(() => {
                            hideUploadNotification();
                        }, 4000);
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            // Remove the files we just added
                            if (tabName === 'personalIds') {
                                tenancyData.personalIds = tenancyData.personalIds.filter(item => !uploadedFileIds.includes(item.id));
                            } else if (tabName === 'communications') {
                                tenancyData.communications = tenancyData.communications.filter(item => !uploadedFileIds.includes(item.id));
                            } else {
                                tenancyData.leases = tenancyData.leases.filter(item => !uploadedFileIds.includes(item.id));
                            }
                            showUploadNotification(`‚ö†Ô∏è Storage quota exceeded! Please delete some old files. Current storage: ${formatStorageSize(getStorageUsage())}`, 'warning');
                            setTimeout(() => hideUploadNotification(), 5000);
                        } else {
                            showUploadNotification('‚ö†Ô∏è Error saving files: ' + e.message, 'warning');
                            setTimeout(() => hideUploadNotification(), 3000);
                        }
                    }
                }
            }).catch(error => {
                console.error('Error compressing file:', file.name, error);
                processedCount++;
                if (processedCount === files.length) {
                    saveTenancyData();
                    refreshTenancyTab(tabName);
                    showUploadNotification('‚ö† Some files may not have uploaded correctly', 'warning');
                    setTimeout(() => {
                        hideUploadNotification();
                    }, 3000);
                }
            });
        } else {
            // Non-image files - store as-is (PDFs, DOC, etc.)
            const fileData = {
                id: fileId,
                name: file.name,
                type: file.type || getFileType(file.name),
                size: formatFileSize(file.size),
                sizeBytes: file.size,
                added: new Date().toLocaleString(),
                base64: null,
                file: file
            };
            
            // Determine category
            if (tabName === 'personalIds') {
                fileData.category = 'personalIds';
                fileData.tenantName = '';
                tenancyData.personalIds.push(fileData);
            } else if (tabName === 'communications') {
                fileData.category = 'communications';
                fileData.commType = '';
                fileData.recipient = '';
                tenancyData.communications.push(fileData);
            } else {
                fileData.category = 'leases';
                fileData.leaseId = '';
                tenancyData.leases.push(fileData);
            }
            
            // Convert to base64 for storage
            const reader = new FileReader();
            reader.onload = function(e) {
                fileData.base64 = e.target.result;
                totalCompressedSize += file.size * 1.33; // Approximate with base64 overhead
                console.log('File converted to base64:', file.name, 'Base64 length:', fileData.base64 ? fileData.base64.length : 0);
                uploadedCount++;
                processedCount++;
                
                // Save and refresh when all files are processed
                if (processedCount === files.length) {
                    try {
                        saveTenancyData();
                        refreshTenancyTab(tabName);
                        const storageUsed = formatStorageSize(getStorageUsage());
                        showUploadNotification(`‚úì Successfully uploaded ${uploadedCount} file(s)! Storage: ${storageUsed}`, 'success');
                        
                        setTimeout(() => {
                            hideUploadNotification();
                        }, 4000);
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            // Remove the files we just added
                            if (tabName === 'personalIds') {
                                tenancyData.personalIds = tenancyData.personalIds.filter(item => !uploadedFileIds.includes(item.id));
                            } else if (tabName === 'communications') {
                                tenancyData.communications = tenancyData.communications.filter(item => !uploadedFileIds.includes(item.id));
                            } else {
                                tenancyData.leases = tenancyData.leases.filter(item => !uploadedFileIds.includes(item.id));
                            }
                            showUploadNotification(`‚ö†Ô∏è Storage quota exceeded! Please delete some old files. Current storage: ${formatStorageSize(getStorageUsage())}`, 'warning');
                            setTimeout(() => hideUploadNotification(), 5000);
                        } else {
                            showUploadNotification('‚ö†Ô∏è Error saving files: ' + e.message, 'warning');
                            setTimeout(() => hideUploadNotification(), 3000);
                        }
                    }
                }
            };
            reader.onerror = function(error) {
                console.error('Error reading file:', file.name, error);
                processedCount++;
                if (processedCount === files.length) {
                    saveTenancyData();
                    refreshTenancyTab(tabName);
                    showUploadNotification('‚ö† Some files may not have uploaded correctly', 'warning');
                    setTimeout(() => {
                        hideUploadNotification();
                    }, 3000);
                }
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Refresh immediately (before compression/conversion completes)
    refreshTenancyTab(tabName);
    
    // Clear file input
    event.target.value = '';
}

function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.6) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Calculate new dimensions
                if (width > height) {
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to base64 with compression
                const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                const originalSize = file.size;
                const compressedSize = Math.round((compressedBase64.length - 22) * 0.75); // Approximate size
                const compressionRatio = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                
                resolve({
                    base64: compressedBase64,
                    originalSize: originalSize,
                    compressedSize: compressedSize,
                    compressionRatio: compressionRatio
                });
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function getStorageUsage() {
    let totalSize = 0;
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key) {
            const value = localStorage.getItem(key);
            totalSize += value ? value.length : 0;
        }
    }
    return totalSize;
}

function formatStorageSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function updateStorageInfo(propertyTag) {
    const storageInfoEl = document.getElementById(`storageInfo_${propertyTag}`);
    if (!storageInfoEl) return;
    
    const storageUsed = getStorageUsage();
    const maxStorage = 5 * 1024 * 1024; // 5MB typical limit
    const percentUsed = ((storageUsed / maxStorage) * 100).toFixed(1);
    const propertyImages = tenancyData.images.filter(img => (img.propertyTag || '') === propertyTag);
    const propertySize = propertyImages.reduce((sum, img) => sum + (img.sizeBytes || 0), 0);
    
    let color = '#10b981'; // green
    if (percentUsed > 80) color = '#ef4444'; // red
    else if (percentUsed > 60) color = '#f59e0b'; // orange
    
    storageInfoEl.innerHTML = `
        Storage: <strong style="color: ${color};">${formatStorageSize(storageUsed)} / ${formatStorageSize(maxStorage)} (${percentUsed}%)</strong> | 
        This property: ${propertyImages.length} images (${formatStorageSize(propertySize)})
    `;
}

function handlePropertyImageUpload(event, propertyTag) {
    const files = Array.from(event.target.files);
    if (files.length === 0) {
        console.log('No files selected');
        return;
    }
    
    // Filter only image files
    const imageFiles = files.filter(f => isImageFile(f.name));
    if (imageFiles.length === 0) {
        alert('Please select image files only (JPG, PNG, GIF)');
        return;
    }
    
    console.log('Images selected for property:', propertyTag, 'Count:', imageFiles.length);
    
    // Show upload notification
    showUploadNotification(`Compressing and uploading ${imageFiles.length} image(s) for ${propertyTag}...`);
    
    // Process files one by one with compression
    let processedCount = 0;
    let totalOriginalSize = 0;
    let totalCompressedSize = 0;
    
    imageFiles.forEach((file, index) => {
        totalOriginalSize += file.size;
        
        compressImage(file, 800, 600, 0.6).then(result => {
            const fileData = {
                id: Date.now() + Math.random() + index,
                name: file.name,
                type: 'image/jpeg', // Always save as JPEG after compression
                size: formatFileSize(result.compressedSize),
                sizeBytes: result.compressedSize,
                originalSizeBytes: result.originalSize,
                added: new Date().toLocaleString(),
                base64: result.base64,
                propertyTag: propertyTag
            };
            
            tenancyData.images.push(fileData);
            totalCompressedSize += result.compressedSize;
            processedCount++;
            
            console.log(`Image ${index + 1} compressed: ${file.name} - ${result.compressionRatio}% reduction`);
            
            // Save and refresh when all files are processed
            if (processedCount === imageFiles.length) {
                try {
                    saveTenancyData();
                    renderPropertyImagesGrid(propertyTag);
                    updateStorageInfo(propertyTag);
                    const savedSpace = ((1 - totalCompressedSize / totalOriginalSize) * 100).toFixed(1);
                    const storageUsed = formatStorageSize(getStorageUsage());
                    showUploadNotification(`‚úì Uploaded ${imageFiles.length} image(s)! Saved ${savedSpace}% space. Storage: ${storageUsed}`, 'success');
                    
                    // Auto-hide notification after 4 seconds
                    setTimeout(() => {
                        hideUploadNotification();
                    }, 4000);
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        // Remove the images we just added
                        tenancyData.images = tenancyData.images.filter(img => !imageFiles.some((f, i) => img.id === Date.now() + Math.random() + i));
                        showUploadNotification(`‚ö†Ô∏è Storage quota exceeded! Please delete some old images. Current storage: ${formatStorageSize(getStorageUsage())}`, 'warning');
                        setTimeout(() => hideUploadNotification(), 5000);
                    } else {
                        showUploadNotification('‚ö†Ô∏è Error saving images: ' + e.message, 'warning');
                        setTimeout(() => hideUploadNotification(), 3000);
                    }
                }
            }
        }).catch(error => {
            console.error('Error compressing image:', file.name, error);
            processedCount++;
            if (processedCount === imageFiles.length) {
                saveTenancyData();
                renderPropertyImagesGrid(propertyTag);
                showUploadNotification('‚ö† Some images may not have uploaded correctly', 'warning');
                setTimeout(() => {
                    hideUploadNotification();
                }, 3000);
            }
        });
    });
    
    // Refresh immediately (before compression completes)
    renderPropertyImagesGrid(propertyTag);
    
    // Clear file input
    event.target.value = '';
}

function showUploadNotification(message, type = 'info') {
    let notification = document.getElementById('uploadNotification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'uploadNotification';
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #3b82f6; color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; font-weight: 500; max-width: 300px;';
        document.body.appendChild(notification);
    }
    
    if (type === 'success') {
        notification.style.background = '#10b981';
    } else if (type === 'warning') {
        notification.style.background = '#f59e0b';
    } else {
        notification.style.background = '#3b82f6';
    }
    
    notification.textContent = message;
    notification.style.display = 'block';
}

function hideUploadNotification() {
    const notification = document.getElementById('uploadNotification');
    if (notification) {
        notification.style.display = 'none';
    }
}

function isImageFile(filename) {
    const imageExts = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    return imageExts.some(ext => filename.toLowerCase().endsWith(ext));
}

function getFileType(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const types = {
        'pdf': 'PDF',
        'doc': 'DOC',
        'docx': 'DOCX',
        'xls': 'XLS',
        'xlsx': 'XLSX',
        'jpg': 'JPG',
        'jpeg': 'JPEG',
        'png': 'PNG',
        'gif': 'GIF'
    };
    return types[ext] || ext.toUpperCase();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function getFileTypeDisplay(fileName, mimeType) {
    if (!fileName && !mimeType) return 'Unknown';
    const name = (fileName || '').toLowerCase();
    const type = (mimeType || '').toLowerCase();
    
    if (name.endsWith('.pdf') || type.includes('pdf')) return 'PDF Document';
    if (name.endsWith('.doc') || name.endsWith('.docx') || type.includes('word') || type.includes('document')) return 'Word Document';
    if (name.endsWith('.xls') || name.endsWith('.xlsx') || type.includes('excel') || type.includes('spreadsheet')) return 'Excel Spreadsheet';
    if (name.endsWith('.txt') || type.includes('text')) return 'Text File';
    if (name.endsWith('.jpg') || name.endsWith('.jpeg') || type.includes('jpeg')) return 'JPEG Image';
    if (name.endsWith('.png') || type.includes('png')) return 'PNG Image';
    if (name.endsWith('.gif') || type.includes('gif')) return 'GIF Image';
    
    return 'Document';
}

function renderLeasesTable() {
    const container = document.getElementById('tenancyLeasesContainer');
    if (!container) return;
    
    // Update document count
    const countElement = document.getElementById('tenancyDocumentsCount');
    if (countElement) {
        countElement.textContent = tenancyData.leases.length;
    }
    
    if (tenancyData.leases.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9ca3af; width: 100%;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
                <p>No lease documents yet. Upload your first document above!</p>
            </div>
        `;
        return;
    }
    
    const rowsHTML = tenancyData.leases.map((item, index) => {
        const itemId = String(item.id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const itemName = escapeHtml(item.name);
        const itemSize = escapeHtml(item.size);
        const itemTypeDisplay = getFileTypeDisplay(item.name, item.type);
        const itemAdded = escapeHtml(item.added || new Date().toLocaleString());
        const isFirst = index === 0;
        const isLast = index === tenancyData.leases.length - 1;
        
        return `
            <tr style="border-bottom: 1px solid #e5e7eb; background: #fff;" onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='#fff';">
                <td style="padding: 12px 15px; font-size: 14px; color: #111827; font-weight: 500;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px;">üìÑ</span>
                        <span style="cursor: pointer; text-decoration: underline; color: #3b82f6;" onclick="previewTenancyFile('leases', '${itemId}')" title="${itemName}">${itemName}</span>
                    </div>
                </td>
                <td style="padding: 12px 15px; font-size: 14px; color: #374151;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">üìÑ</span>
                        <span>${itemTypeDisplay}</span>
                    </div>
                </td>
                <td style="padding: 12px 15px; font-size: 14px; color: #374151;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">üõçÔ∏è</span>
                        <span>${itemSize}</span>
                    </div>
                </td>
                <td style="padding: 12px 15px; font-size: 14px; color: #374151;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">üìÖ</span>
                        <span>${itemAdded}</span>
                    </div>
                </td>
                <td style="padding: 12px 15px; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                        <button onclick="downloadTenancyFile('leases', '${itemId}')" style="background: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;" title="Download">‚¨áÔ∏è</button>
                        <button onclick="moveLeaseItem('${itemId}', 'up')" style="background: ${isFirst ? '#d1d5db' : '#10b981'}; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: ${isFirst ? 'not-allowed' : 'pointer'}; font-size: 16px; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; opacity: ${isFirst ? '0.5' : '1'};" title="Move Up" ${isFirst ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                        <button onclick="moveLeaseItem('${itemId}', 'down')" style="background: ${isLast ? '#d1d5db' : '#10b981'}; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: ${isLast ? 'not-allowed' : 'pointer'}; font-size: 16px; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; opacity: ${isLast ? '0.5' : '1'};" title="Move Down" ${isLast ? 'disabled' : ''}>‚¨áÔ∏è</button>
                        <button onclick="deleteTenancyItem('leases', '${itemId}')" style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;" title="Delete">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="padding: 0; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                        <th style="padding: 12px 15px; text-align: left; font-size: 14px; font-weight: 600;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">üìÑ</span>
                                <span>NAME</span>
                            </div>
                        </th>
                        <th style="padding: 12px 15px; text-align: left; font-size: 14px; font-weight: 600;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">üìÑ</span>
                                <span>TYPE</span>
                            </div>
                        </th>
                        <th style="padding: 12px 15px; text-align: left; font-size: 14px; font-weight: 600;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">üõçÔ∏è</span>
                                <span>SIZE</span>
                            </div>
                        </th>
                        <th style="padding: 12px 15px; text-align: left; font-size: 14px; font-weight: 600;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">üìÖ</span>
                                <span>ADDED</span>
                            </div>
                        </th>
                        <th style="padding: 12px 15px; text-align: center; font-size: 14px; font-weight: 600;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span style="font-size: 16px;">‚öôÔ∏è</span>
                                <span>ACTIONS</span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    ${rowsHTML}
                </tbody>
            </table>
        </div>
    `;
}

function renderPersonalIdsTable() {
    const container = document.getElementById('tenancyPersonalIdsContainer');
    if (!container) return;
    
    if (tenancyData.personalIds.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9ca3af; width: 100%;">
                <div style="font-size: 48px; margin-bottom: 10px;">üÜî</div>
                <p>No personal ID documents yet. Upload your first document above!</p>
            </div>
        `;
        return;
    }
    
    const filesHTML = tenancyData.personalIds.map(item => {
        const itemId = String(item.id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const itemName = escapeHtml(item.name);
        const itemSize = escapeHtml(item.size);
        const itemType = escapeHtml(item.type || '');
        const itemAdded = escapeHtml(item.added || '');
        const itemTenantName = escapeHtml(item.tenantName || '');
        const isImage = isImageFile(item.name);
        
        // Get preview URL
        let previewUrl = '';
        if (item.file && (item.file instanceof Blob || item.file instanceof File)) {
            previewUrl = URL.createObjectURL(item.file);
        } else if (item.base64) {
            previewUrl = item.base64;
        }
        
        const safePreviewUrl = previewUrl.replace(/'/g, "&#39;").replace(/"/g, '&quot;');
        
        // Create preview thumbnail
        let previewHTML = '';
        if (isImage && previewUrl) {
            previewHTML = `<img src="${safePreviewUrl}" alt="${itemName}" style="width: 100%; height: 100%; object-fit: cover; display: block;">`;
        } else if (item.type && item.type.toLowerCase().includes('pdf')) {
            previewHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #ef4444; color: white; font-size: 48px;">üìÑ</div>`;
        } else {
            previewHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #3b82f6; color: white; font-size: 48px;">üÜî</div>`;
        }
        
        return `
            <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                <div style="position: relative; margin-bottom: 10px; height: 180px; background: #f3f4f6; border-radius: 8px; overflow: hidden; cursor: pointer;" onclick="previewTenancyFile('personalIds', '${itemId}')">
                    ${previewHTML}
                </div>
                <div style="font-size: 13px; color: #374151; font-weight: 500; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${itemName}">${itemName}</div>
                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 5px;">${itemType} ‚Ä¢ ${itemSize}</div>
                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 10px;">${itemAdded}</div>
                <input type="text" value="${itemTenantName}" placeholder="Tenant Name" onchange="updateTenancyItem('personalIds', '${itemId}', 'tenantName', this.value)" style="width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                <div style="display: flex; gap: 5px;">
                    <button class="pdf-button" onclick="event.stopPropagation(); downloadTenancyFile('personalIds', '${itemId}')" style="background:#3b82f6; padding:6px 12px; font-size:12px; flex: 1; border-radius: 6px;">‚¨áÔ∏è</button>
                    <button class="pdf-button" onclick="event.stopPropagation(); deleteTenancyItem('personalIds', '${itemId}')" style="background:#ef4444; padding:6px 12px; font-size:12px; border-radius: 6px;">üóë</button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
            ${filesHTML}
        </div>
    `;
}

function renderPropertyImagesGrid(propertyTag) {
    const container = document.getElementById(`tenancyImagesContainer_${propertyTag}`);
    if (!container) {
        console.error('Image container not found for property:', propertyTag);
        return;
    }
    
    // Filter images by property tag
    const filteredImages = (tenancyData.images || []).filter(img => (img.propertyTag || '') === propertyTag);
    
    console.log('Rendering images grid for property:', propertyTag, 'Total images:', filteredImages.length);
    
    if (filteredImages.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9ca3af; width: 100%;">
                <div style="font-size: 48px; margin-bottom: 10px;">üè†</div>
                <p>No images for ${escapeHtml(propertyTag)} yet. Upload your first image above!</p>
            </div>
        `;
        return;
    }
    
    // Render images in large grid with big icons
    const imagesHTML = filteredImages.map((item, idx) => {
        let imageUrl = '';
        try {
            // Priority: file object > base64 > placeholder
            if (item.file) {
                // Check if it's a Blob or File object
                if (item.file instanceof Blob || item.file instanceof File) {
                    imageUrl = URL.createObjectURL(item.file);
                } else {
                    // If it's not a proper Blob, try base64
                    if (item.base64) {
                        imageUrl = item.base64;
                    }
                }
            } else if (item.base64) {
                // Use base64 directly if no file object
                imageUrl = item.base64;
            } else {
                console.warn('No image source for item:', item.name, 'Item data:', item);
                imageUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlPC90ZXh0Pjwvc3ZnPg==';
            }
            
            // Ensure we have a valid URL
            if (!imageUrl || imageUrl === '#') {
                console.warn('Invalid image URL for item:', item.name);
                imageUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlPC90ZXh0Pjwvc3ZnPg==';
            }
        } catch (e) {
            console.error('Error creating image URL:', e, item);
            imageUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlPC90ZXh0Pjwvc3ZnPg==';
        }
        
        const itemId = String(item.id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const itemName = escapeHtml(item.name);
        const itemSize = escapeHtml(item.size);
        
        // Escape imageUrl for use in HTML attribute
        const safeImageUrl = imageUrl.replace(/'/g, "&#39;").replace(/"/g, '&quot;');
        
        return `
            <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                <div style="position: relative; margin-bottom: 10px; height: 180px; background: #f3f4f6; border-radius: 8px; overflow: hidden;">
                    <img src="${safeImageUrl}" alt="${itemName}" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer; display: block;" onclick="viewImageFullscreen('${itemId}')" onerror="console.error('Image failed to load:', '${itemName}'); this.style.display='none'; this.parentElement.innerHTML='<div style=display:flex;align-items:center;justify-content:center;height:100%;color:#9ca3af;>Image Error</div>';">
                </div>
                <div style="font-size: 13px; color: #374151; font-weight: 500; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${itemName}">${itemName}</div>
                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 10px;">${itemSize}</div>
                <div style="display: flex; gap: 5px;">
                    <button class="pdf-button" onclick="downloadTenancyFile('images', '${itemId}')" style="background:#3b82f6; padding:6px 12px; font-size:12px; flex: 1; border-radius: 6px;">‚¨áÔ∏è</button>
                    <button class="pdf-button" onclick="deleteTenancyItem('images', '${itemId}')" style="background:#ef4444; padding:6px 12px; font-size:12px; border-radius: 6px;">üóë</button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px;">
            ${imagesHTML}
        </div>
    `;
    
    console.log('Images grid rendered with', filteredImages.length, 'images for property:', propertyTag);
}

function viewImageFullscreen(imageId) {
    const item = tenancyData.images.find(i => i.id == imageId);
    if (!item) return;
    
    // Get all images for the same property to enable navigation
    const propertyTag = item.propertyTag || '';
    const propertyImages = tenancyData.images.filter(img => (img.propertyTag || '') === propertyTag);
    const currentIndex = propertyImages.findIndex(img => img.id == imageId);
    
    if (currentIndex === -1) {
        alert('Image not found');
        return;
    }
    
    let currentImageIndex = currentIndex;
    let currentImageUrl = '';
    let currentShouldRevoke = false;
    let currentItem = item;
    
    const modal = document.createElement('div');
    modal.id = 'fullscreenImageModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
    
    // Function to get image URL
    const getImageUrl = (imgItem) => {
        let url = '';
        let shouldRevoke = false;
        if (imgItem.file) {
            url = URL.createObjectURL(imgItem.file);
            shouldRevoke = true;
        } else if (imgItem.base64) {
            url = imgItem.base64;
        }
        return { url, shouldRevoke };
    };
    
    // Function to update displayed image
    const updateImage = () => {
        currentItem = propertyImages[currentImageIndex];
        const { url, shouldRevoke } = getImageUrl(currentItem);
        
        // Revoke old URL if needed
        if (currentShouldRevoke && currentImageUrl.startsWith('blob:')) {
            URL.revokeObjectURL(currentImageUrl);
        }
        
        currentImageUrl = url;
        currentShouldRevoke = shouldRevoke;
        
        img.src = currentImageUrl;
        img.alt = currentItem.name || 'Fullscreen image';
        imgName.textContent = `${currentImageIndex + 1} / ${propertyImages.length} - ${currentItem.name || ''}`;
        
        // Update button states
        prevBtn.style.opacity = currentImageIndex === 0 ? '0.3' : '1';
        prevBtn.style.cursor = currentImageIndex === 0 ? 'not-allowed' : 'pointer';
        nextBtn.style.opacity = currentImageIndex === propertyImages.length - 1 ? '0.3' : '1';
        nextBtn.style.cursor = currentImageIndex === propertyImages.length - 1 ? 'not-allowed' : 'pointer';
    };
    
    // Navigation functions
    const showPrevious = (e) => {
        if (e) e.stopPropagation();
        if (currentImageIndex > 0) {
            currentImageIndex--;
            updateImage();
        }
    };
    
    const showNext = (e) => {
        if (e) e.stopPropagation();
        if (currentImageIndex < propertyImages.length - 1) {
            currentImageIndex++;
            updateImage();
        }
    };
    
    // Close function
    const closeModal = () => {
        if (document.body.contains(modal)) {
            document.body.removeChild(modal);
        }
        if (currentShouldRevoke && currentImageUrl.startsWith('blob:')) {
            URL.revokeObjectURL(currentImageUrl);
        }
        // Remove key listener
        document.removeEventListener('keydown', keyHandler);
    };
    
    // Keyboard handler
    const keyHandler = (e) => {
        if (e.key === 'Escape' || e.keyCode === 27) {
            closeModal();
        } else if (e.key === 'ArrowLeft' || e.keyCode === 37) {
            showPrevious(e);
        } else if (e.key === 'ArrowRight' || e.keyCode === 39) {
            showNext(e);
        }
    };
    
    // Close on background click
    modal.onclick = (e) => {
        if (e.target === modal) {
            closeModal();
        }
    };
    
    // Add key listener
    document.addEventListener('keydown', keyHandler);
    
    // Initialize image URL
    const { url, shouldRevoke } = getImageUrl(currentItem);
    currentImageUrl = url;
    currentShouldRevoke = shouldRevoke;
    
    // Create close button
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '‚úï';
    closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); color: #000; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s;';
    closeBtn.onmouseover = () => {
        closeBtn.style.background = '#fff';
        closeBtn.style.transform = 'scale(1.1)';
    };
    closeBtn.onmouseout = () => {
        closeBtn.style.background = 'rgba(255,255,255,0.9)';
        closeBtn.style.transform = 'scale(1)';
    };
    closeBtn.onclick = (e) => {
        e.stopPropagation();
        closeModal();
    };
    
    // Create previous button
    const prevBtn = document.createElement('button');
    prevBtn.innerHTML = '‚Äπ';
    prevBtn.style.cssText = 'position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); color: #000; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 36px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s; line-height: 1;';
    prevBtn.onmouseover = () => {
        if (currentImageIndex > 0) {
            prevBtn.style.background = '#fff';
            prevBtn.style.transform = 'translateY(-50%) scale(1.1)';
        }
    };
    prevBtn.onmouseout = () => {
        prevBtn.style.background = 'rgba(255,255,255,0.9)';
        prevBtn.style.transform = 'translateY(-50%) scale(1)';
    };
    prevBtn.onclick = showPrevious;
    if (currentImageIndex === 0) {
        prevBtn.style.opacity = '0.3';
        prevBtn.style.cursor = 'not-allowed';
    }
    
    // Create next button
    const nextBtn = document.createElement('button');
    nextBtn.innerHTML = '‚Ä∫';
    nextBtn.style.cssText = 'position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); color: #000; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 36px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s; line-height: 1;';
    nextBtn.onmouseover = () => {
        if (currentImageIndex < propertyImages.length - 1) {
            nextBtn.style.background = '#fff';
            nextBtn.style.transform = 'translateY(-50%) scale(1.1)';
        }
    };
    nextBtn.onmouseout = () => {
        nextBtn.style.background = 'rgba(255,255,255,0.9)';
        nextBtn.style.transform = 'translateY(-50%) scale(1)';
    };
    nextBtn.onclick = showNext;
    if (currentImageIndex === propertyImages.length - 1) {
        nextBtn.style.opacity = '0.3';
        nextBtn.style.cursor = 'not-allowed';
    }
    
    // Create image container
    const imgContainer = document.createElement('div');
    imgContainer.style.cssText = 'position: relative; max-width: 90vw; max-height: 90vh; display: flex; align-items: center; justify-content: center;';
    imgContainer.onclick = (e) => e.stopPropagation();
    
    // Create image
    const img = document.createElement('img');
    img.src = currentImageUrl;
    img.style.cssText = 'max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); transition: opacity 0.3s;';
    img.alt = currentItem.name || 'Fullscreen image';
    
    // Add image name and counter below image
    const imgName = document.createElement('div');
    imgName.textContent = `${currentImageIndex + 1} / ${propertyImages.length} - ${currentItem.name || ''}`;
    imgName.style.cssText = 'position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%); color: white; font-size: 14px; text-align: center; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 4px; white-space: nowrap; max-width: 90vw; overflow: hidden; text-overflow: ellipsis;';
    
    imgContainer.appendChild(img);
    imgContainer.appendChild(imgName);
    modal.appendChild(closeBtn);
    modal.appendChild(prevBtn);
    modal.appendChild(nextBtn);
    modal.appendChild(imgContainer);
    document.body.appendChild(modal);
}

function renderCommunicationsTable() {
    const container = document.getElementById('tenancyCommunicationsContainer');
    if (!container) return;
    
    if (tenancyData.communications.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9ca3af; width: 100%;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìß</div>
                <p>No communications yet. Upload your first document above!</p>
            </div>
        `;
        return;
    }
    
    const filesHTML = tenancyData.communications.map(item => {
        const itemId = String(item.id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const itemName = escapeHtml(item.name);
        const itemSize = escapeHtml(item.size);
        const itemType = escapeHtml(item.type || '');
        const itemAdded = escapeHtml(item.added || '');
        const isImage = isImageFile(item.name);
        
        // Get preview URL
        let previewUrl = '';
        if (item.file && (item.file instanceof Blob || item.file instanceof File)) {
            previewUrl = URL.createObjectURL(item.file);
        } else if (item.base64) {
            previewUrl = item.base64;
        }
        
        const safePreviewUrl = previewUrl.replace(/'/g, "&#39;").replace(/"/g, '&quot;');
        
        // Create preview thumbnail
        let previewHTML = '';
        if (isImage && previewUrl) {
            previewHTML = `<img src="${safePreviewUrl}" alt="${itemName}" style="width: 100%; height: 100%; object-fit: cover; display: block;">`;
        } else if (item.type && item.type.toLowerCase().includes('pdf')) {
            previewHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #ef4444; color: white; font-size: 48px;">üìÑ</div>`;
        } else {
            previewHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #8b5cf6; color: white; font-size: 48px;">üìß</div>`;
        }
        
        return `
            <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                <div style="position: relative; margin-bottom: 10px; height: 180px; background: #f3f4f6; border-radius: 8px; overflow: hidden; cursor: pointer;" onclick="previewTenancyFile('communications', '${itemId}')">
                    ${previewHTML}
                </div>
                <div style="font-size: 13px; color: #374151; font-weight: 500; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${itemName}">${itemName}</div>
                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 5px;">${itemType} ‚Ä¢ ${itemSize}</div>
                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 10px;">${itemAdded}</div>
                <div style="display: flex; gap: 5px;">
                    <button class="pdf-button" onclick="event.stopPropagation(); downloadTenancyFile('communications', '${itemId}')" style="background:#3b82f6; padding:6px 12px; font-size:12px; flex: 1; border-radius: 6px;">‚¨áÔ∏è</button>
                    <button class="pdf-button" onclick="event.stopPropagation(); deleteTenancyItem('communications', '${itemId}')" style="background:#ef4444; padding:6px 12px; font-size:12px; border-radius: 6px;">üóë</button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
            ${filesHTML}
        </div>
    `;
}

function previewTenancyFile(category, fileId) {
    const item = tenancyData[category].find(i => i.id == fileId);
    if (!item) return;
    
    // Get all files in the same category for navigation
    const categoryFiles = (tenancyData[category] || []).filter(f => {
        // Only include files that can be previewed (images or PDFs)
        return isImageFile(f.name) || (f.type && f.type.toLowerCase().includes('pdf'));
    });
    const currentIndex = categoryFiles.findIndex(f => f.id == fileId);
    
    if (currentIndex === -1) {
        alert('File not found');
        return;
    }
    
    let currentFileIndex = currentIndex;
    let currentFileUrl = '';
    let currentShouldRevoke = false;
    let currentItem = item;
    let currentImg = null;
    let currentIframe = null;
    let currentMessage = null;
    
    const modal = document.createElement('div');
    modal.id = 'previewFileModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
    
    // Create content container
    const content = document.createElement('div');
    content.style.cssText = 'position: relative; max-width: 95vw; max-height: 95vh; cursor: default; display: flex; align-items: center; justify-content: center;';
    content.onclick = (e) => e.stopPropagation();
    
    // Create file name display
    const fileName = document.createElement('div');
    fileName.style.cssText = 'position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; font-size: 14px; text-align: center; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 4px; white-space: nowrap; max-width: 90vw; overflow: hidden; text-overflow: ellipsis; z-index: 10001;';
    
    // Create previous button
    const prevBtn = document.createElement('button');
    prevBtn.innerHTML = '‚Äπ';
    prevBtn.style.cssText = 'position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); color: #000; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 36px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s; line-height: 1;';
    
    // Create next button
    const nextBtn = document.createElement('button');
    nextBtn.innerHTML = '‚Ä∫';
    nextBtn.style.cssText = 'position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); color: #000; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 36px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s; line-height: 1;';
    
    // Function to get file URL
    const getFileUrl = (fileItem) => {
        let url = '';
        let shouldRevoke = false;
        if (fileItem.file && (fileItem.file instanceof Blob || fileItem.file instanceof File)) {
            url = URL.createObjectURL(fileItem.file);
            shouldRevoke = true;
        } else if (fileItem.base64) {
            url = fileItem.base64;
        }
        return { url, shouldRevoke };
    };
    
    // Function to update displayed file
    const updateFile = () => {
        currentItem = categoryFiles[currentFileIndex];
        const isImage = isImageFile(currentItem.name);
        const isPDF = currentItem.type && currentItem.type.toLowerCase().includes('pdf');
        
        const { url, shouldRevoke } = getFileUrl(currentItem);
        
        // Revoke old URL if needed
        if (currentShouldRevoke && currentFileUrl.startsWith('blob:')) {
            URL.revokeObjectURL(currentFileUrl);
        }
        
        currentFileUrl = url;
        currentShouldRevoke = shouldRevoke;
        
        // Update file name display
        fileName.textContent = `${currentFileIndex + 1} / ${categoryFiles.length} - ${currentItem.name || 'Preview'}`;
        
        // Update button states
        prevBtn.style.opacity = currentFileIndex === 0 ? '0.3' : '1';
        prevBtn.style.cursor = currentFileIndex === 0 ? 'not-allowed' : 'pointer';
        nextBtn.style.opacity = currentFileIndex === categoryFiles.length - 1 ? '0.3' : '1';
        nextBtn.style.cursor = currentFileIndex === categoryFiles.length - 1 ? 'not-allowed' : 'pointer';
        
        // Clear previous content
        if (currentImg) {
            currentImg.remove();
            currentImg = null;
        }
        if (currentIframe) {
            currentIframe.remove();
            currentIframe = null;
        }
        if (currentMessage) {
            currentMessage.remove();
            currentMessage = null;
        }
        
        // Show appropriate preview
        if (isImage && currentFileUrl) {
            currentImg = document.createElement('img');
            currentImg.src = currentFileUrl;
            currentImg.style.cssText = 'max-width: 90vw; max-height: 90vh; object-fit: contain; display: block; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); transition: opacity 0.3s;';
            currentImg.alt = currentItem.name || 'Preview';
            content.appendChild(currentImg);
        } else if (isPDF && currentFileUrl) {
            currentIframe = document.createElement('iframe');
            currentIframe.src = currentFileUrl;
            currentIframe.style.cssText = 'width: 90vw; height: 90vh; border: none; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
            content.appendChild(currentIframe);
        } else {
            // For other file types, show download option
            currentMessage = document.createElement('div');
            currentMessage.style.cssText = 'background: white; padding: 40px; border-radius: 8px; text-align: center; max-width: 500px;';
            currentMessage.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 20px;">üìÑ</div>
                <h3 style="margin: 0 0 10px 0; color: #374151;">${escapeHtml(currentItem.name)}</h3>
                <p style="color: #6b7280; margin: 0 0 20px 0;">Preview not available for this file type. Please download to view.</p>
            `;
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = '‚¨áÔ∏è Download File';
            downloadBtn.style.cssText = 'background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;';
            downloadBtn.onclick = () => {
                downloadTenancyFile(category, currentItem.id);
            };
            currentMessage.appendChild(downloadBtn);
            content.appendChild(currentMessage);
        }
    };
    
    // Navigation functions
    const showPrevious = (e) => {
        if (e) e.stopPropagation();
        if (currentFileIndex > 0) {
            currentFileIndex--;
            updateFile();
        }
    };
    
    const showNext = (e) => {
        if (e) e.stopPropagation();
        if (currentFileIndex < categoryFiles.length - 1) {
            currentFileIndex++;
            updateFile();
        }
    };
    
    // Attach navigation handlers
    prevBtn.onclick = showPrevious;
    nextBtn.onclick = showNext;
    
    // Close function
    const closeModal = () => {
        if (document.body.contains(modal)) {
            document.body.removeChild(modal);
        }
        if (currentShouldRevoke && currentFileUrl.startsWith('blob:')) {
            URL.revokeObjectURL(currentFileUrl);
        }
        document.removeEventListener('keydown', keyHandler);
    };
    
    // Keyboard handler
    const keyHandler = (e) => {
        if (e.key === 'Escape' || e.keyCode === 27) {
            closeModal();
        } else if (e.key === 'ArrowLeft' || e.keyCode === 37) {
            showPrevious(e);
        } else if (e.key === 'ArrowRight' || e.keyCode === 39) {
            showNext(e);
        }
    };
    
    document.addEventListener('keydown', keyHandler);
    
    // Set up button event handlers
    prevBtn.onmouseover = () => {
        if (currentFileIndex > 0) {
            prevBtn.style.background = '#fff';
            prevBtn.style.transform = 'translateY(-50%) scale(1.1)';
        }
    };
    prevBtn.onmouseout = () => {
        prevBtn.style.background = 'rgba(255,255,255,0.9)';
        prevBtn.style.transform = 'translateY(-50%) scale(1)';
    };
    
    nextBtn.onmouseover = () => {
        if (currentFileIndex < categoryFiles.length - 1) {
            nextBtn.style.background = '#fff';
            nextBtn.style.transform = 'translateY(-50%) scale(1.1)';
        }
    };
    nextBtn.onmouseout = () => {
        nextBtn.style.background = 'rgba(255,255,255,0.9)';
        nextBtn.style.transform = 'translateY(-50%) scale(1)';
    };
    
    // Create close button
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '‚úï';
    closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); color: #000; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s;';
    closeBtn.onmouseover = () => {
        closeBtn.style.background = '#fff';
        closeBtn.style.transform = 'scale(1.1)';
    };
    closeBtn.onmouseout = () => {
        closeBtn.style.background = 'rgba(255,255,255,0.9)';
        closeBtn.style.transform = 'scale(1)';
    };
    closeBtn.onclick = (e) => {
        e.stopPropagation();
        closeModal();
    };
    
    // Close on background click
    modal.onclick = (e) => {
        if (e.target === modal) {
            closeModal();
        }
    };
    
    // Initialize display
    content.appendChild(fileName);
    modal.appendChild(closeBtn);
    modal.appendChild(prevBtn);
    modal.appendChild(nextBtn);
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    // Load initial file
    updateFile();
}

function updateTenancyItem(category, id, field, value) {
    const item = tenancyData[category].find(i => i.id == id);
    if (item) {
        item[field] = value;
        saveTenancyData();
    }
}

function moveLeaseItem(id, direction) {
    const index = tenancyData.leases.findIndex(item => String(item.id) === String(id));
    if (index === -1) return;
    
    if (direction === 'up' && index > 0) {
        // Swap with previous item
        [tenancyData.leases[index - 1], tenancyData.leases[index]] = [tenancyData.leases[index], tenancyData.leases[index - 1]];
        saveTenancyData();
        renderLeasesTable();
    } else if (direction === 'down' && index < tenancyData.leases.length - 1) {
        // Swap with next item
        [tenancyData.leases[index], tenancyData.leases[index + 1]] = [tenancyData.leases[index + 1], tenancyData.leases[index]];
        saveTenancyData();
        renderLeasesTable();
    }
}

function handleTenancyFileDrop(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const uploadArea = document.getElementById('tenancyUploadArea');
    if (uploadArea) {
        uploadArea.style.borderColor = '#3b82f6';
    }
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const input = document.getElementById('tenancyFileUpload');
        if (input) {
            // Create a new FileList-like object
            const dataTransfer = new DataTransfer();
            Array.from(files).forEach(file => dataTransfer.items.add(file));
            input.files = dataTransfer.files;
            handleTenancyFileUpload({ target: input });
        }
    }
}

function deleteTenancyItem(category, id) {
    if (!confirm('Are you sure you want to delete this item?')) return;
    
    if (category === 'images') {
        const item = tenancyData.images.find(i => i.id == id);
        const propertyTag = item ? item.propertyTag : null;
        tenancyData.images = tenancyData.images.filter(i => i.id != id);
        saveTenancyData();
        // Refresh the property tab if we're on it
        if (propertyTag) {
            const activeTab = document.querySelector('.tenancy-tab-btn.active');
            if (activeTab && activeTab.dataset.tab === `images_${propertyTag}`) {
                renderPropertyImagesGrid(propertyTag);
                updateStorageInfo(propertyTag);
            }
        }
    } else {
        tenancyData[category] = tenancyData[category].filter(i => i.id != id);
        saveTenancyData();
        refreshTenancyTab(category === 'personalIds' ? 'personalIds' : category);
    }
}

function deleteAllPropertyImages(propertyTag) {
    const propertyImages = tenancyData.images.filter(img => (img.propertyTag || '') === propertyTag);
    const imageCount = propertyImages.length;
    
    if (imageCount === 0) {
        alert(`No images found for property "${propertyTag}".`);
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ALL ${imageCount} image(s) for property "${propertyTag}"? This action cannot be undone!`)) {
        return;
    }
    
    // Double confirmation for safety
    if (!confirm(`Final confirmation: Delete all ${imageCount} image(s) for "${propertyTag}"?`)) {
        return;
    }
    
    // Remove all images for this property
    tenancyData.images = tenancyData.images.filter(img => (img.propertyTag || '') !== propertyTag);
    saveTenancyData();
    
    // Refresh the grid and storage info
    renderPropertyImagesGrid(propertyTag);
    updateStorageInfo(propertyTag);
    
    alert(`Successfully deleted all ${imageCount} image(s) for property "${propertyTag}".`);
}

function removeDuplicateImages(propertyTag) {
    if (!confirm(`Remove duplicate images for property "${propertyTag}"? This will keep only unique images based on file content.`)) {
        return;
    }
    
    // Get all images for this property
    const propertyImages = tenancyData.images.filter(img => (img.propertyTag || '') === propertyTag);
    
    if (propertyImages.length === 0) {
        alert('No images found for this property.');
        return;
    }
    
    // Track seen images by base64 content hash (most accurate)
    const seen = new Map();
    const duplicates = [];
    const unique = [];
    
    propertyImages.forEach(img => {
        let isDuplicate = false;
        let contentHash = '';
        
        // Create hash from base64 content (most accurate)
        if (img.base64) {
            const base64Data = img.base64.includes(',') ? img.base64.split(',')[1] : img.base64;
            // Use full base64 data for accurate comparison
            // For large images, use a hash of the content
            if (base64Data.length > 10000) {
                // For very large images, use first and last 500 chars + middle 500 chars
                const mid = Math.floor(base64Data.length / 2);
                contentHash = base64Data.substring(0, 500) + base64Data.substring(mid - 250, mid + 250) + base64Data.substring(base64Data.length - 500);
            } else {
                // For smaller images, use full content
                contentHash = base64Data;
            }
        } else {
            // Fallback to filename + size if no base64
            contentHash = `${(img.name || '').toLowerCase()}_${img.sizeBytes || 0}`;
        }
        
        // Check if we've seen this content before
        if (seen.has(contentHash)) {
            isDuplicate = true;
        } else {
            seen.set(contentHash, img);
        }
        
        if (isDuplicate) {
            duplicates.push(img.id);
        } else {
            unique.push(img);
        }
    });
    
    if (duplicates.length === 0) {
        alert('No duplicate images found. All images are unique.');
        return;
    }
    
    // Remove duplicates
    tenancyData.images = tenancyData.images.filter(img => !duplicates.includes(img.id));
    saveTenancyData();
    
    // Refresh the grid and storage info
    renderPropertyImagesGrid(propertyTag);
    updateStorageInfo(propertyTag);
    
    alert(`Removed ${duplicates.length} duplicate image(s). Kept ${unique.length} unique image(s).`);
}

// Column resizer functionality
let resizing = false;
let currentResizer = null;
let startX = 0;
let startWidth = 0;
let currentColumn = null;

function startResize(e, resizer) {
    e.preventDefault();
    e.stopPropagation();
    
    resizing = true;
    currentResizer = resizer;
    currentColumn = resizer.parentElement;
    startX = e.pageX;
    startWidth = currentColumn.offsetWidth;
    
    document.addEventListener('mousemove', doResize);
    document.addEventListener('mouseup', stopResize);
    
    // Add visual feedback
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    resizer.style.background = '#3b82f6';
}

function doResize(e) {
    if (!resizing || !currentColumn) return;
    
    const diff = e.pageX - startX;
    const newWidth = Math.max(50, startWidth + diff); // Minimum width of 50px
    currentColumn.style.width = newWidth + 'px';
    
    // Update all cells in this column
    const columnIndex = Array.from(currentColumn.parentElement.children).indexOf(currentColumn);
    const table = currentColumn.closest('table');
    if (table) {
        const rows = table.querySelectorAll('tr');
        rows.forEach(row => {
            const cell = row.children[columnIndex];
            if (cell) {
                cell.style.width = newWidth + 'px';
            }
        });
    }
}

function stopResize() {
    if (resizing) {
        resizing = false;
        document.removeEventListener('mousemove', doResize);
        document.removeEventListener('mouseup', stopResize);
        
        // Remove visual feedback
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        if (currentResizer) {
            currentResizer.style.background = 'transparent';
        }
        
        currentResizer = null;
        currentColumn = null;
    }
}

// Scroll to top on page load/refresh
window.addEventListener('load', function() {
    window.scrollTo(0, 0);
    // Also scroll to top after a short delay to handle any dynamic content loading
    setTimeout(function() {
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
    }, 100);
});

// Also scroll to top when page becomes visible (handles back/forward navigation)
document.addEventListener('DOMContentLoaded', function() {
    window.scrollTo(0, 0);
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
});

function downloadTenancyFile(category, id) {
    const item = tenancyData[category].find(i => i.id == id);
    if (!item) {
        alert('File not available for download.');
        return;
    }
    
    let url = '';
    let shouldRevoke = false;
    
    if (item.file) {
        url = URL.createObjectURL(item.file);
        shouldRevoke = true;
    } else if (item.base64) {
        url = item.base64;
    } else {
        alert('File not available for download.');
        return;
    }
    
    const a = document.createElement('a');
    a.href = url;
    a.download = item.name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    if (shouldRevoke) {
        URL.revokeObjectURL(url);
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ====== HANDLE COMBINED EXCEL FILE UPLOAD (Master Data + Inspection Report) ======
function setupFileUpload() {
    const combinedExcelFileInput = document.getElementById("combinedExcelFile");
    if (!combinedExcelFileInput) {
        console.error("combinedExcelFile input element not found!");
        return;
    }
    
    combinedExcelFileInput.addEventListener("change", function(evt) {
    const file = evt.target.files[0];
    if (!file) {
        console.log("No file selected");
        return;
    }
    
    console.log("File selected:", file.name, "Size:", file.size, "Type:", file.type);
    
    const reader = new FileReader();
    const combinedUploadInfo = document.getElementById("combinedUploadInfo");
    const combinedUploadLabel = document.getElementById("combinedUploadLabel");
    
    // Show loading message
    if (combinedUploadInfo) {
        combinedUploadInfo.innerHTML = "‚è≥ Reading file...";
        combinedUploadInfo.style.color = "#6b7280";
    }
    
    reader.onerror = function(error) {
        console.error("FileReader error:", error);
        if (combinedUploadInfo) {
            combinedUploadInfo.innerHTML = "‚úó Error reading file. Please try again.";
            combinedUploadInfo.style.color = "red";
        }
    };
    
    reader.onload = function(e) {
        console.log("File read successfully, size:", e.target.result.byteLength);
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type:"array"});
            
            let propertySheetName = null;
            let tenantSheetName = null;
            let managerSuperSheetName = null;
            let inspectionSheetName = null;
            let leaseRecordsSheetName = null;
            let messages = [];
            
            // Find normalized sheets (case-insensitive, handle spaces/underscores)
            propertySheetName = workbook.SheetNames.find(name => {
                const normalized = name.trim().toLowerCase().replace(/\s+/g, "_");
                return normalized === "property";
            });
            tenantSheetName = workbook.SheetNames.find(name => {
                const normalized = name.trim().toLowerCase().replace(/\s+/g, "_");
                return normalized === "tenant";
            });
            managerSuperSheetName = workbook.SheetNames.find(name => {
                const normalized = name.trim().toLowerCase().replace(/\s+/g, "_");
                return normalized === "manager_superintendent" || 
                       normalized === "manager_superintendant" ||
                       normalized === "manager_suprintendent" ||  // Handle typo variant
                       normalized.includes("manager") && normalized.includes("super");
            });
            
            // Fallback: Try to find old "Master Data" sheet format for backward compatibility (but don't show error if not found)
            let masterDataSheetName = workbook.SheetNames.find(name => {
                const normalized = name.trim().toLowerCase().replace(/\s+/g, "_");
                return normalized === "master_data" || normalized === "masterdata";
            });
            
            // Find Inspection Report sheet (with underscore)
            inspectionSheetName = workbook.SheetNames.find(name => {
                const normalized = name.trim().toLowerCase().replace(/\s+/g, "_");
                return normalized === "inspection_report" || normalized === "inspectionreport" || name.trim().toLowerCase() === "inspection report";
            });
            if (!inspectionSheetName) {
                inspectionSheetName = workbook.SheetNames.find(name => name.trim().toLowerCase().includes("inspection"));
            }
            console.log("Looking for Inspection Report sheet. Found:", inspectionSheetName, "Available sheets:", workbook.SheetNames);
            
            // Find Lease Records sheet (with underscore)
            leaseRecordsSheetName = workbook.SheetNames.find(name => name.trim().toLowerCase().replace(/\s+/g, "_") === "lease_records" || name.trim().toLowerCase() === "lease records");
            
            // Process normalized sheets or fallback to old format
            let map = {};
            
            if (propertySheetName && tenantSheetName && managerSuperSheetName) {
                // New normalized format
                const propertySheet = XLSX.utils.sheet_to_json(workbook.Sheets[propertySheetName], {header:1, defval:""});
                const tenantSheet = XLSX.utils.sheet_to_json(workbook.Sheets[tenantSheetName], {header:1, defval:""});
                const managerSuperSheet = XLSX.utils.sheet_to_json(workbook.Sheets[managerSuperSheetName], {header:1, defval:""});
                
                map = convertNormalizedToFlat(propertySheet, tenantSheet, managerSuperSheet);
                
                // Debug: Count extracted properties
                const propertyCount = Object.keys(map).filter(k => /^Property_[A-J]$/.test(k) && map[k]).length;
                messages.push(`‚úì Normalized data loaded from: Property (${propertyCount} properties), Tenant, Manager_Superintendent sheets`);
            } else if (masterDataSheetName) {
                // Old format (backward compatibility)
                const masterSheet = workbook.Sheets[masterDataSheetName];
                const rows = XLSX.utils.sheet_to_json(masterSheet, {header:1});
                
                for (let i=0; i<rows.length; i++) {
                    if (rows[i][0] && rows[i][1]) {
                        map[ rows[i][0].trim() ] = rows[i][1];
                    }
                }
                messages.push("‚úì Master Data loaded from: " + masterDataSheetName + " (old format)");
            } else {
                // Provide helpful error message
                const foundSheets = workbook.SheetNames.join(", ");
                messages.push("‚ö† No recognized data sheets found. Expected sheets: 'Property', 'Tenant', 'Manager_Superintendent'. Found sheets: " + foundSheets);
                }
                
                masterData = map;
                try {
                // Overwrite persistent storage with new data
                    localStorage.setItem("masterDataCache", JSON.stringify(map));
            } catch (e) {
                console.error("Error saving to persistent storage:", e);
            }
                window.master = map;
                validateExcel(map);
                populateSelectors(map);
                
            // Check if this is a transactional file (has Current_Lease sheet or Selected_Property field)
            let currentLeaseSheet = workbook.Sheets["Current_Lease"];
            if (currentLeaseSheet) {
                const currentLeaseRows = XLSX.utils.sheet_to_json(currentLeaseSheet, {header:1});
                for (let i=0; i<currentLeaseRows.length; i++) {
                    if (currentLeaseRows[i][0] && currentLeaseRows[i][1]) {
                        map[ currentLeaseRows[i][0].trim() ] = currentLeaseRows[i][1];
                    }
                }
            }
            
                if (map["Selected_Property"]) {
                    // Restore selected values from transactional file
                    if (map["Selected_Property"] && document.getElementById("propertySelect")) {
                        document.getElementById("propertySelect").value = map["Selected_Property"];
                    }
                    if (map["Selected_Landlord"] && document.getElementById("landlordSelect")) {
                        document.getElementById("landlordSelect").value = map["Selected_Landlord"];
                    }
                    if (map["Property_Type"] && document.getElementById("propertyTypeSelect")) {
                        document.getElementById("propertyTypeSelect").value = map["Property_Type"];
                    }
                    if (map["Emergency_Contact_Name"] && document.getElementById("emergencyNameInput")) {
                        document.getElementById("emergencyNameInput").value = map["Emergency_Contact_Name"];
                    }
                    if (map["Emergency_Contact_Email"] && document.getElementById("emergencyEmailInput")) {
                        document.getElementById("emergencyEmailInput").value = map["Emergency_Contact_Email"];
                    }
                    if (map["Emergency_Contact_Phone"] && document.getElementById("emergencyPhoneInput")) {
                        document.getElementById("emergencyPhoneInput").value = map["Emergency_Contact_Phone"];
                    }
                    if (map["Lease_Start_Date"] && document.getElementById("leaseStartDate")) {
                        document.getElementById("leaseStartDate").value = map["Lease_Start_Date"];
                    }
                    if (map["Lease_End_Date"] && document.getElementById("leaseEndDate")) {
                        document.getElementById("leaseEndDate").value = map["Lease_End_Date"];
                    }
                    if (map["Monthly_Rent"] && document.getElementById("monthlyRentInput")) {
                        document.getElementById("monthlyRentInput").value = map["Monthly_Rent"];
                    }
                    if (map["Rent_Frequency"] && document.getElementById("rentFrequencySelect")) {
                        document.getElementById("rentFrequencySelect").value = map["Rent_Frequency"];
                    }
                    if (map["Parking"] && document.getElementById("parkingInput")) {
                        document.getElementById("parkingInput").value = map["Parking"];
                    }
                    if (map["Security_Deposit"] && document.getElementById("securityDepositInput")) {
                        document.getElementById("securityDepositInput").value = map["Security_Deposit"];
                    }
                    
                    // Restore selected tenants
                    for (let i = 1; i <= 4; i++) {
                        const tenantSel = document.getElementById(`tenantSelect${i}`);
                        const selectedTenantId = map[`Selected_Tenant_${i}_ID`];
                        if (tenantSel && selectedTenantId) {
                            tenantSel.value = selectedTenantId.toString();
                        }
                    }
                    
                    // Trigger form population
                    populateFormFields();
                messages.push("‚úì Transactional Lease file loaded (persistent storage updated)");
                } else {
                    // Populate defaults immediately (parking default, emergency defaults, etc.)
                    populateFormFields();
            }
            
            // Merge Lease Records sheet if present (with underscore)
            const leaseRecordsSheet = leaseRecordsSheetName ? workbook.Sheets[leaseRecordsSheetName] : (workbook.Sheets["Lease Records"] || workbook.Sheets["Lease_Records"]);
            if (leaseRecordsSheet) {
                const lrRows = XLSX.utils.sheet_to_json(leaseRecordsSheet, {header:1, defval:""});
                if (lrRows && lrRows.length > 1) {
                    const headers = lrRows[0];
                    const list = [];
                    // Helper function to clean tenant names from imported Excel data
                    function cleanTenantNameFromExcel(name) {
                        if (!name) return name;
                        let cleaned = String(name);
                        // First, remove any superscripts that might be in the stored data
                        cleaned = cleaned.replace(/[¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ‚Å∞‚ÅΩ‚Åæ]/g, '').trim();
                        // Remove patterns like "(75)", "(100)", "(108)", etc. - numbers in parentheses
                        cleaned = cleaned.replace(/\(\s*\d+\s*\)/g, '').trim();
                        // Also remove any trailing numbers that might be attached directly
                        cleaned = cleaned.replace(/\d+$/, '').trim();
                        // Remove any leading numbers followed by space or special chars
                        cleaned = cleaned.replace(/^\d+\s*[-_]\s*/, '').trim();
                        // Final trim to clean up any extra spaces
                        cleaned = cleaned.replace(/\s+/g, ' ').trim();
                        return cleaned;
                    }
                    for (let r = 1; r < lrRows.length; r++) {
                        const row = lrRows[r];
                        if (!row || row.length === 0) continue;
                        const obj = {};
                        headers.forEach((h, idx) => { 
                            if (h) {
                                let value = row[idx] || "";
                                // Clean tenant names if this is the Tenants column
                                if (h === "Tenants" && value) {
                                    // Split by comma, clean each name, then rejoin
                                    const names = String(value).split(',').map(n => cleanTenantNameFromExcel(n.trim())).filter(Boolean);
                                    value = names.join(", ");
                                }
                                obj[h] = value;
                            }
                        });
                        if (Object.values(obj).some(v => (v && String(v).trim().length > 0))) {
                            list.push(obj);
                        }
                    }
                    const existing = getLeaseRecords();
                    const merged = existing.concat(list);
                    setLeaseRecords(merged);
                    messages.push("‚úì Lease Records merged from workbook");
                }
            }
            
            // Process Inspection Report sheet (with underscore)
            if (inspectionSheetName) {
                const inspectionSheet = workbook.Sheets[inspectionSheetName];
                const inspectionReportContainer = document.getElementById("inspectionReportContainer");
                
                if (!inspectionSheet) {
                    messages.push("‚ö† Inspection Report sheet found but could not be read: " + inspectionSheetName);
                } else {
                // Store the workbook for export
                inspectionReportData = workbook;
                
                // Save to localStorage for persistence
                try {
                    const wbBase64 = XLSX.write(workbook, { type: 'base64', bookType: 'xlsx' });
                    localStorage.setItem("inspectionReportData", wbBase64);
                } catch (e) {
                    console.error("Error saving inspection report to localStorage:", e);
                }
                
                // Convert sheet to HTML table
                    const html = XLSX.utils.sheet_to_html(inspectionSheet, {id: "inspection-table", editable: false});
                    console.log("Inspection Report HTML generated, length:", html ? html.length : 0);
                
                    if (inspectionReportContainer && html && html.trim().length > 0) {
                    inspectionReportContainer.innerHTML = html;
                    // Apply the same styling as the original inspection report handler
                    const tables = inspectionReportContainer.querySelectorAll('table');
                    tables.forEach(table => {
                        table.style.width = '100%';
                        table.style.borderCollapse = 'collapse';
                        table.style.marginBottom = '0';
                        table.style.marginTop = '0';
                        table.style.fontSize = '10px';
                        table.style.pageBreakInside = 'auto';
                        table.style.tableLayout = 'fixed';
                        
                        const rows = table.querySelectorAll('tr');
                        
                        // Remove rows that contain title, instructions, or abbreviations
                        const rowsToRemove = [];
                        rows.forEach((row, index) => {
                            const rowText = row.textContent.trim().toLowerCase();
                            if (rowText.includes('residential tenancies') || 
                                rowText.includes('use this report') || 
                                rowText.includes('detailed description') ||
                                rowText.includes('conditional abbr') ||
                                rowText.includes('cleanliness abbr')) {
                                rowsToRemove.push(row);
                            }
                        });
                        
                        rowsToRemove.forEach(row => row.remove());
                        
                        // Re-query rows after potential removal
                        const updatedRows = table.querySelectorAll('tr');
                        
                        // First pass: identify section header rows
                        const sectionHeaderRows = [];
                        const knownSectionHeaders = [
                            'overall conditions', 'furniture', 'walls and trim', 'refrigerator',
                            'kitchen', 'basement', 'exterior', 'bathroom', 'bathroom-1', 'bathroom-2'
                        ];
                        
                        updatedRows.forEach((row, rowIndex) => {
                            if (rowIndex === 0) return; // Skip actual header row
                            
                            const cells = row.querySelectorAll('td, th');
                            if (cells.length === 0) return;
                            
                            const firstCellText = cells[0].textContent.trim();
                            const firstCellLower = firstCellText.toLowerCase();
                            
                            // Skip if it's a table header keyword
                            if (firstCellLower.includes('sections') || 
                                firstCellLower.includes('condition at') ||
                                firstCellLower.includes('comment') ||
                                firstCellLower.includes('code')) {
                                return;
                            }
                            
                            // Check if it's a known section header
                            let isKnownSection = false;
                            for (const knownHeader of knownSectionHeaders) {
                                if (firstCellLower.includes(knownHeader)) {
                                    isKnownSection = true;
                                    break;
                                }
                            }
                            
                            // Check if first cell has substantial text (likely a section header)
                            if (firstCellText.length > 2 && firstCellText.length < 25) {
                                let hasDataInOtherCells = false;
                                let nonEmptyCellCount = 0;
                                for (let i = 1; i < cells.length; i++) {
                                    const otherCellText = cells[i].textContent.trim();
                                    if (otherCellText.length > 1) {
                                        nonEmptyCellCount++;
                                        hasDataInOtherCells = true;
                                    }
                                }
                                
                                const isVeryShort = firstCellText.length < 20;
                                if (isKnownSection && (!hasDataInOtherCells || nonEmptyCellCount === 0)) {
                                    sectionHeaderRows.push(rowIndex);
                                } else if (isVeryShort && !hasDataInOtherCells && nonEmptyCellCount === 0) {
                                    sectionHeaderRows.push(rowIndex);
                                }
                            }
                        });
                        
                        // Identify column indices for condition columns
                        let conditionBeginningColIndex = -1;
                        let conditionEndColIndex = -1;
                        if (updatedRows.length > 0) {
                            const headerRow = updatedRows[0];
                            const headerCells = headerRow.querySelectorAll('td, th');
                            headerCells.forEach((cell, idx) => {
                                const cellText = cell.textContent.trim().toLowerCase();
                                if (cellText.includes('condition at beginning') && cellText.includes('code')) {
                                    conditionBeginningColIndex = idx;
                                }
                                if (cellText.includes('condition at end') && cellText.includes('code')) {
                                    conditionEndColIndex = idx;
                                }
                            });
                        }
                        
                        // Identify header rows (first 1-2 rows typically contain headers)
                        const headerRowIndices = [];
                        updatedRows.forEach((row, idx) => {
                            if (idx < 2) {
                                const cells = row.querySelectorAll('td, th');
                                let headerCellCount = 0;
                                cells.forEach(cell => {
                                    const cellText = cell.textContent.trim().toLowerCase();
                                    if (cellText.includes('sections') || 
                                        cellText.includes('condition at') ||
                                        cellText.includes('comment') ||
                                        cellText.includes('code')) {
                                        headerCellCount++;
                                    }
                                });
                                if (headerCellCount >= 2 || idx === 0) {
                                    headerRowIndices.push(idx);
                                }
                            }
                        });
                        
                        // Second pass: apply styling and merge section headers
                        updatedRows.forEach((row, rowIndex) => {
                            const cells = Array.from(row.querySelectorAll('td, th'));
                            const firstCellText = cells.length > 0 ? cells[0].textContent.trim().toLowerCase() : '';
                            const wasIdentifiedAsSection = sectionHeaderRows.includes(rowIndex);
                            
                            const matchesExactSection = (firstCellText === 'furniture' || 
                                                        firstCellText === 'overall conditions' ||
                                                        firstCellText === 'walls and trim' ||
                                                        firstCellText === 'refrigerator' ||
                                                        firstCellText === 'refrigerator(s)' ||
                                                        firstCellText === 'kitchen' ||
                                                        firstCellText === 'basement' ||
                                                        firstCellText === 'exterior' ||
                                                        firstCellText === 'bathroom' ||
                                                        firstCellText === 'bathroom-1' ||
                                                        firstCellText === 'bathroom-2');
                            
                            let hasDataInOtherCells = false;
                            if (cells.length > 1) {
                                for (let i = 1; i < cells.length; i++) {
                                    const otherCellText = cells[i].textContent.trim();
                                    if (otherCellText.length > 1) {
                                        hasDataInOtherCells = true;
                                        break;
                                    }
                                }
                            }
                            
                            const hasNoDataAtAll = !hasDataInOtherCells && cells.length > 1;
                            const isJustSectionName = firstCellText.length < 25 && 
                                                      !firstCellText.includes(':') &&
                                                      !firstCellText.includes(',');
                            
                            const isSectionHeader = wasIdentifiedAsSection && 
                                                   matchesExactSection && 
                                                   hasNoDataAtAll &&
                                                   isJustSectionName;
                            
                            // Merge "Condition at Beginning of Tenancy" and "Condition at End of Tenancy" headers with adjacent blank cells
                            if (headerRowIndices.includes(rowIndex)) {
                                // Process from right to left to avoid index issues when removing cells
                                for (let i = cells.length - 1; i >= 0; i--) {
                                    const cell = cells[i];
                                    const cellText = cell.textContent.trim().toLowerCase();
                                    if (cellText.includes('condition at beginning of tenancy') || 
                                        cellText.includes('condition at end of tenancy')) {
                                        // Count how many adjacent blank cells follow
                                        let blankCellCount = 0;
                                        for (let j = i + 1; j < cells.length; j++) {
                                            const nextCell = cells[j];
                                            const nextCellText = nextCell.textContent.trim();
                                            if (!nextCellText || nextCellText.length === 0) {
                                                blankCellCount++;
                                            } else {
                                                break;
                                            }
                                        }
                                        
                                        // Merge with adjacent blank cells
                                        if (blankCellCount > 0 && !cell.hasAttribute('colspan')) {
                                            cell.setAttribute('colspan', (blankCellCount + 1).toString());
                                            // Remove the blank cells
                                            for (let k = i + blankCellCount; k > i; k--) {
                                                if (cells[k]) {
                                                    cells[k].remove();
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            
                            // Merge section header cells if needed
                            if (isSectionHeader && cells.length > 0) {
                                const firstCell = cells[0];
                                const totalCols = cells.length;
                                
                                if (totalCols > 1 && !firstCell.hasAttribute('colspan')) {
                                    firstCell.setAttribute('colspan', totalCols.toString());
                                    for (let i = cells.length - 1; i > 0; i--) {
                                        cells[i].remove();
                                    }
                                }
                            }
                            
                            // Apply styling to remaining cells
                            const remainingCells = row.querySelectorAll('td, th');
                            
                            remainingCells.forEach((cell, cellIndex) => {
                                cell.style.border = '1px solid #000';
                                cell.style.padding = '4px 4px';
                                cell.style.fontSize = '10px';
                                cell.style.verticalAlign = 'middle';
                                cell.style.lineHeight = '1.3';
                                cell.style.height = 'auto';
                                cell.style.minHeight = '20px';
                                
                                const cellText = cell.textContent.trim().toLowerCase();
                                
                                const isHeader = headerRowIndices.includes(rowIndex) || 
                                               cellText.includes('sections') || 
                                               cellText.includes('condition at beginning') ||
                                               cellText.includes('condition at end') ||
                                               cellText.includes('comment') ||
                                               cellText.includes('code');
                                
                                if (isHeader) {
                                    cell.style.textAlign = 'center';
                                    cell.style.backgroundColor = '#000';
                                    cell.style.color = '#fff';
                                    cell.style.fontWeight = 'bold';
                                    cell.style.fontSize = '10px';
                                    cell.style.padding = '4px 4px';
                                    cell.style.minHeight = '20px';
                                    cell.style.verticalAlign = 'middle';
                                } else if (isSectionHeader) {
                                    cell.style.backgroundColor = '#000080';
                                    cell.style.color = '#fff';
                                    cell.style.fontWeight = 'bold';
                                    cell.style.fontSize = '10px';
                                    cell.style.textAlign = 'left';
                                    cell.style.padding = '4px 4px';
                                    cell.style.minHeight = '20px';
                                } else {
                                    cell.style.backgroundColor = '#fff';
                                    cell.style.color = '#000';
                                    cell.style.textAlign = 'left';
                                    if (cellIndex === conditionBeginningColIndex || cellIndex === conditionEndColIndex) {
                                        cell.style.textAlign = 'center';
                                    }
                                }
                            });
                        });
                    });
                    } else {
                        if (!inspectionReportContainer) {
                            messages.push("‚ö† Inspection Report container not found");
                        } else if (!html || html.trim().length === 0) {
                            messages.push("‚ö† Inspection Report HTML conversion produced empty result");
                            // Try alternative method: convert to JSON and build table manually
                            try {
                                const sheetData = XLSX.utils.sheet_to_json(inspectionSheet, {header: 1, defval: ""});
                                if (sheetData && sheetData.length > 0) {
                                    let tableHtml = "<table style='width:100%; border-collapse:collapse; font-size:10px;'>";
                                    sheetData.forEach((row, rowIdx) => {
                                        if (row && row.length > 0 && row.some(cell => cell && String(cell).trim().length > 0)) {
                                            tableHtml += "<tr>";
                                            row.forEach(cell => {
                                                const cellValue = cell ? String(cell).trim() : "";
                                                tableHtml += `<td style='border:1px solid #000; padding:4px;'>${cellValue}</td>`;
                                            });
                                            tableHtml += "</tr>";
                                        }
                                    });
                                    tableHtml += "</table>";
                                    inspectionReportContainer.innerHTML = tableHtml;
                                    messages.push("‚úì Inspection Report loaded from: " + inspectionSheetName + " (using alternative method)");
                                } else {
                                    messages.push("‚ö† Inspection Report sheet is empty");
                                }
                            } catch (e) {
                                messages.push("‚ö† Error processing Inspection Report: " + e.message);
                            }
                        }
                    }
                    if (!messages.some(m => m.includes("Inspection Report loaded"))) {
                    messages.push("‚úì Inspection Report loaded from: " + inspectionSheetName);
                    }
                }
            } else {
                messages.push("‚ö† Inspection Report sheet not found");
            }
            
            // Update UI
            combinedUploadLabel.classList.add("has-file");
            combinedUploadInfo.innerHTML = messages.join("<br>");
            combinedUploadInfo.classList.add("has-file");
            combinedUploadInfo.style.color = "#059669";
            
            // Allow re-selecting the same file
            try { evt.target.value = ""; } catch (e) {}
        } catch (error) {
            console.error("Error reading combined Excel file:", error);
            combinedUploadInfo.innerHTML = "‚úó Error reading file: " + error.message;
            combinedUploadInfo.style.color = "red";
        }
    };
    
    try {
    reader.readAsArrayBuffer(file);
    } catch (error) {
        console.error("Error starting file read:", error);
        if (combinedUploadInfo) {
            combinedUploadInfo.innerHTML = "‚úó Error: " + error.message;
            combinedUploadInfo.style.color = "red";
        }
    }
    });
}

// Setup file upload when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupFileUpload);
} else {
    // DOM is already ready
    setupFileUpload();
}

// Ensure clicking the label opens the file dialog reliably across browsers
const combinedUploadLabel = document.getElementById("combinedUploadLabel");
if (combinedUploadLabel) {
    combinedUploadLabel.addEventListener("click", function(e) {
    e.preventDefault();
    const input = document.getElementById("combinedExcelFile");
        if (input) {
            input.click();
        } else {
            console.error("File input not found when label clicked");
        }
    });
} else {
    console.error("combinedUploadLabel element not found!");
}

// Old Inspection Report Upload Handler - REMOVED (now handled by combined upload)

function validateExcel(map) {
    // Check for normalized data structure (converted to flat format)
    let warnings = "";
    let hasProperty = false;
    let hasTenant = false;
    let hasManager = false;
    
    // Check for properties - look for Property_* keys (excluding _Tag and _Address)
    const propertyKeys = Object.keys(map).filter(k => 
        k.startsWith('Property_') && 
        !k.includes('_Tag') && 
        !k.includes('_Address')
    );
    hasProperty = propertyKeys.length > 0;
    
    // Check for tenants (Tenant_1_Name, Tenant_2_Name, etc.)
    for (let i = 1; i <= 50; i++) {
        if (map[`Tenant_${i}_Name`]) {
            hasTenant = true;
            break;
        }
    }
    
    // Check for manager
    if (map["Manager_Name"] || map["Manager_Phone"]) {
        hasManager = true;
    }
    
    // Build warnings
    if (!hasProperty) {
        warnings += "‚ö† No properties found in Property sheet\n";
    }
    if (!hasTenant) {
        warnings += "‚ö† No tenants found in Tenant sheet\n";
    }
    if (!hasManager) {
        warnings += "‚ö† No manager information found in Manager_Superintendent sheet\n";
    }
    
    const warningsDiv = document.getElementById("excelWarnings");
    if (warnings) {
        warningsDiv.innerText = warnings;
    } else {
        warningsDiv.innerHTML = '<div class="success-message">‚úì Excel file loaded successfully!</div>';
    }
}

// ====== CREATE SELECTORS ======
function populateSelectors(map) {
    // Populate Property Selector - use Property_Tag as identifier
    const propertySelect = document.getElementById("propertySelect");
    propertySelect.innerHTML = "<option value=''>-- Select Property --</option>";
    
    // Find all Property_* keys (excluding _Tag and _Address suffixes)
    const propertyKeys = Object.keys(map).filter(k => 
        k.startsWith('Property_') && 
        !k.includes('_Tag') && 
        !k.includes('_Address')
    );
    
    propertyKeys.forEach(propKey => {
        const tagKey = propKey.replace('Property_', '');
        const propTag = map[`Property_${tagKey}_Tag`] || tagKey;
        const propAddress = map[`Property_${tagKey}_Address`] || map[propKey] || "";
        
        if (propAddress || propTag) {
        const option = document.createElement("option");
            option.value = propKey; // Store as Property_${tagKey} for lookup
            option.textContent = propAddress || propTag;
            option.dataset.tag = propTag; // Store the actual tag value
        propertySelect.appendChild(option);
    }
    });
    
    // Populate Landlord Selector with Name and Address combined - keyed by Property_Tag
    const landlordSelect = document.getElementById("landlordSelect");
    landlordSelect.innerHTML = "<option value=''>-- Select Landlord --</option>";
    
    propertyKeys.forEach(propKey => {
        const tagKey = propKey.replace('Property_', '');
        const landlordNameKey = `Landlord_${tagKey}_Name`;
        const landlordName = map[landlordNameKey] || "";
        
        if (landlordName) {
        const option = document.createElement("option");
            option.value = propKey; // Use Property_${tagKey} as value to link property and landlord
            const landlordAddr = map[`Landlord_${tagKey}_Address`] || "";
            option.textContent = landlordAddr ? `${landlordName} ‚Äî ${landlordAddr}` : landlordName;
            option.dataset.address = landlordAddr;
        landlordSelect.appendChild(option);
    }
    });
    
    // Populate Tenant Selectors - Only Active Tenants, Sorted by Name, Limited to 50
    const tenants = [];
    for (let i=1; i<=50; i++) {
        let name = map[`Tenant_${i}_Name`];
        if (name) {
            const activeValue = map[`Tenant_${i}_Active`];
            const isActive = activeValue === undefined || activeValue === "1" || activeValue === 1 || activeValue === true; // Default to active if not set
            
            // Only include active tenants
            if (isActive) {
                tenants.push({
                    id: i,
                    name,
                    email: map[`Tenant_${i}_Email`] || "",
                    phone: map[`Tenant_${i}_Phone`] || "",
                    address: map[`Tenant_${i}_Old_Address`] || ""
                });
            }
        }
    }
    
    // Sort tenants by name (case-insensitive)
    tenants.sort((a, b) => {
        const nameA = (a.name || "").toLowerCase();
        const nameB = (b.name || "").toLowerCase();
        return nameA.localeCompare(nameB);
    });
    
    // Limit to 50 active tenants
    const activeTenants = tenants.slice(0, 50);

    // Add superscripts to duplicate tenant names
    const tenantsWithSuperscripts = addSuperscriptsToDuplicateNames(activeTenants);

    const tenantDiv = document.getElementById("tenantSelectors");
    tenantDiv.innerHTML = "";
    tenantDiv.style.gridTemplateColumns = "repeat(2, 1fr)"; // 2 columns for 2 rows
    for (let i=1; i<=4; i++) {
        const selectorItem = document.createElement("div");
        selectorItem.className = "selector-item";
        
        const label = document.createElement("label");
        label.textContent = `Tenant ${i}`;
        label.setAttribute("for", `tenantSelect${i}`);
        
        const sel = document.createElement("select");
        sel.id = `tenantSelect${i}`;
        sel.innerHTML = "<option value=''>-- Select Tenant --</option>" +
            tenantsWithSuperscripts.map(t => {
                const name = t.name || "";
                const phone = t.phone || "";
                const email = t.email || "";
                return `<option value="${t.id}">${name} ‚Äî ${phone} ‚Äî ${email}</option>`;
            }).join("");
        sel.addEventListener("change", function() {
            localStorage.removeItem("leaseIdCurrent");
            // Default occupant i to match tenant i if occupant is currently empty
            const occSel = document.getElementById(`occupantSelect${i}`);
            if (occSel && !occSel.value) {
                occSel.value = this.value || "";
            }
            populateFormFields();
        });
        
        selectorItem.appendChild(label);
        selectorItem.appendChild(sel);
        tenantDiv.appendChild(selectorItem);
    }

    // Populate Occupant Selectors - Use same filtered active tenants
    const occDiv = document.getElementById("occupantSelectors");
    occDiv.innerHTML = "";
    occDiv.style.gridTemplateColumns = "repeat(4, 1fr)"; // 4 columns for 1 row
    for (let i=1; i<=4; i++) {
        const selectorItem = document.createElement("div");
        selectorItem.className = "selector-item";
        
        const label = document.createElement("label");
        label.textContent = `Occupant ${i}`;
        label.setAttribute("for", `occupantSelect${i}`);
        
        const sel = document.createElement("select");
        sel.id = `occupantSelect${i}`;
        sel.innerHTML = "<option value=''>-- Select Occupant --</option>" +
            tenantsWithSuperscripts.map(t => `<option value="${t.id}">${t.name}</option>`).join("");
        sel.addEventListener("change", function() {
            localStorage.removeItem("leaseIdCurrent");
            populateFormFields();
        });
        
        selectorItem.appendChild(label);
        selectorItem.appendChild(sel);
        occDiv.appendChild(selectorItem);
    }
    // Initialize occupants to match selected tenants by default (editable after)
    for (let i=1; i<=4; i++) {
        const tSel = document.getElementById(`tenantSelect${i}`);
        const oSel = document.getElementById(`occupantSelect${i}`);
        if (tSel && oSel && !oSel.value && tSel.value) {
            oSel.value = tSel.value;
        }
    }
    
    // Add event listeners to property and landlord selectors
    propertySelect.addEventListener("change", function() {
        localStorage.removeItem("leaseIdCurrent");
        populateFormFields();
    });
    landlordSelect.addEventListener("change", function() {
        localStorage.removeItem("leaseIdCurrent");
        populateFormFields();
    });
    
    // Add event listener to property type selector
    const propertyTypeSelect = document.getElementById("propertyTypeSelect");
    if (propertyTypeSelect) {
        propertyTypeSelect.addEventListener("change", populateFormFields);
    }
    
    // Add event listeners to date pickers
    const leaseStartDate = document.getElementById("leaseStartDate");
    const leaseEndDate = document.getElementById("leaseEndDate");
    
    if (leaseStartDate) {
        leaseStartDate.addEventListener("change", function() {
            localStorage.removeItem("leaseIdCurrent");
            try { localStorage.setItem("leaseStartDate", this.value || ""); } catch (e) {}
            updateLeaseDates();
        });
    }
    if (leaseEndDate) {
        leaseEndDate.addEventListener("change", function() {
            localStorage.removeItem("leaseIdCurrent");
            try { localStorage.setItem("leaseEndDate", this.value || ""); } catch (e) {}
            updateLeaseDates();
        });
    }
    
    // Add event listeners to rent fields
    const monthlyRentInput = document.getElementById("monthlyRentInput");
    const rentFrequencySelect = document.getElementById("rentFrequencySelect");
    
    if (monthlyRentInput) {
        monthlyRentInput.addEventListener("input", updateRentFields);
    }
    if (rentFrequencySelect) {
        rentFrequencySelect.addEventListener("change", updateRentFields);
    }
    
    // Security deposit manual override detection
    const securityDepositInput = document.getElementById("securityDepositInput");
    if (securityDepositInput) {
        securityDepositInput.addEventListener("input", function() {
            window.depositManuallyEdited = true;
            updateDepositDisplay();
        });
    }
    
    // Add event listener to parking dropdown
    const parkingInput = document.getElementById("parkingInput");
    if (parkingInput) {
        parkingInput.addEventListener("change", function() {
            const parkingField = document.getElementById("parkingField");
            if (parkingField) {
                parkingField.textContent = this.value;
            }
        });
    }
    
    // Security deposit input handled above (manual override + display update)
    
    // Add event listeners to emergency contact input fields
    const emergencyNameInput = document.getElementById("emergencyNameInput");
    const emergencyEmailInput = document.getElementById("emergencyEmailInput");
    const emergencyPhoneInput = document.getElementById("emergencyPhoneInput");
    
    if (emergencyNameInput) {
        emergencyNameInput.addEventListener("input", function() {
            document.getElementById("emergencyNameField").value = this.value;
        });
    }
    if (emergencyEmailInput) {
        emergencyEmailInput.addEventListener("input", function() {
            document.getElementById("emergencyEmailField").value = this.value;
        });
    }
    if (emergencyPhoneInput) {
        emergencyPhoneInput.addEventListener("input", function() {
            document.getElementById("emergencyPhoneField").value = this.value;
        });
    }
}

// ====== FORMAT DATE ======
function formatDate(dateString) {
    if (!dateString) return "";
    
    // Handle YYYY-MM-DD format
    const date = new Date(dateString + 'T00:00:00'); // Add time to avoid timezone issues
    if (isNaN(date.getTime())) return dateString; // Return original if invalid
    
    const months = ["January", "February", "March", "April", "May", "June",
                   "July", "August", "September", "October", "November", "December"];
    
    const day = date.getDate();
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    
    return `${day} ${month} ${year}`;
}

// ====== UPDATE LEASE DATES ======
function updateLeaseDates() {
    const startDateInput = document.getElementById("leaseStartDate");
    const endDateInput = document.getElementById("leaseEndDate");
    const startDateDisplay = document.getElementById("leaseStartDateDisplay");
    const endDateDisplay = document.getElementById("leaseEndDateDisplay");
    const leaseDatesTags = document.querySelectorAll(".leaseDatesTag");
    const currentLeaseId = localStorage.getItem("leaseIdCurrent") || "";
    // We store generation timestamp for records but do not show it in the header
    
    // Fallback to cached values if inputs are empty
    const cachedStart = localStorage.getItem("leaseStartDate") || "";
    const cachedEnd = localStorage.getItem("leaseEndDate") || "";
    const startDateRaw = (startDateInput && startDateInput.value) ? startDateInput.value : cachedStart;
    const endDateRaw = (endDateInput && endDateInput.value) ? endDateInput.value : cachedEnd;
    if (startDateInput && !startDateInput.value && cachedStart) startDateInput.value = cachedStart;
    if (endDateInput && !endDateInput.value && cachedEnd) endDateInput.value = cachedEnd;
    
    if (startDateDisplay) {
        startDateDisplay.textContent = formatDate(startDateRaw);
    }
    
    if (endDateDisplay) {
        endDateDisplay.textContent = formatDate(endDateRaw);
    }
    
    const startFormatted = formatDate(startDateRaw);
    const endFormatted = formatDate(endDateRaw);
    const bothEmpty = (!startFormatted && !endFormatted);
    leaseDatesTags.forEach(tag => {
        // If both dates are empty, don't overwrite existing text (preserve previously set dates)
        if (bothEmpty) return;
        const idPrefix = currentLeaseId ? `||${currentLeaseId}||` : "";
        const idPart = currentLeaseId ? `${idPrefix}` : "";
        // Do not append timestamp in header line
        tag.textContent = `${idPart}${currentLeaseId ? "  " : ""}Lease: ${startFormatted || "‚Äî"} ‚Äî ${endFormatted || "‚Äî"}`;
    });
    
    // No dynamic positioning; this line is fixed within header
}


// ====== UPDATE RENT FIELDS ======
function updateRentFields() {
    const monthlyRentInput = document.getElementById("monthlyRentInput");
    const rentFrequencySelect = document.getElementById("rentFrequencySelect");
    const rentFieldCombined = document.getElementById("rentFieldCombined");
    const securityDepositInput = document.getElementById("securityDepositInput");
    
    const monthlyRent = monthlyRentInput ? monthlyRentInput.value : "";
    const frequency = rentFrequencySelect ? rentFrequencySelect.value : "";
    
    // Combine all three rent fields into one paragraph
    if (rentFieldCombined) {
        let rentText = "";
        if (monthlyRent) {
            const amount = parseFloat(monthlyRent).toFixed(2);
            rentText += `The periodic rent is <span style="font-weight: bold; text-decoration: underline; font-size: 1.15em;">$${amount}</span>. `;
        }
        if (frequency) {
            rentText += `The rent is agreed to be paid on <span style="font-weight: bold; text-decoration: underline; font-size: 1.15em;">${frequency}</span>. `;
            rentText += `The Rent is <span style="font-weight: bold; text-decoration: underline; font-size: 1.15em;">due on 1st day</span> of the chosen frequency.`;
        }
        rentFieldCombined.innerHTML = rentText.trim();
    }
    
    // Auto-calc security deposit (50% of rent) unless user has overridden
    if (monthlyRentInput && securityDepositInput && !window.depositManuallyEdited) {
        const rentNum = parseFloat(monthlyRentInput.value);
        if (!isNaN(rentNum)) {
            const deposit = (rentNum * 0.5);
            securityDepositInput.value = deposit.toFixed(2);
        }
    }
    updateDepositDisplay();
}

function updateDepositDisplay() {
    const securityDepositInput = document.getElementById("securityDepositInput");
    const depositField = document.getElementById("depositField");
    if (!depositField) return;
    const val = securityDepositInput ? securityDepositInput.value : "";
    if (val && !isNaN(parseFloat(val))) {
        depositField.textContent = `$${parseFloat(val).toFixed(2)}`;
    } else {
        depositField.textContent = "";
    }
}
// ====== FINALIZE LEASE AND GENERATE LEASE ID ======
function getSelectedPropertyTag() {
    const propertySelect = document.getElementById("propertySelect");
    if (!propertySelect) return "";
    const selectedProperty = propertySelect.value;
    const map = masterData || {};
    if (selectedProperty) {
        // Extract tagKey from selectedProperty (e.g., "Property_15SM" -> "15SM")
        const tagKey = selectedProperty.replace('Property_', '');
        return map[`Property_${tagKey}_Tag`] || tagKey || "";
    }
    return "";
}

function getMonthAbbrevUpper(dateObj) {
    const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    return months[dateObj.getMonth()];
}

function pad3(n) {
    return String(n).padStart(3, "0");
}

function generateUniqueLeaseId(propertyTag) {
    const mon = getMonthAbbrevUpper(new Date());
    const counterKey = `leaseCounter:${propertyTag}:${mon}`;
    const current = parseInt(localStorage.getItem(counterKey) || "0", 10) || 0;
    const next = current + 1;
    localStorage.setItem(counterKey, String(next));
    return `${propertyTag}-${mon}-${pad3(next)}`;
}

function finalizeLease() {
    const propertyTag = getSelectedPropertyTag();
    if (!propertyTag) {
        alert("Please select a property (with a valid tag) before finalizing the lease.");
        return;
    }
    if (!confirm("Is this lease final? This will generate a Lease ID.")) {
        return;
    }
    const leaseId = generateUniqueLeaseId(propertyTag);
    localStorage.setItem("leaseIdCurrent", leaseId);
    // Store generation timestamp in required format YYYY-MM-DD @ HH-MM-SS
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    const ss = String(now.getSeconds()).padStart(2,'0');
    const genTs = `${y}-${m}-${d} @ ${hh}-${mm}-${ss}`;
    localStorage.setItem("leaseGeneratedAt", genTs);
    // Refresh header tags to include Lease ID
    populateFormFields();
    updateLeaseDates();
    alert(`Lease finalized.\nLease ID: ${leaseId}`);
    
    // Store a lightweight lease record in localStorage
    try {
        const landlordSelect = document.getElementById("landlordSelect");
        const landlordKey = landlordSelect ? landlordSelect.value : "";
        const landlordName = (masterData || {})[landlordKey] || "";
        // Get tenant names with superscripts from dropdown (which already has superscripts applied)
        const tenantList = [];
        for (let i = 1; i <= 4; i++) {
            const sel = document.getElementById(`tenantSelect${i}`);
            if (sel && sel.value) {
                const id = parseInt(sel.value);
                const name = (masterData || {})[`Tenant_${id}_Name`] || "";
                if (name) {
                    // Get the display name from the select option (which has superscripts from Tenants sheet)
                    const option = sel.options[sel.selectedIndex];
                    let displayName = option ? option.textContent.split(" ‚Äî ")[0] : name;
                    // Clean numbers in parentheses (these are IDs, not superscripts)
                    displayName = displayName.replace(/\(\s*\d+\s*\)/g, '').trim();
                    // Remove trailing digits that are not superscripts (preserve superscripts like ¬π, ¬≤, ¬≥)
                    if (displayName && /[0-9]$/.test(displayName) && !/[¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ‚Å∞]$/.test(displayName)) {
                        displayName = displayName.replace(/\d+$/, '').trim();
                    }
                    // Preserve superscripts from dropdown - they come from Tenants sheet
                    // Only clean if we didn't get it from dropdown
                    if (!option) {
                        // If no option, get name from masterData and we'll let the modal add superscripts
                        displayName = displayName.replace(/[¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ‚Å∞‚ÅΩ‚Åæ]/g, '').trim();
                    }
                    // Final cleanup of extra spaces (but preserve superscripts)
                    displayName = displayName.replace(/\s+/g, ' ').trim();
                    tenantList.push(displayName);
                }
            }
        }
        const tenantNames = tenantList.join(", ");
        const leaseStart = (document.getElementById("leaseStartDate") || {}).value || "";
        const leaseEnd = (document.getElementById("leaseEndDate") || {}).value || "";
        const rent = (document.getElementById("monthlyRentInput") || {}).value || "";
        const deposit = (document.getElementById("securityDepositInput") || {}).value || "";
        const record = {
            Lease_ID: leaseId,
            Property_Tag: propertyTag,
            Landlord: landlordName,
            Tenants: tenantNames,
            Lease_Start_Date: leaseStart,
            Lease_End_Date: leaseEnd,
            Monthly_Rent: rent,
            Security_Deposit: deposit,
            Notes: (masterData || {})["Lease_Notes"] || "",
            Created_At: genTs
        };
        const key = "leaseRecords";
        const prev = JSON.parse(localStorage.getItem(key) || "[]");
        prev.push(record);
        localStorage.setItem(key, JSON.stringify(prev));
    } catch (e) {}
}

// ====== POPULATE FORM FIELDS ======
function populateFormFields() {
    const map = masterData;
    if (!map) return;
    
    // Get selected property - now uses Property_Tag as key (e.g., Property_15SM)
    const propertySelect = document.getElementById("propertySelect");
    const selectedProperty = propertySelect.value;
    // Extract tagKey from selectedProperty (e.g., "Property_15SM" -> "15SM")
    const tagKey = selectedProperty ? selectedProperty.replace('Property_', '') : "";
    // Use Property_Address if available, otherwise fall back to Property_${tagKey} value
    const propertyAddressKey = tagKey ? `Property_${tagKey}_Address` : "";
    const propertyAddress = (propertyAddressKey && map[propertyAddressKey]) ? map[propertyAddressKey] : (map[selectedProperty] || "");
    
    // Get selected landlord - now linked to Property_Tag
    const landlordSelect = document.getElementById("landlordSelect");
    const selectedLandlord = landlordSelect.value;
    const landlordTagKey = selectedLandlord ? selectedLandlord.replace('Property_', '') : "";
    const landlordNameKey = landlordTagKey ? `Landlord_${landlordTagKey}_Name` : "";
    const landlordName = landlordNameKey ? map[landlordNameKey] || "" : "";
    const selectedOption = landlordSelect.options[landlordSelect.selectedIndex];
    const landlordAddress = selectedOption ? (selectedOption.dataset.address || (landlordTagKey ? map[`Landlord_${landlordTagKey}_Address`] || "" : "")) : "";
    
    // Get selected tenants
    const selectedTenants = [];
    for (let i=1; i<=4; i++) {
        const tenantSel = document.getElementById(`tenantSelect${i}`);
        if (tenantSel && tenantSel.value) {
            const tenantId = parseInt(tenantSel.value);
            const tenant = {
                name: map[`Tenant_${tenantId}_Name`] || "",
                email: map[`Tenant_${tenantId}_Email`] || "",
                phone: map[`Tenant_${tenantId}_Phone`] || "",
                address: map[`Tenant_${tenantId}_Old_Address`] || ""
            };
            if (tenant.name) selectedTenants.push(tenant);
        }
    }
    
    // Get selected occupants
    const selectedOccupants = [];
    for (let i=1; i<=4; i++) {
        const occSel = document.getElementById(`occupantSelect${i}`);
        if (occSel && occSel.value) {
            const tenantId = parseInt(occSel.value);
            const name = map[`Tenant_${tenantId}_Name`] || "";
            if (name) selectedOccupants.push(name);
        }
    }
    
    // Update lease tag with Property Tag instead of full address
    const leaseTag = document.querySelectorAll("#leaseTag");
    const tenantNames = selectedTenants.map(t => t.name).join(", ");
    
    // Get Property Tag based on selected property - now uses Property_Tag
    let propertyTag = "";
    if (selectedProperty && tagKey) {
        propertyTag = map[`Property_${tagKey}_Tag`] || tagKey;
    }
    
    // Inject header without Lease ID; Lease ID shows separately on left
    const currentLeaseId = localStorage.getItem("leaseIdCurrent") || "";
    leaseTag.forEach(tag => {
        if (propertyTag) {
            tag.textContent = `${propertyTag} ‚Äî ${tenantNames || "TENANTS"}`;
        } else {
            tag.textContent = "PROPERTY ‚Äî TENANTS HERE";
        }
    });
    
    // Update meta line (Lease ID + Lease Dates) on every page, right-aligned second row
    updateLeaseDates();
    
    // 1. Parties (Landlord and Tenants)
    // Display Landlord Name and Address separately
    document.getElementById("landlordNameDisplay").textContent = landlordName || "";
    document.getElementById("landlordAddressDisplay").textContent = landlordAddress || "";
    
    // Display Tenant Names in separate text boxes
    const tenantNamesContainer = document.getElementById("tenantNamesContainer");
    tenantNamesContainer.innerHTML = "";
    
    if (selectedTenants.length > 0) {
        selectedTenants.forEach((tenant) => {
            const tenantField = document.createElement("div");
            tenantField.className = "input-line";
            tenantField.style.marginBottom = "3px";
            // Show tenant name with phone number like Property Manager format
            let tenantText = tenant.name;
            if (tenant.phone) {
                tenantText += ` ‚Äî ${tenant.phone}`;
            }
            tenantField.textContent = tenantText;
            tenantNamesContainer.appendChild(tenantField);
        });
    } else {
        // Show at least one empty field if no tenants selected
        const tenantField = document.createElement("div");
        tenantField.className = "input-line";
        tenantField.textContent = "";
        tenantNamesContainer.appendChild(tenantField);
    }
    
    // 2. Occupants
    document.getElementById("occupantsField").textContent = selectedOccupants.join(", ") || "";
    
    // 3A. Property Address
    document.getElementById("premisesField").textContent = propertyAddress || "";
    
    // 3B. Type of Rental
    const propertyTypeSelect = document.getElementById("propertyTypeSelect");
    const propertyType = propertyTypeSelect ? propertyTypeSelect.value : "";
    document.getElementById("propertyTypeField").textContent = propertyType || "";
    
    // 4. Emergency Contact - Single emergency contact for the lease (not per tenant)
    const emergencyNameInput = document.getElementById("emergencyNameInput");
    const emergencyEmailInput = document.getElementById("emergencyEmailInput");
    const emergencyPhoneInput = document.getElementById("emergencyPhoneInput");
    
    // Load from Excel if available (single emergency contact fields)
    if (emergencyNameInput) {
        emergencyNameInput.value = map["Emergency_Contact_Name"] || emergencyNameInput.value || "Not Provided";
    }
    if (emergencyEmailInput) {
        emergencyEmailInput.value = map["Emergency_Contact_Email"] || emergencyEmailInput.value || "Not Provided";
    }
    if (emergencyPhoneInput) {
        emergencyPhoneInput.value = map["Emergency_Contact_Phone"] || emergencyPhoneInput.value || "Not Provided";
    }
    
    // Sync to form display fields
    document.getElementById("emergencyNameField").value = emergencyNameInput ? emergencyNameInput.value : "";
    document.getElementById("emergencyEmailField").value = emergencyEmailInput ? emergencyEmailInput.value : "";
    document.getElementById("emergencyPhoneField").value = emergencyPhoneInput ? emergencyPhoneInput.value : "";
    
    // 5. Property Manager
    let managerText = "";
    if (map["Manager_Name"]) {
        managerText = map["Manager_Name"];
        if (map["Manager_Phone"]) {
            managerText += ` ‚Äî ${map["Manager_Phone"]}`;
        }
    }
    document.getElementById("managerField").textContent = managerText;
    
    // 6. Superintendent
    let superText = "";
    if (map["Superintendent_Name"]) {
        superText = map["Superintendent_Name"];
        if (map["Superintendent_Phone"]) {
            superText += ` ‚Äî ${map["Superintendent_Phone"]}`;
        }
    }
    document.getElementById("superField").textContent = superText;
    
    // 7A. Electronic Address (Landlord to Tenant) - One field per selected tenant
    const emailLTContainer = document.getElementById("emailLTContainer");
    emailLTContainer.innerHTML = "";
    
    if (selectedTenants.length > 0) {
        // Create one field for each selected tenant
        selectedTenants.forEach((tenant, index) => {
            const emailField = document.createElement("div");
            emailField.className = "input-line";
            emailField.style.marginBottom = "2px";
            emailField.textContent = tenant.email || ""; // Show email if available, otherwise empty
            emailLTContainer.appendChild(emailField);
        });
    } else {
        // If no tenants selected, show one empty field
        const emailField = document.createElement("div");
        emailField.className = "input-line";
        emailField.textContent = "";
        emailLTContainer.appendChild(emailField);
    }
    
    // 7B. Electronic Address (Tenant to Landlord) - Fixed value
    document.getElementById("emailTL").textContent = "omagarwal.properties@gmail.com";
    
    // 7C. How to Serve Notice - Fixed non-editable text
    document.getElementById("serveField").innerHTML = "All Notices to Quit or service of documents, except Applications to the Director, must be in writing and served in accordance with Section 15 of the Act.<br>Applications to the Director must be served in accordance with subsections 13(2A), (2B) and (2C) of the Act.";
    
    // 8B. Fixed-Term Lease Dates
    const leaseStartDateInput = document.getElementById("leaseStartDate");
    const leaseEndDateInput = document.getElementById("leaseEndDate");
    
    // Load dates from Excel if available, otherwise use date picker values
    if (map["Lease_Start_Date"] && leaseStartDateInput) {
        // Convert Excel date to YYYY-MM-DD format if needed
        let startDate = map["Lease_Start_Date"];
        if (startDate && !startDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
            // Try to parse and convert to YYYY-MM-DD
            const parsedDate = new Date(startDate);
            if (!isNaN(parsedDate.getTime())) {
                startDate = parsedDate.toISOString().split('T')[0];
            }
        }
        leaseStartDateInput.value = startDate || "";
    }
    
    if (map["Lease_End_Date"] && leaseEndDateInput) {
        // Convert Excel date to YYYY-MM-DD format if needed
        let endDate = map["Lease_End_Date"];
        if (endDate && !endDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
            // Try to parse and convert to YYYY-MM-DD
            const parsedDate = new Date(endDate);
            if (!isNaN(parsedDate.getTime())) {
                endDate = parsedDate.toISOString().split('T')[0];
            }
        }
        leaseEndDateInput.value = endDate || "";
    }
    
    // Update display with formatted dates
    updateLeaseDates();
    
    // 10. Rent
    const monthlyRentInput = document.getElementById("monthlyRentInput");
    const rentFrequencySelect = document.getElementById("rentFrequencySelect");
    
    // Load from Excel if available
    if (map["Monthly_Rent"] && monthlyRentInput) {
        monthlyRentInput.value = map["Monthly_Rent"];
    }
    if (map["Rent_Frequency"] && rentFrequencySelect) {
        rentFrequencySelect.value = map["Rent_Frequency"];
    } else if (rentFrequencySelect && !rentFrequencySelect.value) {
        // Set default to Monthly if no value from Excel
        rentFrequencySelect.value = "Monthly";
    }
    
    // Update rent fields display
    updateRentFields();
    
    // 12. Rental Incentives - Fixed content, no need to update from Excel
    
    // 13. Rent Includes - Fixed content for 13A, 13B, 13C
    // 13D. Parking - Load from Excel if available, otherwise use input value
    const parkingInput = document.getElementById("parkingInput");
    const parkingField = document.getElementById("parkingField");
    
    if (parkingInput) {
        if (map["Parking"]) {
        parkingInput.value = map["Parking"];
        }
        if (!parkingInput.value) {
            parkingInput.value = "Parking spot is not allocated, no guest parking allowed on driveway.";
        }
    }
    
    if (parkingField) {
        const parkingValue = parkingInput ? parkingInput.value : (map["Parking"] || "Parking spot is not allocated, no guest parking allowed on driveway.");
        parkingField.textContent = parkingValue;
    }
    
    // 14. Additional Obligations - Fixed content, no need to update from Excel
    
    // 15. Security Deposit
    const securityDepositInput = document.getElementById("securityDepositInput");
    const depositField = document.getElementById("depositField");
    
    // Load from Excel if available, otherwise use input value
    if (securityDepositInput) {
        if (map["Security_Deposit"]) {
        securityDepositInput.value = map["Security_Deposit"];
        } else if (!window.depositManuallyEdited) {
            const mr = document.getElementById("monthlyRentInput");
            const rentNum = mr ? parseFloat(mr.value) : NaN;
            if (!isNaN(rentNum)) {
                securityDepositInput.value = (rentNum * 0.5).toFixed(2);
            }
        }
    }
    
    // Update display field
    updateDepositDisplay();
    
    // 17B. Assigning & Subletting
    const subletField = document.getElementById("subletField");
    if (subletField) {
        subletField.textContent = map["Subletting_Terms"] || "The tenant cannot sublet the premises.";
    }
    
    // 19. Tenant Notice to Quit - Fixed content, no text box needed
    
    // 22A. Tenant Signatures
    const tenantSignaturesContainer = document.getElementById("tenantSignaturesContainer");
    if (tenantSignaturesContainer) {
        tenantSignaturesContainer.innerHTML = "";
        selectedTenants.forEach((tenant, index) => {
            const signatureDiv = document.createElement("div");
            signatureDiv.style.marginBottom = "25px";
            signatureDiv.style.display = "flex";
            signatureDiv.style.justifyContent = "space-between";
            signatureDiv.style.alignItems = "flex-start";
            signatureDiv.style.gap = "20px";
            signatureDiv.innerHTML = `
                <div style="flex: 1; font-weight: bold; padding-top: 5px;">${tenant.name}</div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 3px;">Signature:</div>
                    <div style="min-height: 20px;">_____________________________</div>
                </div>
                <div style="flex: 1;">
                    <div style="margin-bottom: 3px;">Date (YYYY-MM-DD):</div>
                    <div style="min-height: 20px;">_____________________________</div>
                </div>
            `;
            tenantSignaturesContainer.appendChild(signatureDiv);
        });
    }
    
    // 22B. Manager Signature
    const managerSignatureContainer = document.getElementById("managerSignatureContainer");
    if (managerSignatureContainer) {
        let managerText = "";
        if (map["Manager_Name"]) {
            managerText = map["Manager_Name"];
        }
        managerSignatureContainer.innerHTML = "";
        const signatureDiv = document.createElement("div");
        signatureDiv.style.marginBottom = "25px";
        signatureDiv.style.display = "flex";
        signatureDiv.style.justifyContent = "space-between";
        signatureDiv.style.alignItems = "flex-start";
        signatureDiv.style.gap = "20px";
        signatureDiv.innerHTML = `
            <div style="flex: 1; font-weight: bold; padding-top: 5px;">${managerText || "Manager Name"}</div>
            <div style="flex: 1;">
                <div style="margin-bottom: 3px;">Signature:</div>
                <div style="min-height: 20px;">_____________________________</div>
            </div>
            <div style="flex: 1;">
                <div style="margin-bottom: 3px;">Date (YYYY-MM-DD):</div>
                <div style="min-height: 20px;">_____________________________</div>
            </div>
        `;
        managerSignatureContainer.appendChild(signatureDiv);
    }
    
    // Update Page 3 tenant names list
    const page3TenantNames = document.getElementById("page3TenantNames");
    if (page3TenantNames) {
        if (selectedTenants && selectedTenants.length > 0) {
            page3TenantNames.innerHTML = "";
            selectedTenants.forEach((tenant, index) => {
                // Create a container for each name with signature line above
                const nameContainer = document.createElement("div");
                nameContainer.style.display = "inline-flex";
                nameContainer.style.flexDirection = "column";
                nameContainer.style.alignItems = "flex-start";
                nameContainer.style.marginRight = "5px";
                
                // Signature line above name
                const signatureLine = document.createElement("div");
                signatureLine.style.width = "100px";
                signatureLine.style.height = "1px";
                signatureLine.style.backgroundColor = "#000";
                signatureLine.style.marginBottom = "2px";
                
                // Name text
                const nameText = document.createElement("span");
                nameText.textContent = tenant.name;
                nameText.style.fontSize = "12px";
                
                nameContainer.appendChild(signatureLine);
                nameContainer.appendChild(nameText);
                page3TenantNames.appendChild(nameContainer);
                
                // Add comma separator except for last name
                if (index < selectedTenants.length - 1) {
                    const comma = document.createTextNode(", ");
                    page3TenantNames.appendChild(comma);
                }
            });
        } else {
            page3TenantNames.textContent = "";
        }
    }
    
    // Update lease tag on page 6 and 7 (Inspection Report pages) (no Lease ID here)
    const page6LeaseTag = document.querySelectorAll('.page[data-page="6"] #leaseTag');
    page6LeaseTag.forEach(tag => {
        if (propertyTag) {
            tag.textContent = `${propertyTag} ‚Äî ${tenantNames || "TENANTS"}`;
        } else {
            tag.textContent = "PROPERTY ‚Äî TENANTS HERE";
        }
    });
    
    const page7LeaseTag = document.querySelectorAll('.page[data-page="7"] #leaseTag');
    page7LeaseTag.forEach(tag => {
        if (propertyTag) {
            tag.textContent = `${propertyTag} ‚Äî ${tenantNames || "TENANTS"}`;
        } else {
            tag.textContent = "PROPERTY ‚Äî TENANTS HERE";
        }
    });
    
    // Refresh meta line (Lease ID + dates)
    updateLeaseDates();
    
    // Inspection Report - Will be loaded via separate file upload or from localStorage
    // Only show placeholder if container is empty (don't overwrite if already loaded from localStorage)
    const inspectionReportContainer = document.getElementById("inspectionReportContainer");
    if (inspectionReportContainer && !inspectionReportContainer.innerHTML.trim()) {
        // Check if we have inspection report data in localStorage
        const hasCachedInspection = localStorage.getItem("inspectionReportData");
        if (!hasCachedInspection) {
            inspectionReportContainer.innerHTML = "<div class='input-line'>Please upload an Inspection Report Excel file using the upload button in the control panel.</div>";
        }
    }
    
    // Inspection Report Signatures - Same tenants as lease
    const inspectionSignaturesContainer = document.getElementById("inspectionSignaturesContainer");
    if (inspectionSignaturesContainer) {
        inspectionSignaturesContainer.innerHTML = "";
        inspectionSignaturesContainer.style.fontSize = "15px"; // Reduced by 30% for Page 7
        if (selectedTenants && selectedTenants.length > 0) {
            selectedTenants.forEach((tenant, index) => {
                const signatureDiv = document.createElement("div");
                signatureDiv.style.marginBottom = "12px";
                signatureDiv.style.display = "flex";
                signatureDiv.style.justifyContent = "space-between";
                signatureDiv.style.alignItems = "flex-start";
                signatureDiv.style.gap = "15px";
                signatureDiv.innerHTML = `
                    <div style="flex: 1; font-weight: bold; padding-top: 3px; font-size: 17px;">${tenant.name}</div>
                    <div style="flex: 1;">
                        <div style="margin-bottom: 2px; font-size: 17px;">Signature:</div>
                        <div style="min-height: 18px;">_____________________________</div>
                    </div>
                `;
                inspectionSignaturesContainer.appendChild(signatureDiv);
            });
        } else {
            // Fallback if no tenants selected yet
            inspectionSignaturesContainer.innerHTML = "<div style='font-size: 17px; color: #666;'>Tenant signatures will appear here after selecting tenants.</div>";
        }
    }
}

// ====== UPDATE PAGE NUMBERS ======
function updatePageNumbers() {
    const pages = document.querySelectorAll('.page');
    const totalPages = pages.length;
    
    pages.forEach((page, index) => {
        const footer = page.querySelector('.page-footer');
        if (footer) {
            const pageNumber = footer.querySelector('.page-number');
            const totalPagesSpan = footer.querySelector('.total-pages');
            if (pageNumber) pageNumber.textContent = (index + 1).toString();
            if (totalPagesSpan) totalPagesSpan.textContent = totalPages.toString();
        }
    });
}

// Update page numbers on page load
// Column resizer functionality for Excel-like tables
function initColumnResizers() {
    const tables = document.querySelectorAll('.excel-table');
    tables.forEach(table => {
        const tableId = table.id || 'default';
        const headers = table.querySelectorAll('thead th.resizable');
        
        // Load saved column widths
        try {
            const savedWidths = JSON.parse(localStorage.getItem(`columnWidths_${tableId}`) || '{}');
            headers.forEach((header, index) => {
                if (savedWidths[index]) {
                    const width = savedWidths[index];
                    header.style.width = width + 'px';
                    // Update all cells in this column
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const cell = row.children[index];
                        if (cell) {
                            cell.style.width = width + 'px';
                        }
                    });
                }
            });
        } catch (e) {
            console.error("Error loading column widths:", e);
        }
        
        headers.forEach((header, index) => {
            // Remove existing resizer if any
            const existingResizer = header.querySelector('.column-resizer');
            if (existingResizer) {
                existingResizer.remove();
            }
            
            const resizer = document.createElement('div');
            resizer.className = 'column-resizer';
            header.appendChild(resizer);
            
            let startX, startWidth, th;
            
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                th = header;
                startX = e.pageX;
                startWidth = th.offsetWidth;
                resizer.classList.add('active');
                
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
            });
            
            function resize(e) {
                if (!th) return;
                const width = startWidth + (e.pageX - startX);
                if (width >= 50) { // Minimum width
                    th.style.width = width + 'px';
                    // Update all cells in this column
                    const colIndex = Array.from(th.parentElement.children).indexOf(th);
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const cell = row.children[colIndex];
                        if (cell) {
                            cell.style.width = width + 'px';
                        }
                    });
                }
            }
            
            function stopResize() {
                resizer.classList.remove('active');
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
                
                // Save column widths to localStorage
                try {
                    const savedWidths = {};
                    headers.forEach((h, idx) => {
                        savedWidths[idx] = parseInt(h.style.width) || h.offsetWidth;
                    });
                    localStorage.setItem(`columnWidths_${tableId}`, JSON.stringify(savedWidths));
                } catch (e) {
                    console.error("Error saving column widths:", e);
                }
            }
        });
    });
}

// Column resizers will be initialized when modals are opened

document.addEventListener('DOMContentLoaded', function() {
    // Starting a new preparation session: ensure no stale Lease ID shows up
    localStorage.removeItem("leaseIdCurrent");
    updatePageNumbers();
    
    // Set default dates ONLY if fields are empty and no cached dates exist
    // Users can always change these dates manually - they are fully editable
    const startDateInput = document.getElementById("leaseStartDate");
    const endDateInput = document.getElementById("leaseEndDate");
    
    // Check if there are cached dates in localStorage first
    const cachedStart = localStorage.getItem("leaseStartDate");
    const cachedEnd = localStorage.getItem("leaseEndDate");
    
    // Only set defaults if both the field AND localStorage are empty
    if (startDateInput && !startDateInput.value && !cachedStart) {
        const now = new Date();
        const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        const startDateStr = nextMonth.getFullYear() + '-' + 
                            String(nextMonth.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(nextMonth.getDate()).padStart(2, '0');
        startDateInput.value = startDateStr;
        localStorage.setItem("leaseStartDate", startDateStr);
    }
    
    if (endDateInput && !endDateInput.value && !cachedEnd) {
        const now = new Date();
        const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        const endDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth() + 3, 0); // Last day of month 3 months after
        const endDateStr = endDate.getFullYear() + '-' + 
                          String(endDate.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(endDate.getDate()).padStart(2, '0');
        endDateInput.value = endDateStr;
        localStorage.setItem("leaseEndDate", endDateStr);
    }
    
    updateLeaseDates();
    
    // Load master data from persistent storage (localStorage)
    try {
        const cached = localStorage.getItem("masterDataCache");
        if (cached) {
            masterData = JSON.parse(cached) || {};
            window.master = masterData;
            
            // Validate and populate selectors
            validateExcel(masterData);
            populateSelectors(masterData);
            
            // Populate form fields with default values from master data
            populateFormFields();
            
            // Show status message that data was loaded from persistent storage
            const info = document.getElementById("combinedUploadInfo");
            if (info) {
                info.innerHTML = "‚úì Master Data loaded from persistent storage. Use 'Upload Master Data' to overwrite with a new file.";
                info.style.color = "#059669";
            }
        } else {
            // No cached data - show message that user should upload
            const info = document.getElementById("combinedUploadInfo");
            if (info) {
                info.innerHTML = "‚Ñπ No master data found. Please upload an Excel file to get started.";
                info.style.color = "#6b7280";
            }
        }
    } catch (e) {
        console.error("Error loading master data from persistent storage:", e);
        const info = document.getElementById("combinedUploadInfo");
        if (info) {
            info.innerHTML = "‚ö† Error loading master data from persistent storage. Please upload a file.";
            info.style.color = "#ef4444";
        }
    }
    
    // Restore cached dates if present (without overwriting selected ones)
    const start = localStorage.getItem("leaseStartDate");
    const end = localStorage.getItem("leaseEndDate");
    const sIn = document.getElementById("leaseStartDate");
    const eIn = document.getElementById("leaseEndDate");
    if (sIn && start && !sIn.value) sIn.value = start;
    if (eIn && end && !eIn.value) eIn.value = end;
    updateLeaseDates();
    
    // Load inspection report data from persistent storage
    try {
        const cachedInspectionReport = localStorage.getItem("inspectionReportData");
        if (cachedInspectionReport) {
            // Convert base64 back to workbook
            const wb = XLSX.read(cachedInspectionReport, { type: 'base64' });
            inspectionReportData = wb;
            
            // Find inspection report sheet
            const inspectionSheetName = wb.SheetNames.find(name => {
                const normalized = name.trim().toLowerCase().replace(/\s+/g, "_");
                return normalized === "inspection_report" || normalized === "inspectionreport" || name.trim().toLowerCase() === "inspection report";
            }) || wb.SheetNames.find(name => name.trim().toLowerCase().includes("inspection")) || wb.SheetNames[0];
            
            if (inspectionSheetName) {
                const inspectionSheet = wb.Sheets[inspectionSheetName];
                if (inspectionSheet) {
                    // Convert sheet to HTML table
                    const html = XLSX.utils.sheet_to_html(inspectionSheet, {id: "inspection-table", editable: false});
                    const inspectionReportContainer = document.getElementById("inspectionReportContainer");
                    
                    if (inspectionReportContainer && html && html.trim().length > 0) {
                        inspectionReportContainer.innerHTML = html;
                        // Apply styling
                        const tables = inspectionReportContainer.querySelectorAll('table');
                        tables.forEach(table => {
                            table.style.width = '100%';
                            table.style.borderCollapse = 'collapse';
                            table.style.marginBottom = '0';
                            table.style.marginTop = '0';
                            table.style.fontSize = '10px';
                            table.style.pageBreakInside = 'auto';
                            table.style.tableLayout = 'fixed';
                            
                            const rows = table.querySelectorAll('tr');
                            
                            // Remove rows that contain title, instructions, or abbreviations
                            const rowsToRemove = [];
                            rows.forEach((row) => {
                                const rowText = row.textContent.trim().toLowerCase();
                                if (rowText.includes('residential tenancies') || 
                                    rowText.includes('use this report') || 
                                    rowText.includes('detailed description') ||
                                    rowText.includes('conditional abbr') ||
                                    rowText.includes('cleanliness abbr')) {
                                    rowsToRemove.push(row);
                                }
                            });
                            
                            rowsToRemove.forEach(row => row.remove());
                            
                            // Apply styling to cells
                            const updatedRows = table.querySelectorAll('tr');
                            updatedRows.forEach((row, rowIndex) => {
                                const cells = row.querySelectorAll('td, th');
                                cells.forEach((cell, cellIndex) => {
                                    cell.style.border = '1px solid #000';
                                    cell.style.padding = '2px 4px';
                                    cell.style.textAlign = cellIndex === 0 ? 'left' : 'center';
                                    cell.style.verticalAlign = 'top';
                                });
                            });
                        });
                    }
                }
            }
        }
    } catch (e) {
        console.error("Error loading inspection report from persistent storage:", e);
    }
});

// No viewport-based repositioning needed for the fixed header layout

// ====== GENERATE PDF ======
function generatePDF() {
    // Hide control panel and buttons for printing
    const controlPanel = document.querySelector('.control-panel');
    const buttonContainers = document.querySelectorAll('.button-container');
    const header = document.querySelector('.header');
    // Ensure date displays are up to date before printing
    try { updateLeaseDates(); } catch (e) {}
    
    // Store original display states
    const originalDisplay = {
        controlPanel: controlPanel ? controlPanel.style.display : '',
        header: header ? header.style.display : '',
        buttons: []
    };
    
    buttonContainers.forEach(btn => {
        originalDisplay.buttons.push(btn.style.display);
        btn.style.display = 'none';
    });
    
    if (controlPanel) controlPanel.style.display = 'none';
    if (header) header.style.display = 'none';
    
    // Trigger print dialog
    window.print();
    
    // Restore display after a short delay (print dialog is async)
    setTimeout(() => {
        if (controlPanel) controlPanel.style.display = originalDisplay.controlPanel;
        if (header) header.style.display = originalDisplay.header;
        buttonContainers.forEach((btn, index) => {
            btn.style.display = originalDisplay.buttons[index] || '';
        });
    }, 500);
}

// ====== EXTRACT INSPECTION REPORT FROM PAGE 6/7 ======
function extractInspectionReportFromPage() {
    const inspectionReportContainer = document.getElementById("inspectionReportContainer");
    if (!inspectionReportContainer) {
        return null;
    }
    
    // Find the table in the container
    const table = inspectionReportContainer.querySelector('table');
    if (!table) {
        return null;
    }
    
    const rows = table.querySelectorAll('tr');
    if (rows.length === 0) {
        return null;
    }
    
    const sheetData = [];
    
    // Add empty rows 1-5 (to match Excel structure)
    for (let i = 0; i < 5; i++) {
        sheetData.push(["", "", "", "", ""]);
    }
    
    // Identify column mapping from header row
    let sectionColIndex = 0;
    let comment1ColIndex = -1;
    let code1ColIndex = -1;
    let comment2ColIndex = -1;
    let code2ColIndex = -1;
    
    // Find header row and map columns
    let headerRowIndex = -1;
    for (let i = 0; i < Math.min(3, rows.length); i++) {
        const row = rows[i];
        const cells = row.querySelectorAll('td, th');
        if (cells.length === 0) continue;
        
        const cellTexts = Array.from(cells).map(cell => cell.textContent.trim().toLowerCase());
        const rowText = cellTexts.join(' ');
        
        // Check if this is a header row
        if (rowText.includes('section') || rowText.includes('comment') || rowText.includes('code')) {
            headerRowIndex = i;
            
            // Map columns based on header content
            cells.forEach((cell, idx) => {
                const cellText = cell.textContent.trim().toLowerCase();
                if (cellText.includes('section')) {
                    sectionColIndex = idx;
                } else if (cellText.includes('condition at beginning') || cellText.includes('begin')) {
                    if (cellText.includes('comment')) {
                        comment1ColIndex = idx;
                    } else if (cellText.includes('code')) {
                        code1ColIndex = idx;
                    }
                } else if (cellText.includes('condition at end') || cellText.includes('end')) {
                    if (cellText.includes('comment')) {
                        comment2ColIndex = idx;
                    } else if (cellText.includes('code')) {
                        code2ColIndex = idx;
                    }
                } else if (cellText.includes('comment') && comment1ColIndex === -1) {
                    comment1ColIndex = idx;
                } else if (cellText.includes('code') && code1ColIndex === -1) {
                    code1ColIndex = idx;
                }
            });
            
            // If we couldn't find specific columns, use default mapping
            if (comment1ColIndex === -1 && cells.length > 1) comment1ColIndex = 1;
            if (code1ColIndex === -1 && cells.length > 2) code1ColIndex = 2;
            if (comment2ColIndex === -1 && cells.length > 3) comment2ColIndex = 3;
            if (code2ColIndex === -1 && cells.length > 4) code2ColIndex = 4;
            
            break;
        }
    }
    
    // Add header row (Row 6)
    sheetData.push(["Sections", "Comment", "Code", "Comment", "Code"]);
    
    // Process data rows (skip header rows)
    for (let i = headerRowIndex + 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.querySelectorAll('td, th');
        
        if (cells.length === 0) continue;
        
        // Extract cell text content
        const cellTexts = Array.from(cells).map(cell => cell.textContent.trim());
        
        // Skip rows that are clearly headers/instructions
        const rowText = cellTexts.join(' ').toLowerCase();
        if (rowText.includes('residential tenancies') || 
            rowText.includes('use this report') || 
            rowText.includes('detailed description') ||
            rowText.includes('conditional codes') ||
            rowText.includes('cleanliness codes')) {
            continue;
        }
        
        // Map cells to: Sections, Comment, Code, Comment, Code (5 columns)
        let section = (sectionColIndex >= 0 && sectionColIndex < cellTexts.length) ? cellTexts[sectionColIndex] : "";
        let comment1 = (comment1ColIndex >= 0 && comment1ColIndex < cellTexts.length) ? cellTexts[comment1ColIndex] : "";
        let code1 = (code1ColIndex >= 0 && code1ColIndex < cellTexts.length) ? cellTexts[code1ColIndex] : "";
        let comment2 = (comment2ColIndex >= 0 && comment2ColIndex < cellTexts.length) ? cellTexts[comment2ColIndex] : "";
        let code2 = (code2ColIndex >= 0 && code2ColIndex < cellTexts.length) ? cellTexts[code2ColIndex] : "";
        
        // Fallback: if column mapping failed, use sequential mapping
        if (comment1ColIndex === -1 && cellTexts.length > 1) comment1 = cellTexts[1] || "";
        if (code1ColIndex === -1 && cellTexts.length > 2) code1 = cellTexts[2] || "";
        if (comment2ColIndex === -1 && cellTexts.length > 3) comment2 = cellTexts[3] || "";
        if (code2ColIndex === -1 && cellTexts.length > 4) code2 = cellTexts[4] || "";
        
        // Only add row if there's some data
        if (section || comment1 || code1 || comment2 || code2) {
            sheetData.push([section, comment1, code1, comment2, code2]);
        }
    }
    
    // If we have at least the header row, return the data
    if (sheetData.length > 5) {
        return sheetData;
    }
    
    return null;
}

// ====== GENERATE EXCEL TEMPLATE ======
function generateExcelTemplate() {
    // Check if master data is loaded
    const map = masterData || {};
    
    // Convert flat format to normalized sheets
    const normalized = convertFlatToNormalized(map);
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    
    // Add Property sheet
    const propertyWs = XLSX.utils.aoa_to_sheet(normalized.property);
    propertyWs['!cols'] = [
        {wch: 15}, // Property_Tag
        {wch: 40}, // Property_Address
        {wch: 25}, // Landlord_Name
        {wch: 40}, // Landlord_Address
        {wch: 18}  // Landlord_Phone
    ];
    XLSX.utils.book_append_sheet(wb, propertyWs, "Property");
    
    // Add Tenant sheet
    const tenantWs = XLSX.utils.aoa_to_sheet(normalized.tenant);
    tenantWs['!cols'] = [
        {wch: 25}, // Tenant_Name
        {wch: 30}, // Tenant_Email
        {wch: 18}, // Tenant_Phone
        {wch: 40}, // Tenant_Old_Address
        {wch: 40}  // Tenant_Job_Desc
    ];
    XLSX.utils.book_append_sheet(wb, tenantWs, "Tenant");
    
    // Add Manager_Superintendent sheet
    const managerSuperWs = XLSX.utils.aoa_to_sheet(normalized.managerSuper);
    managerSuperWs['!cols'] = [
        {wch: 25}, // Manager_Name
        {wch: 18}, // Manager_Phone
        {wch: 25}, // Superintendent_Name
        {wch: 18}  // Superintendent_Phone
    ];
    XLSX.utils.book_append_sheet(wb, managerSuperWs, "Manager_Superintendent");
    
    // Extract Inspection Report from page 6/7 (currently displayed data)
    const extractedInspectionData = extractInspectionReportFromPage();
    
    // Add Inspection Report as sheet if available
    if (extractedInspectionData && extractedInspectionData.length > 0) {
        // Use extracted data from page 6/7
        const clonedSheet = XLSX.utils.aoa_to_sheet(extractedInspectionData);
        clonedSheet['!cols'] = [
            {wch: 40}, // Sections
            {wch: 15}, // Begin Code
            {wch: 30}, // Begin Comment
            {wch: 15}, // End Code
            {wch: 30}  // End Comment
        ];
        XLSX.utils.book_append_sheet(wb, clonedSheet, "Inspection_Report");
    } else if (inspectionReportData && inspectionReportData.SheetNames.length > 0) {
        // Fallback to stored inspectionReportData
        const inspectionSheetName = inspectionReportData.SheetNames[0];
        const inspectionSheet = inspectionReportData.Sheets[inspectionSheetName];
        // Clone the sheet by converting to JSON and back to preserve structure
        const sheetData = XLSX.utils.sheet_to_json(inspectionSheet, {header: 1, defval: "", raw: false});
        const clonedSheet = XLSX.utils.aoa_to_sheet(sheetData);
        // Copy column widths if they exist
        if (inspectionSheet['!cols']) {
            clonedSheet['!cols'] = inspectionSheet['!cols'];
        }
        XLSX.utils.book_append_sheet(wb, clonedSheet, "Inspection_Report");
    }
    
    // Add Lease Records sheet from persisted records
    const records = getLeaseRecords();
    const headers = [
        "Lease_ID","Property_Tag","Landlord","Tenants",
        "Lease_Start_Date","Lease_End_Date","Monthly_Rent",
        "Security_Deposit","Notes","Created_At"
    ];
    const rows = [headers];
    records.forEach(r => rows.push(headers.map(h => r[h] || "")));
    const lrWs = XLSX.utils.aoa_to_sheet(rows);
    lrWs['!cols'] = [
        {wch:20},{wch:12},{wch:25},{wch:40},
        {wch:14},{wch:14},{wch:14},
        {wch:20},{wch:22}
    ];
    XLSX.utils.book_append_sheet(wb, lrWs, "Lease_Records");
    
    // Generate Excel file and download
    const fileName = Object.keys(map).length > 0 ? "NS_Lease_Master_Data.xlsx" : "NS_Lease_Master_Data_Template.xlsx";
    XLSX.writeFile(wb, fileName);
    
    // Show message if no data loaded
    if (Object.keys(map).length === 0) {
        alert("No master data loaded. Please upload your master data file first, then click this button again to download with your values.");
    }
}

// ====== DOWNLOAD CURRENT LEASE (TRANSACTIONAL FILE) ======
function downloadCurrentLease() {
    const map = masterData || {};
    
    // Get current form values
    const propertySelect = document.getElementById("propertySelect");
    const selectedProperty = propertySelect ? propertySelect.value : "";
    const propertyAddress = map[selectedProperty] || "";
    
    const landlordSelect = document.getElementById("landlordSelect");
    const selectedLandlord = landlordSelect ? landlordSelect.value : "";
    const landlordName = map[selectedLandlord] || "";
    const selectedOption = landlordSelect ? landlordSelect.options[landlordSelect.selectedIndex] : null;
    const landlordAddress = selectedOption ? (selectedOption.dataset.address || map[`${selectedLandlord}_Address`] || "") : "";
    
    // Get selected tenants
    const selectedTenants = [];
    const selectedTenantIds = [];
    for (let i=1; i<=4; i++) {
        const tenantSel = document.getElementById(`tenantSelect${i}`);
        if (tenantSel && tenantSel.value) {
            const tenantId = parseInt(tenantSel.value);
            selectedTenantIds.push(tenantId);
            const tenant = {
                id: tenantId,
                name: map[`Tenant_${tenantId}_Name`] || "",
                email: map[`Tenant_${tenantId}_Email`] || "",
                phone: map[`Tenant_${tenantId}_Phone`] || "",
                address: map[`Tenant_${tenantId}_Old_Address`] || ""
            };
            if (tenant.name) selectedTenants.push(tenant);
        }
    }
    
    // Get property tag - extract tagKey from selectedProperty (e.g., "Property_15SM" -> "15SM")
    let propertyTag = "";
    if (selectedProperty && tagKey) {
        propertyTag = map[`Property_${tagKey}_Tag`] || tagKey || "";
    }
    
    // Get current form field values
    const propertyTypeSelect = document.getElementById("propertyTypeSelect");
    const propertyType = propertyTypeSelect ? propertyTypeSelect.value : "";
    
    const emergencyNameInput = document.getElementById("emergencyNameInput");
    const emergencyEmailInput = document.getElementById("emergencyEmailInput");
    const emergencyPhoneInput = document.getElementById("emergencyPhoneInput");
    const emergencyName = emergencyNameInput ? emergencyNameInput.value : "";
    const emergencyEmail = emergencyEmailInput ? emergencyEmailInput.value : "";
    const emergencyPhone = emergencyPhoneInput ? emergencyPhoneInput.value : "";
    
    const leaseStartDateInput = document.getElementById("leaseStartDate");
    const leaseEndDateInput = document.getElementById("leaseEndDate");
    const leaseStartDate = leaseStartDateInput ? leaseStartDateInput.value : "";
    const leaseEndDate = leaseEndDateInput ? leaseEndDateInput.value : "";
    
    const monthlyRentInput = document.getElementById("monthlyRentInput");
    const rentFrequencySelect = document.getElementById("rentFrequencySelect");
    const monthlyRent = monthlyRentInput ? monthlyRentInput.value : "";
    const rentFrequency = rentFrequencySelect ? rentFrequencySelect.value : "";
    
    const parkingInput = document.getElementById("parkingInput");
    const parking = parkingInput ? parkingInput.value : "";
    
    const securityDepositInput = document.getElementById("securityDepositInput");
    const securityDeposit = securityDepositInput ? securityDepositInput.value : "";
    
    // Create workbook with normalized format
    const wb = XLSX.utils.book_new();
    
    // Convert flat format to normalized sheets for master data
    const normalized = convertFlatToNormalized(map);
    
    // Add Property sheet
    const propertyWs = XLSX.utils.aoa_to_sheet(normalized.property);
    propertyWs['!cols'] = [
        {wch: 15}, // Property_Tag
        {wch: 40}, // Property_Address
        {wch: 25}, // Landlord_Name
        {wch: 40}, // Landlord_Address
        {wch: 18}  // Landlord_Phone
    ];
    XLSX.utils.book_append_sheet(wb, propertyWs, "Property");
    
    // Add Tenant sheet
    const tenantWs = XLSX.utils.aoa_to_sheet(normalized.tenant);
    tenantWs['!cols'] = [
        {wch: 25}, // Tenant_Name
        {wch: 30}, // Tenant_Email
        {wch: 18}, // Tenant_Phone
        {wch: 40}, // Tenant_Old_Address
        {wch: 40}  // Tenant_Job_Desc
    ];
    XLSX.utils.book_append_sheet(wb, tenantWs, "Tenant");
    
    // Add Manager_Superintendent sheet
    const managerSuperWs = XLSX.utils.aoa_to_sheet(normalized.managerSuper);
    managerSuperWs['!cols'] = [
        {wch: 25}, // Manager_Name
        {wch: 18}, // Manager_Phone
        {wch: 25}, // Superintendent_Name
        {wch: 18}  // Superintendent_Phone
    ];
    XLSX.utils.book_append_sheet(wb, managerSuperWs, "Manager_Superintendent");
    
    // Add Current Lease sheet with transactional data
    const currentLeaseFields = [
        ["Selected_Property", selectedProperty],
        ["Selected_Property_Address", propertyAddress],
        ["Selected_Landlord", selectedLandlord],
        ["Selected_Landlord_Name", landlordName],
        ["Selected_Landlord_Address", landlordAddress],
        ["Property_Type", propertyType],
        ["Lease_Start_Date", leaseStartDate],
        ["Lease_End_Date", leaseEndDate],
        ["Monthly_Rent", monthlyRent],
        ["Rent_Frequency", rentFrequency],
        ["Parking", parking],
        ["Security_Deposit", securityDeposit],
        ["Emergency_Contact_Name", emergencyName],
        ["Emergency_Contact_Email", emergencyEmail],
        ["Emergency_Contact_Phone", emergencyPhone],
    ];
    // Add selected tenant IDs
    selectedTenantIds.forEach((tenantId, index) => {
        currentLeaseFields.push([`Selected_Tenant_${index + 1}_ID`, tenantId.toString()]);
    });
    const currentLeaseWs = XLSX.utils.aoa_to_sheet(currentLeaseFields);
    currentLeaseWs['!cols'] = [{ wch: 35 }, { wch: 50 }];
    XLSX.utils.book_append_sheet(wb, currentLeaseWs, "Current_Lease");
    
    // Extract Inspection Report from page 6/7 (currently displayed data)
    const extractedInspectionData = extractInspectionReportFromPage();
    
    // Add Inspection Report as sheet if available
    if (extractedInspectionData && extractedInspectionData.length > 0) {
        // Use extracted data from page 6/7
        const clonedSheet = XLSX.utils.aoa_to_sheet(extractedInspectionData);
        clonedSheet['!cols'] = [
            {wch: 40}, // Sections
            {wch: 15}, // Begin Code
            {wch: 30}, // Begin Comment
            {wch: 15}, // End Code
            {wch: 30}  // End Comment
        ];
        XLSX.utils.book_append_sheet(wb, clonedSheet, "Inspection_Report");
    } else if (inspectionReportData && inspectionReportData.SheetNames.length > 0) {
        // Fallback to stored inspectionReportData
        const inspectionSheetName = inspectionReportData.SheetNames[0];
        const inspectionSheet = inspectionReportData.Sheets[inspectionSheetName];
        const sheetData = XLSX.utils.sheet_to_json(inspectionSheet, {header: 1, defval: "", raw: false});
        const clonedSheet = XLSX.utils.aoa_to_sheet(sheetData);
        if (inspectionSheet['!cols']) {
            clonedSheet['!cols'] = inspectionSheet['!cols'];
        }
        XLSX.utils.book_append_sheet(wb, clonedSheet, "Inspection_Report");
    }
    
    // Add Lease Records sheet from persisted records
    const records = getLeaseRecords();
    const headers = [
        "Lease_ID","Property_Tag","Landlord","Tenants",
        "Lease_Start_Date","Lease_End_Date","Monthly_Rent",
        "Security_Deposit","Notes","Created_At"
    ];
    const rows = [headers];
    records.forEach(r => rows.push(headers.map(h => r[h] || "")));
    const lrWs = XLSX.utils.aoa_to_sheet(rows);
    lrWs['!cols'] = [
        {wch:20},{wch:12},{wch:25},{wch:40},
        {wch:14},{wch:14},{wch:14},
        {wch:20},{wch:22}
    ];
    XLSX.utils.book_append_sheet(wb, lrWs, "Lease_Records");
    
    // Generate filename: Lease_Property_Tag_Tenants_Firstname_Tenant_FirstName_YYYY_MM_DD.xlsx
    let fileName = "Lease_";
    
    // Add property tag
    if (propertyTag) {
        fileName += propertyTag.replace(/\s+/g, "_") + "_";
    }
    
    // Add tenant first names
    if (selectedTenants.length > 0) {
        const tenantFirstNames = selectedTenants.map(t => {
            const firstName = t.name.split(" ")[0];
            return firstName.replace(/\s+/g, "_");
        });
        fileName += tenantFirstNames.join("_") + "_";
    }
    
    // Add current date YYYY_MM_DD
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    fileName += `${year}_${month}_${day}.xlsx`;
    
    // Generate Excel file and download
    XLSX.writeFile(wb, fileName);
}

// ====== DOWNLOAD LEASE RECORDS LOG ======
function downloadLeaseRecords() {
    const key = "leaseRecords";
    const records = JSON.parse(localStorage.getItem(key) || "[]");
    if (!records || records.length === 0) {
        alert("No finalized lease records found yet.");
        return;
    }
    // Convert array of objects to sheet
    const headers = [
        "Lease_ID","Property_Tag","Landlord","Tenants",
        "Lease_Start_Date","Lease_End_Date","Monthly_Rent",
        "Security_Deposit","Notes","Created_At"
    ];
    const rows = [headers];
    records.forEach(r => {
        rows.push(headers.map(h => r[h] || ""));
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [
        {wch:20},{wch:12},{wch:25},{wch:40},
        {wch:14},{wch:14},{wch:14},
        {wch:16},{wch:50},{wch:22}
    ];
    XLSX.utils.book_append_sheet(wb, ws, "Lease_Records");
    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth()+1).padStart(2,'0');
    const d = String(today.getDate()).padStart(2,'0');
    XLSX.writeFile(wb, `Lease_Records_${y}_${m}_${d}.xlsx`);
}

</script>

</body>
</html>

