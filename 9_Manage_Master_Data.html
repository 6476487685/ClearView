<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Master Data ‚Äî ClearView</title>
  <link rel="stylesheet" href="2_Expanse_Style.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--primary-bg, #f8fafc);
    }
    .master-data-container {
      min-height: 100vh;
      background: var(--primary-bg, #f8fafc);
    }
    .tabs-container {
      display: flex;
      gap: 4px;
      padding: 10px 12px;
      background: var(--card-bg, #ffffff);
      border-bottom: 2px solid var(--border-color, #e2e8f0);
      overflow-x: auto;
      flex-wrap: nowrap;
      justify-content: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .tab {
      padding: 8px 10px;
      background: var(--primary-bg, #f8fafc);
      border: 2px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.75rem;
      color: white;
      transition: all 0.3s ease;
      white-space: nowrap;
      flex: 0 1 auto;
      min-width: fit-content;
      max-width: 140px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
    }
    .tab * {
      position: relative;
      z-index: 1;
    }
    .tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.2);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 6px;
      z-index: 0;
    }
    .tab:hover::before {
      opacity: 1;
    }
    .tab:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .tab.active {
      color: white;
      border: 3px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transform: translateY(-2px);
      animation: pulse-active 0.5s ease, blink-border 1.5s ease-in-out infinite;
    }
    @keyframes pulse-active {
      0% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-3px) scale(1.05); }
      100% { transform: translateY(-2px) scale(1); }
    }
    @keyframes blink-border {
      0%, 100% { border-color: rgba(255, 255, 255, 0.8); box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 0 0 rgba(255, 255, 255, 0.5); }
      50% { border-color: rgba(255, 255, 255, 1); box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 0 4px rgba(255, 255, 255, 0.3); }
    }
    
    /* Individual tab colors */
    .tab[data-tab="income"] {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-color: #10b981;
    }
    .tab[data-tab="income"].active {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }
    
    .tab[data-tab="expense"] {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      border-color: #f59e0b;
    }
    .tab[data-tab="expense"].active {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    }
    
    .tab[data-tab="investment"] {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      border-color: #8b5cf6;
    }
    .tab[data-tab="investment"].active {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
    }
    
    .tab[data-tab="task"] {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      border-color: #06b6d4;
    }
    .tab[data-tab="task"].active {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
    }
    
    .tab[data-tab="common"] {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #3b82f6;
    }
    .tab[data-tab="common"].active {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    }
    
    .tab[data-tab="bank-accounts"] {
      background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
      border-color: #ec4899;
    }
    .tab[data-tab="bank-accounts"].active {
      background: linear-gradient(135deg, #db2777 0%, #be185d 100%);
    }
    
    .tab[data-tab="trading-accounts"] {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      border-color: #14b8a6;
    }
    .tab[data-tab="trading-accounts"].active {
      background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
    }
    
    .tab[data-tab="properties"] {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      border-color: #f97316;
    }
    .tab[data-tab="properties"].active {
      background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
    }
    
    .tab[data-tab="credit-cards"] {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      border-color: #6366f1;
    }
    .tab[data-tab="credit-cards"].active {
      background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
    }
    
    .tab[data-tab="tenants"] {
      background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
      border-color: #a855f7;
    }
    .tab[data-tab="tenants"].active {
      background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
    }
    
    .tab[data-tab="paths"] {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      border-color: #64748b;
    }
    .tab[data-tab="paths"].active {
      background: linear-gradient(135deg, #475569 0%, #334155 100%);
    }
    
    /* Ensure active tabs have white text */
    .tab.active {
      color: white !important;
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
    .two-column-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 1562px;
      margin: 0 auto;
    }
    .field-card {
      background: var(--card-bg, #ffffff);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .field-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color, #e2e8f0);
    }
    .field-name {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-primary, #1e293b);
    }
    .field-count {
      font-size: 0.85rem;
      color: var(--text-secondary, #64748b);
      font-weight: 500;
    }
    .values-container {
      /* show ~4 rows with vertical scroll for better placement */
      max-height: 208px;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    .value-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      margin-bottom: 4px;
      background: var(--primary-bg, #f8fafc);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      transition: all 0.2s;
    }
    .value-row:hover {
      border-color: var(--accent-blue, #3b82f6);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .value-text {
      flex: 1;
      color: var(--text-primary, #1e293b);
      font-size: 0.95rem;
      padding-right: 10px;
    }
    .value-row.sqa-row {
      justify-content: flex-start;
      gap: 8px;
      align-items: center;
    }
    .value-row.sqa-row .value-actions {
      margin-left: auto;
      flex-shrink: 0;
    }
    .value-text.sqa-question {
      flex: 0 0 80%;
      font-size: 0.82rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .value-text.sqa-answer {
      flex: 0 0 15%;
      font-size: 0.75rem;
      text-align: right;
      color: var(--text-secondary, #64748b);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .value-actions {
      display: flex;
      gap: 6px;
    }
    .btn-icon {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-edit {
      background: var(--accent-blue, #3b82f6);
      color: white;
    }
    .btn-edit:hover {
      background: #2563eb;
    }
    .btn-delete {
      background: #ef4444;
      color: white;
    }
    .btn-delete:hover {
      background: #dc2626;
    }
    .add-form {
      display: flex;
      gap: 8px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color, #e2e8f0);
    }
    .add-form.sqa-add {
      align-items: center;
    }
    .add-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      font-size: 0.95rem;
      background: var(--card-bg, #ffffff);
      color: var(--text-primary, #1e293b);
    }
    .sqa-input-question {
      flex: 0 0 80%;
      font-size: 0.9rem;
    }
    .sqa-input-answer {
      flex: 0 0 15%;
      font-size: 0.85rem;
    }
    .add-input:focus {
      outline: none;
      border-color: var(--accent-blue, #3b82f6);
    }
    .btn-add {
      padding: 10px 20px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .btn-add:hover {
      background: #059669;
    }
    .empty-field {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary, #64748b);
      font-style: italic;
    }
    /* Modal for editing */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: var(--card-bg, #ffffff);
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .modal-header {
      margin-bottom: 20px;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary, #1e293b);
    }
    .modal-body input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      font-size: 1rem;
      margin-bottom: 20px;
      background: var(--card-bg, #ffffff);
      color: var(--text-primary, #1e293b);
    }
    .modal-body input:focus {
      outline: none;
      border-color: var(--accent-blue, #3b82f6);
    }
    .sqa-edit-group {
      display: none;
      gap: 10px;
      margin-top: 10px;
    }
    .sqa-edit-group input {
      flex: 1;
      margin-bottom: 0;
      font-size: 0.95rem;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .btn-secondary {
      background: var(--text-secondary, #64748b);
      color: white;
    }
    .btn-secondary:hover {
      background: #475569;
    }
    .btn-primary {
      background: var(--accent-blue, #3b82f6);
      color: white;
    }
    .btn-primary:hover {
      background: #2563eb;
    }
    @media (max-width: 1200px) {
      .two-column-grid {
        grid-template-columns: 1fr;
      }
    }
    .values-container::-webkit-scrollbar {
      width: 8px;
    }
    .values-container::-webkit-scrollbar-track {
      background: var(--primary-bg, #f8fafc);
      border-radius: 4px;
    }
    .values-container::-webkit-scrollbar-thumb {
      background: var(--text-secondary, #64748b);
      border-radius: 4px;
    }
    .values-container::-webkit-scrollbar-thumb:hover {
      background: var(--accent-blue, #3b82f6);
    }
    /* Paths tab styles */
    .paths-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .path-section {
      background: var(--card-bg, #ffffff);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .path-title {
      margin: 0 0 15px 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary, #1e293b);
    }
    .path-display {
      background: var(--primary-bg, #f8fafc);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      color: var(--text-primary, #1e293b);
      word-break: break-all;
      min-height: 20px;
    }
    .path-display:empty::before {
      content: "Not set";
      color: var(--text-secondary, #64748b);
      font-style: italic;
    }
    .path-input-group {
      display: flex;
      gap: 10px;
    }
    .path-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      font-size: 0.95rem;
      background: var(--card-bg, #ffffff);
      color: var(--text-primary, #1e293b);
    }
    .path-input:focus {
      outline: none;
      border-color: var(--accent-blue, #3b82f6);
    }
  </style>
</head>
<body>
  <!-- Header matching dashboard style -->
  <header class="header">
    <div class="left">
      <button class="black" onclick="window.location.href='index.html'">‚Üê Back to Main Dashboard</button>
    </div>
    <div class="title">Manage Master Data</div>
    <div class="right">
      <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display:none;">
      <button class="excel" id="btnLoadFromD" type="button" title="Upload Excel File">üì§ Load from D:</button>
      <button class="excel" id="btnDownloadExcel" type="button" title="Download Current Master Data to Excel">üì• Download Master Data</button>
      <button class="danger" id="btnClearData" style="background:#ea4335;color:white;" title="It deletes all Master Data">üóëÔ∏è Clear All Data</button>
    </div>
  </header>
  <div id="lastFileInfo" style="margin:8px auto 0 auto;max-width:1400px;padding:8px 12px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;font-size:0.9rem;line-height:1.4;background:rgba(59,130,246,0.08);color:var(--accent-blue, #3b82f6);font-weight:600;border:1px solid rgba(59,130,246,0.25);">
    <span id="filePathDisplay" style="text-align:left;">Not set</span>
    <span id="fileNameDisplay" style="text-align:right;">No file loaded</span>
  </div>

  <div class="master-data-container">
    <!-- Tabs -->
    <div class="tabs-container">
      <div class="tab active" data-tab="task">‚úÖ Task</div>
      <div class="tab" data-tab="expense">üí∞ Expense</div>
      <div class="tab" data-tab="income">üìä Income</div>
      <div class="tab" data-tab="investment">üìà Investment</div>
      <div class="tab" data-tab="common">üåê Shared Attributes</div>
      <div class="tab" data-tab="credit-cards">üí≥ Credit Cards</div>
      <div class="tab" data-tab="bank-accounts">üè¶ Bank A/c</div>
      <div class="tab" data-tab="trading-accounts">üìä Trading A/c</div>
      <div class="tab" data-tab="properties">üè† Properties</div>
      <div class="tab" data-tab="tenants">üë• Tenants</div>
      <div class="tab" data-tab="paths">üîß Paths</div>
    </div>

    <!-- Tab Contents -->
    <div id="taskContent" class="tab-content active">
      <div class="two-column-grid" id="taskGrid"></div>
    </div>

    <div id="expenseContent" class="tab-content">
      <div class="two-column-grid" id="expenseGrid"></div>
    </div>

    <div id="incomeContent" class="tab-content">
      <div class="two-column-grid" id="incomeGrid"></div>
    </div>

    <div id="investmentContent" class="tab-content">
      <div class="two-column-grid" id="investmentGrid"></div>
    </div>

    <div id="commonContent" class="tab-content">
      <div class="two-column-grid" id="commonGrid"></div>
    </div>

    <div id="bank-accountsContent" class="tab-content">
      <div class="two-column-grid" id="bank-accountsGrid"></div>
    </div>

    <div id="trading-accountsContent" class="tab-content">
      <div class="two-column-grid" id="trading-accountsGrid"></div>
    </div>

    <div id="propertiesContent" class="tab-content">
      <div class="two-column-grid" id="propertiesGrid"></div>
    </div>

    <div id="credit-cardsContent" class="tab-content">
      <div class="two-column-grid" id="credit-cardsGrid"></div>
    </div>

    <div id="tenantsContent" class="tab-content">
      <div class="two-column-grid" id="tenantsGrid"></div>
    </div>

    <div id="pathsContent" class="tab-content">
      <div class="paths-container" id="pathsContainer">
        <div class="path-section">
          <h3 class="path-title">üìä Master Data File</h3>
          <div class="path-display" id="masterDataFileDisplay">Not set</div>
          <div class="path-input-group">
            <input type="text" id="masterDataFileInput" class="path-input" placeholder="Enter Excel file path (e.g., D:\Projects\MasterData.xlsx)">
            <button class="btn btn-primary" onclick="chooseMasterDataFile()">üìÅ Choose File</button>
          </div>
        </div>
        <div class="path-section">
          <h3 class="path-title">üìÅ Project Backup Folder</h3>
          <div class="path-display" id="backupPathDisplay">Not set</div>
          <div class="path-input-group">
            <input type="text" id="backupPathInput" class="path-input" placeholder="Enter backup folder path (e.g., D:\Projects\Backup)">
            <button class="btn btn-primary" onclick="chooseBackupFolder()">üìÅ Choose Folder</button>
          </div>
        </div>
        <div class="path-section">
          <h3 class="path-title">üìÑ Project Documents Folder</h3>
          <div class="path-display" id="documentsPathDisplay">Not set</div>
          <div class="path-input-group">
            <input type="text" id="documentsPathInput" class="path-input" placeholder="Enter documents folder path (e.g., D:\Projects\Documents)">
            <button class="btn btn-primary" onclick="chooseDocumentsFolder()">üìÅ Choose Folder</button>
          </div>
        </div>
        <div class="path-section">
          <h3 class="path-title">‚¨áÔ∏è Project Downloads Folder</h3>
          <div class="path-display" id="downloadsPathDisplay">Not set</div>
          <div class="path-input-group">
            <input type="text" id="downloadsPathInput" class="path-input" placeholder="Enter downloads folder path (e.g., D:\Projects\Downloads)">
            <button class="btn btn-primary" onclick="chooseDownloadsFolder()">üìÅ Choose Folder</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">Edit Value</div>
      <div class="modal-body">
        <input type="text" id="editInput" placeholder="Enter value">
        <div id="editSqaGroup" class="sqa-edit-group">
          <input type="text" id="editQuestionInput" placeholder="Security question">
          <input type="text" id="editAnswerInput" placeholder="Answer (optional)">
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEditedValue()">Save</button>
      </div>
    </div>
  </div>

  <!-- Critical script runs first, before XLSX library -->
  <script>
    console.log('=== Critical script loading ===');
    
    // Define path selection functions immediately so they're available for onclick
    window.chooseMasterDataFile = async function() {
      console.log('chooseMasterDataFile called');
      try {
        if ('showOpenFilePicker' in window) {
          const [fileHandle] = await window.showOpenFilePicker({
            types: [{
              description: 'Excel Files',
              accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] }
            }]
          });
          const file = await fileHandle.getFile();
          const path = prompt('File selected: ' + file.name + '\n\nDue to browser security limitations, you need to enter the full path manually:\n(e.g., D:\\Projects\\' + file.name, file.name);
          if (path && path.trim()) {
            localStorage.setItem('project_master_data_file', path.trim());
            const folderPath = path.substring(0, path.lastIndexOf('\\'));
            if (folderPath) {
              localStorage.setItem('project_master_data_folder', folderPath);
            }
            alert('Master Data File path saved!');
            // Update display immediately
            const display = document.getElementById('masterDataFileDisplay');
            const input = document.getElementById('masterDataFileInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        } else {
          const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Master Data Excel file:\n(e.g., D:\\Projects\\MasterData.xlsx)', 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_master_data_file', path.trim());
            const folderPath = path.substring(0, path.lastIndexOf('\\'));
            if (folderPath) {
              localStorage.setItem('project_master_data_folder', folderPath);
            }
            alert('Master Data File path saved!');
            // Update display immediately
            const display = document.getElementById('masterDataFileDisplay');
            const input = document.getElementById('masterDataFileInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      } catch (err) {
        if (err.name !== 'AbortError') {
          const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Master Data Excel file:\n(e.g., D:\\Projects\\MasterData.xlsx)', 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_master_data_file', path.trim());
            alert('Master Data File path saved!');
            // Update display immediately
            const display = document.getElementById('masterDataFileDisplay');
            const input = document.getElementById('masterDataFileInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      }
    };

    window.chooseBackupFolder = async function() {
      console.log('chooseBackupFolder called');
      try {
        if ('showDirectoryPicker' in window) {
          const dirHandle = await window.showDirectoryPicker();
          const path = prompt('Folder selected: ' + dirHandle.name + '\n\nDue to browser security limitations, you need to enter the full path manually:\n(e.g., D:\\Projects\\' + dirHandle.name, 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_backup_path', path.trim());
            alert('Backup folder path saved!');
            // Update display immediately
            const display = document.getElementById('backupPathDisplay');
            const input = document.getElementById('backupPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        } else {
          const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Backup folder:\n(e.g., D:\\Projects\\Backup)', 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_backup_path', path.trim());
            alert('Backup folder path saved!');
            // Update display immediately
            const display = document.getElementById('backupPathDisplay');
            const input = document.getElementById('backupPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      } catch (err) {
        if (err.name !== 'AbortError') {
            const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Backup folder:\n(e.g., D:\\Projects\\Backup)', 'D:\\');
            if (path && path.trim()) {
              localStorage.setItem('project_backup_path', path.trim());
              alert('Backup folder path saved!');
            // Update display immediately
            const display = document.getElementById('backupPathDisplay');
            const input = document.getElementById('backupPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      }
    };

    window.chooseDocumentsFolder = async function() {
      console.log('chooseDocumentsFolder called');
      try {
        if ('showDirectoryPicker' in window) {
          const dirHandle = await window.showDirectoryPicker();
          const path = prompt('Folder selected: ' + dirHandle.name + '\n\nDue to browser security limitations, you need to enter the full path manually:\n(e.g., D:\\Projects\\' + dirHandle.name, 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_documents_path', path.trim());
            alert('Documents folder path saved!');
            // Update display immediately
            const display = document.getElementById('documentsPathDisplay');
            const input = document.getElementById('documentsPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        } else {
          const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Documents folder:\n(e.g., D:\\Projects\\Documents)', 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_documents_path', path.trim());
            alert('Documents folder path saved!');
            // Update display immediately
            const display = document.getElementById('documentsPathDisplay');
            const input = document.getElementById('documentsPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      } catch (err) {
        if (err.name !== 'AbortError') {
            const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Documents folder:\n(e.g., D:\\Projects\\Documents)', 'D:\\');
            if (path && path.trim()) {
              localStorage.setItem('project_documents_path', path.trim());
              alert('Documents folder path saved!');
            // Update display immediately
            const display = document.getElementById('documentsPathDisplay');
            const input = document.getElementById('documentsPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      }
    };

    window.chooseDownloadsFolder = async function() {
      console.log('chooseDownloadsFolder called');
      const path = prompt('Enter the full path to the Downloads folder:\n(e.g., D:\\Projects\\Downloads)', localStorage.getItem('project_downloads_path') || 'D:\\');
      if (path && path.trim()) {
        localStorage.setItem('project_downloads_path', path.trim());
        alert('Downloads folder path saved!');
        // Update display immediately
        const display = document.getElementById('downloadsPathDisplay');
        const input = document.getElementById('downloadsPathInput');
        if (display) display.textContent = path.trim();
        if (input) input.value = path.trim();
      }
    };
    
    // Define openFilePicker immediately - this must work regardless of XLSX library
    window.openFilePicker = function(){
      console.log('openFilePicker called');
      const input = document.getElementById('excelFileInput');
      if(!input){ 
        alert('File input not found'); 
        console.error('File input element not found');
          return;
        }
      console.log('File input found, opening picker');
      try{
        input.click();
        console.log('File picker triggered');
      }catch(err){
        console.error('Error opening file picker:', err);
        alert('Error opening file picker: ' + err.message);
      }
    };
    
    console.log('openFilePicker function defined');
    
    // Attach button listener here as well (early), so it works even if other scripts fail
    (function attachEarlyButtonListener(){
      function tryAttach(){
        const btn = document.getElementById('btnLoadFromD');
        if (btn) {
          btn.onclick = function(e){
            e.preventDefault();
            e.stopPropagation();
            window.openFilePicker();
          };
          console.log('Early button listener attached');
          return true;
        }
        return false;
      }
      if (!tryAttach()) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', tryAttach, { once: true });
        } else {
          setTimeout(tryAttach, 50);
        }
      }
    })();

    // Store folder path variable - persists until file is reloaded
    window.lastExcelFolderPath = localStorage.getItem('last_excel_folder_path') || '';
    
    // Early minimal change handler to verify file selection and XLSX availability
    (function attachEarlyChangeHandler(){
      const input = document.getElementById('excelFileInput');
      if (!input) return;
      input.addEventListener('change', function(e){
        const f = e.target.files && e.target.files[0];
        console.log('Early handler: file selected?', !!f, f ? f.name : '');
        if (!window.XLSX) {
          console.warn('Early handler: XLSX not loaded yet');
          return;
        }
        if (!f) return;
        
        // Try to capture folder path from file input (may be limited by browser security)
        let folderPath = '';
        try {
          // File System Access API provides better path info if available
          if (f.path) {
            // Chrome/Edge may provide this
            const fullPath = f.path || '';
            const pathParts = fullPath.split('\\');
            pathParts.pop(); // Remove filename
            folderPath = pathParts.join('\\');
          }
          
          // If path not available, try to get from input value (often stripped but worth trying)
          const inputValue = e.target.value || '';
          if (inputValue && !folderPath) {
            // Extract folder path from input value (format: "C:\path\to\file.xlsx")
            // Skip if it's the fake path browsers show for security
            if (!inputValue.includes('fakepath') && !inputValue.toLowerCase().includes('c:\\fakepath')) {
              const match = inputValue.match(/^(.+)[\\\/][^\\\/]+$/);
              if (match && match[1]) {
                folderPath = match[1];
                // Double check it's not a fake path
                if (folderPath.toLowerCase().includes('fakepath')) {
                  folderPath = '';
                }
              }
            }
          }
          
          // If still no path, prompt user once
          if (!folderPath && !window.lastExcelFolderPath) {
            folderPath = prompt(`File "${f.name}" selected.\n\nEnter the folder path where this file is located:`, 'D:\\');
            if (folderPath) {
              folderPath = folderPath.trim().replace(/[\\\/]+$/, ''); // Remove trailing slashes
            }
          } else if (!folderPath && window.lastExcelFolderPath) {
            // Reuse last known folder path
            folderPath = window.lastExcelFolderPath;
          }
          
          // Store folder path
          if (folderPath) {
            window.lastExcelFolderPath = folderPath;
            localStorage.setItem('last_excel_folder_path', folderPath);
            console.log('Folder path captured:', folderPath);
          }
        } catch (err) {
          console.warn('Could not capture folder path:', err);
        }
        try{
          const reader = new FileReader();
          reader.onload = function(ev){
            try{
              const data = new Uint8Array(ev.target.result);
              const wb = XLSX.read(data, { type: 'array' });
              const sheetNames = wb.SheetNames || [];
              console.log('[Early] Sheets:', sheetNames);
              // Minimal mapping used only as fallback
              const MAP = {
                expense: { Expanse_Category: 'Expanse_Category', Expanse_Ac_Tag: 'Expanse_Ac_Tag' },
                income: { Income_Category: 'Income_Category', Income_Ac_Tag: 'Income_Ac_Tag' },
                investment: { Investment_Category: 'Investment_Category', Investment_Ac_Tag: 'Investment_Ac_Tag' },
                task: { Task_Category: 'Task_Category', Task_Status: 'Task_Status', Task_Assignee: 'Task_Assignee', Task_Priority: 'Task_Priority', Task_Adhoc: 'Task_Adhoc' },
                common: { Currency: 'Currency', Mode: 'Mode', Status_Txn: 'Status_Txn', Ac_Holder: 'Ac_Holder', Frequency: 'Frequency', Ac_Status: 'Ac_Status', Ac_Classification: 'Ac_Classification', Country: 'Country', Institution: 'Institution', Ac_Type: 'Ac_Type' }
              };
              const VARIANTS = {
                Mode_Txn: { module: 'common', key: 'Mode' },
                Txn_Mode: { module: 'common', key: 'Mode' },
                Expense_Category: { module: 'expense', key: 'Expanse_Category' },
                Expense_Ac_Tag: { module: 'expense', key: 'Expanse_Ac_Tag' },
                Expense_Tag: { module: 'expense', key: 'Expanse_Ac_Tag' },
                Investment_Tag: { module: 'investment', key: 'Investment_Ac_Tag' },
                Task_Tag: { module: 'common', key: 'Country' },
                Country: { module: 'common', key: 'Country' }
              };
              let unified = { task:{}, expense:{}, income:{}, investment:{}, common:{}, tenants:{}, 'bank-accounts':{}, 'trading-accounts':{}, properties:{}, 'credit-cards':{} };
              // Merge existing if present
              try{ const existing = JSON.parse(localStorage.getItem('unified_master_data')||'null'); if (existing) unified = existing; }catch(_){ }

              // Handle Paths sheet if it exists
              if (sheetNames.includes('Paths')) {
                const pathsSheet = wb.Sheets['Paths'];
                const pathsData = XLSX.utils.sheet_to_json(pathsSheet);
                pathsData.forEach(row => {
                  const pathType = String(row['Path Type'] || '').trim();
                  const path = String(row['Path'] || '').trim();
                  if (pathType && path) {
                    let storageKey = null;
                    if (pathType === 'Master Data File') storageKey = 'project_master_data_file';
                    else if (pathType === 'Backup Path') storageKey = 'project_backup_path';
                    else if (pathType === 'Documents Path') storageKey = 'project_documents_path';
                    else if (pathType === 'Downloads Path') storageKey = 'project_downloads_path';
                    if (storageKey) localStorage.setItem(storageKey, path);
                  }
                });
              }

              sheetNames.forEach(name => {
                // Skip Txn_* except Mode/Status
                if (name.startsWith('Txn_') && !name.includes('Mode') && !name.includes('Status')) return;
                
                if (name === 'SQA') {
                  const sheet = wb.Sheets[name];
                  if (sheet) {
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    const items = rows.map(row => {
                      const question = extractSqaQuestion(row);
                      const answer = extractSqaAnswer(row);
                      if (!question && !answer) return null;
                      return answer ? `${question} ‚Äî ${answer}` : question;
                    }).filter(Boolean);
                    if (items.length) {
                      if (!unified.common.SQA) unified.common.SQA = [];
                      unified.common.SQA = Array.from(new Set([...(unified.common.SQA || []), ...items]));
                      console.log(`[Early] Loaded ${items.length} entries into common.SQA`);
                    }
                  }
                  return;
                }
                
                // NEW: Handle merged sheets (Ac_Category, Ac_Tag)
                if (name === 'Ac_Category' || name === 'Ac_Tag') {
                  const sheet = wb.Sheets[name];
                  const rows = XLSX.utils.sheet_to_json(sheet);
                  if (!rows || !rows.length) return;
                  
                  const mainCol = name === 'Ac_Category' ? 'Ac_Category' : 'Ac_Tag';
                  const classCol = 'Ac_Classification';
                  const cols = Object.keys(rows[0]);
                  
                  if (!cols.includes(mainCol) || !cols.includes(classCol)) return;
                  
                  const incomeVals = [], investVals = [], expVals = [], tenantVals = [];
                  rows.forEach(r => {
                    const val = String(r[mainCol]||'').trim();
                    const cls = String(r[classCol]||'').trim();
                    if (!val) return;
                    if (cls === 'Income') incomeVals.push(val);
                    else if (cls === 'Investment') investVals.push(val);
                    else if (cls === 'Expanse' || cls === 'Expense') expVals.push(val);
                    else if (cls === 'Tenant') tenantVals.push(val);
                  });
                  
                  let incKey, invKey, expKey, tenKey;
                  if (name === 'Ac_Category') {
                    incKey = 'Income_Category'; invKey = 'Investment_Category'; expKey = 'Expanse_Category'; tenKey = 'Tenant_Category';
                  } else {
                    incKey = 'Income_Ac_Tag'; invKey = 'Investment_Ac_Tag'; expKey = 'Expanse_Ac_Tag'; tenKey = 'Tenant_Ac_Tag';
                  }
                  
                  ['income', 'investment', 'expense', 'tenants'].forEach(m => {
                    const v = m === 'income' ? incomeVals : (m === 'investment' ? investVals : (m === 'expense' ? expVals : tenantVals));
                    const k = m === 'income' ? incKey : (m === 'investment' ? invKey : (m === 'expense' ? expKey : tenKey));
                    if (!unified[m][k]) unified[m][k] = [];
                    unified[m][k] = Array.from(new Set([...(unified[m][k]||[]), ...v])).sort();
                    console.log(`[Early] Loaded ${v.length} ${m} from ${name}`);
                  });
                  return;
                }
                
                let mod=null,key=null;
                if (MAP.expense[name]){ mod='expense'; key=name; }
                else if (MAP.income[name]){ mod='income'; key=name; }
                else if (MAP.investment[name]){ mod='investment'; key=name; }
                else if (MAP.task[name]){ mod='task'; key=name; }
                else if (MAP.common[name]){ mod='common'; key=name; }
                else if (VARIANTS[name]){ mod=VARIANTS[name].module; key=VARIANTS[name].key; }
                else if (name === 'Mode' || name === 'Status_Txn' || name === 'Ac_Classification' || name === 'Institution' || name === 'Ac_Type'){ mod='common'; key=name; }
                if (!mod || !key) return;
                const sheet = wb.Sheets[name];
                const rows = XLSX.utils.sheet_to_json(sheet);
                if (!rows || !rows.length) return;
                // Column selection: prefer matching column name else first
                const firstRow = rows[0];
                const cols = Object.keys(firstRow);
                let col = cols.find(c=>c.toLowerCase()===name.toLowerCase()) || cols.find(c=>c.toLowerCase().includes(key.toLowerCase())) || cols[0];
                const values = rows.map(r=>String(r[col]??'').trim()).filter(v=>v);
                if (!unified[mod][key]) unified[mod][key]=[];
                unified[mod][key] = Array.from(new Set([...(unified[mod][key]||[]), ...values])).sort();
                console.log(`[Early] Loaded ${values.length} into ${mod}.${key}`);
              });
              normalizeSqaValues(unified);
              localStorage.setItem('unified_master_data', JSON.stringify(unified));
              localStorage.setItem('last_excel_file_loaded', f.name);
              localStorage.setItem('last_excel_file_source', 'D:');
              
              // Store folder path if captured
              if (window.lastExcelFolderPath) {
                localStorage.setItem('last_excel_folder_path', window.lastExcelFolderPath);
              }
              
              // Update display immediately if function exists
              if (typeof updateLastFileDisplay === 'function') {
                updateLastFileDisplay();
              }
              // Build detailed summary
              const totalSheets = sheetNames.length;
              const transactionalSheets = sheetNames.filter(s => s.startsWith('Txn_') && !s.includes('Mode') && !s.includes('Status')).length;
              const hasPathsSheet = sheetNames.includes('Paths');
              const masterDataSheets = sheetNames.length - transactionalSheets - (hasPathsSheet ? 1 : 0);
              const moduleFieldCounts = {
                income: Object.keys(unified.income||{}).length,
                expense: Object.keys(unified.expense||{}).length,
                investment: Object.keys(unified.investment||{}).length,
                task: Object.keys(unified.task||{}).length,
                common: Object.keys(unified.common||{}).length
              };
              const moduleValueCounts = {
                income: Object.values(unified.income||{}).reduce((a,b)=>a+(b?b.length:0),0),
                expense: Object.values(unified.expense||{}).reduce((a,b)=>a+(b?b.length:0),0),
                investment: Object.values(unified.investment||{}).reduce((a,b)=>a+(b?b.length:0),0),
                task: Object.values(unified.task||{}).reduce((a,b)=>a+(b?b.length:0),0),
                common: Object.values(unified.common||{}).reduce((a,b)=>a+(b?b.length:0),0)
              };
              const summaryMsg =
                `Successfully imported master data from Excel file!\n\n`+
                `Total sheets in file: ${totalSheets}\n`+
                `Transactional sheets skipped: ${transactionalSheets}\n`+
                `Master data sheets processed: ${masterDataSheets}${hasPathsSheet ? ' + Paths' : ''}\n\n`+
                `Fields loaded ‚Äî Income: ${moduleFieldCounts.income}, Expense: ${moduleFieldCounts.expense}, Investment: ${moduleFieldCounts.investment}, Task: ${moduleFieldCounts.task}, Shared Attributes: ${moduleFieldCounts.common}${hasPathsSheet ? ', Paths: 4' : ''}\n`+
                (!localStorage.getItem('project_backup_path') || !localStorage.getItem('project_documents_path') || !localStorage.getItem('project_downloads_path')
                  ? `\n\n‚ö†Ô∏è Please set Project Paths in the "Set/Change Paths" tab!`
                  : '');

              // If main helpers are available, render immediately without reload
              if (typeof window !== 'undefined' && typeof saveMasterData === 'function' && typeof renderTab === 'function') {
                try {
                  window.masterData = unified;
                  saveMasterData();
                  if (typeof updateLastFileDisplay === 'function') updateLastFileDisplay();
                  const currentTab = (document.querySelector('.tab.active')||{getAttribute:()=> 'income'}).getAttribute('data-tab');
                  renderTab(currentTab || 'income');
                  alert(summaryMsg);
                } catch (e) {
                  console.warn('Immediate render failed, reloading...', e);
                  alert(summaryMsg + '\n\nReloading to render.');
                  location.reload();
                }
              } else {
                alert(summaryMsg + '\n\nReloading to render.');
                location.reload();
              }
            }catch(err){
              console.error('[Early] Parse error:', err);
              alert('Error reading Excel (early): ' + err.message);
            }
          };
          reader.readAsArrayBuffer(f);
        }catch(err){
          console.error('[Early] Reader error:', err);
          alert('Error: '+err.message);
        }
      });
    })();

    // Provide minimal fallback rendering if main script did not attach functions
    (function ensureFallbackRender(){
      if (typeof window.renderTab === 'function') return; // main script present
      console.warn('Main render functions missing; installing fallback renderer');
      // Basic structure mirrors the confirmed fields
      const FB_STRUCTURE = {
        expense: { 'Expanse_Category':'Expense Category', 'Expanse_Ac_Tag':'Expense Account Tag' },
        income: { 'Income_Category':'Income Category', 'Income_Ac_Tag':'Income Account Tag' },
        investment: { 'Investment_Category':'Investment Category', 'Investment_Ac_Tag':'Investment Account Tag' },
        task: { 'Task_Tag':'Task Tag','Task_Status':'Task Status','Task_Assignee':'Task Assignee','Task_Priority':'Task Priority','Task_Category':'Task Category','Task_Adhoc':'Task Adhoc' },
        common: {
          'Currency':'Currency',
          'Mode':'Mode',
          'Status_Txn':'Transaction Status',
          'Ac_Holder':'Account Holder',
          'Frequency':'Frequency',
          'Ac_Status':'Account Status',
          'Ac_Classification':'Account Classification',
          'Email':'Email Addresses',
          'Phone':'Phone Numbers',
          'SQA':'Security Questions & Answers'
        },
        'bank-accounts': {},
        'trading-accounts': {},
        'properties': {},
        'credit-cards': {},
        'tenants': { 'Tenant_Category':'Tenant Category', 'Tenant_Ac_Tag':'Tenant Account Tag' }
      };
      window.initializeMasterData = function(){
        const data = window.masterData || {};
        ['expense','income','investment','task','common','bank-accounts','trading-accounts','properties','credit-cards','tenants'].forEach(m => {
          if (!data[m]) data[m] = {};
          Object.keys(FB_STRUCTURE[m] || {}).forEach(k => { if (!Array.isArray(data[m][k])) data[m][k] = []; });
        });
        normalizeSqaValues(data);
        window.masterData = data;
      };
      window.saveMasterData = function(){
        localStorage.setItem('unified_master_data', JSON.stringify(window.masterData||{}));
      };
      function createFieldCard(module, fieldKey, label){
        const card = document.createElement('div');
        card.className = 'field-card';
        const header = document.createElement('div');
        header.className = 'field-header';
        const values = ((window.masterData||{})[module]||{})[fieldKey] || [];
        header.innerHTML = `<span class="field-name">${fieldKey} (${values.length}) <--> ${label}</span>`;
        card.appendChild(header);
        const valuesContainer = document.createElement('div');
        valuesContainer.className = 'values-container';
        if (values.length === 0){
          valuesContainer.innerHTML = '<div class="empty-field">No entries yet</div>';
        } else {
          values.forEach((v, idx) => {
            const isSqa = fieldKey === 'SQA';
            const row = document.createElement('div');
            row.className = isSqa ? 'value-row sqa-row' : 'value-row';
            if (isSqa) {
              const parsed = (window.parseSqaValue||defaultParseSqaValue)(v);
              const q = escapeHtml(parsed.question||'');
              const a = escapeHtml(parsed.answer||'');
              row.innerHTML = `
                <span class="value-text sqa-question" title="${q}">${q || '‚Äî'}</span>
                <span class="value-text sqa-answer" title="${a}">${a || '‚Äî'}</span>
                <div class="value-actions">
                  <button class="btn-icon btn-edit" onclick="(window.editValue||window.__fb_editValue)('${module}','${fieldKey}',${idx})">Edit</button>
                  <button class="btn-icon btn-delete" onclick="(window.deleteValue||window.__fb_deleteValue)('${module}','${fieldKey}',${idx})">Delete</button>
                </div>`;
            } else {
              row.innerHTML = `
                <span class="value-text">${escapeHtml(v)}</span>
                <div class="value-actions">
                  <button class="btn-icon btn-edit" onclick="(window.editValue||window.__fb_editValue)('${module}','${fieldKey}',${idx})">Edit</button>
                  <button class="btn-icon btn-delete" onclick="(window.deleteValue||window.__fb_deleteValue)('${module}','${fieldKey}',${idx})">Delete</button>
                </div>`;
            }
            valuesContainer.appendChild(row);
          });
        }
        card.appendChild(valuesContainer);
        // Add form
        const addForm = document.createElement('div');
        if (fieldKey === 'SQA') {
          addForm.className = 'add-form sqa-add';
          addForm.innerHTML = `
            <input type="text" class="add-input sqa-input-question" id="add_${module}_${fieldKey}_question" placeholder="Security question" onkeypress="if(event.key==='Enter')(window.addValue||window.__fb_addValue)('${module}','${fieldKey}')">
            <input type="text" class="add-input sqa-input-answer" id="add_${module}_${fieldKey}_answer" placeholder="Answer (optional)" onkeypress="if(event.key==='Enter')(window.addValue||window.__fb_addValue)('${module}','${fieldKey}')">
            <button class="btn-add" onclick="(window.addValue||window.__fb_addValue)('${module}','${fieldKey}')">Add</button>`;
        } else {
          addForm.className = 'add-form';
          addForm.innerHTML = `
            <input type="text" class="add-input" id="add_${module}_${fieldKey}" placeholder="Add new ${label.toLowerCase()}" onkeypress="if(event.key==='Enter')(window.addValue||window.__fb_addValue)('${module}','${fieldKey}')">
            <button class="btn-add" onclick="(window.addValue||window.__fb_addValue)('${module}','${fieldKey}')">Add</button>`;
        }
        card.appendChild(addForm);
        return card;
      }
      // Fallback add/edit/delete if main ones are missing
      if (typeof window.editValue !== 'function') {
        window.__fb_editValue = function(module, fieldKey, index){
          const arr = ((window.masterData||{})[module]||{})[fieldKey]||[];
          const curr = arr[index] || '';
          let val = '';
          if (fieldKey === 'SQA') {
            const parsed = (window.parseSqaValue||defaultParseSqaValue)(curr);
            const question = prompt('Edit security question', parsed.question||'');
            if (question === null) return;
            const trimmedQuestion = String(question).trim();
            if (!trimmedQuestion) { alert('Question cannot be empty'); return; }
            const answer = prompt('Edit answer (optional)', parsed.answer||'');
            if (answer === null) return;
            val = formatSqaValue(trimmedQuestion, String(answer).trim());
          } else {
            const nv = prompt('Edit value', curr);
            if (nv===null) return; val = String(nv).trim(); if (!val) return;
          }
          if (arr.includes(val) && arr[index] !== val) { alert('This value already exists'); return; }
          arr[index] = val; arr.sort();
          if (!window.masterData[module]) window.masterData[module] = {};
          window.masterData[module][fieldKey] = arr;
          saveMasterData();
          window.renderTab((document.querySelector('.tab.active')||{getAttribute:()=>module}).getAttribute('data-tab')||module);
        };
      }
      if (typeof window.deleteValue !== 'function') {
        window.__fb_deleteValue = function(module, fieldKey, index){
          if (!confirm('Delete this value?')) return;
          const arr = ((window.masterData||{})[module]||{})[fieldKey]||[];
          arr.splice(index,1);
          if (!window.masterData[module]) window.masterData[module] = {};
          window.masterData[module][fieldKey] = arr;
          saveMasterData();
          window.renderTab((document.querySelector('.tab.active')||{getAttribute:()=>module}).getAttribute('data-tab')||module);
        };
      }
      if (typeof window.addValue !== 'function') {
        window.__fb_addValue = function(module, fieldKey){
          let v = '';
          if (fieldKey === 'SQA') {
            const qInput = document.getElementById(`add_${module}_${fieldKey}_question`);
            const aInput = document.getElementById(`add_${module}_${fieldKey}_answer`);
            const question = qInput ? qInput.value.trim() : '';
            const answer = aInput ? aInput.value.trim() : '';
            if (!question) { alert('Please enter a security question'); return; }
            v = formatSqaValue(question, answer);
          } else {
            const input = document.getElementById(`add_${module}_${fieldKey}`);
            if (!input) return; v = String(input.value||'').trim(); if (!v) { alert('Please enter a value'); return; }
          }
          if (!window.masterData[module]) window.masterData[module] = {};
          if (!Array.isArray(window.masterData[module][fieldKey])) window.masterData[module][fieldKey] = [];
          if (window.masterData[module][fieldKey].includes(v)) { alert('This value already exists'); return; }
          window.masterData[module][fieldKey].push(v);
          window.masterData[module][fieldKey].sort();
          saveMasterData();
          window.renderTab((document.querySelector('.tab.active')||{getAttribute:()=>module}).getAttribute('data-tab')||module);
          if (fieldKey === 'SQA') {
            const qInput = document.getElementById(`add_${module}_${fieldKey}_question`);
            const aInput = document.getElementById(`add_${module}_${fieldKey}_answer`);
            if (qInput) qInput.value='';
            if (aInput) aInput.value='';
          } else {
            const input = document.getElementById(`add_${module}_${fieldKey}`);
            if (input) input.value='';
          }
        };
      }
      window.renderTab = function(module){
        console.log('[Fallback renderTab] module=', module);
        const container = document.getElementById(`${module}Grid`);
        if (!container) return;
        container.innerHTML = '';
        const fields = FB_STRUCTURE[module] || {};
        console.log('[Fallback renderTab] fields=', Object.keys(fields));
        const keys = Object.keys(fields);
        const mid = Math.ceil(keys.length/2);
        const left = document.createElement('div');
        keys.slice(0,mid).forEach(k => left.appendChild(createFieldCard(module,k,fields[k])));
        const right = document.createElement('div');
        keys.slice(mid).forEach(k => right.appendChild(createFieldCard(module,k,fields[k])));
        container.appendChild(left);
        container.appendChild(right);
      };
      window.switchTab = function(tab){
        console.log('[Fallback switchTab] to', tab);
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const t = document.querySelector(`[data-tab="${tab}"]`);
        if (t) t.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const content = document.getElementById(`${tab}Content`);
        if (content) content.classList.add('active');
        window.renderTab(tab);
      };
      // Define updateLastFileDisplay early so it can be called from file handlers
      window.updateLastFileDisplay = function() {
        const lastExcelFile = localStorage.getItem('last_excel_file_loaded') || '';
        const lastExcelSource = localStorage.getItem('last_excel_file_source') || '';
        const lastExcelFolderPath = localStorage.getItem('last_excel_folder_path') || window.lastExcelFolderPath || '';
        const filePathDisplay = document.getElementById('filePathDisplay');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        
        if (!filePathDisplay || !fileNameDisplay) {
          // Elements not ready yet, retry after a short delay
          setTimeout(function() { window.updateLastFileDisplay(); }, 100);
          return;
        }
        
        if (lastExcelFile) {
          // Display folder path if available and valid (not fake path)
          if (lastExcelFolderPath && 
              !lastExcelFolderPath.toLowerCase().includes('fakepath') && 
              lastExcelFolderPath.trim() !== 'C:\\fakepath' &&
              lastExcelFolderPath.trim() !== 'c:\\fakepath') {
            filePathDisplay.innerHTML = `<span style="color:#64748b;">üìÅ</span> <span style="color:#1e293b;font-weight:500;">${lastExcelFolderPath}</span>`;
          } else {
            // Clear invalid fake path from storage
            if (lastExcelFolderPath && lastExcelFolderPath.toLowerCase().includes('fakepath')) {
              window.lastExcelFolderPath = '';
              localStorage.removeItem('last_excel_folder_path');
            }
            filePathDisplay.innerHTML = `<span style="color:#64748b;">üìÅ</span> <span style="color:#64748b;font-style:italic;">Folder path not available</span>`;
          }
          
          // Display file name on right - same style as file path
          const icon = lastExcelSource === 'Google Drive' ? '‚òÅÔ∏è' : 'üìÑ';
          let sourceLabel = lastExcelSource === 'D:' ? 'Local Drive D:' : lastExcelSource;
          if (lastExcelSource === 'Google Drive') sourceLabel = 'Google Drive';
          fileNameDisplay.innerHTML = `<span style="color:#64748b;">${icon}</span> <span style="color:#1e293b;font-weight:500;">${lastExcelFile}</span> <span style="color:#64748b;font-weight:400;font-size:0.85rem;">(${sourceLabel || 'Unknown source'})</span>`;
        } else {
          filePathDisplay.innerHTML = '<span style="color:#64748b;">‚ö†Ô∏è No file loaded</span>';
          fileNameDisplay.innerHTML = '<span style="color:#64748b;">‚ö†Ô∏è No Excel file loaded yet</span>';
        }
      };
      
      // If we already have data, render immediately
      try{
        const data = JSON.parse(localStorage.getItem('unified_master_data')||'null');
        if (data){ window.masterData = data; normalizeSqaValues(window.masterData); initializeMasterData(); saveMasterData(); }
      }catch(_){ }
      // Render all tabs once then default to task
      ['task','expense','income','investment','common','credit-cards','bank-accounts','trading-accounts','properties','tenants'].forEach(m => window.renderTab(m));
      window.switchTab('task');
      // Update file display on load
      setTimeout(function() { window.updateLastFileDisplay(); }, 200);
    })();

    // Robust tab click delegation to ensure switching works even if other listeners fail
    (function robustTabDelegation(){
      function onClick(e){
        const t = e.target && e.target.closest && e.target.closest('.tab');
        if (!t) return;
        const tab = t.getAttribute('data-tab');
        if (!tab) return;
        e.preventDefault();
        e.stopPropagation();
        if (typeof window.switchTab === 'function') {
          console.log('[Delegation] switching to', tab);
          window.switchTab(tab);
        }
      }
      document.addEventListener('click', onClick);
    })();

    // Early Clear All fallback
    (function earlyClearAll(){
      const btn = document.getElementById('btnClearData');
      if (!btn) return;
      if (btn.__earlyBound) return; // avoid duplicate
      btn.__earlyBound = true;
      btn.addEventListener('click', function(){
        try{
          if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL master data!\n\nAre you sure you want to proceed?')) return;
          if (!confirm('‚ö†Ô∏è FINAL WARNING: This action cannot be undone!\n\nAll master data for Income, Expense, Investment, Task, and Common fields will be permanently deleted.\n\nClick OK to confirm deletion.')) return;
          localStorage.removeItem('unified_master_data');
          ['task_master_data','expense_master_data','income_master_data','investment_master_data','bank_accounts_master_data','trading_accounts_master_data','properties_master_data','credit_cards_master_data','tenants_master_data'].forEach(k=>localStorage.removeItem(k));
          window.masterData = { task:{}, expense:{}, income:{}, investment:{}, common:{}, 'bank-accounts':{}, 'trading-accounts':{}, properties:{}, 'credit-cards':{}, tenants:{} };
          if (typeof initializeMasterData==='function') initializeMasterData();
          if (typeof saveMasterData==='function') saveMasterData();
          ['income','expense','investment','task','common','bank-accounts','trading-accounts','properties','credit-cards','tenants'].forEach(m=>{ if (typeof renderTab==='function') renderTab(m); });
          window.switchTab && window.switchTab('task');
          alert('All master data cleared.');
        }catch(err){
          console.error('Early clear error:', err);
          alert('Error clearing data: '+err.message);
        }
      });
    })();
  </script>
  
  <script src="assets/xlsx.full.min.js" 
          onerror="console.error('Failed to load local XLSX library')"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="10_Global_Master_Data_Export.js"></script>
  <script>
    console.log('=== Main script started ===');
    // (Reverted) No inline onchange handler; main listener will process
    // Master data structure - only fields specified by user
    // Sheets with prefix Income_, Investment_, Expense_, Task_ belong to those modules
    // Sheets without these prefixes are common fields (Currency, Frequency, Ac_Holder, Mode, Txn_Status, Ac_Status)
    // Sheets with prefix Txn_ are transactional data (not master data)
    const MASTER_DATA_STRUCTURE = {
      expense: {
        'Expanse_Category': 'Expense Category',
        'Expanse_Ac_Tag': 'Expense Account Tag'
      },
      income: {
        'Income_Category': 'Income Category',
        'Income_Ac_Tag': 'Income Account Tag' // Relates to "Paid From" in Expense and Investment Dashboards
      },
      investment: {
        'Investment_Category': 'Investment Category',
        'Investment_Ac_Tag': 'Investment Account Tag'
      },
      task: {
        'Task_Status': 'Task Status',
        'Task_Assignee': 'Task Assignee',
        'Task_Priority': 'Task Priority',
        'Task_Category': 'Task Category',
        'Task_Adhoc': 'Task Adhoc'
      },
      common: {
        'Currency': 'Currency',
        'Mode': 'Mode',
        'Status_Txn': 'Transaction Status',
        'Ac_Holder': 'Account Holder',
        'Frequency': 'Frequency',
        'Ac_Status': 'Account Status',
        'Ac_Classification': 'Account Classification',
        'Country': 'Country',
        'Institution': 'Institution',
        'Ac_Type': 'Account Type',
        'Email': 'Email Addresses',
        'Phone': 'Phone Numbers',
        'SQA': 'Security Questions & Answers'
      },
      'bank-accounts': {
        // Fields will be added later from Excel
      },
      'trading-accounts': {
        // Fields will be added later from Excel
      },
      'properties': {
        // Fields will be added later from Excel
      },
      'credit-cards': {
        // Fields will be added later from Excel
      },
      'tenants': {
        'Tenant_Category': 'Tenant Category',
        'Tenant_Ac_Tag': 'Tenant Account Tag'
      }
    };

    // Mapping: Excel sheet name variations to unified field keys
    const SHEET_NAME_MAP = {
      // Expense variations ‚Üí expense fields
      'Expanse_Category': { module: 'expense', key: 'Expanse_Category' },
      'Expense_Category': { module: 'expense', key: 'Expanse_Category' }, // Map to Expanse_Category
      'Expanse_Ac_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' },
      'Expense_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' }, // Map to Expanse_Ac_Tag
      'Expense_Ac_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' },
      
      // Income variations ‚Üí income fields
      'Income_Category': { module: 'income', key: 'Income_Category' },
      'Income_Ac_Tag': { module: 'income', key: 'Income_Ac_Tag' },
      'Income_Tag': { module: 'income', key: 'Income_Ac_Tag' }, // Map to Income_Ac_Tag
      
      // Investment variations ‚Üí investment fields
      'Investment_Category': { module: 'investment', key: 'Investment_Category' },
      'Investment_Ac_Tag': { module: 'investment', key: 'Investment_Ac_Tag' },
      'Investment_Tag': { module: 'investment', key: 'Investment_Ac_Tag' }, // Map to Investment_Ac_Tag
      
      // Task fields
      'Task_Category': { module: 'task', key: 'Task_Category' },
      'Task_Tag': { module: 'common', key: 'Country' },  // Map to Country in common
      'Task_Status': { module: 'task', key: 'Task_Status' },
      'Task_Assignee': { module: 'task', key: 'Task_Assignee' },
      'Task_Priority': { module: 'task', key: 'Task_Priority' },
      'Task_Adhoc': { module: 'task', key: 'Task_Adhoc' },
      'Country': { module: 'common', key: 'Country' },  // Direct Country mapping
      
      // Common fields (no prefix)
      'Currency': { module: 'common', key: 'Currency' },
      'Frequency': { module: 'common', key: 'Frequency' },
      'Ac_Holder': { module: 'common', key: 'Ac_Holder' },
      'Expense_Holder': { module: 'common', key: 'Ac_Holder' }, // Map variations to Ac_Holder
      'Income_Holder': { module: 'common', key: 'Ac_Holder' },
      'Investment_Holder': { module: 'common', key: 'Ac_Holder' },
      'Mode_Txn': { module: 'common', key: 'Mode' },
      'Txn_Mode': { module: 'common', key: 'Mode' }, // Normalize to Mode
      'Mode': { module: 'common', key: 'Mode' },
      'Expense_Mode': { module: 'common', key: 'Mode' }, // Map variations to Mode
      'Income_Mode': { module: 'common', key: 'Mode' },
      'Investment_Mode': { module: 'common', key: 'Mode' },
      'Status_Txn': { module: 'common', key: 'Status_Txn' },
      'Txn_Status': { module: 'common', key: 'Status_Txn' }, // Map old name to new
      'Expense_Txn_Status': { module: 'common', key: 'Status_Txn' }, // Map variations to Status_Txn
      'Income_Txn_Status': { module: 'common', key: 'Status_Txn' },
      'Investment_Txn_Status': { module: 'common', key: 'Status_Txn' },
      'Ac_Status': { module: 'common', key: 'Ac_Status' },
      'Expense_Account_Status': { module: 'common', key: 'Ac_Status' }, // Map variations to Ac_Status
      'Income_Account_Status': { module: 'common', key: 'Ac_Status' },
      'Investment_Account_Status': { module: 'common', key: 'Ac_Status' },
      'Institution': { module: 'common', key: 'Institution' },
      'Ac_Type': { module: 'common', key: 'Ac_Type' },
      'Email': { module: 'common', key: 'Email' },
      'Phone': { module: 'common', key: 'Phone' },
      'SQA': { module: 'common', key: 'SQA' }
    };

    // Unified master data container
    let masterData = {};
    let currentEdit = null;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        switchTab(targetTab);
      });
    });

    function switchTab(tabName) {
      // Update active tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      // Update active content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`${tabName}Content`).classList.add('active');

      // Render the tab content (or load paths for paths tab)
      if (tabName === 'paths') {
        loadPaths();
      } else {
        renderTab(tabName);
      }
    }

    // Load master data from localStorage
    function loadMasterData() {
      const saved = localStorage.getItem('unified_master_data');
      if (saved) {
        masterData = JSON.parse(saved);
        // Migration: normalize common.Mode_Txn -> common.Mode
        if (masterData.common) {
          const legacy = masterData.common['Mode_Txn'];
          if (legacy && Array.isArray(legacy)) {
            if (!Array.isArray(masterData.common['Mode'])) masterData.common['Mode'] = [];
            const merged = [...masterData.common['Mode'], ...legacy].filter((v, i, a) => v && a.indexOf(v) === i).sort();
            masterData.common['Mode'] = merged;
            delete masterData.common['Mode_Txn'];
          }
        }
      } else {
        // Try to load from legacy format and convert
        masterData = {
          task: JSON.parse(localStorage.getItem('task_master_data') || '{}'),
          expense: JSON.parse(localStorage.getItem('expense_master_data') || '{}'),
          income: JSON.parse(localStorage.getItem('income_master_data') || '{}'),
          investment: JSON.parse(localStorage.getItem('investment_master_data') || '{}'),
          common: {},
          'bank-accounts': JSON.parse(localStorage.getItem('bank_accounts_master_data') || '{}'),
          'trading-accounts': JSON.parse(localStorage.getItem('trading_accounts_master_data') || '{}'),
          properties: JSON.parse(localStorage.getItem('properties_master_data') || '{}'),
          'credit-cards': JSON.parse(localStorage.getItem('credit_cards_master_data') || '{}'),
          tenants: JSON.parse(localStorage.getItem('tenants_master_data') || '{}')
        };
        saveMasterData();
      }
      initializeMasterData();
      renderTab('task'); // Render default tab
    }

    // Save master data to localStorage
    function saveMasterData() {
      localStorage.setItem('unified_master_data', JSON.stringify(masterData));
      // Also save to module-specific keys for backwards compatibility
      localStorage.setItem('task_master_data', JSON.stringify(masterData.task || {}));
      localStorage.setItem('expense_master_data', JSON.stringify(masterData.expense || {}));
      localStorage.setItem('income_master_data', JSON.stringify(masterData.income || {}));
      localStorage.setItem('investment_master_data', JSON.stringify(masterData.investment || {}));
      localStorage.setItem('bank_accounts_master_data', JSON.stringify(masterData['bank-accounts'] || {}));
      localStorage.setItem('trading_accounts_master_data', JSON.stringify(masterData['trading-accounts'] || {}));
      localStorage.setItem('properties_master_data', JSON.stringify(masterData.properties || {}));
      localStorage.setItem('credit_cards_master_data', JSON.stringify(masterData['credit-cards'] || {}));
      localStorage.setItem('tenants_master_data', JSON.stringify(masterData.tenants || {}));
    }

    // NEW PATH MANAGEMENT SYSTEM
    // Load all paths from localStorage
    function loadPaths() {
      const masterDataFile = localStorage.getItem('project_master_data_file') || '';
      const masterDataFolder = localStorage.getItem('project_master_data_folder') || '';
      const backupPath = localStorage.getItem('project_backup_path') || '';
      const documentsPath = localStorage.getItem('project_documents_path') || '';
      const downloadsPath = localStorage.getItem('project_downloads_path') || '';
      
      // Update displays
      const masterDataFileDisplay = document.getElementById('masterDataFileDisplay');
      const backupPathDisplay = document.getElementById('backupPathDisplay');
      const documentsPathDisplay = document.getElementById('documentsPathDisplay');
      const downloadsPathDisplay = document.getElementById('downloadsPathDisplay');
      
      if (masterDataFileDisplay) {
        masterDataFileDisplay.textContent = masterDataFile || 'Not set';
      }
      if (backupPathDisplay) {
        backupPathDisplay.textContent = backupPath || 'Not set';
      }
      if (documentsPathDisplay) {
        documentsPathDisplay.textContent = documentsPath || 'Not set';
      }
      if (downloadsPathDisplay) {
        downloadsPathDisplay.textContent = downloadsPath || 'Not set';
      }
      
      // Update input fields
      const masterDataFileInput = document.getElementById('masterDataFileInput');
      const backupPathInput = document.getElementById('backupPathInput');
      const documentsPathInput = document.getElementById('documentsPathInput');
      const downloadsPathInput = document.getElementById('downloadsPathInput');
      
      if (masterDataFileInput) masterDataFileInput.value = masterDataFile;
      if (backupPathInput) backupPathInput.value = backupPath;
      if (documentsPathInput) documentsPathInput.value = documentsPath;
      if (downloadsPathInput) downloadsPathInput.value = downloadsPath;
    }

    // Save path function
    function savePath(type, path) {
      const storageKeys = {
        'master-data-file': 'project_master_data_file',
        'master-data-folder': 'project_master_data_folder',
        'backup': 'project_backup_path',
        'documents': 'project_documents_path',
        'downloads': 'project_downloads_path'
      };
      
      const displayIds = {
        'master-data-file': 'masterDataFileDisplay',
        'master-data-folder': 'masterDataFileDisplay', // Same display for file
        'backup': 'backupPathDisplay',
        'documents': 'documentsPathDisplay',
        'downloads': 'downloadsPathDisplay'
      };
      
      const inputIds = {
        'master-data-file': 'masterDataFileInput',
        'master-data-folder': 'masterDataFileInput',
        'backup': 'backupPathInput',
        'documents': 'documentsPathInput',
        'downloads': 'downloadsPathInput'
      };
      
      if (storageKeys[type]) {
        localStorage.setItem(storageKeys[type], path);
        const displayEl = document.getElementById(displayIds[type]);
        const inputEl = document.getElementById(inputIds[type]);
        if (displayEl) displayEl.textContent = path;
        if (inputEl) inputEl.value = path;
        return true;
      }
      return false;
    }

    // Function to update Manage Master Data tooltip (can be called from index.html)
    window.updateManageMasterDataTooltip = function() {
      const lastExcelFile = localStorage.getItem('last_excel_file_loaded') || '';
      const lastExcelSource = localStorage.getItem('last_excel_file_source') || '';
      // This will be called from index.html to update its tooltip
    };

    // Clear all paths
    function clearAllPaths() {
      localStorage.removeItem('project_master_data_file');
      localStorage.removeItem('project_master_data_folder');
      localStorage.removeItem('project_backup_path');
      localStorage.removeItem('project_documents_path');
      localStorage.removeItem('project_downloads_path');
      loadPaths();
    }

    // Check if paths are set
    function arePathsSet() {
      const backupPath = localStorage.getItem('project_backup_path');
      const documentsPath = localStorage.getItem('project_documents_path');
      const downloadsPath = localStorage.getItem('project_downloads_path');
      return !!(backupPath && documentsPath && downloadsPath);
    }

    // Initialize master data structure
    function initializeMasterData() {
      ['task', 'expense', 'income', 'investment', 'common', 'bank-accounts', 'trading-accounts', 'properties', 'credit-cards', 'tenants'].forEach(module => {
        if (!masterData[module]) {
          masterData[module] = {};
        }
        if (MASTER_DATA_STRUCTURE[module]) {
          Object.keys(MASTER_DATA_STRUCTURE[module]).forEach(key => {
            // Only initialize if it doesn't exist or is not an array - preserve existing data
            if (!masterData[module][key] || !Array.isArray(masterData[module][key])) {
              masterData[module][key] = [];
            }
          });
        }
      });
      console.log('Master data initialized:', masterData);
    }

    // Render a tab
    function renderTab(module) {
      const container = document.getElementById(`${module}Grid`);
      container.innerHTML = '';

      const fields = MASTER_DATA_STRUCTURE[module];
      const fieldKeys = Object.keys(fields);
      
      // Only show module-specific fields - NO common fields in module tabs
      // Common fields are only shown in the Common tab
      
      // Split fields into two columns
      const midPoint = Math.ceil(fieldKeys.length / 2);
      const leftFields = fieldKeys.slice(0, midPoint);
      const rightFields = fieldKeys.slice(midPoint);

      // Create left column
      const leftCol = document.createElement('div');
      leftFields.forEach(fieldKey => {
        const displayLabel = fields[fieldKey];
        leftCol.appendChild(createFieldCard(module, fieldKey, displayLabel, false));
      });
      container.appendChild(leftCol);

      // Create right column
      const rightCol = document.createElement('div');
      rightFields.forEach(fieldKey => {
        const displayLabel = fields[fieldKey];
        rightCol.appendChild(createFieldCard(module, fieldKey, displayLabel, false));
      });
      container.appendChild(rightCol);
    }

    // Create a field card
    function createFieldCard(module, fieldKey, fieldLabel, isCommonField = false) {
      const card = document.createElement('div');
      card.className = 'field-card';

      const header = document.createElement('div');
      header.className = 'field-header';
      // Get values - if this is a common field being accessed from a module tab
      // Task module does NOT show Status_Txn and Mode
      let values = [];
      if (isCommonField) {
        // Access common field (but exclude Status_Txn and Mode from task module)
        if (module === 'task' && (fieldKey === 'Status_Txn' || fieldKey === 'Mode')) {
          values = [];
        } else {
          values = masterData.common && masterData.common[fieldKey] ? masterData.common[fieldKey] : [];
        }
      } else {
        values = masterData[module] && masterData[module][fieldKey] ? masterData[module][fieldKey] : [];
      }
      // Format: Actual Field Name (count) <--> Mapped Field Name
      const actualFieldName = fieldKey; // Excel sheet name (e.g., Expanse_Category)
      let mappedFieldName = fieldLabel.replace(' ‚Üî', ''); // Display name (e.g., Expense Category)
      
      // Special case: Country field should show alternative names
      if (fieldKey === 'Country') {
        mappedFieldName += ', Task_Tag';
      }
      
      header.innerHTML = `
        <span class="field-name">${actualFieldName} (${values.length}) <--> ${mappedFieldName}</span>
      `;
      card.appendChild(header);

      const valuesContainer = document.createElement('div');
      valuesContainer.className = 'values-container';

      if (values.length === 0) {
        valuesContainer.innerHTML = '<div class="empty-field">No entries yet</div>';
      } else {
          values.forEach((value, index) => {
          const row = document.createElement('div');
          const isSqaField = fieldKey === 'SQA';
          row.className = isSqaField ? 'value-row sqa-row' : 'value-row';
          // Determine save module/key for common fields viewed from module tabs
          let saveModule = module;
          let saveKey = fieldKey;
          if (isCommonField || (module !== 'common' && MASTER_DATA_STRUCTURE.common[fieldKey])) {
            saveModule = 'common';
            saveKey = fieldKey;
          }
          if (isSqaField) {
            const parsed = parseSqaValue(value);
            const question = escapeHtml(parsed.question || '');
            const answer = escapeHtml(parsed.answer || '');
            row.innerHTML = `
              <span class="value-text sqa-question" title="${question}">${question || '‚Äî'}</span>
              <span class="value-text sqa-answer" title="${answer}">${answer || '‚Äî'}</span>
              <div class="value-actions">
                <button class="btn-icon btn-edit" onclick="editValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Edit</button>
                <button class="btn-icon btn-delete" onclick="deleteValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Delete</button>
              </div>
            `;
          } else {
            row.innerHTML = `
              <span class="value-text">${escapeHtml(value)}</span>
              <div class="value-actions">
                <button class="btn-icon btn-edit" onclick="editValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Edit</button>
                <button class="btn-icon btn-delete" onclick="deleteValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Delete</button>
              </div>
            `;
          }
          valuesContainer.appendChild(row);
        });
      }
      card.appendChild(valuesContainer);

      const addForm = document.createElement('div');
      addForm.className = 'add-form';
      // Determine which module to save to for common fields
      let saveModule = module;
      let saveKey = fieldKey;
      if (isCommonField || (module !== 'common' && MASTER_DATA_STRUCTURE.common[fieldKey])) {
        saveModule = 'common';
        saveKey = fieldKey;
      }
      if (fieldKey === 'SQA') {
        addForm.classList.add('sqa-add');
        addForm.innerHTML = `
          <input type="text" class="add-input sqa-input-question" id="add_${module}_${fieldKey}_question" placeholder="Security question" onkeypress="if(event.key==='Enter') addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">
          <input type="text" class="add-input sqa-input-answer" id="add_${module}_${fieldKey}_answer" placeholder="Answer (optional)" onkeypress="if(event.key==='Enter') addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">
          <button class="btn-add" onclick="addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">Add</button>
        `;
      } else {
        addForm.innerHTML = `
          <input type="text" class="add-input" id="add_${module}_${fieldKey}" placeholder="Add new ${fieldLabel.toLowerCase()}" onkeypress="if(event.key==='Enter') addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">
          <button class="btn-add" onclick="addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">Add</button>
        `;
      }
      card.appendChild(addForm);

      return card;
    }

    // Add value
    function extractSqaQuestion(row){
      const keys = ['Security Question','Security Questions','Security Question(s)','Question','Questions','Security_Q'];
      return extractColumnValue(row, keys, true);
    }
    function extractSqaAnswer(row){
      const keys = ['Security Answer','Security Answers','Security Answer(s)','Answer','Answers','Security_A'];
      return extractColumnValue(row, keys, false);
    }
    function extractColumnValue(row, keyCandidates, fallbackToFirst){
      if (!row) return '';
      const lowerMap = {};
      Object.keys(row).forEach(k=>{
        lowerMap[k.toLowerCase().trim()] = row[k];
      });
      for (const candidate of keyCandidates){
        const val = lowerMap[candidate.toLowerCase().trim()];
        if (val !== undefined && val !== null && String(val).trim() !== '') {
          return String(val).trim();
        }
      }
      if (fallbackToFirst) {
        const firstNonEmpty = Object.values(row).find(v=>String(v||'').trim()!== '');
        return firstNonEmpty ? String(firstNonEmpty).trim() : '';
      }
      return '';
    }
    const SQA_SEPARATOR = ' ‚Äî ';
    function parseSqaValue(rawValue) {
      const text = String(rawValue || '').trim();
      if (!text) return { question: '', answer: '' };
      const separatorIndex = text.indexOf('‚Äî');
      if (separatorIndex === -1) {
        return { question: text, answer: '' };
      }
      const question = text.slice(0, separatorIndex).trim();
      const answer = text.slice(separatorIndex + 1).replace(/^[\\s‚Äî-]+/, '').trim();
      return { question, answer };
    }
    function defaultParseSqaValue(rawValue){
      return parseSqaValue(rawValue);
    }

    function formatSqaValue(question, answer) {
      const q = String(question || '').trim();
      const a = String(answer || '').trim();
      if (!q && !a) return '';
      return a ? `${q}${SQA_SEPARATOR}${a}` : q;
    }

    function addValue(saveModule, saveKey, displayModule, displayKey) {
      // displayModule and displayKey are for the input element ID when viewing common fields from module tabs
      let value = '';
      let questionInput, answerInput;
      if (saveKey === 'SQA') {
        const questionInputId = displayModule ? `add_${displayModule}_${displayKey}_question` : `add_${saveModule}_${saveKey}_question`;
        const answerInputId = displayModule ? `add_${displayModule}_${displayKey}_answer` : `add_${saveModule}_${saveKey}_answer`;
        questionInput = document.getElementById(questionInputId);
        answerInput = document.getElementById(answerInputId);
        const question = questionInput ? questionInput.value.trim() : '';
        const answer = answerInput ? answerInput.value.trim() : '';
        if (!question) {
          alert('Please enter a security question');
          return;
        }
        value = formatSqaValue(question, answer);
      } else {
        const inputId = displayModule ? `add_${displayModule}_${displayKey}` : `add_${saveModule}_${saveKey}`;
        const input = document.getElementById(inputId);
        value = input.value.trim();
        if (!value) {
          alert('Please enter a value');
          return;
        }
      }
      if (!masterData[saveModule]) masterData[saveModule] = {};
      if (!masterData[saveModule][saveKey]) masterData[saveModule][saveKey] = [];
      if (masterData[saveModule][saveKey].includes(value)) {
        alert('This value already exists');
        return;
      }
      masterData[saveModule][saveKey].push(value);
      masterData[saveModule][saveKey].sort();
      saveMasterData();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
      if (saveKey === 'SQA') {
        if (questionInput) questionInput.value = '';
        if (answerInput) answerInput.value = '';
      } else {
        const inputId = displayModule ? `add_${displayModule}_${displayKey}` : `add_${saveModule}_${saveKey}`;
        const input = document.getElementById(inputId);
        if (input) input.value = '';
      }
    }

    // Edit value
    function editValue(module, fieldKey, index, displayModule) {
      currentEdit = { module, fieldKey, index, displayModule: displayModule || module };
      const value = masterData[module][fieldKey][index];
      const editInput = document.getElementById('editInput');
      const sqaGroup = document.getElementById('editSqaGroup');
      const questionInput = document.getElementById('editQuestionInput');
      const answerInput = document.getElementById('editAnswerInput');
      if (fieldKey === 'SQA') {
        const parsed = parseSqaValue(value);
        editInput.style.display = 'none';
        sqaGroup.style.display = 'flex';
        questionInput.value = parsed.question || '';
        answerInput.value = parsed.answer || '';
      } else {
        editInput.style.display = 'block';
        sqaGroup.style.display = 'none';
        editInput.value = value;
      }
      // Get the display label
      let displayLabel = '';
      if (module === 'common') {
        displayLabel = MASTER_DATA_STRUCTURE.common[fieldKey] || fieldKey;
      } else {
        displayLabel = MASTER_DATA_STRUCTURE[module][fieldKey] || fieldKey;
      }
      document.getElementById('modalTitle').textContent = `Edit ${displayLabel}`;
      document.getElementById('editModal').classList.add('show');
    }

    // Save edited value
    function saveEditedValue() {
      if (!currentEdit) return;
      const { module, fieldKey, index, displayModule } = currentEdit;
      let newValue = '';
      if (fieldKey === 'SQA') {
        const question = document.getElementById('editQuestionInput').value.trim();
        const answer = document.getElementById('editAnswerInput').value.trim();
        if (!question) {
          alert('Please enter a security question');
          return;
        }
        newValue = formatSqaValue(question, answer);
      } else {
        const input = document.getElementById('editInput');
        newValue = input.value.trim();
        if (!newValue) {
          alert('Please enter a value');
          return;
        }
      }
      if (masterData[module][fieldKey].includes(newValue) && masterData[module][fieldKey][index] !== newValue) {
        alert('This value already exists');
        return;
      }
      masterData[module][fieldKey][index] = newValue;
      masterData[module][fieldKey].sort();
      saveMasterData();
      closeEditModal();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
    }

    // Delete value
    function deleteValue(module, fieldKey, index, displayModule) {
      if (!confirm('Are you sure you want to delete this value?')) return;
      masterData[module][fieldKey].splice(index, 1);
      saveMasterData();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      const editInput = document.getElementById('editInput');
      const sqaGroup = document.getElementById('editSqaGroup');
      const questionInput = document.getElementById('editQuestionInput');
      const answerInput = document.getElementById('editAnswerInput');
      if (editInput) {
        editInput.style.display = 'block';
        editInput.value = '';
      }
      if (sqaGroup) {
        sqaGroup.style.display = 'none';
      }
      if (questionInput) questionInput.value = '';
      if (answerInput) answerInput.value = '';
      currentEdit = null;
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Excel import handler - set up when DOM is ready
    function setupExcelFileHandler() {
      const fileInput = document.getElementById('excelFileInput');
      if (!fileInput) {
        console.error('Excel file input not found in DOM');
        return;
      }
      
      fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
        if (!file) {
          console.log('No file selected');
          return;
        }
        
        console.log('File selected:', file.name, file.type, file.size);
        
        // Proceed to read selected Excel file
      const reader = new FileReader();
        
        reader.onerror = function(error) {
          console.error('FileReader error:', error);
          alert('Error reading file: ' + (error.target.error?.message || 'Unknown error'));
          e.target.value = ''; // Reset file input
        };
        
      reader.onload = function(e) {
        try {
          console.log('File read successfully, size:', e.target.result.byteLength);
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetNames = workbook.SheetNames;

          console.log('Available sheets:', sheetNames);

          // Initialize master data
          initializeMasterData();

          // Extract all master data sheets (exclude Txn_* transactional sheets, but include Mode_Txn and Status_Txn)
          const processedSheets = [];
          
          // FIRST: Handle Paths sheet if it exists
          if (sheetNames.includes('Paths')) {
            console.log('‚úì Processing Paths sheet');
            const pathsSheet = workbook.Sheets['Paths'];
            const pathsData = XLSX.utils.sheet_to_json(pathsSheet);
            
            pathsData.forEach(row => {
              const pathType = String(row['Path Type'] || '').trim();
              const path = String(row['Path'] || '').trim();
              
              if (pathType && path) {
                let storageKey = null;
                if (pathType === 'Master Data File') {
                  storageKey = 'project_master_data_file';
                } else if (pathType === 'Backup Path') {
                  storageKey = 'project_backup_path';
                } else if (pathType === 'Documents Path') {
                  storageKey = 'project_documents_path';
                } else if (pathType === 'Downloads Path') {
                  storageKey = 'project_downloads_path';
                }
                
                if (storageKey) {
                  localStorage.setItem(storageKey, path);
                  console.log(`‚úì Loaded path for ${pathType}: ${path}`);
                }
              }
            });
            
            processedSheets.push('Paths');
            loadPaths(); // Refresh UI display
          }
          
          sheetNames.forEach(sheetName => {
            // Skip transactional data sheets (Txn_Expense, Txn_Income, Txn_Investment, Txn_Task)
            if (sheetName.startsWith('Txn_') && !sheetName.includes('Mode') && !sheetName.includes('Status')) {
              console.log('‚úó Skipping transactional sheet:', sheetName);
              return;
            }
            
            if (sheetName === 'SQA') {
              console.log('‚úì Processing security questions sheet');
              const sheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(sheet);
              if (jsonData.length) {
                const entries = jsonData.map(row => {
                  const question = extractSqaQuestion(row);
                  const answer = extractSqaAnswer(row);
                  if (!question && !answer) return null;
                  return answer ? `${question} ‚Äî ${answer}` : question;
                }).filter(Boolean);
                if (!masterData.common.SQA || !Array.isArray(masterData.common.SQA)) {
                  masterData.common.SQA = [];
                }
                if (entries.length) {
                  masterData.common.SQA = Array.from(new Set([...(masterData.common.SQA || []), ...entries]));
                  console.log(`‚úì Loaded ${entries.length} security Q&A rows`);
                  processedSheets.push(sheetName);
                }
              }
              return;
            }
            
            // NEW: Handle merged sheets (Ac_Category, Ac_Tag)
            if (sheetName === 'Ac_Category' || sheetName === 'Ac_Tag') {
              console.log(`‚úì Processing merged sheet: ${sheetName}`);
              const sheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(sheet);
              
              if (jsonData.length === 0) return;
              
              const firstRow = jsonData[0];
              const columnKeys = Object.keys(firstRow);
              
              // Find the main column (Ac_Category or Ac_Tag) and classification column
              const mainColumn = sheetName === 'Ac_Category' ? 'Ac_Category' : 'Ac_Tag';
              const classColumn = 'Ac_Classification';
              
              if (!columnKeys.includes(mainColumn) || !columnKeys.includes(classColumn)) {
                console.log(`‚ö† Sheet "${sheetName}" missing required columns`);
                return;
              }
              
              // Process data for each account type
              const incomeValues = [];
              const investmentValues = [];
              const expenseValues = [];
              const tenantValues = [];
              
              jsonData.forEach(row => {
                const value = String(row[mainColumn] || '').trim();
                const classification = String(row[classColumn] || '').trim();
                
                if (!value) return;
                
                if (classification === 'Income') {
                  incomeValues.push(value);
                } else if (classification === 'Investment') {
                  investmentValues.push(value);
                } else if (classification === 'Expanse' || classification === 'Expense') {
                  expenseValues.push(value);
                } else if (classification === 'Tenant') {
                  tenantValues.push(value);
                }
              });
              
              // Map to appropriate modules and fields
              let incomeKey = null, investmentKey = null, expenseKey = null, tenantKey = null;
              
              if (sheetName === 'Ac_Category') {
                incomeKey = 'Income_Category';
                investmentKey = 'Investment_Category';
                expenseKey = 'Expanse_Category';
                tenantKey = 'Tenant_Category';
              } else if (sheetName === 'Ac_Tag') {
                incomeKey = 'Income_Ac_Tag';
                investmentKey = 'Investment_Ac_Tag';
                expenseKey = 'Expanse_Ac_Tag';
                tenantKey = 'Tenant_Ac_Tag';
              }
              
              // Load data into appropriate modules
              ['income', 'investment', 'expense', 'tenants'].forEach(module => {
                const fieldKey = module === 'income' ? incomeKey : (module === 'investment' ? investmentKey : (module === 'expense' ? expenseKey : tenantKey));
                const values = module === 'income' ? incomeValues : (module === 'investment' ? investmentValues : (module === 'expense' ? expenseValues : tenantValues));
                
                if (!masterData[module]) masterData[module] = {};
                if (!masterData[module][fieldKey]) masterData[module][fieldKey] = [];
                
                if (values.length > 0) {
                  const existing = masterData[module][fieldKey] || [];
                  const newValues = values.filter(v => v && v !== '' && !existing.includes(v));
                  masterData[module][fieldKey] = [...existing, ...newValues].sort();
                  console.log(`‚úì Loaded ${values.length} ${module} values from "${sheetName}" into ${module}.${fieldKey} (${newValues.length} new)`);
                } else {
                  console.log(`‚ö† No ${module} values found in "${sheetName}"`);
                }
              });
              
              processedSheets.push(sheetName);
              return;
            }
            
            processedSheets.push(sheetName);

            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet);

            if (jsonData.length === 0) return;

            // Try to find the column with the same name as the sheet, or use first column
            let values = [];
            const firstRow = jsonData[0];
            const columnKeys = Object.keys(firstRow);

            // Try to find the column with the same name as the sheet, or use first column
            // Handle case-insensitive matching and variations
            let columnName = sheetName;
            
            // First try exact match
            if (firstRow[sheetName] !== undefined && firstRow[sheetName] !== null && String(firstRow[sheetName]).trim() !== '') {
              columnName = sheetName;
            } else {
              // Try case-insensitive match
              const matchingKey = columnKeys.find(key => key.toLowerCase() === sheetName.toLowerCase());
              if (matchingKey) {
                columnName = matchingKey;
              } else {
                // For common fields, also try common variations
                if (sheetName === 'Mode' || sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode' || sheetName.toLowerCase() === 'mode' || sheetName.toLowerCase() === 'mode_txn' || sheetName.toLowerCase() === 'txn_mode') {
                  const modeVariations = columnKeys.find(key => 
                    key.toLowerCase().includes('mode') || key.toLowerCase().includes('txn_mode') || key.toLowerCase().includes('mode_txn')
                  );
                  if (modeVariations) columnName = modeVariations;
                } else if (sheetName === 'Status_Txn' || sheetName === 'Txn_Status' || sheetName.toLowerCase() === 'status_txn' || sheetName.toLowerCase() === 'txn_status') {
                  const statusVariations = columnKeys.find(key => 
                    key.toLowerCase().includes('status') || key.toLowerCase().includes('txn_status') || key.toLowerCase().includes('status_txn')
                  );
                  if (statusVariations) columnName = statusVariations;
                } else if (sheetName === 'Ac_Classification' || sheetName.toLowerCase() === 'ac_classification') {
                  // For Ac_Classification sheet, try to find column with same name, or use first column
                  const classVariations = columnKeys.find(key => 
                    key.toLowerCase() === 'ac_classification' || key.toLowerCase().includes('classification')
                  );
                  if (classVariations) columnName = classVariations;
                  else columnName = columnKeys[0]; // Use first column if no match
                } else {
                  // Use first column
                  columnName = columnKeys[0];
                }
              }
            }
            
            console.log(`Reading sheet "${sheetName}": Using column "${columnName}" from available columns:`, columnKeys);
            
            values = jsonData.map(row => {
              const val = row[columnName];
              // Handle various data types
              if (val === undefined || val === null) return null;
              const strVal = String(val).trim();
              return strVal === '' ? null : strVal;
            }).filter(v => v !== null && v !== '');
            
            // values extracted

            // Determine which module and field this sheet belongs to
            let foundModule = null;
            let foundKey = null;

            // PRIORITY 1: Check if sheet name is exactly Mode/Mode_Txn/Txn_Mode or Status_Txn or Ac_Classification (common fields) - CHECK FIRST!
            // These must be checked BEFORE checking module prefixes to avoid mis-mapping
            if (sheetName === 'Mode' || sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode') {
              foundModule = 'common';
              foundKey = 'Mode';
              console.log(`‚úì PRIORITY MATCH: Sheet "${sheetName}" -> common.Mode`);
            } else if (sheetName === 'Status_Txn' || sheetName === 'Txn_Status') {
              foundModule = 'common';
              foundKey = 'Status_Txn';
              console.log(`‚úì PRIORITY MATCH: Sheet "${sheetName}" -> common.Status_Txn`);
            } else if (sheetName === 'Ac_Classification') {
              foundModule = 'common';
              foundKey = 'Ac_Classification';
              console.log(`‚úì PRIORITY MATCH: Sheet "${sheetName}" -> common.Ac_Classification`);
            }
            // PRIORITY 2: Check exact mapping dictionary
            else if (SHEET_NAME_MAP[sheetName]) {
              foundModule = SHEET_NAME_MAP[sheetName].module;
              foundKey = SHEET_NAME_MAP[sheetName].key;
              console.log(`‚úì Matched "${sheetName}" via SHEET_NAME_MAP -> ${foundModule}.${foundKey}`);
            } else {
              // PRIORITY 3: Try to determine based on prefix rules
              const lowerSheet = sheetName.toLowerCase();
              
              // Check for module prefixes
              if (sheetName.startsWith('Task_')) {
                // Special case: Task_Tag maps to Country in common, not task
                if (sheetName === 'Task_Tag') {
                  foundModule = 'common';
                  foundKey = 'Country';
                } else {
                  foundModule = 'task';
                  foundKey = sheetName;
                  // Check if it's in our structure
                  if (!MASTER_DATA_STRUCTURE.task[sheetName]) {
                    foundModule = null;
                    foundKey = null;
                  }
                }
              } else if (sheetName.startsWith('Income_')) {
                foundModule = 'income';
                foundKey = sheetName;
                // Check if it's in our structure
                if (!MASTER_DATA_STRUCTURE.income[sheetName]) {
                  foundModule = null;
                  foundKey = null;
                }
              } else if (sheetName.startsWith('Investment_')) {
                foundModule = 'investment';
                foundKey = sheetName;
                // Check if it's in our structure
                if (!MASTER_DATA_STRUCTURE.investment[sheetName]) {
                  foundModule = null;
                  foundKey = null;
                }
              } else if (sheetName.startsWith('Expense_') || sheetName.startsWith('Expanse_')) {
                foundModule = 'expense';
                // Map variations to unified keys
                if (sheetName === 'Expense_Category') {
                  foundKey = 'Expanse_Category';
                } else if (sheetName === 'Expanse_Category') {
                  foundKey = 'Expanse_Category';
                } else if (sheetName === 'Expense_Tag' || sheetName === 'Expense_Ac_Tag') {
                  foundKey = 'Expanse_Ac_Tag';
                } else if (sheetName === 'Expanse_Ac_Tag') {
                  foundKey = 'Expanse_Ac_Tag';
                } else {
                  // Not a valid expense master field - might be a variation that should map to common
                  foundModule = null;
                  foundKey = null;
                }
              } else {
                // No prefix = common field
                // Check if it matches common field names (case-insensitive matching)
                if (lowerSheet === 'currency') {
                  foundModule = 'common';
                  foundKey = 'Currency';
                } else if (lowerSheet === 'frequency') {
                  foundModule = 'common';
                  foundKey = 'Frequency';
                } else if (lowerSheet === 'ac_holder' || lowerSheet === 'account holder' || lowerSheet === 'ac holder') {
                  foundModule = 'common';
                  foundKey = 'Ac_Holder';
                } else if (lowerSheet === 'mode' || lowerSheet === 'mode_txn' || lowerSheet === 'txn_mode' || lowerSheet === 'transaction mode' || lowerSheet === 'txn mode' ||
                           sheetName === 'Mode' || sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode' || sheetName === 'MODE' || sheetName === 'MODE_TXN' || sheetName === 'TXN_MODE' || sheetName === 'txn_mode' || sheetName === 'Txn_MODE') {
                  foundModule = 'common';
                  foundKey = 'Mode';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Mode`);
                } else if (lowerSheet === 'status_txn' || lowerSheet === 'txn_status' || lowerSheet === 'transaction status' || lowerSheet === 'txn status' ||
                           sheetName === 'Status_Txn' || sheetName === 'Txn_Status' || sheetName === 'STATUS_TXN' || sheetName === 'TXN_STATUS' || sheetName === 'txn_status') {
                  foundModule = 'common';
                  foundKey = 'Status_Txn';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Status_Txn`);
                } else if (lowerSheet === 'ac_status' || lowerSheet === 'account status' || lowerSheet === 'ac status') {
                  foundModule = 'common';
                  foundKey = 'Ac_Status';
                } else if (lowerSheet === 'ac_classification' || lowerSheet === 'account classification') {
                  foundModule = 'common';
                  foundKey = 'Ac_Classification';
                } else if (lowerSheet === 'country' || sheetName === 'Country' || sheetName === 'COUNTRY') {
                  foundModule = 'common';
                  foundKey = 'Country';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Country`);
                } else if (lowerSheet === 'email' || sheetName === 'Email' || sheetName === 'EMAIL') {
                  foundModule = 'common';
                  foundKey = 'Email';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Email`);
                } else if (lowerSheet === 'phone' || sheetName === 'Phone' || sheetName === 'PHONE') {
                  foundModule = 'common';
                  foundKey = 'Phone';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Phone`);
                } else if (lowerSheet === 'sqa' || sheetName === 'SQA') {
                  foundModule = 'common';
                  foundKey = 'SQA';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.SQA`);
                } else if (SHEET_NAME_MAP[sheetName]) {
                  // Check variations mapping
                  foundModule = SHEET_NAME_MAP[sheetName].module;
                  foundKey = SHEET_NAME_MAP[sheetName].key;
                } else {
                  // Try exact case match for common fields
                    if (sheetName === 'Currency' || sheetName === 'FREQUENCY' || sheetName === 'Frequency' ||
                      sheetName === 'Ac_Holder' || sheetName === 'Ac_HOLDER' ||
                      sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode' || sheetName === 'MODE_TXN' || sheetName === 'TXN_MODE' || sheetName === 'Txn_MODE' ||
                      sheetName === 'Status_Txn' || sheetName === 'Txn_Status' || sheetName === 'STATUS_TXN' || sheetName === 'TXN_STATUS' || sheetName === 'Txn_STATUS' ||
                      sheetName === 'Ac_Status' || sheetName === 'AC_STATUS' ||
                      sheetName === 'Ac_Classification' || sheetName === 'AC_CLASSIFICATION' ||
                      sheetName === 'Country' || sheetName === 'COUNTRY') {
                    foundModule = 'common';
                    // Normalize to standard case
                    if (sheetName === 'Mode' || sheetName.toUpperCase() === 'MODE' || sheetName === 'Mode_Txn' || sheetName.toUpperCase() === 'MODE_TXN' || sheetName === 'Txn_Mode' || sheetName.toUpperCase() === 'TXN_MODE' || sheetName === 'Txn_MODE') {
                      foundKey = 'Mode';
                    } else if (sheetName === 'Status_Txn' || sheetName.toUpperCase() === 'STATUS_TXN' || sheetName === 'Txn_Status' || sheetName.toUpperCase() === 'TXN_STATUS' || sheetName === 'Txn_STATUS') {
                      foundKey = 'Status_Txn';
                    } else if (sheetName.toUpperCase() === 'FREQUENCY' || sheetName === 'Frequency') {
                      foundKey = 'Frequency';
                    } else if (sheetName.toUpperCase() === 'AC_STATUS' || sheetName === 'Ac_STATUS') {
                      foundKey = 'Ac_Status';
                    } else if (sheetName.toUpperCase() === 'AC_HOLDER' || sheetName === 'Ac_HOLDER') {
                      foundKey = 'Ac_Holder';
                    } else if (sheetName.toUpperCase() === 'AC_CLASSIFICATION' || sheetName === 'Ac_Classification') {
                      foundKey = 'Ac_Classification';
                    } else if (sheetName.toUpperCase() === 'COUNTRY' || sheetName === 'Country') {
                      foundKey = 'Country';
                    } else {
                      foundKey = sheetName;
                    }
                    console.log(`Matched ${sheetName} to common.${foundKey}`);
                  }
                }
              }
            }

            if (foundModule && foundKey) {
              // Initialize if needed
              if (!masterData[foundModule]) masterData[foundModule] = {};
              if (!masterData[foundModule][foundKey]) masterData[foundModule][foundKey] = [];
              
              if (values.length > 0) {
                // Merge with existing values (avoid duplicates)
                const existing = masterData[foundModule][foundKey] || [];
                const newValues = values.filter(v => v && v !== '' && !existing.includes(v));
                masterData[foundModule][foundKey] = [...existing, ...newValues].sort();
                console.log(`‚úì Loaded ${values.length} values from "${sheetName}" into ${foundModule}.${foundKey} (${newValues.length} new values added)`);
              } else {
                console.log(`‚ö† Sheet "${sheetName}" matched to ${foundModule}.${foundKey} but contains no values`);
              }
            } else {
              console.log(`‚úó Skipping sheet "${sheetName}" - not a master data field`);
            }
          });

          normalizeSqaValues(masterData);
          localStorage.setItem('unified_master_data', JSON.stringify(masterData));
          
          // Save the Excel file name for tooltip
          localStorage.setItem('last_excel_file_loaded', file.name);
          localStorage.setItem('last_excel_file_source', 'D:');
          
          // Try to capture folder path from file input
          let folderPath = '';
          try {
            const input = document.getElementById('excelFileInput');
            const inputValue = input ? input.value || '' : '';
            
            // Extract folder path from input value if available
            // Skip if it's the fake path browsers show for security
            if (inputValue && !inputValue.includes('fakepath') && !inputValue.toLowerCase().includes('c:\\fakepath')) {
              const match = inputValue.match(/^(.+)[\\\/][^\\\/]+$/);
              if (match && match[1]) {
                folderPath = match[1].replace(/[\\\/]+$/, '');
                // Double check it's not a fake path
                if (folderPath.toLowerCase().includes('fakepath')) {
                  folderPath = '';
                }
              }
            }
            
            // If path not captured and we have a stored folder path, reuse it
            if (!folderPath && window.lastExcelFolderPath) {
              folderPath = window.lastExcelFolderPath;
            }
            
            // If still no path, prompt user once
            if (!folderPath) {
              folderPath = prompt(`File "${file.name}" selected.\n\nEnter the folder path where this file is located:`, window.lastExcelFolderPath || 'D:\\');
              if (folderPath) {
                folderPath = folderPath.trim().replace(/[\\\/]+$/, '');
              }
            }
            
            // Store folder path
            if (folderPath) {
              window.lastExcelFolderPath = folderPath;
              localStorage.setItem('last_excel_folder_path', folderPath);
              console.log('Folder path captured (main handler):', folderPath);
            }
          } catch (err) {
            console.warn('Could not capture folder path:', err);
          }
          
          // Update display immediately
          if (typeof updateLastFileDisplay === 'function') {
            updateLastFileDisplay();
          }
          
          // Update tooltip in index.html if it's open
          if (window.opener && typeof window.opener.updateManageMasterDataTooltip === 'function') {
            window.opener.updateManageMasterDataTooltip();
          }
          
          const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
          renderTab(currentTab);
          
          const totalSheets = sheetNames.length;
          const transactionalSheets = sheetNames.filter(s => s.startsWith('Txn_') && s !== 'Txn_Mode' && s !== 'Txn_Status' && !s.includes('Mode') && !s.includes('Status')).length;
          const hasPathsSheet = sheetNames.includes('Paths');
          const masterDataSheets = processedSheets.length;
          
          // Check if paths are set and show warning if not
          let message = `Successfully imported master data from Excel file!\n\nTotal sheets in file: ${totalSheets}\nTransactional sheets skipped: ${transactionalSheets}\nMaster data sheets processed: ${masterDataSheets}${hasPathsSheet ? ' (includes Paths)' : ''}`;
          
          if (!arePathsSet()) {
            message += '\n\n‚ö†Ô∏è Please set Project Paths in the "Set/Change Paths" tab!';
          }
          
          alert(message);
          e.target.value = ''; // Reset file input after successful processing
        } catch (error) {
          console.error('Error reading Excel file:', error);
          alert('Error reading Excel file: ' + error.message);
          e.target.value = ''; // Reset file input on error
        }
      };
      reader.readAsArrayBuffer(file);
    });
    }
    
    // Set up the file handler when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupExcelFileHandler);
    } else {
      setupExcelFileHandler();
    }

    // Close modal on outside click
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEditModal();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeEditModal();
      }
    });

    // Clear all data with double confirmation
    document.getElementById('btnClearData').addEventListener('click', function() {
      // First confirmation
      const firstConfirm = confirm('‚ö†Ô∏è WARNING: This will delete ALL master data!\n\nAre you sure you want to proceed?');
      if (!firstConfirm) return;

      // Second confirmation with more details
      const secondConfirm = confirm('‚ö†Ô∏è FINAL WARNING: This action cannot be undone!\n\nAll master data for Income, Expense, Investment, Task, and Common fields will be permanently deleted.\n\nClick OK to confirm deletion.');
      if (!secondConfirm) return;

      // Clear all master data
      masterData = {
        task: {},
        expense: {},
        income: {},
        investment: {},
        common: {},
        'bank-accounts': {},
        'trading-accounts': {},
        properties: {},
        'credit-cards': {},
        tenants: {}
      };

      // Clear localStorage
      localStorage.removeItem('unified_master_data');
      localStorage.removeItem('task_master_data');
      localStorage.removeItem('expense_master_data');
      localStorage.removeItem('income_master_data');
      localStorage.removeItem('investment_master_data');
      localStorage.removeItem('bank_accounts_master_data');
      localStorage.removeItem('trading_accounts_master_data');
      localStorage.removeItem('properties_master_data');
      localStorage.removeItem('credit_cards_master_data');
      localStorage.removeItem('tenants_master_data');

      // Clear all paths
      clearAllPaths();

      // Initialize empty structure and re-render
      initializeMasterData();
      saveMasterData();
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      if (currentTab === 'paths') {
        loadPaths();
      } else {
        renderTab(currentTab);
      }
      
      alert('‚úÖ All master data and paths have been cleared successfully.');
    });

    // Display last loaded Excel file info (if not already defined by fallback)
    if (typeof window.updateLastFileDisplay !== 'function') {
      function updateLastFileDisplay() {
        const lastExcelFile = localStorage.getItem('last_excel_file_loaded') || '';
        const lastExcelSource = localStorage.getItem('last_excel_file_source') || '';
        const lastExcelPath = localStorage.getItem('last_excel_file_path') || '';
        const filePathDisplay = document.getElementById('filePathDisplay');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        
        if (!filePathDisplay || !fileNameDisplay) {
          setTimeout(updateLastFileDisplay, 100);
          return;
        }
        
        if (lastExcelFile) {
          // Browser security prevents access to actual file path
          // Show a clear message that path is not accessible
          filePathDisplay.innerHTML = `<span style="color:#64748b;">üìÅ</span> <span style="color:#64748b;font-style:italic;">Path not accessible (browser security)</span>`;
          
          // Display file name on right
          const icon = lastExcelSource === 'Google Drive' ? '‚òÅÔ∏è' : 'üìÑ';
          let sourceLabel = lastExcelSource === 'D:' ? 'Local Drive D:' : lastExcelSource;
          if (lastExcelSource === 'Google Drive') sourceLabel = 'Google Drive';
          fileNameDisplay.innerHTML = `${icon} <strong>${lastExcelFile}</strong> <span style="color:#64748b;font-weight:400;font-size:0.85rem;">(${sourceLabel || 'Unknown source'})</span>`;
        } else {
          filePathDisplay.innerHTML = '<span style="color:#64748b;">‚ö†Ô∏è No file loaded</span>';
          fileNameDisplay.innerHTML = '<span style="color:#64748b;">‚ö†Ô∏è No Excel file loaded yet</span>';
        }
      }
      window.updateLastFileDisplay = updateLastFileDisplay;
    }

    // Initialize folder path from localStorage on load
    window.lastExcelFolderPath = localStorage.getItem('last_excel_folder_path') || '';
    
    // Download Master Data to Excel function
    async function downloadMasterDataExcel() {
      try {
        // Create a new workbook
        const wb = XLSX.utils.book_new();
        
        // Use global consolidated master data export function
        if (typeof addConsolidatedMasterDataToWorkbook === 'function') {
          addConsolidatedMasterDataToWorkbook(wb);
        } else {
          console.warn('Global master data export function not available, using fallback');
          // Fallback to old method if global function not loaded
          const acCategoryData = [['Ac_Category', 'Ac_Classification']];
          const classifications = ['Income', 'Investment', 'Expanse', 'Tenant'];
          const categoryMapping = {
            'Income': 'Income_Category',
            'Investment': 'Investment_Category',
            'Expanse': 'Expanse_Category',
            'Tenant': 'Tenant_Category'
          };
          
          classifications.forEach(cls => {
            const fieldKey = categoryMapping[cls];
            const moduleMap = {'Income': 'income', 'Investment': 'investment', 'Expanse': 'expense', 'Tenant': 'tenants'};
            const moduleName = moduleMap[cls] || '';
            const values = (masterData[moduleName] || {})[fieldKey] || [];
            values.forEach(value => {
              acCategoryData.push([value, cls]);
            });
          });
          
          if (acCategoryData.length > 1) {
            const acCategoryWs = XLSX.utils.aoa_to_sheet(acCategoryData);
            XLSX.utils.book_append_sheet(wb, acCategoryWs, 'Ac_Category');
          }
          
          const acTagData = [['Ac_Tag', 'Ac_Classification']];
          const tagMapping = {
            'Income': 'Income_Ac_Tag',
            'Investment': 'Investment_Ac_Tag',
            'Expanse': 'Expanse_Ac_Tag',
            'Tenant': 'Tenant_Ac_Tag'
          };
          
          classifications.forEach(cls => {
            const fieldKey = tagMapping[cls];
            const moduleMap = {'Income': 'income', 'Investment': 'investment', 'Expanse': 'expense', 'Tenant': 'tenants'};
            const moduleName = moduleMap[cls] || '';
            const values = (masterData[moduleName] || {})[fieldKey] || [];
            values.forEach(value => {
              acTagData.push([value, cls]);
            });
          });
          
          if (acTagData.length > 1) {
            const acTagWs = XLSX.utils.aoa_to_sheet(acTagData);
            XLSX.utils.book_append_sheet(wb, acTagWs, 'Ac_Tag');
          }
          
          const acClassificationData = [['Ac_Classification']];
          const classificationValues = (masterData.common || {})['Ac_Classification'] || ['Income', 'Investment', 'Expanse', 'Tenant'];
          classificationValues.forEach(value => {
            acClassificationData.push([value]);
          });
          
          const acClassWs = XLSX.utils.aoa_to_sheet(acClassificationData);
          XLSX.utils.book_append_sheet(wb, acClassWs, 'Ac_Classification');
          
          const commonData = masterData.common || {};
          Object.keys(commonData).forEach(fieldKey => {
            if (fieldKey === 'Ac_Classification') return;
            const values = commonData[fieldKey];
            if (values && Array.isArray(values) && values.length > 0) {
              const sheetData = [[fieldKey], ...values.map(v => [v])];
              const ws = XLSX.utils.aoa_to_sheet(sheetData);
              XLSX.utils.book_append_sheet(wb, ws, fieldKey);
            }
          });
        }
        
        // STEP 5: Add Task fields
        const taskData = masterData.task || {};
        Object.keys(MASTER_DATA_STRUCTURE.task || {}).forEach(fieldKey => {
          const values = taskData[fieldKey];
          if (values && Array.isArray(values) && values.length > 0) {
            const sheetData = [];
            sheetData.push([fieldKey]); // Header row
            values.forEach(value => {
              sheetData.push([value]);
            });
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            XLSX.utils.book_append_sheet(wb, ws, fieldKey);
            console.log(`Added ${fieldKey} sheet with ${values.length} items`);
          }
        });
        
        // STEP 6: Add Paths sheet
        const pathsData = [['Path Type', 'Path']]; // Header
        const pathsToExport = [
          ['Master Data File', 'project_master_data_file'],
          ['Backup Path', 'project_backup_path'],
          ['Documents Path', 'project_documents_path'],
          ['Downloads Path', 'project_downloads_path']
        ];
        
        pathsToExport.forEach(([label, key]) => {
          const pathValue = localStorage.getItem(key) || '';
          pathsData.push([label, pathValue]);
        });
        
        const pathsWs = XLSX.utils.aoa_to_sheet(pathsData);
        XLSX.utils.book_append_sheet(wb, pathsWs, 'Paths');
        console.log(`Added Paths sheet with ${pathsData.length - 1} items`);
        
        // Generate Excel file
        const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        
        // Generate filename with timestamp
        const now = new Date();
        const timestamp = now.toISOString().split('T')[0];
        const filename = `ClearView_Master_Data_${timestamp}.xlsx`;
        
        // Traditional download to default Downloads folder
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        
        // Show download path reminder
        const downloadsPath = localStorage.getItem('project_downloads_path') || '';
        const backupPath = localStorage.getItem('project_backup_path') || '';
        
        let message = 'Master data exported successfully!\n\nFile downloaded to your default Downloads folder.';
        if (downloadsPath || backupPath) {
          message += '\n\n';
          if (downloadsPath) {
            message += `üìÅ Recommended: Move to: ${downloadsPath}\n`;
          }
          if (backupPath) {
            message += `üíæ Backup: Copy to: ${backupPath}\n`;
          }
          message += '\n(Note: Use Chrome/Edge to save directly to custom locations)';
        }
        
        setTimeout(() => alert(message), 500);
      } catch (error) {
        console.error('Error exporting master data:', error);
        alert('Error exporting master data: ' + error.message);
      }
    }
    
    // Initialize on load
    loadMasterData();
    loadPaths(); // Load paths on page load
    updateLastFileDisplay(); // Show last loaded file
    renderTab('task'); // Render default tab
    
    // Set up button event listener - multiple attempts to ensure it works
    function setupButton() {
      const btn = document.getElementById('btnLoadFromD');
      if (btn) {
        btn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (window.openFilePicker) {
            window.openFilePicker();
          } else {
            alert('Error: openFilePicker function not available');
          }
        };
        console.log('Button listener attached');
        return true;
      }
      return false;
    }
    
    // Set up download button event
    function setupDownloadButton() {
      const btn = document.getElementById('btnDownloadExcel');
      if (btn) {
        btn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          downloadMasterDataExcel();
        };
        console.log('Download button listener attached');
        return true;
      }
      return false;
    }
    
    // Try multiple times to ensure button is attached
    if (!setupButton()) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          if (!setupButton()) {
            setTimeout(setupButton, 500);
          }
        });
      } else {
        setTimeout(setupButton, 100);
      }
    }
    
    // Try multiple times to ensure download button is attached
    if (!setupDownloadButton()) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          if (!setupDownloadButton()) {
            setTimeout(setupDownloadButton, 500);
          }
        });
      } else {
        setTimeout(setupDownloadButton, 100);
      }
    }
    
    // Update tooltip for Manage Master Data link in index.html
    updateManageMasterDataTooltip();
  </script>
</body>
</html>
