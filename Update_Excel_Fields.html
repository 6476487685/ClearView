<!DOCTYPE html>
<html>
<head>
    <title>Update Excel Field Names</title>
    <script src="assets/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 10px; }
        h1 { color: #333; }
        .section { margin: 20px 0; padding: 15px; background: white; border-radius: 5px; }
        input[type="file"] { margin: 10px 0; }
        button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: #45a049; }
        .btn-download { background: #2196F3; }
        .btn-download:hover { background: #0b7dda; }
        .log { background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 200px; overflow-y: auto; font-size: 12px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
        th { background-color: #4CAF50; color: white; }
        .sheet-info { background: #e3f2fd; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Update Excel Field Names</h1>
        <p>This tool will update field names to match standardized data structure:</p>
        <ul style="text-align:left;display:inline-block;">
            <li><strong>Task Module:</strong> Category_Task ‚Üí Task_Category</li>
            <li><strong>Expense Module:</strong> Updates field names to match your Excel structure</li>
            <li><strong>Shared Fields:</strong> Txn_Mode, Frequency, Ac_Status, Txn_Status, Ac_Holder, Txn_Tag (NO module prefix)</li>
        </ul>
        
        <div class="section">
            <h2>Step 1: Upload Your Excel File</h2>
            <input type="file" id="fileInput" accept=".xlsx,.xls" />
            <div id="uploadStatus"></div>
        </div>

        <div class="section" id="processSection" style="display:none;">
            <h2>Step 2: Processing...</h2>
            <div class="log" id="log"></div>
            <button onclick="processFile()">Process File</button>
        </div>

        <div class="section" id="resultSection" style="display:none;">
            <h2>Step 3: Download Updated File</h2>
            <p id="resultInfo"></p>
            <button class="btn-download" onclick="downloadFile()">‚¨áÔ∏è Download Updated Excel File</button>
        </div>
    </div>

    <script>
        let workbook = null;
        let fileName = '';
        let updatedData = {};

        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            fileName = file.name;
            document.getElementById('uploadStatus').innerHTML = 
                '<p style="color:green;">‚úì File loaded: ' + fileName + '</p>';
            document.getElementById('processSection').style.display = 'block';
            log('File loaded: ' + fileName);

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Read with options for better compatibility
                    const readOptions = {
                        type: 'array',
                        cellDates: true,
                        cellStyles: false,
                        sheetStubs: false
                    };
                    workbook = XLSX.read(data, readOptions);
                    log('‚úì Excel file parsed successfully');
                    log('Found ' + workbook.SheetNames.length + ' sheets');
                    processFile();
                } catch (error) {
                    log('‚úó Error: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Field mapping configurations
        const fieldMappings = {
            'Category_Task': {
                sheetName: 'Category_Task',
                newSheetName: 'Task_Category',
                columnName: 'Category_Task',
                newColumnName: 'Task_Category'
            },
            'Expense_Fields': {
                // Expense field mappings
                columnMappings: {
                    'desc': 'Expense_Description',
                    'cat': 'Expense_Category',
                    'tag': 'Expense_Tag',
                    'cur': 'Expense_Currency',
                    'amt': 'Expense_Amount',
                    'mode': 'Expense_Mode',
                    'holder': 'Expense_Holder',
                    'due': 'Expense_Due_Date',
                    'paid': 'Expense_Paid_Date',
                    'freq': 'Expense_Frequency',
                    'acstatus': 'Expense_Account_Status',
                    'txnstatus': 'Expense_Txn_Status'
                }
            }
        };

        function processFile() {
            if (!workbook) {
                log('‚úó No file loaded');
                return;
            }

            log('Starting processing...');
            const changes = [];
            const sheetRenames = [];

            // First, rename sheet names to match standardized naming
            workbook.SheetNames.forEach((sheetName, index) => {
                // Task module sheet renames
                if (sheetName === 'Category_Task') {
                    const newSheetName = 'Task_Category';
                    const sheet = workbook.Sheets[sheetName];
                    delete workbook.Sheets[sheetName];
                    workbook.Sheets[newSheetName] = sheet;
                    workbook.SheetNames[index] = newSheetName;
                    sheetRenames.push({ old: sheetName, new: newSheetName });
                    log('‚úì Renamed sheet: "Category_Task" ‚Üí "Task_Category"');
                }
                
                // Expense module sheet renames - common variations
                const expenseSheetMap = {
                    'Category_Expanse': 'Expense_Category',
                    'Category_Expense': 'Expense_Category',
                    'Tag_Expanse': 'Expense_Tag',
                    'Tag_Expense': 'Expense_Tag',
                    'Mode_Expanse': 'Expense_Mode',
                    'Mode_Expense': 'Expense_Mode',
                    'Holder_Expanse': 'Expense_Holder',
                    'Holder_Expense': 'Expense_Holder',
                    'Txn_Expanse': 'Txn_Expense'
                };
                
                if (expenseSheetMap[sheetName]) {
                    const newSheetName = expenseSheetMap[sheetName];
                    const sheet = workbook.Sheets[sheetName];
                    delete workbook.Sheets[sheetName];
                    workbook.Sheets[newSheetName] = sheet;
                    workbook.SheetNames[index] = newSheetName;
                    sheetRenames.push({ old: sheetName, new: newSheetName });
                    log('‚úì Renamed sheet: "' + sheetName + '" ‚Üí "' + newSheetName + '"');
                }
            });

            // Process each sheet
            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                if (jsonData.length > 0) {
                    const headers = Object.keys(jsonData[0]);
                    log('Processing sheet: ' + sheetName + ' - Headers: ' + headers.join(', '));
                    
                    let sheetUpdated = false;
                    
                    // Check if sheet has Category_Task column (for Task module)
                    if (headers.includes('Category_Task')) {
                        log('‚úì Found Category_Task column in sheet: ' + sheetName);
                        
                        const updatedData = jsonData.map(row => {
                            const newRow = { ...row };
                            newRow['Task_Category'] = row['Category_Task'];
                            delete newRow['Category_Task'];
                            return newRow;
                        });
                        
                        const newSheet = XLSX.utils.json_to_sheet(updatedData);
                        workbook.Sheets[sheetName] = newSheet;
                        
                        changes.push(sheetName + ' (Category_Task ‚Üí Task_Category)');
                        sheetUpdated = true;
                        log('‚úì Updated column: Category_Task ‚Üí Task_Category');
                    }
                    
                    // Check for Expense fields (actual Excel field names from user's file)
                    const expenseFieldMappings = {
                        // Expense-specific fields (WITH module prefix)
                        'Expance_Description': 'Expanse_Description',
                        'Category_Expanse': 'Expanse_Category',
                        'Ac_Tag_Expance': 'Expanse_Ac_Tag',
                        // Date fields
                        'Due_Date': 'Due_Date',  // Keep as is (no prefix)
                        'Paid_Date': 'Paid_Date',  // Keep as is (no prefix)
                        'Paid_From': 'Paid_From',  // Keep as is (no prefix)
                        // SHARED fields (NO module prefix - keep as is or update names)
                        'Payment_Mode': 'Txn_Mode',  // User wants Txn_Mode instead of Payment_Mode
                        'Ac_Holder': 'Ac_Holder',  // NO prefix
                        'Frequency': 'Frequency',  // NO prefix
                        'Amount': 'Amount',  // NO prefix
                        'Ac_Status': 'Ac_Status',  // NO prefix
                        'Txn_Status': 'Txn_Status',  // NO prefix
                        'Txn_Tag': 'Txn_Tag',  // NO prefix
                        // Also handle old abbreviated names - map to new standardized names
                        'desc': 'Expanse_Description',
                        'cat': 'Expanse_Category',
                        'tag': 'Expanse_Ac_Tag',
                        'cur': 'Currency',  // If currency needs handling
                        'amt': 'Amount',  // Keep as shared field
                        'mode': 'Txn_Mode',  // Map to shared field (Txn_Mode, not Payment_Mode)
                        'holder': 'Ac_Holder',  // Map to shared field
                        'due': 'Due_Date',
                        'paid': 'Paid_Date',
                        'freq': 'Frequency',  // Map to shared field
                        'acstatus': 'Ac_Status',  // Map to shared field
                        'txnstatus': 'Txn_Status'  // Map to shared field
                    };
                    
                    const hasExpenseFields = Object.keys(expenseFieldMappings).some(field => headers.includes(field));
                    
                    if (hasExpenseFields) {
                        log('‚úì Found Expense field names in sheet: ' + sheetName);
                        
                        const updatedData = jsonData.map(row => {
                            const newRow = { ...row };
                            
                            // Map old field names to new standardized names
                            Object.keys(expenseFieldMappings).forEach(oldField => {
                                if (row[oldField] !== undefined && row[oldField] !== null) {
                                    newRow[expenseFieldMappings[oldField]] = row[oldField];
                                }
                            });
                            
                            // Delete old fields (don't delete if they're the same as new name)
                            Object.keys(expenseFieldMappings).forEach(field => {
                                if (field !== expenseFieldMappings[field] && newRow[field]) {
                                    delete newRow[field];
                                }
                            });
                            
                            return newRow;
                        });
                        
                        // Recreate sheet with proper options to preserve structure
                        const newSheet = XLSX.utils.json_to_sheet(updatedData, {
                            header: Object.keys(updatedData[0] || {}),
                            skipHeader: false
                        });
                        
                        // Preserve sheet properties
                        if (sheet['!rows']) newSheet['!rows'] = sheet['!rows'];
                        if (sheet['!merges']) newSheet['!merges'] = sheet['!merges'];
                        
                        workbook.Sheets[sheetName] = newSheet;
                        
                        if (!sheetUpdated) {
                            changes.push(sheetName + ' (Expense fields updated to standardized names)');
                        }
                        sheetUpdated = true;
                        log('‚úì Updated Expense fields to standardized names');
                    }
                }
            });

            log('Processing complete!');
            log('Renamed ' + sheetRenames.length + ' sheet name(s)');
            log('Updated ' + changes.length + ' column(s)');
            
            // Always show result section
            document.getElementById('resultSection').style.display = 'block';
            
            if (changes.length > 0 || sheetRenames.length > 0) {
                let info = '<p style="color:green;">‚úì Successfully updated:</p><ul>';
                if (sheetRenames.length > 0) {
                    info += '<li>Renamed sheet(s): ' + sheetRenames.map(r => r.old + ' ‚Üí ' + r.new).join(', ') + '</li>';
                }
                if (changes.length > 0) {
                    info += '<li>Updated column(s) in sheet(s): ' + changes.join(', ') + '</li>';
                }
                info += '</ul>';
                document.getElementById('resultInfo').innerHTML = info;
            } else {
                document.getElementById('resultInfo').innerHTML = 
                    '<p style="color:orange;">‚ö† No changes needed. All field names are already up to date.</p>' +
                    '<p style="color:blue;">You can still download the file to verify.</p>';
            }
        }

        function downloadFile() {
            if (!workbook) {
                alert('No file to download');
                return;
            }

            try {
                log('Preparing file for download...');
                
                // Add workbook properties for better compatibility
                if (!workbook.Props) {
                    workbook.Props = {};
                }
                workbook.Props.Title = "ClearView Dashboard Data";
                workbook.Props.Subject = "Updated Excel File";
                workbook.Props.Author = "ClearView Dashboard";
                workbook.Props.CreatedDate = new Date();
                
                // Set default column widths for better display
                workbook.SheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    if (sheet && sheet['!ref']) {
                        const range = XLSX.utils.decode_range(sheet['!ref']);
                        sheet['!cols'] = [];
                        for (let i = 0; i <= range.e.c; i++) {
                            sheet['!cols'].push({ wch: 15 }); // Set default column width
                        }
                    }
                });
                
                // Generate Excel file with compatibility options for MS Office 2016
                const wopts = {
                    bookType: 'xlsx',
                    bookSST: false,
                    type: 'array',
                    cellStyles: false,
                    cellDates: true,
                    compression: true
                };
                
                log('Writing workbook with compatibility options...');
                const excelBuffer = XLSX.write(workbook, wopts);
                
                log('File generated successfully. Size: ' + excelBuffer.length + ' bytes');
                
                // Create download with correct MIME type
                const blob = new Blob([excelBuffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                
                // Ensure filename has .xlsx extension
                let newFileName = fileName;
                // Remove any existing extension
                newFileName = newFileName.replace(/\.(xlsx|xls)$/i, '');
                // Add _Updated and ensure .xlsx extension
                newFileName = newFileName + '_Updated.xlsx';
                
                a.download = newFileName;
                a.setAttribute('download', newFileName);
                
                // Trigger download
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                
                log('‚úì Downloaded file as: ' + newFileName);
                alert('‚úì File downloaded successfully as: ' + newFileName);
            } catch (error) {
                log('‚úó Error downloading file: ' + error.message);
                alert('Error downloading file: ' + error.message);
            }
        }
    </script>
</body>
</html>

