<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Master Data ‚Äî ClearView</title>
  <link rel="stylesheet" href="2_Expanse_Style.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--primary-bg, #f8fafc);
    }
    .master-data-container {
      min-height: 100vh;
      background: var(--primary-bg, #f8fafc);
    }
    .tabs-container {
      display: flex;
      gap: 8px;
      padding: 15px 20px;
      background: var(--card-bg, #ffffff);
      border-bottom: 2px solid var(--border-color, #e2e8f0);
      overflow-x: auto;
      flex-wrap: nowrap;
    }
    .tab {
      padding: 12px 24px;
      background: var(--primary-bg, #f8fafc);
      border: 2px solid var(--border-color, #e2e8f0);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-secondary, #64748b);
      transition: all 0.2s;
      white-space: nowrap;
      min-width: fit-content;
    }
    .tab:hover {
      background: var(--accent-blue, #3b82f6);
      color: white;
      border-color: var(--accent-blue, #3b82f6);
    }
    .tab.active {
      background: var(--accent-blue, #3b82f6);
      color: white;
      border-color: var(--accent-blue, #3b82f6);
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
    .two-column-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }
    .field-card {
      background: var(--card-bg, #ffffff);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .field-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color, #e2e8f0);
    }
    .field-name {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-primary, #1e293b);
    }
    .field-count {
      font-size: 0.85rem;
      color: var(--text-secondary, #64748b);
      font-weight: 500;
    }
    .values-container {
      max-height: 280px;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    .value-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      margin-bottom: 6px;
      background: var(--primary-bg, #f8fafc);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      transition: all 0.2s;
    }
    .value-row:hover {
      border-color: var(--accent-blue, #3b82f6);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .value-text {
      flex: 1;
      color: var(--text-primary, #1e293b);
      font-size: 0.95rem;
      padding-right: 10px;
    }
    .value-actions {
      display: flex;
      gap: 6px;
    }
    .btn-icon {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-edit {
      background: var(--accent-blue, #3b82f6);
      color: white;
    }
    .btn-edit:hover {
      background: #2563eb;
    }
    .btn-delete {
      background: #ef4444;
      color: white;
    }
    .btn-delete:hover {
      background: #dc2626;
    }
    .add-form {
      display: flex;
      gap: 8px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color, #e2e8f0);
    }
    .add-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      font-size: 0.95rem;
      background: var(--card-bg, #ffffff);
      color: var(--text-primary, #1e293b);
    }
    .add-input:focus {
      outline: none;
      border-color: var(--accent-blue, #3b82f6);
    }
    .btn-add {
      padding: 10px 20px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .btn-add:hover {
      background: #059669;
    }
    .empty-field {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary, #64748b);
      font-style: italic;
    }
    /* Modal for editing */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: var(--card-bg, #ffffff);
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .modal-header {
      margin-bottom: 20px;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary, #1e293b);
    }
    .modal-body input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      font-size: 1rem;
      margin-bottom: 20px;
      background: var(--card-bg, #ffffff);
      color: var(--text-primary, #1e293b);
    }
    .modal-body input:focus {
      outline: none;
      border-color: var(--accent-blue, #3b82f6);
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .btn-secondary {
      background: var(--text-secondary, #64748b);
      color: white;
    }
    .btn-secondary:hover {
      background: #475569;
    }
    .btn-primary {
      background: var(--accent-blue, #3b82f6);
      color: white;
    }
    .btn-primary:hover {
      background: #2563eb;
    }
    @media (max-width: 1200px) {
      .two-column-grid {
        grid-template-columns: 1fr;
      }
    }
    .values-container::-webkit-scrollbar {
      width: 8px;
    }
    .values-container::-webkit-scrollbar-track {
      background: var(--primary-bg, #f8fafc);
      border-radius: 4px;
    }
    .values-container::-webkit-scrollbar-thumb {
      background: var(--text-secondary, #64748b);
      border-radius: 4px;
    }
    .values-container::-webkit-scrollbar-thumb:hover {
      background: var(--accent-blue, #3b82f6);
    }
  </style>
</head>
<body>
  <!-- Header matching dashboard style -->
  <header class="header">
    <div class="left">
      <button class="black" onclick="window.location.href='index.html'">‚Üê Back to Main Dashboard</button>
    </div>
    <div class="title">Manage Master Data</div>
    <div class="right">
      <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display:none;">
      <button class="excel" onclick="document.getElementById('excelFileInput').click()">üì• Load from Excel</button>
      <button class="danger" id="btnClearData" style="background:#ea4335;color:white;">üóëÔ∏è Clear All Data</button>
    </div>
  </header>

  <div class="master-data-container">
    <!-- Tabs -->
    <div class="tabs-container">
      <div class="tab active" data-tab="income">üìä Master Data for Income</div>
      <div class="tab" data-tab="expense">üí∞ Master Data for Expense</div>
      <div class="tab" data-tab="investment">üìà Master Data for Investment</div>
      <div class="tab" data-tab="task">‚úÖ Master Data for Task</div>
      <div class="tab" data-tab="common">üåê Common Master Data Fields</div>
    </div>

    <!-- Tab Contents -->
    <div id="incomeContent" class="tab-content active">
      <div class="two-column-grid" id="incomeGrid"></div>
    </div>

    <div id="expenseContent" class="tab-content">
      <div class="two-column-grid" id="expenseGrid"></div>
    </div>

    <div id="investmentContent" class="tab-content">
      <div class="two-column-grid" id="investmentGrid"></div>
    </div>

    <div id="taskContent" class="tab-content">
      <div class="two-column-grid" id="taskGrid"></div>
    </div>

    <div id="commonContent" class="tab-content">
      <div class="two-column-grid" id="commonGrid"></div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">Edit Value</div>
      <div class="modal-body">
        <input type="text" id="editInput" placeholder="Enter value">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEditedValue()">Save</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Master data structure - only fields specified by user
    // Sheets with prefix Income_, Investment_, Expense_, Task_ belong to those modules
    // Sheets without these prefixes are common fields (Currency, Frequency, Ac_Holder, Txn_Mode, Txn_Status, Ac_Status)
    // Sheets with prefix Txn_ are transactional data (not master data)
    const MASTER_DATA_STRUCTURE = {
      expense: {
        'Expanse_Category': 'Expense Category',
        'Expanse_Ac_Tag': 'Expense Account Tag'
      },
      income: {
        'Income_Category': 'Income Category',
        'Income_Ac_Tag': 'Income Account Tag' // Relates to "Paid From" in Expense and Investment Dashboards
      },
      investment: {
        'Investment_Category': 'Investment Category',
        'Investment_Ac_Tag': 'Investment Account Tag'
      },
      task: {
        'Task_Tag': 'Task Tag',
        'Task_Status': 'Task Status',
        'Task_Assignee': 'Task Assignee',
        'Task_Priority': 'Task Priority',
        'Task_Category': 'Task Category'
      },
      common: {
        'Currency': 'Currency',
        'Txn_Mode': 'Transaction Mode',
        'Txn_Status': 'Transaction Status',
        'Ac_Holder': 'Account Holder',
        'Frequency': 'Frequency',
        'Ac_Status': 'Account Status'
      }
    };

    // Mapping: Excel sheet name variations to unified field keys
    const SHEET_NAME_MAP = {
      // Expense variations ‚Üí expense fields
      'Expanse_Category': { module: 'expense', key: 'Expanse_Category' },
      'Expense_Category': { module: 'expense', key: 'Expanse_Category' }, // Map to Expanse_Category
      'Expanse_Ac_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' },
      'Expense_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' }, // Map to Expanse_Ac_Tag
      'Expense_Ac_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' },
      
      // Income variations ‚Üí income fields
      'Income_Category': { module: 'income', key: 'Income_Category' },
      'Income_Ac_Tag': { module: 'income', key: 'Income_Ac_Tag' },
      'Income_Tag': { module: 'income', key: 'Income_Ac_Tag' }, // Map to Income_Ac_Tag
      
      // Investment variations ‚Üí investment fields
      'Investment_Category': { module: 'investment', key: 'Investment_Category' },
      'Investment_Ac_Tag': { module: 'investment', key: 'Investment_Ac_Tag' },
      'Investment_Tag': { module: 'investment', key: 'Investment_Ac_Tag' }, // Map to Investment_Ac_Tag
      
      // Task fields
      'Task_Category': { module: 'task', key: 'Task_Category' },
      'Task_Tag': { module: 'task', key: 'Task_Tag' },
      'Task_Status': { module: 'task', key: 'Task_Status' },
      'Task_Assignee': { module: 'task', key: 'Task_Assignee' },
      'Task_Priority': { module: 'task', key: 'Task_Priority' },
      'Task_Adhoc': { module: 'task', key: 'Task_Adhoc' },
      
      // Common fields (no prefix)
      'Currency': { module: 'common', key: 'Currency' },
      'Frequency': { module: 'common', key: 'Frequency' },
      'Ac_Holder': { module: 'common', key: 'Ac_Holder' },
      'Expense_Holder': { module: 'common', key: 'Ac_Holder' }, // Map variations to Ac_Holder
      'Income_Holder': { module: 'common', key: 'Ac_Holder' },
      'Investment_Holder': { module: 'common', key: 'Ac_Holder' },
      'Txn_Mode': { module: 'common', key: 'Txn_Mode' },
      'Expense_Mode': { module: 'common', key: 'Txn_Mode' }, // Map variations to Txn_Mode
      'Income_Mode': { module: 'common', key: 'Txn_Mode' },
      'Investment_Mode': { module: 'common', key: 'Txn_Mode' },
      'Txn_Status': { module: 'common', key: 'Txn_Status' },
      'Expense_Txn_Status': { module: 'common', key: 'Txn_Status' }, // Map variations to Txn_Status
      'Income_Txn_Status': { module: 'common', key: 'Txn_Status' },
      'Investment_Txn_Status': { module: 'common', key: 'Txn_Status' },
      'Ac_Status': { module: 'common', key: 'Ac_Status' },
      'Expense_Account_Status': { module: 'common', key: 'Ac_Status' }, // Map variations to Ac_Status
      'Income_Account_Status': { module: 'common', key: 'Ac_Status' },
      'Investment_Account_Status': { module: 'common', key: 'Ac_Status' }
    };

    // Unified master data container
    let masterData = {};
    let currentEdit = null;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        switchTab(targetTab);
      });
    });

    function switchTab(tabName) {
      // Update active tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      // Update active content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`${tabName}Content`).classList.add('active');

      // Render the tab content
      renderTab(tabName);
    }

    // Load master data from localStorage
    function loadMasterData() {
      const saved = localStorage.getItem('unified_master_data');
      if (saved) {
        masterData = JSON.parse(saved);
      } else {
        // Try to load from legacy format and convert
        masterData = {
          task: JSON.parse(localStorage.getItem('task_master_data') || '{}'),
          expense: JSON.parse(localStorage.getItem('expense_master_data') || '{}'),
          income: JSON.parse(localStorage.getItem('income_master_data') || '{}'),
          investment: JSON.parse(localStorage.getItem('investment_master_data') || '{}'),
          common: {}
        };
        saveMasterData();
      }
      initializeMasterData();
      renderTab('income'); // Render default tab
    }

    // Save master data to localStorage
    function saveMasterData() {
      localStorage.setItem('unified_master_data', JSON.stringify(masterData));
      // Also save to module-specific keys for backwards compatibility
      localStorage.setItem('task_master_data', JSON.stringify(masterData.task || {}));
      localStorage.setItem('expense_master_data', JSON.stringify(masterData.expense || {}));
      localStorage.setItem('income_master_data', JSON.stringify(masterData.income || {}));
      localStorage.setItem('investment_master_data', JSON.stringify(masterData.investment || {}));
    }

    // Initialize master data structure
    function initializeMasterData() {
      ['task', 'expense', 'income', 'investment', 'common'].forEach(module => {
        if (!masterData[module]) masterData[module] = {};
        Object.keys(MASTER_DATA_STRUCTURE[module]).forEach(key => {
          if (!masterData[module][key]) masterData[module][key] = [];
        });
      });
    }

    // Render a tab
    function renderTab(module) {
      const container = document.getElementById(`${module}Grid`);
      container.innerHTML = '';

      const fields = MASTER_DATA_STRUCTURE[module];
      let fieldKeys = Object.keys(fields);
      
      // For module tabs (not common), also include common fields
      if (module !== 'common') {
        const commonFields = MASTER_DATA_STRUCTURE.common;
        fieldKeys = [...fieldKeys, ...Object.keys(commonFields)];
      }
      
      // Split fields into two columns
      const midPoint = Math.ceil(fieldKeys.length / 2);
      const leftFields = fieldKeys.slice(0, midPoint);
      const rightFields = fieldKeys.slice(midPoint);

      // Create left column
      const leftCol = document.createElement('div');
      leftFields.forEach(fieldKey => {
        // Determine if this is a common field being shown in a module tab
        const isCommonField = module !== 'common' && MASTER_DATA_STRUCTURE.common[fieldKey];
        let displayLabel;
        if (isCommonField) {
          displayLabel = MASTER_DATA_STRUCTURE.common[fieldKey] + ' ‚Üî';
        } else {
          displayLabel = fields[fieldKey];
        }
        leftCol.appendChild(createFieldCard(module, fieldKey, displayLabel, isCommonField));
      });
      container.appendChild(leftCol);

      // Create right column
      const rightCol = document.createElement('div');
      rightFields.forEach(fieldKey => {
        // Determine if this is a common field being shown in a module tab
        const isCommonField = module !== 'common' && MASTER_DATA_STRUCTURE.common[fieldKey];
        let displayLabel;
        if (isCommonField) {
          displayLabel = MASTER_DATA_STRUCTURE.common[fieldKey] + ' ‚Üî';
        } else {
          displayLabel = fields[fieldKey];
        }
        rightCol.appendChild(createFieldCard(module, fieldKey, displayLabel, isCommonField));
      });
      container.appendChild(rightCol);
    }

    // Create a field card
    function createFieldCard(module, fieldKey, fieldLabel, isCommonField = false) {
      const card = document.createElement('div');
      card.className = 'field-card';

      const header = document.createElement('div');
      header.className = 'field-header';
      // Get values - if this is a common field being accessed from a module tab
      let values = [];
      if (isCommonField || (module !== 'common' && MASTER_DATA_STRUCTURE.common[fieldKey])) {
        // Access common field
        values = masterData.common && masterData.common[fieldKey] ? masterData.common[fieldKey] : [];
      } else {
        values = masterData[module] && masterData[module][fieldKey] ? masterData[module][fieldKey] : [];
      }
      // Format: Actual Field Name (count) <--> Mapped Field Name
      const actualFieldName = fieldKey; // Excel sheet name (e.g., Expanse_Category)
      const mappedFieldName = fieldLabel.replace(' ‚Üî', ''); // Display name (e.g., Expense Category)
      header.innerHTML = `
        <span class="field-name">${actualFieldName} (${values.length}) <--> ${mappedFieldName}</span>
      `;
      card.appendChild(header);

      const valuesContainer = document.createElement('div');
      valuesContainer.className = 'values-container';

      if (values.length === 0) {
        valuesContainer.innerHTML = '<div class="empty-field">No entries yet</div>';
      } else {
          values.forEach((value, index) => {
          const row = document.createElement('div');
          row.className = 'value-row';
          // Determine save module/key for common fields viewed from module tabs
          let saveModule = module;
          let saveKey = fieldKey;
          if (isCommonField || (module !== 'common' && MASTER_DATA_STRUCTURE.common[fieldKey])) {
            saveModule = 'common';
            saveKey = fieldKey;
          }
          row.innerHTML = `
            <span class="value-text">${escapeHtml(value)}</span>
            <div class="value-actions">
              <button class="btn-icon btn-edit" onclick="editValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Edit</button>
              <button class="btn-icon btn-delete" onclick="deleteValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Delete</button>
            </div>
          `;
          valuesContainer.appendChild(row);
        });
      }
      card.appendChild(valuesContainer);

      const addForm = document.createElement('div');
      addForm.className = 'add-form';
      // Determine which module to save to for common fields
      let saveModule = module;
      let saveKey = fieldKey;
      if (isCommonField || (module !== 'common' && MASTER_DATA_STRUCTURE.common[fieldKey])) {
        saveModule = 'common';
        saveKey = fieldKey;
      }
      addForm.innerHTML = `
        <input type="text" class="add-input" id="add_${module}_${fieldKey}" placeholder="Add new ${fieldLabel.toLowerCase()}" onkeypress="if(event.key==='Enter') addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">
        <button class="btn-add" onclick="addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">Add</button>
      `;
      card.appendChild(addForm);

      return card;
    }

    // Add value
    function addValue(saveModule, saveKey, displayModule, displayKey) {
      // displayModule and displayKey are for the input element ID when viewing common fields from module tabs
      const inputId = displayModule ? `add_${displayModule}_${displayKey}` : `add_${saveModule}_${saveKey}`;
      const input = document.getElementById(inputId);
      const value = input.value.trim();
      if (!value) {
        alert('Please enter a value');
        return;
      }
      if (!masterData[saveModule]) masterData[saveModule] = {};
      if (!masterData[saveModule][saveKey]) masterData[saveModule][saveKey] = [];
      if (masterData[saveModule][saveKey].includes(value)) {
        alert('This value already exists');
        return;
      }
      masterData[saveModule][saveKey].push(value);
      masterData[saveModule][saveKey].sort();
      saveMasterData();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
      input.value = '';
    }

    // Edit value
    function editValue(module, fieldKey, index, displayModule) {
      currentEdit = { module, fieldKey, index, displayModule: displayModule || module };
      const value = masterData[module][fieldKey][index];
      document.getElementById('editInput').value = value;
      // Get the display label
      let displayLabel = '';
      if (module === 'common') {
        displayLabel = MASTER_DATA_STRUCTURE.common[fieldKey] || fieldKey;
      } else {
        displayLabel = MASTER_DATA_STRUCTURE[module][fieldKey] || fieldKey;
      }
      document.getElementById('modalTitle').textContent = `Edit ${displayLabel}`;
      document.getElementById('editModal').classList.add('show');
    }

    // Save edited value
    function saveEditedValue() {
      if (!currentEdit) return;
      const input = document.getElementById('editInput');
      const newValue = input.value.trim();
      if (!newValue) {
        alert('Please enter a value');
        return;
      }
      const { module, fieldKey, index, displayModule } = currentEdit;
      if (masterData[module][fieldKey].includes(newValue) && masterData[module][fieldKey][index] !== newValue) {
        alert('This value already exists');
        return;
      }
      masterData[module][fieldKey][index] = newValue;
      masterData[module][fieldKey].sort();
      saveMasterData();
      closeEditModal();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
    }

    // Delete value
    function deleteValue(module, fieldKey, index, displayModule) {
      if (!confirm('Are you sure you want to delete this value?')) return;
      masterData[module][fieldKey].splice(index, 1);
      saveMasterData();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      currentEdit = null;
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Excel import handler
    document.getElementById('excelFileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetNames = workbook.SheetNames;

          console.log('Available sheets:', sheetNames);

          // Initialize master data
          initializeMasterData();

          // Extract all master data sheets (exclude Txn_* sheets)
          sheetNames.forEach(sheetName => {
            if (sheetName.startsWith('Txn_')) {
              console.log('Skipping transactional sheet:', sheetName);
              return;
            }

            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet);

            if (jsonData.length === 0) return;

            // Try to find the column with the same name as the sheet, or use first column
            let values = [];
            const firstRow = jsonData[0];
            const columnKeys = Object.keys(firstRow);

            // Try exact match first
            if (firstRow[sheetName] !== undefined) {
              values = jsonData.map(row => row[sheetName]).filter(v => v !== undefined && v !== null && v !== '');
            } else {
              // Use first column
              const firstCol = columnKeys[0];
              values = jsonData.map(row => row[firstCol]).filter(v => v !== undefined && v !== null && v !== '');
            }

            // Determine which module and field this sheet belongs to
            let foundModule = null;
            let foundKey = null;

            // First, check exact mapping
            if (SHEET_NAME_MAP[sheetName]) {
              foundModule = SHEET_NAME_MAP[sheetName].module;
              foundKey = SHEET_NAME_MAP[sheetName].key;
            } else {
              // Try to determine based on prefix rules
              const lowerSheet = sheetName.toLowerCase();
              
              // Check for module prefixes
              if (sheetName.startsWith('Task_')) {
                foundModule = 'task';
                foundKey = sheetName;
                // Check if it's in our structure
                if (!MASTER_DATA_STRUCTURE.task[sheetName]) {
                  foundModule = null;
                  foundKey = null;
                }
              } else if (sheetName.startsWith('Income_')) {
                foundModule = 'income';
                foundKey = sheetName;
                // Check if it's in our structure
                if (!MASTER_DATA_STRUCTURE.income[sheetName]) {
                  foundModule = null;
                  foundKey = null;
                }
              } else if (sheetName.startsWith('Investment_')) {
                foundModule = 'investment';
                foundKey = sheetName;
                // Check if it's in our structure
                if (!MASTER_DATA_STRUCTURE.investment[sheetName]) {
                  foundModule = null;
                  foundKey = null;
                }
              } else if (sheetName.startsWith('Expense_') || sheetName.startsWith('Expanse_')) {
                foundModule = 'expense';
                // Map variations to unified keys
                if (sheetName === 'Expense_Category') {
                  foundKey = 'Expanse_Category';
                } else if (sheetName === 'Expanse_Category') {
                  foundKey = 'Expanse_Category';
                } else if (sheetName === 'Expense_Tag' || sheetName === 'Expense_Ac_Tag') {
                  foundKey = 'Expanse_Ac_Tag';
                } else if (sheetName === 'Expanse_Ac_Tag') {
                  foundKey = 'Expanse_Ac_Tag';
                } else {
                  // Not a valid expense master field - might be a variation that should map to common
                  foundModule = null;
                  foundKey = null;
                }
              } else {
                // No prefix = common field
                // Check if it matches common field names
                if (lowerSheet === 'currency') {
                  foundModule = 'common';
                  foundKey = 'Currency';
                } else if (lowerSheet === 'frequency') {
                  foundModule = 'common';
                  foundKey = 'Frequency';
                } else if (lowerSheet === 'ac_holder' || lowerSheet === 'account holder') {
                  foundModule = 'common';
                  foundKey = 'Ac_Holder';
                } else if (lowerSheet === 'txn_mode' || lowerSheet === 'transaction mode') {
                  foundModule = 'common';
                  foundKey = 'Txn_Mode';
                } else if (lowerSheet === 'txn_status' || lowerSheet === 'transaction status') {
                  foundModule = 'common';
                  foundKey = 'Txn_Status';
                } else if (lowerSheet === 'ac_status' || lowerSheet === 'account status') {
                  foundModule = 'common';
                  foundKey = 'Ac_Status';
                } else if (SHEET_NAME_MAP[sheetName]) {
                  // Check variations mapping
                  foundModule = SHEET_NAME_MAP[sheetName].module;
                  foundKey = SHEET_NAME_MAP[sheetName].key;
                }
              }
            }

            if (foundModule && foundKey && values.length > 0) {
              // Initialize if needed
              if (!masterData[foundModule]) masterData[foundModule] = {};
              if (!masterData[foundModule][foundKey]) masterData[foundModule][foundKey] = [];
              
              // Merge with existing values (avoid duplicates)
              const existing = masterData[foundModule][foundKey] || [];
              const newValues = values.filter(v => v && v !== '' && !existing.includes(v));
              masterData[foundModule][foundKey] = [...existing, ...newValues].sort();
              console.log(`Loaded ${values.length} values from ${sheetName} into ${foundModule}.${foundKey} (${newValues.length} new)`);
            } else {
              console.log(`Skipping sheet ${sheetName} - not a master data field or no values`);
            }
          });

          saveMasterData();
          const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
          renderTab(currentTab);
          alert(`Successfully imported master data from Excel file!\n\nTotal sheets processed: ${sheetNames.filter(s => !s.startsWith('Txn_')).length}`);
        } catch (error) {
          console.error('Error reading Excel file:', error);
          alert('Error reading Excel file: ' + error.message);
        }
      };
      reader.readAsArrayBuffer(file);
      // Reset file input
      e.target.value = '';
    });

    // Close modal on outside click
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEditModal();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeEditModal();
      }
    });

    // Clear all data with double confirmation
    document.getElementById('btnClearData').addEventListener('click', function() {
      // First confirmation
      const firstConfirm = confirm('‚ö†Ô∏è WARNING: This will delete ALL master data!\n\nAre you sure you want to proceed?');
      if (!firstConfirm) return;

      // Second confirmation with more details
      const secondConfirm = confirm('‚ö†Ô∏è FINAL WARNING: This action cannot be undone!\n\nAll master data for Income, Expense, Investment, Task, and Common fields will be permanently deleted.\n\nClick OK to confirm deletion.');
      if (!secondConfirm) return;

      // Clear all master data
      masterData = {
        task: {},
        expense: {},
        income: {},
        investment: {},
        common: {}
      };

      // Clear localStorage
      localStorage.removeItem('unified_master_data');
      localStorage.removeItem('task_master_data');
      localStorage.removeItem('expense_master_data');
      localStorage.removeItem('income_master_data');
      localStorage.removeItem('investment_master_data');

      // Initialize empty structure and re-render
      initializeMasterData();
      saveMasterData();
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
      
      alert('‚úÖ All master data has been cleared successfully.');
    });

    // Initialize on load
    loadMasterData();
  </script>
</body>
</html>
