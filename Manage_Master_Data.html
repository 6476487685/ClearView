<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Master Data ‚Äî ClearView</title>
  <link rel="stylesheet" href="2_Expanse_Style.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--primary-bg, #f8fafc);
    }
    .master-data-container {
      min-height: 100vh;
      background: var(--primary-bg, #f8fafc);
    }
    .tabs-container {
      display: flex;
      gap: 5px;
      padding: 10px 12px;
      background: var(--card-bg, #ffffff);
      border-bottom: 2px solid var(--border-color, #e2e8f0);
      overflow-x: hidden;
      flex-wrap: nowrap;
    }
    .tab {
      padding: 8px 12px;
      background: var(--primary-bg, #f8fafc);
      border: 2px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--text-secondary, #64748b);
      transition: all 0.2s;
      white-space: nowrap;
      flex: 1;
      min-width: 0;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tab:hover {
      background: var(--accent-blue, #3b82f6);
      color: white;
      border-color: var(--accent-blue, #3b82f6);
    }
    .tab.active {
      background: var(--accent-blue, #3b82f6);
      color: white;
      border-color: var(--accent-blue, #3b82f6);
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
    .two-column-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 1562px;
      margin: 0 auto;
    }
    .field-card {
      background: var(--card-bg, #ffffff);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .field-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color, #e2e8f0);
    }
    .field-name {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-primary, #1e293b);
    }
    .field-count {
      font-size: 0.85rem;
      color: var(--text-secondary, #64748b);
      font-weight: 500;
    }
    .values-container {
      max-height: 220px;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    .value-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      margin-bottom: 6px;
      background: var(--primary-bg, #f8fafc);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      transition: all 0.2s;
    }
    .value-row:hover {
      border-color: var(--accent-blue, #3b82f6);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .value-text {
      flex: 1;
      color: var(--text-primary, #1e293b);
      font-size: 0.95rem;
      padding-right: 10px;
    }
    .value-actions {
      display: flex;
      gap: 6px;
    }
    .btn-icon {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-edit {
      background: var(--accent-blue, #3b82f6);
      color: white;
    }
    .btn-edit:hover {
      background: #2563eb;
    }
    .btn-delete {
      background: #ef4444;
      color: white;
    }
    .btn-delete:hover {
      background: #dc2626;
    }
    .add-form {
      display: flex;
      gap: 8px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color, #e2e8f0);
    }
    .add-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      font-size: 0.95rem;
      background: var(--card-bg, #ffffff);
      color: var(--text-primary, #1e293b);
    }
    .add-input:focus {
      outline: none;
      border-color: var(--accent-blue, #3b82f6);
    }
    .btn-add {
      padding: 10px 20px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .btn-add:hover {
      background: #059669;
    }
    .empty-field {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary, #64748b);
      font-style: italic;
    }
    /* Modal for editing */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: var(--card-bg, #ffffff);
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .modal-header {
      margin-bottom: 20px;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary, #1e293b);
    }
    .modal-body input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      font-size: 1rem;
      margin-bottom: 20px;
      background: var(--card-bg, #ffffff);
      color: var(--text-primary, #1e293b);
    }
    .modal-body input:focus {
      outline: none;
      border-color: var(--accent-blue, #3b82f6);
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .btn-secondary {
      background: var(--text-secondary, #64748b);
      color: white;
    }
    .btn-secondary:hover {
      background: #475569;
    }
    .btn-primary {
      background: var(--accent-blue, #3b82f6);
      color: white;
    }
    .btn-primary:hover {
      background: #2563eb;
    }
    @media (max-width: 1200px) {
      .two-column-grid {
        grid-template-columns: 1fr;
      }
    }
    .values-container::-webkit-scrollbar {
      width: 8px;
    }
    .values-container::-webkit-scrollbar-track {
      background: var(--primary-bg, #f8fafc);
      border-radius: 4px;
    }
    .values-container::-webkit-scrollbar-thumb {
      background: var(--text-secondary, #64748b);
      border-radius: 4px;
    }
    .values-container::-webkit-scrollbar-thumb:hover {
      background: var(--accent-blue, #3b82f6);
    }
    /* Paths tab styles */
    .paths-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .path-section {
      background: var(--card-bg, #ffffff);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .path-title {
      margin: 0 0 15px 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary, #1e293b);
    }
    .path-display {
      background: var(--primary-bg, #f8fafc);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      color: var(--text-primary, #1e293b);
      word-break: break-all;
      min-height: 20px;
    }
    .path-display:empty::before {
      content: "Not set";
      color: var(--text-secondary, #64748b);
      font-style: italic;
    }
    .path-input-group {
      display: flex;
      gap: 10px;
    }
    .path-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      font-size: 0.95rem;
      background: var(--card-bg, #ffffff);
      color: var(--text-primary, #1e293b);
    }
    .path-input:focus {
      outline: none;
      border-color: var(--accent-blue, #3b82f6);
    }
  </style>
</head>
<body>
  <!-- Header matching dashboard style -->
  <header class="header">
    <div class="left">
      <button class="black" onclick="window.location.href='index.html'">‚Üê Back to Main Dashboard</button>
    </div>
    <div class="title">Manage Master Data</div>
    <div class="right">
      <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display:none;">
      <button class="excel" id="btnLoadFromD" type="button" title="Upload Excel File">üì• Load from D:</button>
      <button class="excel" onclick="alert('Google Drive integration is currently unavailable.')" title="Upload Excel File, Currently Unavailable" style="opacity: 0.6; cursor: not-allowed;">‚òÅÔ∏è Load from Google Drive</button>
      <button class="danger" id="btnClearData" style="background:#ea4335;color:white;" title="It deletes all Master Data">üóëÔ∏è Clear All Data</button>
    </div>
  </header>
  <div style="text-align:center;padding:5px 0;font-size:0.85rem;color:var(--text-secondary);" id="lastFileInfo"></div>

  <div class="master-data-container">
    <!-- Tabs -->
    <div class="tabs-container">
      <div class="tab active" data-tab="income">üìä Income</div>
      <div class="tab" data-tab="expense">üí∞ Expense</div>
      <div class="tab" data-tab="investment">üìà Investment</div>
      <div class="tab" data-tab="task">‚úÖ Task</div>
      <div class="tab" data-tab="common">üåê Common</div>
      <div class="tab" data-tab="paths">üîß Set/Change Paths</div>
    </div>

    <!-- Tab Contents -->
    <div id="incomeContent" class="tab-content active">
      <div class="two-column-grid" id="incomeGrid"></div>
    </div>

    <div id="expenseContent" class="tab-content">
      <div class="two-column-grid" id="expenseGrid"></div>
    </div>

    <div id="investmentContent" class="tab-content">
      <div class="two-column-grid" id="investmentGrid"></div>
    </div>

    <div id="taskContent" class="tab-content">
      <div class="two-column-grid" id="taskGrid"></div>
    </div>

    <div id="commonContent" class="tab-content">
      <div class="two-column-grid" id="commonGrid"></div>
    </div>

    <div id="pathsContent" class="tab-content">
      <div class="paths-container" id="pathsContainer">
        <div class="path-section">
          <h3 class="path-title">üìÅ Project Backup</h3>
          <div class="path-display" id="backupPathDisplay">Not set</div>
          <div class="path-input-group">
            <input type="text" id="backupPathInput" class="path-input" placeholder="Enter backup folder path (e.g., D:\Projects\Backup)">
            <button class="btn btn-primary" onclick="setPath('backup')">Set Path</button>
          </div>
        </div>
        <div class="path-section">
          <h3 class="path-title">üìÑ Project Documents</h3>
          <div class="path-display" id="documentsPathDisplay">Not set</div>
          <div class="path-input-group">
            <input type="text" id="documentsPathInput" class="path-input" placeholder="Enter documents folder path (e.g., D:\Projects\Documents)">
            <button class="btn btn-primary" onclick="setPath('documents')">Set Path</button>
          </div>
        </div>
        <div class="path-section">
          <h3 class="path-title">‚¨áÔ∏è Project Downloads</h3>
          <div class="path-display" id="downloadsPathDisplay">Not set</div>
          <div class="path-input-group">
            <input type="text" id="downloadsPathInput" class="path-input" placeholder="Enter downloads folder path (e.g., D:\Projects\Downloads)">
            <button class="btn btn-primary" onclick="setPath('downloads')">Set Path</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">Edit Value</div>
      <div class="modal-body">
        <input type="text" id="editInput" placeholder="Enter value">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEditedValue()">Save</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Define openFilePicker immediately and make it globally accessible
    window.openFilePicker = function openFilePicker(){
      console.log('openFilePicker called');
      const input = document.getElementById('excelFileInput');
      if(!input){ 
        alert('File input not found'); 
        console.error('File input element not found');
        return; 
      }
      console.log('File input found, attempting to open picker');
      try{
        if(typeof input.showPicker === 'function'){
          console.log('Using showPicker()');
          input.showPicker();
          return;
        }
      }catch(err){ 
        console.log('showPicker not available, using click fallback:', err);
        /* fall through to click */ 
      }
      try{
        console.log('Using click() method');
        input.click();
        console.log('File picker opened successfully');
      }catch(err){
        console.error('Unable to open file picker:', err);
        alert('Unable to open file picker: ' + err.message);
      }
    };
    // (Reverted) No inline onchange handler; main listener will process
    // Master data structure - only fields specified by user
    // Sheets with prefix Income_, Investment_, Expense_, Task_ belong to those modules
    // Sheets without these prefixes are common fields (Currency, Frequency, Ac_Holder, Mode, Txn_Status, Ac_Status)
    // Sheets with prefix Txn_ are transactional data (not master data)
    const MASTER_DATA_STRUCTURE = {
      expense: {
        'Expanse_Category': 'Expense Category',
        'Expanse_Ac_Tag': 'Expense Account Tag'
      },
      income: {
        'Income_Category': 'Income Category',
        'Income_Ac_Tag': 'Income Account Tag' // Relates to "Paid From" in Expense and Investment Dashboards
      },
      investment: {
        'Investment_Category': 'Investment Category',
        'Investment_Ac_Tag': 'Investment Account Tag'
      },
      task: {
        'Task_Tag': 'Task Tag',
        'Task_Status': 'Task Status',
        'Task_Assignee': 'Task Assignee',
        'Task_Priority': 'Task Priority',
        'Task_Category': 'Task Category',
        'Task_Adhoc': 'Task Adhoc'
      },
      common: {
        'Currency': 'Currency',
        'Mode': 'Mode',
        'Status_Txn': 'Transaction Status',
        'Ac_Holder': 'Account Holder',
        'Frequency': 'Frequency',
        'Ac_Status': 'Account Status'
      }
    };

    // Mapping: Excel sheet name variations to unified field keys
    const SHEET_NAME_MAP = {
      // Expense variations ‚Üí expense fields
      'Expanse_Category': { module: 'expense', key: 'Expanse_Category' },
      'Expense_Category': { module: 'expense', key: 'Expanse_Category' }, // Map to Expanse_Category
      'Expanse_Ac_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' },
      'Expense_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' }, // Map to Expanse_Ac_Tag
      'Expense_Ac_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' },
      
      // Income variations ‚Üí income fields
      'Income_Category': { module: 'income', key: 'Income_Category' },
      'Income_Ac_Tag': { module: 'income', key: 'Income_Ac_Tag' },
      'Income_Tag': { module: 'income', key: 'Income_Ac_Tag' }, // Map to Income_Ac_Tag
      
      // Investment variations ‚Üí investment fields
      'Investment_Category': { module: 'investment', key: 'Investment_Category' },
      'Investment_Ac_Tag': { module: 'investment', key: 'Investment_Ac_Tag' },
      'Investment_Tag': { module: 'investment', key: 'Investment_Ac_Tag' }, // Map to Investment_Ac_Tag
      
      // Task fields
      'Task_Category': { module: 'task', key: 'Task_Category' },
      'Task_Tag': { module: 'task', key: 'Task_Tag' },
      'Task_Status': { module: 'task', key: 'Task_Status' },
      'Task_Assignee': { module: 'task', key: 'Task_Assignee' },
      'Task_Priority': { module: 'task', key: 'Task_Priority' },
      'Task_Adhoc': { module: 'task', key: 'Task_Adhoc' },
      
      // Common fields (no prefix)
      'Currency': { module: 'common', key: 'Currency' },
      'Frequency': { module: 'common', key: 'Frequency' },
      'Ac_Holder': { module: 'common', key: 'Ac_Holder' },
      'Expense_Holder': { module: 'common', key: 'Ac_Holder' }, // Map variations to Ac_Holder
      'Income_Holder': { module: 'common', key: 'Ac_Holder' },
      'Investment_Holder': { module: 'common', key: 'Ac_Holder' },
      'Mode_Txn': { module: 'common', key: 'Mode' },
      'Txn_Mode': { module: 'common', key: 'Mode' }, // Normalize to Mode
      'Mode': { module: 'common', key: 'Mode' },
      'Expense_Mode': { module: 'common', key: 'Mode' }, // Map variations to Mode
      'Income_Mode': { module: 'common', key: 'Mode' },
      'Investment_Mode': { module: 'common', key: 'Mode' },
      'Status_Txn': { module: 'common', key: 'Status_Txn' },
      'Txn_Status': { module: 'common', key: 'Status_Txn' }, // Map old name to new
      'Expense_Txn_Status': { module: 'common', key: 'Status_Txn' }, // Map variations to Status_Txn
      'Income_Txn_Status': { module: 'common', key: 'Status_Txn' },
      'Investment_Txn_Status': { module: 'common', key: 'Status_Txn' },
      'Ac_Status': { module: 'common', key: 'Ac_Status' },
      'Expense_Account_Status': { module: 'common', key: 'Ac_Status' }, // Map variations to Ac_Status
      'Income_Account_Status': { module: 'common', key: 'Ac_Status' },
      'Investment_Account_Status': { module: 'common', key: 'Ac_Status' }
    };

    // Unified master data container
    let masterData = {};
    let currentEdit = null;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        switchTab(targetTab);
      });
    });

    function switchTab(tabName) {
      // Update active tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      // Update active content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`${tabName}Content`).classList.add('active');

      // Render the tab content (or load paths for paths tab)
      if (tabName === 'paths') {
        loadPaths();
      } else {
        renderTab(tabName);
      }
    }

    // Load master data from localStorage
    function loadMasterData() {
      const saved = localStorage.getItem('unified_master_data');
      if (saved) {
        masterData = JSON.parse(saved);
        // Migration: normalize common.Mode_Txn -> common.Mode
        if (masterData.common) {
          const legacy = masterData.common['Mode_Txn'];
          if (legacy && Array.isArray(legacy)) {
            if (!Array.isArray(masterData.common['Mode'])) masterData.common['Mode'] = [];
            const merged = [...masterData.common['Mode'], ...legacy].filter((v, i, a) => v && a.indexOf(v) === i).sort();
            masterData.common['Mode'] = merged;
            delete masterData.common['Mode_Txn'];
          }
        }
      } else {
        // Try to load from legacy format and convert
        masterData = {
          task: JSON.parse(localStorage.getItem('task_master_data') || '{}'),
          expense: JSON.parse(localStorage.getItem('expense_master_data') || '{}'),
          income: JSON.parse(localStorage.getItem('income_master_data') || '{}'),
          investment: JSON.parse(localStorage.getItem('investment_master_data') || '{}'),
          common: {}
        };
        saveMasterData();
      }
      initializeMasterData();
      renderTab('income'); // Render default tab
    }

    // Save master data to localStorage
    function saveMasterData() {
      localStorage.setItem('unified_master_data', JSON.stringify(masterData));
      // Also save to module-specific keys for backwards compatibility
      localStorage.setItem('task_master_data', JSON.stringify(masterData.task || {}));
      localStorage.setItem('expense_master_data', JSON.stringify(masterData.expense || {}));
      localStorage.setItem('income_master_data', JSON.stringify(masterData.income || {}));
      localStorage.setItem('investment_master_data', JSON.stringify(masterData.investment || {}));
    }

    // Load paths from localStorage
    function loadPaths() {
      const backupPath = localStorage.getItem('project_backup_path') || '';
      const documentsPath = localStorage.getItem('project_documents_path') || '';
      const downloadsPath = localStorage.getItem('project_downloads_path') || '';
      
      if (document.getElementById('backupPathDisplay')) {
        document.getElementById('backupPathDisplay').textContent = backupPath || 'Not set';
        document.getElementById('documentsPathDisplay').textContent = documentsPath || 'Not set';
        document.getElementById('downloadsPathDisplay').textContent = downloadsPath || 'Not set';
        
        document.getElementById('backupPathInput').value = backupPath;
        document.getElementById('documentsPathInput').value = documentsPath;
        document.getElementById('downloadsPathInput').value = downloadsPath;
      }
    }

    // Set path function (exposed globally for onclick)
    window.setPath = function(type) {
      let inputId, storageKey, displayId;
      
      if (type === 'backup') {
        inputId = 'backupPathInput';
        storageKey = 'project_backup_path';
        displayId = 'backupPathDisplay';
      } else if (type === 'documents') {
        inputId = 'documentsPathInput';
        storageKey = 'project_documents_path';
        displayId = 'documentsPathDisplay';
      } else if (type === 'downloads') {
        inputId = 'downloadsPathInput';
        storageKey = 'project_downloads_path';
        displayId = 'downloadsPathDisplay';
      } else {
        return;
      }
      
      const path = document.getElementById(inputId).value.trim();
      if (path) {
        localStorage.setItem(storageKey, path);
        document.getElementById(displayId).textContent = path;
        alert(`Path set successfully for ${type}!`);
        
        // Update tooltip in index.html if it's open
        if (window.opener && typeof window.opener.updateProjectDocumentsTooltip === 'function') {
          window.opener.updateProjectDocumentsTooltip();
        }
      } else {
        alert('Please enter a valid path.');
      }
    };
    
    // Function to update Manage Master Data tooltip (can be called from index.html)
    window.updateManageMasterDataTooltip = function() {
      const lastExcelFile = localStorage.getItem('last_excel_file_loaded') || '';
      const lastExcelSource = localStorage.getItem('last_excel_file_source') || '';
      // This will be called from index.html to update its tooltip
    };

    // Clear all paths
    function clearAllPaths() {
      localStorage.removeItem('project_backup_path');
      localStorage.removeItem('project_documents_path');
      localStorage.removeItem('project_downloads_path');
      loadPaths();
    }

    // Check if paths are set
    function arePathsSet() {
      const backupPath = localStorage.getItem('project_backup_path');
      const documentsPath = localStorage.getItem('project_documents_path');
      const downloadsPath = localStorage.getItem('project_downloads_path');
      return !!(backupPath && documentsPath && downloadsPath);
    }

    // Initialize master data structure
    function initializeMasterData() {
      ['task', 'expense', 'income', 'investment', 'common'].forEach(module => {
        if (!masterData[module]) {
          masterData[module] = {};
        }
        if (MASTER_DATA_STRUCTURE[module]) {
          Object.keys(MASTER_DATA_STRUCTURE[module]).forEach(key => {
            // Only initialize if it doesn't exist or is not an array - preserve existing data
            if (!masterData[module][key] || !Array.isArray(masterData[module][key])) {
              masterData[module][key] = [];
            }
          });
        }
      });
      console.log('Master data initialized:', masterData);
    }

    // Render a tab
    function renderTab(module) {
      const container = document.getElementById(`${module}Grid`);
      container.innerHTML = '';

      const fields = MASTER_DATA_STRUCTURE[module];
      const fieldKeys = Object.keys(fields);
      
      // Only show module-specific fields - NO common fields in module tabs
      // Common fields are only shown in the Common tab
      
      // Split fields into two columns
      const midPoint = Math.ceil(fieldKeys.length / 2);
      const leftFields = fieldKeys.slice(0, midPoint);
      const rightFields = fieldKeys.slice(midPoint);

      // Create left column
      const leftCol = document.createElement('div');
      leftFields.forEach(fieldKey => {
        const displayLabel = fields[fieldKey];
        leftCol.appendChild(createFieldCard(module, fieldKey, displayLabel, false));
      });
      container.appendChild(leftCol);

      // Create right column
      const rightCol = document.createElement('div');
      rightFields.forEach(fieldKey => {
        const displayLabel = fields[fieldKey];
        rightCol.appendChild(createFieldCard(module, fieldKey, displayLabel, false));
      });
      container.appendChild(rightCol);
    }

    // Create a field card
    function createFieldCard(module, fieldKey, fieldLabel, isCommonField = false) {
      const card = document.createElement('div');
      card.className = 'field-card';

      const header = document.createElement('div');
      header.className = 'field-header';
      // Get values - if this is a common field being accessed from a module tab
      // Task module does NOT show Status_Txn and Mode
      let values = [];
      if (isCommonField) {
        // Access common field (but exclude Status_Txn and Mode from task module)
        if (module === 'task' && (fieldKey === 'Status_Txn' || fieldKey === 'Mode')) {
          values = [];
        } else {
          values = masterData.common && masterData.common[fieldKey] ? masterData.common[fieldKey] : [];
        }
      } else {
        values = masterData[module] && masterData[module][fieldKey] ? masterData[module][fieldKey] : [];
      }
      // Format: Actual Field Name (count) <--> Mapped Field Name
      const actualFieldName = fieldKey; // Excel sheet name (e.g., Expanse_Category)
      const mappedFieldName = fieldLabel.replace(' ‚Üî', ''); // Display name (e.g., Expense Category)
      header.innerHTML = `
        <span class="field-name">${actualFieldName} (${values.length}) <--> ${mappedFieldName}</span>
      `;
      card.appendChild(header);

      const valuesContainer = document.createElement('div');
      valuesContainer.className = 'values-container';

      if (values.length === 0) {
        valuesContainer.innerHTML = '<div class="empty-field">No entries yet</div>';
      } else {
          values.forEach((value, index) => {
          const row = document.createElement('div');
          row.className = 'value-row';
          // Determine save module/key for common fields viewed from module tabs
          let saveModule = module;
          let saveKey = fieldKey;
          if (isCommonField || (module !== 'common' && MASTER_DATA_STRUCTURE.common[fieldKey])) {
            saveModule = 'common';
            saveKey = fieldKey;
          }
          row.innerHTML = `
            <span class="value-text">${escapeHtml(value)}</span>
            <div class="value-actions">
              <button class="btn-icon btn-edit" onclick="editValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Edit</button>
              <button class="btn-icon btn-delete" onclick="deleteValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Delete</button>
            </div>
          `;
          valuesContainer.appendChild(row);
        });
      }
      card.appendChild(valuesContainer);

      const addForm = document.createElement('div');
      addForm.className = 'add-form';
      // Determine which module to save to for common fields
      let saveModule = module;
      let saveKey = fieldKey;
      if (isCommonField || (module !== 'common' && MASTER_DATA_STRUCTURE.common[fieldKey])) {
        saveModule = 'common';
        saveKey = fieldKey;
      }
      addForm.innerHTML = `
        <input type="text" class="add-input" id="add_${module}_${fieldKey}" placeholder="Add new ${fieldLabel.toLowerCase()}" onkeypress="if(event.key==='Enter') addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">
        <button class="btn-add" onclick="addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">Add</button>
      `;
      card.appendChild(addForm);

      return card;
    }

    // Add value
    function addValue(saveModule, saveKey, displayModule, displayKey) {
      // displayModule and displayKey are for the input element ID when viewing common fields from module tabs
      const inputId = displayModule ? `add_${displayModule}_${displayKey}` : `add_${saveModule}_${saveKey}`;
      const input = document.getElementById(inputId);
      const value = input.value.trim();
      if (!value) {
        alert('Please enter a value');
        return;
      }
      if (!masterData[saveModule]) masterData[saveModule] = {};
      if (!masterData[saveModule][saveKey]) masterData[saveModule][saveKey] = [];
      if (masterData[saveModule][saveKey].includes(value)) {
        alert('This value already exists');
        return;
      }
      masterData[saveModule][saveKey].push(value);
      masterData[saveModule][saveKey].sort();
      saveMasterData();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
      input.value = '';
    }

    // Edit value
    function editValue(module, fieldKey, index, displayModule) {
      currentEdit = { module, fieldKey, index, displayModule: displayModule || module };
      const value = masterData[module][fieldKey][index];
      document.getElementById('editInput').value = value;
      // Get the display label
      let displayLabel = '';
      if (module === 'common') {
        displayLabel = MASTER_DATA_STRUCTURE.common[fieldKey] || fieldKey;
      } else {
        displayLabel = MASTER_DATA_STRUCTURE[module][fieldKey] || fieldKey;
      }
      document.getElementById('modalTitle').textContent = `Edit ${displayLabel}`;
      document.getElementById('editModal').classList.add('show');
    }

    // Save edited value
    function saveEditedValue() {
      if (!currentEdit) return;
      const input = document.getElementById('editInput');
      const newValue = input.value.trim();
      if (!newValue) {
        alert('Please enter a value');
        return;
      }
      const { module, fieldKey, index, displayModule } = currentEdit;
      if (masterData[module][fieldKey].includes(newValue) && masterData[module][fieldKey][index] !== newValue) {
        alert('This value already exists');
        return;
      }
      masterData[module][fieldKey][index] = newValue;
      masterData[module][fieldKey].sort();
      saveMasterData();
      closeEditModal();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
    }

    // Delete value
    function deleteValue(module, fieldKey, index, displayModule) {
      if (!confirm('Are you sure you want to delete this value?')) return;
      masterData[module][fieldKey].splice(index, 1);
      saveMasterData();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      currentEdit = null;
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Excel import handler - set up when DOM is ready
    function setupExcelFileHandler() {
      const fileInput = document.getElementById('excelFileInput');
      if (!fileInput) {
        console.error('Excel file input not found in DOM');
        return;
      }
      
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) {
          console.log('No file selected');
          return;
        }
        
        console.log('File selected:', file.name, file.type, file.size);
        
        // Proceed to read selected Excel file
        const reader = new FileReader();
        
        reader.onerror = function(error) {
          console.error('FileReader error:', error);
          alert('Error reading file: ' + (error.target.error?.message || 'Unknown error'));
          e.target.value = ''; // Reset file input
        };
        
        reader.onload = function(e) {
        try {
          console.log('File read successfully, size:', e.target.result.byteLength);
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetNames = workbook.SheetNames;

          console.log('Available sheets:', sheetNames);

          // Initialize master data
          initializeMasterData();

          // Extract all master data sheets (exclude Txn_* transactional sheets, but include Mode_Txn and Status_Txn)
          const processedSheets = [];
          sheetNames.forEach(sheetName => {
            // Skip transactional data sheets (Txn_Expense, Txn_Income, Txn_Investment, Txn_Task)
            if (sheetName.startsWith('Txn_') && !sheetName.includes('Mode') && !sheetName.includes('Status')) {
              console.log('‚úó Skipping transactional sheet:', sheetName);
              return;
            }
            processedSheets.push(sheetName);

            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet);

            if (jsonData.length === 0) return;

            // Try to find the column with the same name as the sheet, or use first column
            let values = [];
            const firstRow = jsonData[0];
            const columnKeys = Object.keys(firstRow);

            // Try to find the column with the same name as the sheet, or use first column
            // Handle case-insensitive matching and variations
            let columnName = sheetName;
            
            // First try exact match
            if (firstRow[sheetName] !== undefined && firstRow[sheetName] !== null && String(firstRow[sheetName]).trim() !== '') {
              columnName = sheetName;
            } else {
              // Try case-insensitive match
              const matchingKey = columnKeys.find(key => key.toLowerCase() === sheetName.toLowerCase());
              if (matchingKey) {
                columnName = matchingKey;
              } else {
                // For common fields, also try common variations
                if (sheetName === 'Mode' || sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode' || sheetName.toLowerCase() === 'mode' || sheetName.toLowerCase() === 'mode_txn' || sheetName.toLowerCase() === 'txn_mode') {
                  const modeVariations = columnKeys.find(key => 
                    key.toLowerCase().includes('mode') || key.toLowerCase().includes('txn_mode') || key.toLowerCase().includes('mode_txn')
                  );
                  if (modeVariations) columnName = modeVariations;
                } else if (sheetName === 'Status_Txn' || sheetName === 'Txn_Status' || sheetName.toLowerCase() === 'status_txn' || sheetName.toLowerCase() === 'txn_status') {
                  const statusVariations = columnKeys.find(key => 
                    key.toLowerCase().includes('status') || key.toLowerCase().includes('txn_status') || key.toLowerCase().includes('status_txn')
                  );
                  if (statusVariations) columnName = statusVariations;
                } else {
                  // Use first column
                  columnName = columnKeys[0];
                }
              }
            }
            
            console.log(`Reading sheet "${sheetName}": Using column "${columnName}" from available columns:`, columnKeys);
            
            values = jsonData.map(row => {
              const val = row[columnName];
              // Handle various data types
              if (val === undefined || val === null) return null;
              const strVal = String(val).trim();
              return strVal === '' ? null : strVal;
            }).filter(v => v !== null && v !== '');
            
            // values extracted

            // Determine which module and field this sheet belongs to
            let foundModule = null;
            let foundKey = null;

            // PRIORITY 1: Check if sheet name is exactly Mode/Mode_Txn/Txn_Mode or Status_Txn (common fields) - CHECK FIRST!
            // These must be checked BEFORE checking module prefixes to avoid mis-mapping
            if (sheetName === 'Mode' || sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode') {
              foundModule = 'common';
              foundKey = 'Mode';
              console.log(`‚úì PRIORITY MATCH: Sheet "${sheetName}" -> common.Mode`);
            } else if (sheetName === 'Status_Txn' || sheetName === 'Txn_Status') {
              foundModule = 'common';
              foundKey = 'Status_Txn';
              console.log(`‚úì PRIORITY MATCH: Sheet "${sheetName}" -> common.Status_Txn`);
            }
            // PRIORITY 2: Check exact mapping dictionary
            else if (SHEET_NAME_MAP[sheetName]) {
              foundModule = SHEET_NAME_MAP[sheetName].module;
              foundKey = SHEET_NAME_MAP[sheetName].key;
              console.log(`‚úì Matched "${sheetName}" via SHEET_NAME_MAP -> ${foundModule}.${foundKey}`);
            } else {
              // PRIORITY 3: Try to determine based on prefix rules
              const lowerSheet = sheetName.toLowerCase();
              
              // Check for module prefixes
              if (sheetName.startsWith('Task_')) {
                foundModule = 'task';
                foundKey = sheetName;
                // Check if it's in our structure
                if (!MASTER_DATA_STRUCTURE.task[sheetName]) {
                  foundModule = null;
                  foundKey = null;
                }
              } else if (sheetName.startsWith('Income_')) {
                foundModule = 'income';
                foundKey = sheetName;
                // Check if it's in our structure
                if (!MASTER_DATA_STRUCTURE.income[sheetName]) {
                  foundModule = null;
                  foundKey = null;
                }
              } else if (sheetName.startsWith('Investment_')) {
                foundModule = 'investment';
                foundKey = sheetName;
                // Check if it's in our structure
                if (!MASTER_DATA_STRUCTURE.investment[sheetName]) {
                  foundModule = null;
                  foundKey = null;
                }
              } else if (sheetName.startsWith('Expense_') || sheetName.startsWith('Expanse_')) {
                foundModule = 'expense';
                // Map variations to unified keys
                if (sheetName === 'Expense_Category') {
                  foundKey = 'Expanse_Category';
                } else if (sheetName === 'Expanse_Category') {
                  foundKey = 'Expanse_Category';
                } else if (sheetName === 'Expense_Tag' || sheetName === 'Expense_Ac_Tag') {
                  foundKey = 'Expanse_Ac_Tag';
                } else if (sheetName === 'Expanse_Ac_Tag') {
                  foundKey = 'Expanse_Ac_Tag';
                } else {
                  // Not a valid expense master field - might be a variation that should map to common
                  foundModule = null;
                  foundKey = null;
                }
              } else {
                // No prefix = common field
                // Check if it matches common field names (case-insensitive matching)
                if (lowerSheet === 'currency') {
                  foundModule = 'common';
                  foundKey = 'Currency';
                } else if (lowerSheet === 'frequency') {
                  foundModule = 'common';
                  foundKey = 'Frequency';
                } else if (lowerSheet === 'ac_holder' || lowerSheet === 'account holder' || lowerSheet === 'ac holder') {
                  foundModule = 'common';
                  foundKey = 'Ac_Holder';
                } else if (lowerSheet === 'mode' || lowerSheet === 'mode_txn' || lowerSheet === 'txn_mode' || lowerSheet === 'transaction mode' || lowerSheet === 'txn mode' ||
                           sheetName === 'Mode' || sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode' || sheetName === 'MODE' || sheetName === 'MODE_TXN' || sheetName === 'TXN_MODE' || sheetName === 'txn_mode' || sheetName === 'Txn_MODE') {
                  foundModule = 'common';
                  foundKey = 'Mode';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Mode`);
                } else if (lowerSheet === 'status_txn' || lowerSheet === 'txn_status' || lowerSheet === 'transaction status' || lowerSheet === 'txn status' ||
                           sheetName === 'Status_Txn' || sheetName === 'Txn_Status' || sheetName === 'STATUS_TXN' || sheetName === 'TXN_STATUS' || sheetName === 'txn_status') {
                  foundModule = 'common';
                  foundKey = 'Status_Txn';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Status_Txn`);
                } else if (lowerSheet === 'ac_status' || lowerSheet === 'account status' || lowerSheet === 'ac status') {
                  foundModule = 'common';
                  foundKey = 'Ac_Status';
                } else if (SHEET_NAME_MAP[sheetName]) {
                  // Check variations mapping
                  foundModule = SHEET_NAME_MAP[sheetName].module;
                  foundKey = SHEET_NAME_MAP[sheetName].key;
                } else {
                  // Try exact case match for common fields
                    if (sheetName === 'Currency' || sheetName === 'FREQUENCY' || sheetName === 'Frequency' ||
                      sheetName === 'Ac_Holder' || sheetName === 'Ac_HOLDER' ||
                      sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode' || sheetName === 'MODE_TXN' || sheetName === 'TXN_MODE' || sheetName === 'Txn_MODE' ||
                      sheetName === 'Status_Txn' || sheetName === 'Txn_Status' || sheetName === 'STATUS_TXN' || sheetName === 'TXN_STATUS' || sheetName === 'Txn_STATUS' ||
                      sheetName === 'Ac_Status' || sheetName === 'AC_STATUS') {
                    foundModule = 'common';
                    // Normalize to standard case
                    if (sheetName === 'Mode' || sheetName.toUpperCase() === 'MODE' || sheetName === 'Mode_Txn' || sheetName.toUpperCase() === 'MODE_TXN' || sheetName === 'Txn_Mode' || sheetName.toUpperCase() === 'TXN_MODE' || sheetName === 'Txn_MODE') {
                      foundKey = 'Mode';
                    } else if (sheetName === 'Status_Txn' || sheetName.toUpperCase() === 'STATUS_TXN' || sheetName === 'Txn_Status' || sheetName.toUpperCase() === 'TXN_STATUS' || sheetName === 'Txn_STATUS') {
                      foundKey = 'Status_Txn';
                    } else if (sheetName.toUpperCase() === 'FREQUENCY' || sheetName === 'Frequency') {
                      foundKey = 'Frequency';
                    } else if (sheetName.toUpperCase() === 'AC_STATUS' || sheetName === 'Ac_STATUS') {
                      foundKey = 'Ac_Status';
                    } else if (sheetName.toUpperCase() === 'AC_HOLDER' || sheetName === 'Ac_HOLDER') {
                      foundKey = 'Ac_Holder';
                    } else {
                      foundKey = sheetName;
                    }
                    console.log(`Matched ${sheetName} to common.${foundKey}`);
                  }
                }
              }
            }

            if (foundModule && foundKey) {
              // Initialize if needed
              if (!masterData[foundModule]) masterData[foundModule] = {};
              if (!masterData[foundModule][foundKey]) masterData[foundModule][foundKey] = [];
              
              if (values.length > 0) {
                // Merge with existing values (avoid duplicates)
                const existing = masterData[foundModule][foundKey] || [];
                const newValues = values.filter(v => v && v !== '' && !existing.includes(v));
                masterData[foundModule][foundKey] = [...existing, ...newValues].sort();
                console.log(`‚úì Loaded ${values.length} values from "${sheetName}" into ${foundModule}.${foundKey} (${newValues.length} new values added)`);
              } else {
                console.log(`‚ö† Sheet "${sheetName}" matched to ${foundModule}.${foundKey} but contains no values`);
              }
            } else {
              console.log(`‚úó Skipping sheet "${sheetName}" - not a master data field`);
            }
          });

          saveMasterData();
          
          // Save the Excel file name for tooltip
          localStorage.setItem('last_excel_file_loaded', file.name);
          localStorage.setItem('last_excel_file_source', 'D:');
          
          // Update tooltip in index.html if it's open
          if (window.opener && typeof window.opener.updateManageMasterDataTooltip === 'function') {
            window.opener.updateManageMasterDataTooltip();
          }
          
          const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
          renderTab(currentTab);
          
          const totalSheets = sheetNames.length;
          const transactionalSheets = sheetNames.filter(s => s.startsWith('Txn_') && s !== 'Txn_Mode' && s !== 'Txn_Status' && !s.includes('Mode') && !s.includes('Status')).length;
          const masterDataSheets = processedSheets.length;
          
          // Check if paths are set and show warning if not
          let message = `Successfully imported master data from Excel file!\n\nTotal sheets in file: ${totalSheets}\nTransactional sheets skipped: ${transactionalSheets}\nMaster data sheets processed: ${masterDataSheets}`;
          
          if (!arePathsSet()) {
            message += '\n\n‚ö†Ô∏è Please set Project Paths in the "Set/Change Paths" tab!';
          }
          
          alert(message);
          e.target.value = ''; // Reset file input after successful processing
        } catch (error) {
          console.error('Error reading Excel file:', error);
          alert('Error reading Excel file: ' + error.message);
          e.target.value = ''; // Reset file input on error
        }
      };
      reader.readAsArrayBuffer(file);
    });
    }
    
    // Set up the file handler when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupExcelFileHandler);
    } else {
      setupExcelFileHandler();
    }

    // Close modal on outside click
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEditModal();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeEditModal();
      }
    });

    // Clear all data with double confirmation
    document.getElementById('btnClearData').addEventListener('click', function() {
      // First confirmation
      const firstConfirm = confirm('‚ö†Ô∏è WARNING: This will delete ALL master data!\n\nAre you sure you want to proceed?');
      if (!firstConfirm) return;

      // Second confirmation with more details
      const secondConfirm = confirm('‚ö†Ô∏è FINAL WARNING: This action cannot be undone!\n\nAll master data for Income, Expense, Investment, Task, and Common fields will be permanently deleted.\n\nClick OK to confirm deletion.');
      if (!secondConfirm) return;

      // Clear all master data
      masterData = {
        task: {},
        expense: {},
        income: {},
        investment: {},
        common: {}
      };

      // Clear localStorage
      localStorage.removeItem('unified_master_data');
      localStorage.removeItem('task_master_data');
      localStorage.removeItem('expense_master_data');
      localStorage.removeItem('income_master_data');
      localStorage.removeItem('investment_master_data');

      // Clear all paths
      clearAllPaths();

      // Initialize empty structure and re-render
      initializeMasterData();
      saveMasterData();
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      if (currentTab === 'paths') {
        loadPaths();
      } else {
        renderTab(currentTab);
      }
      
      alert('‚úÖ All master data and paths have been cleared successfully.');
    });

    // Display last loaded Excel file info
    function updateLastFileDisplay() {
      const lastExcelFile = localStorage.getItem('last_excel_file_loaded') || '';
      const lastExcelSource = localStorage.getItem('last_excel_file_source') || '';
      const lastExcelPath = localStorage.getItem('last_excel_file_path') || lastExcelFile;
      const infoDiv = document.getElementById('lastFileInfo');
      if (infoDiv) {
        if (lastExcelFile) {
          if (lastExcelSource === 'D:') {
            infoDiv.textContent = `üìÑ Current file: ${lastExcelPath} (Local Drive D:)`;
          } else if (lastExcelSource === 'Google Drive') {
            infoDiv.textContent = `‚òÅÔ∏è Current file: ${lastExcelFile} (Google Drive)`;
          } else {
            infoDiv.textContent = `üìÑ Current file: ${lastExcelPath}`;
          }
          infoDiv.style.color = 'var(--accent-blue, #3b82f6)';
          infoDiv.style.fontWeight = '600';
        } else {
          infoDiv.textContent = '‚ö†Ô∏è No Excel file loaded yet';
          infoDiv.style.color = 'var(--text-secondary, #64748b)';
        }
      }
    }

    // Initialize on load
    loadMasterData();
    loadPaths(); // Load paths on page load
    updateLastFileDisplay(); // Show last loaded file
    renderTab('income'); // Render default tab
    
    // Set up button event listener
    const btnLoadFromD = document.getElementById('btnLoadFromD');
    if (btnLoadFromD) {
      btnLoadFromD.addEventListener('click', function(e) {
        console.log('Button clicked via event listener');
        e.preventDefault();
        e.stopPropagation();
        window.openFilePicker();
      });
      console.log('Button event listener attached successfully');
    } else {
      console.error('Load from D button not found - will retry on DOMContentLoaded');
      // Retry if DOM not ready yet
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          const btn = document.getElementById('btnLoadFromD');
          if (btn) {
            btn.addEventListener('click', function(e) {
              console.log('Button clicked via event listener (DOMContentLoaded)');
              e.preventDefault();
              e.stopPropagation();
              window.openFilePicker();
            });
            console.log('Button event listener attached (DOMContentLoaded)');
          }
        });
      }
    }
    
    // Update tooltip for Manage Master Data link in index.html
    updateManageMasterDataTooltip();
</body>
</html>
