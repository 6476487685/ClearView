<!DOCTYPE html>
<html>
<head>
    <title>Rename Payment_Mode to Txn_Mode</title>
    <script src="assets/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 10px; }
        h1 { color: #333; }
        input[type="file"] { margin: 10px 0; }
        button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        button:hover { background: #45a049; }
        .btn-download { background: #2196F3; }
        .btn-download:hover { background: #0b7dda; }
        .log { background: #f9f9f9; padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Rename Payment_Mode ‚Üí Txn_Mode</h1>
        <p>This tool will rename the <strong>Payment_Mode</strong> column to <strong>Txn_Mode</strong> in all sheets.</p>
        
        <div>
            <h2>Step 1: Upload Your Excel File</h2>
            <input type="file" id="fileInput" accept=".xlsx,.xls" />
            <div id="uploadStatus"></div>
        </div>

        <div id="processSection" style="display:none;">
            <h2>Step 2: Processing</h2>
            <div class="log" id="log"></div>
        </div>

        <div id="resultSection" style="display:none;">
            <h2>Step 3: Download Updated File</h2>
            <p id="resultInfo"></p>
            <button class="btn-download" onclick="downloadFile()">‚¨áÔ∏è Download Updated Excel File</button>
        </div>
    </div>

    <script>
        let workbook = null;
        let fileName = '';

        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            fileName = file.name;
            document.getElementById('uploadStatus').innerHTML = 
                '<p style="color:green;">‚úì File loaded: ' + fileName + '</p>';
            document.getElementById('processSection').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            log('File loaded: ' + fileName);

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    log('‚úì Excel file parsed successfully');
                    log('Found ' + workbook.SheetNames.length + ' sheets');
                    processFile();
                } catch (error) {
                    log('‚úó Error: ' + error.message);
                    alert('Error reading file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function processFile() {
            if (!workbook) {
                log('‚úó No file loaded');
                return;
            }

            log('Starting processing...');
            let renamedCount = 0;

            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                if (!sheet) return;

                // Check if this sheet has Payment_Mode column
                let hasPaymentMode = false;
                const range = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
                
                // Scan first row for header
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({r: 0, c: col});
                    const cell = sheet[cellAddress];
                    if (cell && cell.v === 'Payment_Mode') {
                        hasPaymentMode = true;
                        log('‚úì Found Payment_Mode in sheet: ' + sheetName);
                        
                        // Rename the header cell
                        delete sheet[cellAddress];
                        const newCellAddress = cellAddress; // Same cell address, just change value
                        const newCell = { t: 's', v: 'Txn_Mode' };
                        sheet[cellAddress] = newCell;
                        
                        log('‚úì Renamed Payment_Mode to Txn_Mode in sheet: ' + sheetName);
                        renamedCount++;
                    }
                }
            });

            if (renamedCount === 0) {
                log('No Payment_Mode columns found to rename.');
                document.getElementById('resultInfo').innerHTML = 
                    '<p style="color:orange;">‚ö† No Payment_Mode columns found. File will be downloaded as-is.</p>';
            } else {
                log('‚úì Processing complete! Renamed ' + renamedCount + ' column(s)');
                document.getElementById('resultInfo').innerHTML = 
                    '<p style="color:green;">‚úì Successfully renamed ' + renamedCount + ' Payment_Mode column(s) to Txn_Mode</p>';
            }
            
            document.getElementById('resultSection').style.display = 'block';
        }

        function downloadFile() {
            if (!workbook) {
                alert('No file to download');
                return;
            }

            try {
                const excelBuffer = XLSX.write(workbook, { 
                    bookType: 'xlsx', 
                    type: 'array',
                    cellDates: true
                });
                
                const blob = new Blob([excelBuffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                
                let newFileName = fileName.replace(/\.(xlsx|xls)$/i, '') + '_Updated.xlsx';
                a.download = newFileName;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                
                alert('‚úì File downloaded successfully as: ' + newFileName);
            } catch (error) {
                alert('Error downloading file: ' + error.message);
                log('‚úó Download error: ' + error.message);
            }
        }
    </script>
</body>
</html>

