<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Master Data ‚Äî ClearView</title>
  <link rel="stylesheet" href="2_Expanse_Style.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--primary-bg, #f8fafc);
    }
    .master-data-container {
      min-height: 100vh;
      background: var(--primary-bg, #f8fafc);
    }
    .tabs-container {
      display: flex;
      gap: 4px;
      padding: 10px 12px;
      background: var(--card-bg, #ffffff);
      border-bottom: 2px solid var(--border-color, #e2e8f0);
      overflow-x: auto;
      flex-wrap: nowrap;
      justify-content: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .tab {
      padding: 8px 10px;
      background: var(--primary-bg, #f8fafc);
      border: 2px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.75rem;
      color: white;
      transition: all 0.3s ease;
      white-space: nowrap;
      flex: 0 1 auto;
      min-width: fit-content;
      max-width: 140px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
    }
    .tab * {
      position: relative;
      z-index: 1;
    }
    .tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.2);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 6px;
      z-index: 0;
    }
    .tab:hover::before {
      opacity: 1;
    }
    .tab:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .tab.active {
      color: white;
      border: 3px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transform: translateY(-2px);
      animation: pulse-active 0.5s ease, blink-border 1.5s ease-in-out infinite;
    }
    @keyframes pulse-active {
      0% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-3px) scale(1.05); }
      100% { transform: translateY(-2px) scale(1); }
    }
    @keyframes blink-border {
      0%, 100% { border-color: rgba(255, 255, 255, 0.8); box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 0 0 rgba(255, 255, 255, 0.5); }
      50% { border-color: rgba(255, 255, 255, 1); box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 0 4px rgba(255, 255, 255, 0.3); }
    }
    
    /* Individual tab colors */
    .tab[data-tab="income"] {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-color: #10b981;
    }
    .tab[data-tab="income"].active {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }
    
    .tab[data-tab="expense"] {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      border-color: #f59e0b;
    }
    .tab[data-tab="expense"].active {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    }
    
    .tab[data-tab="investment"] {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      border-color: #8b5cf6;
    }
    .tab[data-tab="investment"].active {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
    }
    
    .tab[data-tab="task"] {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      border-color: #06b6d4;
    }
    .tab[data-tab="task"].active {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
    }
    
    .tab[data-tab="common"] {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #3b82f6;
    }
    .tab[data-tab="common"].active {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    }
    
    .tab[data-tab="trading-accounts"] {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      border-color: #14b8a6;
    }
    .tab[data-tab="trading-accounts"].active {
      background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
    }
    
    .tab[data-tab="property-tenancy"] {
      background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
      border-color: #a855f7;
      color: white !important;
    }
    .tab[data-tab="property-tenancy"].active {
      background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
      color: white !important;
    }
    
    .tab[data-tab="paths"] {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      border-color: #64748b;
    }
    .tab[data-tab="paths"].active {
      background: linear-gradient(135deg, #475569 0%, #334155 100%);
    }
    
    /* Ensure active tabs have white text */
    .tab.active {
      color: white !important;
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
    
    /* Property-Tenancy Sub-tabs */
    .property-tenancy-subtabs {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .property-tenancy-subtab {
      padding: 14px 28px;
      cursor: pointer;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      transition: all 0.3s ease;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      position: relative;
      font-size: 15px;
    }
    
    .property-tenancy-subtab:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .property-tenancy-subtab.active {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
      font-weight: 700;
    }
    
    /* Property sub-tab - blue-grey */
    .property-tenancy-subtab[data-subtab="property"] {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      color: #fff;
    }
    .property-tenancy-subtab[data-subtab="property"]:hover {
      background: linear-gradient(135deg, #475569 0%, #334155 100%);
    }
    .property-tenancy-subtab[data-subtab="property"].active {
      background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
    }
    
    /* Tenant sub-tab - orange/peach */
    .property-tenancy-subtab[data-subtab="tenant"] {
      background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
      color: #fff;
    }
    .property-tenancy-subtab[data-subtab="tenant"]:hover {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    }
    .property-tenancy-subtab[data-subtab="tenant"].active {
      background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
    }
    
    /* Manager sub-tab - grey */
    .property-tenancy-subtab[data-subtab="manager"] {
      background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
      color: #fff;
    }
    .property-tenancy-subtab[data-subtab="manager"]:hover {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    }
    .property-tenancy-subtab[data-subtab="manager"].active {
      background: linear-gradient(135deg, #475569 0%, #334155 100%);
    }
    
    /* Lease Records sub-tab - yellow/cream */
    .property-tenancy-subtab[data-subtab="lease-records"] {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #1f2937;
    }
    .property-tenancy-subtab[data-subtab="lease-records"]:hover {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #fff;
    }
    .property-tenancy-subtab[data-subtab="lease-records"].active {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      color: #fff;
    }
    
    /* Inspection Report sub-tab - green */
    .property-tenancy-subtab[data-subtab="inspection-report"] {
      background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      color: #fff;
    }
    .property-tenancy-subtab[data-subtab="inspection-report"]:hover {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .property-tenancy-subtab[data-subtab="inspection-report"].active {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }
    
    .property-tenancy-subcontent {
      display: none;
    }
    
    .property-tenancy-subcontent.active {
      display: block;
    }
    
    .two-column-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 1562px;
      margin: 0 auto;
    }
    .field-card {
      background: var(--card-bg, #ffffff);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .field-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color, #e2e8f0);
    }
    .field-name {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-primary, #1e293b);
    }
    .field-count {
      font-size: 0.85rem;
      color: var(--text-secondary, #64748b);
      font-weight: 500;
    }
    .values-container {
      /* show ~4 rows with vertical scroll for better placement */
      max-height: 208px;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    .value-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      margin-bottom: 4px;
      background: var(--primary-bg, #f8fafc);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      transition: all 0.2s;
      width: 100%;
      box-sizing: border-box;
    }
    .value-row:hover {
      border-color: var(--accent-blue, #3b82f6);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .value-row.sqa-row {
      display: grid;
      grid-template-columns: 8cm 3.5cm minmax(3cm, 1fr);
      column-gap: 0.1cm;
      align-items: center;
    }
    .value-row.sqa-row .value-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding-right: 6px;
    }
    .value-text {
      flex: 1;
      color: var(--text-primary, #1e293b);
      font-size: 0.95rem;
      padding-right: 10px;
    }
    .value-row.sqa-row .value-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .value-text.sqa-question {
      width: 100%;
      font-size: 0.8rem;
      white-space: normal;
      display: -webkit-box;
      display: box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #b91c1c;
      padding-right: 0.1cm;
      border-right: 2px solid rgba(0,0,0,0.12);
    }
    .value-text.sqa-answer {
      width: 100%;
      font-size: 0.75rem;
      text-align: center;
      color: #15803d;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-left: 0.1cm;
    }
    .value-actions {
      display: flex;
      gap: 8px;
      flex: 1;
      justify-content: flex-end;
    }
    .btn-icon {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-edit {
      background: var(--accent-blue, #3b82f6);
      color: white;
    }
    .btn-edit:hover {
      background: #2563eb;
    }
    .btn-delete {
      background: #ef4444;
      color: white;
    }
    .btn-delete:hover {
      background: #dc2626;
    }
    .add-form {
      display: flex;
      gap: 6px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color, #e2e8f0);
      width: 100%;
    }
    .add-form.sqa-add {
      display: grid;
      grid-template-columns: 8cm 3.5cm minmax(3cm, 1fr);
      column-gap: 0.1cm;
      align-items: center;
    }
    .add-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      font-size: 0.95rem;
      background: var(--card-bg, #ffffff);
      color: var(--text-primary, #1e293b);
    }
    .sqa-input-question {
      width: 100%;
      max-width: 100%;
      font-size: 0.9rem;
      color: #b91c1c;
    }
    .sqa-input-question::placeholder {
      color: #dc2626;
    }
    .sqa-input-answer {
      width: 100%;
      max-width: 100%;
      font-size: 0.85rem;
      color: #15803d;
      text-align: center;
    }
    .sqa-input-answer::placeholder {
      color: #16a34a;
    }
    .add-input:focus {
      outline: none;
      border-color: var(--accent-blue, #3b82f6);
    }
    .btn-add {
      width: auto;
      min-width: 3cm;
      display: inline-flex;
      justify-content: center;
      padding: 10px 20px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .btn-add:hover {
      background: #059669;
    }
    .empty-field {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary, #64748b);
      font-style: italic;
    }
    /* Modal for editing */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: var(--card-bg, #ffffff);
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .modal-header {
      margin-bottom: 20px;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary, #1e293b);
    }
    .modal-body input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      font-size: 1rem;
      margin-bottom: 20px;
      background: var(--card-bg, #ffffff);
      color: var(--text-primary, #1e293b);
    }
    .modal-body input:focus {
      outline: none;
      border-color: var(--accent-blue, #3b82f6);
    }
    .sqa-edit-group {
      display: none;
      gap: 10px;
      margin-top: 10px;
    }
    .sqa-edit-group input {
      flex: 1;
      margin-bottom: 0;
      font-size: 0.95rem;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .btn-secondary {
      background: var(--text-secondary, #64748b);
      color: white;
    }
    .btn-secondary:hover {
      background: #475569;
    }
    .btn-primary {
      background: var(--accent-blue, #3b82f6);
      color: white;
    }
    .btn-primary:hover {
      background: #2563eb;
    }
    @media (max-width: 1200px) {
      .two-column-grid {
        grid-template-columns: 1fr;
      }
    }
    .values-container::-webkit-scrollbar {
      width: 8px;
    }
    .values-container::-webkit-scrollbar-track {
      background: var(--primary-bg, #f8fafc);
      border-radius: 4px;
    }
    .values-container::-webkit-scrollbar-thumb {
      background: var(--text-secondary, #64748b);
      border-radius: 4px;
    }
    .values-container::-webkit-scrollbar-thumb:hover {
      background: var(--accent-blue, #3b82f6);
    }
    /* Paths tab styles */
    .paths-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .path-section {
      background: var(--card-bg, #ffffff);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .path-title {
      margin: 0 0 15px 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary, #1e293b);
    }
    .path-display {
      background: var(--primary-bg, #f8fafc);
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      color: var(--text-primary, #1e293b);
      word-break: break-all;
      min-height: 20px;
    }
    .path-display:empty::before {
      content: "Not set";
      color: var(--text-secondary, #64748b);
      font-style: italic;
    }
    .path-input-group {
      display: flex;
      gap: 10px;
    }
    .path-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color, #e2e8f0);
      border-radius: 6px;
      font-size: 0.95rem;
      background: var(--card-bg, #ffffff);
      color: var(--text-primary, #1e293b);
    }
    .path-input:focus {
      outline: none;
      border-color: var(--accent-blue, #3b82f6);
    }

    /* Header layout aligned with dashboard style */
    .header{
      background:var(--surface, #ffffff);
      color:var(--text-primary, #0a0a0a);
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 20px;
      font-weight:400;
      position:relative;
      border-bottom:1px solid var(--border-light, #f1f3f4);
      box-shadow:var(--shadow-xs, 0 1px 2px 0 rgba(60,64,67,0.3),0 1px 3px 1px rgba(60,64,67,0.15));
      gap:16px;
    }
    .header-left{
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
      align-items:flex-start;
    }
    .header-title{
      font-size:20px;
      font-weight:700;
      color:#b87333;
      letter-spacing:-0.02em;
      text-shadow:1px 1px 2px rgba(0,0,0,0.1);
      margin:0;
    }
    .header-left-actions{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .header-right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
  </style>
</head>
<body>
  <!-- Header matching dashboard style -->
  <header class="header">
    <div class="header-left">
      <h1 class="header-title">Manage Master Data</h1>
      <div class="header-left-actions">
        <button class="black" onclick="window.location.href='index.html'">‚Üê Back to Main Dashboard</button>
      </div>
    </div>
    <div class="header-right">
      <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display:none;">
      <button class="excel" id="btnLoadFromD" type="button" title="Upload Excel File">üì§ Load from D:</button>
      <button class="excel" id="btnDownloadExcel" type="button" title="Download Current Master Data to Excel">üì• Download Master Data</button>
      <button class="danger" id="btnClearData" style="background:#ea4335;color:white;" title="It deletes all Master Data">üóëÔ∏è Clear All Data</button>
    </div>
  </header>
  <div id="lastFileInfo" style="margin:8px auto 0 auto;max-width:1400px;padding:8px 12px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;font-size:0.9rem;line-height:1.4;background:rgba(59,130,246,0.08);color:var(--accent-blue, #3b82f6);font-weight:600;border:1px solid rgba(59,130,246,0.25);">
    <span id="filePathDisplay" style="text-align:left;">Not set</span>
    <span id="fileNameDisplay" style="text-align:right;">No file loaded</span>
  </div>

  <div class="master-data-container">
    <!-- Tabs -->
    <div class="tabs-container">
      <div class="tab active" data-tab="common">üåê Shared Attributes</div>
      <div class="tab" data-tab="task">‚úÖ Task</div>
      <div class="tab" data-tab="expense">üí∞ Expense</div>
      <div class="tab" data-tab="income">üìä Income</div>
      <div class="tab" data-tab="investment">üìà Investment</div>
      <div class="tab" data-tab="trading-accounts">üìä Trading A/c</div>
      <div class="tab" data-tab="property-tenancy">üè† Property-Tenancy Data</div>
      <div class="tab" data-tab="paths">üîß Paths</div>
    </div>

    <!-- Tab Contents -->
    <div id="taskContent" class="tab-content active">
      <div class="two-column-grid" id="taskGrid"></div>
    </div>

    <div id="expenseContent" class="tab-content">
      <div class="two-column-grid" id="expenseGrid"></div>
    </div>

    <div id="incomeContent" class="tab-content">
      <div class="two-column-grid" id="incomeGrid"></div>
    </div>

    <div id="investmentContent" class="tab-content">
      <div class="two-column-grid" id="investmentGrid"></div>
    </div>

    <div id="commonContent" class="tab-content">
      <div class="two-column-grid" id="commonGrid"></div>
    </div>

    <div id="trading-accountsContent" class="tab-content">
      <div class="two-column-grid" id="trading-accountsGrid"></div>
    </div>

    <div id="pathsContent" class="tab-content">
      <div class="paths-container" id="pathsContainer">
        <div class="path-section">
          <h3 class="path-title">üìä Master Data File</h3>
          <div class="path-display" id="masterDataFileDisplay">Not set</div>
          <div class="path-input-group">
            <input type="text" id="masterDataFileInput" class="path-input" placeholder="Enter Excel file path (e.g., D:\Projects\MasterData.xlsx)">
            <button class="btn btn-primary" onclick="chooseMasterDataFile()">üìÅ Choose File</button>
          </div>
        </div>
        <div class="path-section">
          <h3 class="path-title">üìÅ Project Backup Folder</h3>
          <div class="path-display" id="backupPathDisplay">Not set</div>
          <div class="path-input-group">
            <input type="text" id="backupPathInput" class="path-input" placeholder="Enter backup folder path (e.g., D:\Projects\Backup)">
            <button class="btn btn-primary" onclick="chooseBackupFolder()">üìÅ Choose Folder</button>
          </div>
        </div>
        <div class="path-section">
          <h3 class="path-title">üìÑ Project Documents Folder</h3>
          <div class="path-display" id="documentsPathDisplay">Not set</div>
          <div class="path-input-group">
            <input type="text" id="documentsPathInput" class="path-input" placeholder="Enter documents folder path (e.g., D:\Projects\Documents)">
            <button class="btn btn-primary" onclick="chooseDocumentsFolder()">üìÅ Choose Folder</button>
          </div>
        </div>
        <div class="path-section">
          <h3 class="path-title">‚¨áÔ∏è Project Downloads Folder</h3>
          <div class="path-display" id="downloadsPathDisplay">Not set</div>
          <div class="path-input-group">
            <input type="text" id="downloadsPathInput" class="path-input" placeholder="Enter downloads folder path (e.g., D:\Projects\Downloads)">
            <button class="btn btn-primary" onclick="chooseDownloadsFolder()">üìÅ Choose Folder</button>
          </div>
        </div>
      </div>
    </div>

    <div id="property-tenancyContent" class="tab-content">
      <!-- Sub-tab Buttons Bar -->
      <div class="property-tenancy-subtabs">
        <div class="property-tenancy-subtab active" data-subtab="property" onclick="switchPropertyTenancySubTab('property')">Property</div>
        <div class="property-tenancy-subtab" data-subtab="tenant" onclick="switchPropertyTenancySubTab('tenant')">Tenant</div>
        <div class="property-tenancy-subtab" data-subtab="manager" onclick="switchPropertyTenancySubTab('manager')">Manager</div>
        <div class="property-tenancy-subtab" data-subtab="lease-records" onclick="switchPropertyTenancySubTab('lease-records')">Lease Records</div>
        <div class="property-tenancy-subtab" data-subtab="inspection-report" onclick="switchPropertyTenancySubTab('inspection-report')">Inspection Report</div>
      </div>

      <!-- Sub-tab Content Areas -->
      <div id="propertySubContent" class="property-tenancy-subcontent active">
        <!-- Property content will be populated here -->
      </div>

      <div id="tenantSubContent" class="property-tenancy-subcontent">
        <!-- Tenant content - modal form will be opened on button click -->
      </div>

      <div id="managerSubContent" class="property-tenancy-subcontent">
        <!-- Manager content - modal form will be opened on button click -->
      </div>

      <div id="lease-recordsSubContent" class="property-tenancy-subcontent">
        <!-- Lease Records content - modal form will be opened on button click -->
      </div>

      <div id="inspection-reportSubContent" class="property-tenancy-subcontent">
        <!-- Inspection Report content - modal form will be opened on button click -->
      </div>
    </div>
  </div>

  <!-- Property-Tenancy Modals -->
  <!-- Properties Modal -->
  <div id="propertiesCRUDBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 1000;"></div>
  <div id="propertiesCRUDModal" style="display:none; position: fixed; top: 150px; left: 50%; transform: translate(-50%, 0); width: 1200px; max-width: 95vw; max-height: 90vh; overflow: auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 1001; padding: 20px;">
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 15px;">
      <h3 id="propertiesModalTitle" style="margin:0;">üè† Manage Properties</h3>
      <button class="pdf-button" onclick="closePropertiesCRUD()" style="background:#ef4444;">‚úñ Close</button>
    </div>
    <div class="excel-table-container" style="max-height: 60vh; margin-bottom: 10px;">
      <table class="excel-table" id="propertiesTable">
        <thead>
          <tr>
            <th class="resizable" style="width: 150px;">Property_Tag</th>
            <th class="resizable" style="width: 250px;">Property_Address</th>
            <th class="resizable" style="width: 200px;">Landlord_Name</th>
            <th class="resizable" style="width: 250px;">Landlord_Address</th>
            <th class="resizable" style="width: 150px;">Landlord_Phone</th>
            <th style="width: 100px; text-align: center;">Actions</th>
          </tr>
        </thead>
        <tbody id="propertiesCRUDBody"></tbody>
      </table>
    </div>
    <div style="display:flex; justify-content: space-between; align-items:center; margin-top:15px;">
      <button class="pdf-button" onclick="addPropertyRow()" style="background:#10b981;">Ôºã Add Property</button>
      <div style="display:flex; gap:8px;">
        <button class="pdf-button" onclick="savePropertiesCRUD()" style="background:#3b82f6;">‚úî Save & Apply</button>
      </div>
    </div>
  </div>

  <!-- Tenants Modal -->
  <div id="tenantsCRUDBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 1000;"></div>
  <div id="tenantsCRUDModal" style="display:none; position: fixed; top: 150px; left: 50%; transform: translate(-50%, 0); width: 95vw; max-width: 1400px; max-height: 75vh; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 1001; padding: 18px; flex-direction: column; overflow: hidden;">
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 15px; flex-shrink: 0;">
      <h3 id="tenantsModalTitle" style="margin:0;">üë• Manage Tenants</h3>
      <button class="pdf-button" onclick="closeTenantsCRUD()" style="background:#ef4444;">‚úñ Close</button>
    </div>
    <div class="excel-table-container" style="flex: 1; overflow: auto; margin-bottom: 10px; min-height: 0;">
      <table class="excel-table" id="tenantsTable">
        <thead>
          <tr>
            <th class="resizable" style="width: 120px;">Tenant_ID</th>
            <th class="resizable" style="width: 200px;">Tenant_Name</th>
            <th class="resizable" style="width: 200px;">Tenant_Email</th>
            <th class="resizable" style="width: 150px;">Tenant_Phone</th>
            <th class="resizable" style="width: 250px;">Tenant_Old_Address</th>
            <th class="resizable" style="width: 200px;">Tenant_Job_Desc</th>
            <th class="resizable" style="width: 120px; text-align: center;">Current_Status</th>
            <th style="width: 100px; text-align: center;">Actions</th>
          </tr>
        </thead>
        <tbody id="tenantsCRUDBody"></tbody>
      </table>
    </div>
    <div style="display:flex; justify-content: space-between; align-items:center; margin-top:15px; flex-shrink: 0;">
      <button class="pdf-button" onclick="addTenantRow()" style="background:#10b981;">Ôºã Add Tenant</button>
      <div style="display:flex; gap:8px;">
        <button class="pdf-button" onclick="saveTenantsCRUD()" style="background:#3b82f6;">‚úî Save & Apply</button>
      </div>
    </div>
  </div>

  <!-- Managers Modal -->
  <div id="managersCRUDBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 1000;"></div>
  <div id="managersCRUDModal" style="display:none; position: fixed; top: 150px; left: 50%; transform: translate(-50%, 0); width: 800px; max-width: 95vw; max-height: 85vh; overflow: auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 1001; padding: 18px;">
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px;">
      <h3 id="managersModalTitle" style="margin:0;">üëî Manage Managers & Superintendents</h3>
      <button class="pdf-button" onclick="closeManagersCRUD()" style="background:#ef4444;">‚úñ Close</button>
    </div>
    <div class="excel-table-container" style="max-height: 60vh; margin-bottom: 10px;">
      <table class="excel-table" id="managersTable">
        <thead>
          <tr>
            <th class="resizable" style="width: 200px;">Manager_Name</th>
            <th class="resizable" style="width: 150px;">Manager_Phone</th>
            <th class="resizable" style="width: 200px;">Superintendent_Name</th>
            <th class="resizable" style="width: 150px;">Superintendent_Phone</th>
            <th style="width: 100px; text-align: center;">Actions</th>
          </tr>
        </thead>
        <tbody id="managersCRUDBody"></tbody>
      </table>
    </div>
    <div style="display:flex; justify-content: space-between; align-items:center;">
      <button class="pdf-button" onclick="addManagerRow()" style="background:#10b981;">Ôºã Add Row</button>
      <div style="display:flex; gap:8px;">
        <button class="pdf-button" onclick="saveManagersCRUD()" style="background:#3b82f6;">‚úî Save</button>
        <button class="pdf-button" onclick="closeManagersCRUD()" style="background:#6b7280;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Lease Records Modal -->
  <div id="leasesCRUDBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 1000;"></div>
  <div id="leasesCRUDModal" style="display:none; position: fixed; top: 150px; left: 50%; transform: translate(-50%, 0); width: 95vw; max-width: 1400px; max-height: 75vh; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 1001; padding: 18px; flex-direction: column; overflow: hidden;">
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 15px; flex-shrink: 0;">
      <h3 id="leasesModalTitle" style="margin:0;">üìã Manage Leases</h3>
      <button class="pdf-button" onclick="closeLeasesCRUD()" style="background:#ef4444;">‚úñ Close</button>
    </div>
    <div class="excel-table-container" style="flex: 1; overflow: auto; margin-bottom: 10px; min-height: 0;">
      <table class="excel-table" id="leasesTable">
        <thead>
          <tr>
            <th class="resizable" style="width: 150px;">Lease_ID</th>
            <th class="resizable" style="width: 120px;">Property_Tag</th>
            <th class="resizable" style="width: 180px;">Landlord</th>
            <th class="resizable" style="width: 200px;">Tenants</th>
            <th class="resizable" style="width: 120px;">Lease_Start_Date</th>
            <th class="resizable" style="width: 120px;">Lease_End_Date</th>
            <th class="resizable" style="width: 120px;">Monthly_Rent</th>
            <th class="resizable" style="width: 130px;">Security_Deposit</th>
            <th class="resizable" style="width: 200px;">Notes</th>
            <th style="width: 100px; text-align: center;">Actions</th>
          </tr>
        </thead>
        <tbody id="leasesCRUDBody"></tbody>
      </table>
    </div>
    <div style="display:flex; justify-content: space-between; align-items:center; margin-top:15px; flex-shrink: 0;">
      <div style="font-size: 12px; color:#666;">Leases are created when you finalize a lease. You can edit Notes here.</div>
      <div style="display:flex; gap:8px;">
        <button class="pdf-button" onclick="saveLeasesCRUD()" style="background:#3b82f6;">‚úî Save Changes</button>
        <button class="pdf-button" onclick="clearAllLeaseRecords()" style="background:#ef4444;">üóë Clear All Records</button>
      </div>
    </div>
  </div>

  <!-- Inspection Report Modal -->
  <div id="inspectionReportCRUDBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 1000;"></div>
  <div id="inspectionReportCRUDModal" style="display:none; position: fixed; top: 150px; left: 50%; transform: translate(-50%, 0); width: 95vw; max-width: 1400px; max-height: 75vh; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 1001; padding: 18px; flex-direction: column; overflow: hidden;">
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; flex-shrink: 0;">
      <h3 id="inspectionModalTitle" style="margin:0;">üìã Manage Inspection Report</h3>
      <button class="pdf-button" onclick="closeInspectionReportCRUD()" style="background:#ef4444;">‚úñ Close</button>
    </div>
    <div style="margin-bottom: 10px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 12px; flex-shrink: 0;">
      <strong>Instructions:</strong> Edit sections, comments, and codes. Use "Add Row" to create new entries. Column headers can be resized by dragging the border between columns.
      <br><br>
      <strong class="flashing-text">Conditional Codes: B: Broken, M: Missing, D: Damaged, G: Good, S: Scratched/Marked</strong><br>
      <strong class="flashing-text">Cleanliness Codes: C: Clean, DT: Dirty, ST: Stained</strong>
    </div>
    <div class="excel-table-container" style="flex: 1; overflow: auto; margin-bottom: 10px; min-height: 0;">
      <table class="excel-table" id="inspectionReportTable">
        <thead>
          <tr>
            <th class="resizable" style="width: 200px;">Sections</th>
            <th class="resizable" style="width: 120px;" title="Condition at Beginning of Tenancy">Comment</th>
            <th class="resizable" style="width: 80px;" title="Condition at Beginning of Tenancy">Code</th>
            <th class="resizable" style="width: 120px;" title="Condition at End of Tenancy">Comment</th>
            <th class="resizable" style="width: 80px;" title="Condition at End of Tenancy">Code</th>
            <th style="width: 100px; text-align: center;">Actions</th>
          </tr>
        </thead>
        <tbody id="inspectionReportCRUDBody"></tbody>
      </table>
    </div>
    <div style="display:flex; justify-content: space-between; align-items:center; flex-shrink: 0;">
      <button class="pdf-button" onclick="addInspectionRow()" style="background:#10b981;">Ôºã Add Row</button>
      <div style="display:flex; gap:8px;">
        <button class="pdf-button" onclick="saveInspectionReportCRUD()" style="background:#3b82f6;">‚úî Save</button>
        <button class="pdf-button" onclick="closeInspectionReportCRUD()" style="background:#6b7280;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">Edit Value</div>
      <div class="modal-body">
        <input type="text" id="editInput" placeholder="Enter value">
        <div id="editSqaGroup" class="sqa-edit-group">
          <input type="text" id="editQuestionInput" placeholder="Security question">
          <input type="text" id="editAnswerInput" placeholder="Answer (optional)">
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEditedValue()">Save</button>
      </div>
    </div>
  </div>

  <!-- Critical script runs first, before XLSX library -->
  <script>
    console.log('=== Critical script loading ===');
    
    // Define path selection functions immediately so they're available for onclick
    window.chooseMasterDataFile = async function() {
      console.log('chooseMasterDataFile called');
      try {
        if ('showOpenFilePicker' in window) {
          const [fileHandle] = await window.showOpenFilePicker({
            types: [{
              description: 'Excel Files',
              accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] }
            }]
          });
          const file = await fileHandle.getFile();
          const path = prompt('File selected: ' + file.name + '\n\nDue to browser security limitations, you need to enter the full path manually:\n(e.g., D:\\Projects\\' + file.name, file.name);
          if (path && path.trim()) {
            localStorage.setItem('project_master_data_file', path.trim());
            const folderPath = path.substring(0, path.lastIndexOf('\\'));
            if (folderPath) {
              localStorage.setItem('project_master_data_folder', folderPath);
            }
            alert('Master Data File path saved!');
            // Update display immediately
            const display = document.getElementById('masterDataFileDisplay');
            const input = document.getElementById('masterDataFileInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        } else {
          const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Master Data Excel file:\n(e.g., D:\\Projects\\MasterData.xlsx)', 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_master_data_file', path.trim());
            const folderPath = path.substring(0, path.lastIndexOf('\\'));
            if (folderPath) {
              localStorage.setItem('project_master_data_folder', folderPath);
            }
            alert('Master Data File path saved!');
            // Update display immediately
            const display = document.getElementById('masterDataFileDisplay');
            const input = document.getElementById('masterDataFileInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      } catch (err) {
        if (err.name !== 'AbortError') {
          const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Master Data Excel file:\n(e.g., D:\\Projects\\MasterData.xlsx)', 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_master_data_file', path.trim());
            alert('Master Data File path saved!');
            // Update display immediately
            const display = document.getElementById('masterDataFileDisplay');
            const input = document.getElementById('masterDataFileInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      }
    };

    window.chooseBackupFolder = async function() {
      console.log('chooseBackupFolder called');
      try {
        if ('showDirectoryPicker' in window) {
          const dirHandle = await window.showDirectoryPicker();
          const path = prompt('Folder selected: ' + dirHandle.name + '\n\nDue to browser security limitations, you need to enter the full path manually:\n(e.g., D:\\Projects\\' + dirHandle.name, 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_backup_path', path.trim());
            alert('Backup folder path saved!');
            // Update display immediately
            const display = document.getElementById('backupPathDisplay');
            const input = document.getElementById('backupPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        } else {
          const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Backup folder:\n(e.g., D:\\Projects\\Backup)', 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_backup_path', path.trim());
            alert('Backup folder path saved!');
            // Update display immediately
            const display = document.getElementById('backupPathDisplay');
            const input = document.getElementById('backupPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      } catch (err) {
        if (err.name !== 'AbortError') {
            const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Backup folder:\n(e.g., D:\\Projects\\Backup)', 'D:\\');
            if (path && path.trim()) {
              localStorage.setItem('project_backup_path', path.trim());
              alert('Backup folder path saved!');
            // Update display immediately
            const display = document.getElementById('backupPathDisplay');
            const input = document.getElementById('backupPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      }
    };

    window.chooseDocumentsFolder = async function() {
      console.log('chooseDocumentsFolder called');
      try {
        if ('showDirectoryPicker' in window) {
          const dirHandle = await window.showDirectoryPicker();
          const path = prompt('Folder selected: ' + dirHandle.name + '\n\nDue to browser security limitations, you need to enter the full path manually:\n(e.g., D:\\Projects\\' + dirHandle.name, 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_documents_path', path.trim());
            alert('Documents folder path saved!');
            // Update display immediately
            const display = document.getElementById('documentsPathDisplay');
            const input = document.getElementById('documentsPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        } else {
          const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Documents folder:\n(e.g., D:\\Projects\\Documents)', 'D:\\');
          if (path && path.trim()) {
            localStorage.setItem('project_documents_path', path.trim());
            alert('Documents folder path saved!');
            // Update display immediately
            const display = document.getElementById('documentsPathDisplay');
            const input = document.getElementById('documentsPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      } catch (err) {
        if (err.name !== 'AbortError') {
            const path = prompt('Due to browser security limitations, you need to enter the full path manually.\n\nEnter the full path to the Documents folder:\n(e.g., D:\\Projects\\Documents)', 'D:\\');
            if (path && path.trim()) {
              localStorage.setItem('project_documents_path', path.trim());
              alert('Documents folder path saved!');
            // Update display immediately
            const display = document.getElementById('documentsPathDisplay');
            const input = document.getElementById('documentsPathInput');
            if (display) display.textContent = path.trim();
            if (input) input.value = path.trim();
          }
        }
      }
    };

    window.chooseDownloadsFolder = async function() {
      console.log('chooseDownloadsFolder called');
      const path = prompt('Enter the full path to the Downloads folder:\n(e.g., D:\\Projects\\Downloads)', localStorage.getItem('project_downloads_path') || 'D:\\');
      if (path && path.trim()) {
        localStorage.setItem('project_downloads_path', path.trim());
        alert('Downloads folder path saved!');
        // Update display immediately
        const display = document.getElementById('downloadsPathDisplay');
        const input = document.getElementById('downloadsPathInput');
        if (display) display.textContent = path.trim();
        if (input) input.value = path.trim();
      }
    };
    
    // Define openFilePicker immediately - this must work regardless of XLSX library
    window.openFilePicker = function(){
      console.log('openFilePicker called');
      const input = document.getElementById('excelFileInput');
      if(!input){ 
        alert('File input not found'); 
        console.error('File input element not found');
          return;
        }
      console.log('File input found, opening picker');
      try{
        input.click();
        console.log('File picker triggered');
      }catch(err){
        console.error('Error opening file picker:', err);
        alert('Error opening file picker: ' + err.message);
      }
    };
    
    console.log('openFilePicker function defined');
    
    // Attach button listener here as well (early), so it works even if other scripts fail
    (function attachEarlyButtonListener(){
      function tryAttach(){
        const btn = document.getElementById('btnLoadFromD');
        if (btn) {
          btn.onclick = function(e){
            e.preventDefault();
            e.stopPropagation();
            window.openFilePicker();
          };
          console.log('Early button listener attached');
          return true;
        }
        return false;
      }
      if (!tryAttach()) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', tryAttach, { once: true });
        } else {
          setTimeout(tryAttach, 50);
        }
      }
    })();

    // Store folder path variable - persists until file is reloaded
    window.lastExcelFolderPath = localStorage.getItem('last_excel_folder_path') || '';
    
    // Define helper functions early for Excel loading
    if (typeof window.extractSqaQuestion === 'undefined') {
      window.extractColumnValue = function(row, keyCandidates, fallbackToFirst) {
        if (!row) return '';
        for (const key of keyCandidates) {
          const val = row[key];
          if (val !== undefined && val !== null && String(val).trim()) {
            return String(val).trim();
          }
        }
        if (fallbackToFirst) {
          const firstKey = Object.keys(row)[0];
          return firstKey ? String(row[firstKey] || '').trim() : '';
        }
        return '';
      };
      
      window.extractSqaQuestion = function(row) {
        const keys = ['Security Question','Security Questions','Security Question(s)','Question','Questions','Security_Q'];
        return window.extractColumnValue(row, keys, true);
      };
      
      window.extractSqaAnswer = function(row) {
        const keys = ['Security Answer','Security Answers','Security Answer(s)','Answer','Answers','Security_A'];
        return window.extractColumnValue(row, keys, false);
      };
      
      window.parseSqaValue = function(rawValue) {
        const text = String(rawValue || '').trim();
        if (!text) return { question: '', answer: '' };
        const separatorIndex = text.indexOf('‚Äî');
        if (separatorIndex === -1) {
          return { question: text, answer: '' };
        }
        const question = text.slice(0, separatorIndex).trim();
        const answer = text.slice(separatorIndex + 1).replace(/^[\s‚Äî-]+/, '').trim();
        return { question, answer };
      };
      
      window.formatSqaValue = function(question, answer) {
        const q = String(question || '').trim();
        const a = String(answer || '').trim();
        if (!q && !a) return '';
        return a ? `${q} ‚Äî ${a}` : q;
      };
      
      window.normalizeSqaValues = function(data) {
        if (!data || !data.common) return;
        let entries = data.common.SQA;
        if (!entries) return;
        if (Array.isArray(entries)) {
          // Ensure all entries are strings in format "question ‚Äî answer" or just "question"
          data.common.SQA = entries.map(e => {
            if (typeof e === 'string') return e;
            if (e && typeof e === 'object' && (e.question || e.answer)) {
              const q = String(e.question || '').trim();
              const a = String(e.answer || '').trim();
              return window.formatSqaValue(q, a);
            }
            return String(e || '');
          }).filter(e => e);
        }
      };
      
      window.defaultParseSqaValue = function(rawValue) {
        return window.parseSqaValue(rawValue);
      };
    }
    
    // Shared function to show consolidated import message (defined early so early handler can use it)
    window.showConsolidatedImportMessage = function(fileName, sheetNames, masterDataForCounting) {
      const totalSheets = sheetNames.length;
      const transactionalSheets = sheetNames.filter(s => s.startsWith('Txn_') && s !== 'Txn_Mode' && s !== 'Txn_Status' && !s.includes('Mode') && !s.includes('Status')).length;
      const hasPathsSheet = sheetNames.includes('Paths');
      const masterDataSheets = totalSheets - transactionalSheets - (hasPathsSheet ? 1 : 0);
      
      // Ensure we have masterData - load from cache if needed
      let dataForCounting = masterDataForCounting || {};
      if (!dataForCounting || Object.keys(dataForCounting).length === 0) {
        try {
          const cached = localStorage.getItem('masterDataCache');
          if (cached) dataForCounting = JSON.parse(cached) || {};
        } catch (e) {}
      }
      if (!dataForCounting || Object.keys(dataForCounting).length === 0) {
        dataForCounting = window.masterData || {};
      }
      
      // Count Property-Tenancy records
      const propertyKeys = new Set();
      Object.keys(dataForCounting).forEach(key => {
        const match = key.match(/^Property_(.+?)_Tag$/);
        if (match) {
          propertyKeys.add(match[1]);
        }
      });
      const propertyCount = propertyKeys.size;
      
      const tenantIds = new Set();
      Object.keys(dataForCounting).forEach(key => {
        const match = key.match(/^Tenant_(.+?)_ID$/);
        if (match) {
          tenantIds.add(match[1]);
        }
      });
      const tenantCount = tenantIds.size;
      
      const managerCount = (dataForCounting['Manager_Name'] || '').trim() ? 1 : 0;
      
      let leaseRecordsCount = 0;
      try {
        const leaseRecords = JSON.parse(localStorage.getItem('leaseRecords') || '[]');
        leaseRecordsCount = Array.isArray(leaseRecords) ? leaseRecords.length : 0;
      } catch (e) {
        leaseRecordsCount = 0;
      }
      
      let inspectionReportCount = 0;
      try {
        const inspectionData = localStorage.getItem('inspectionReportData');
        if (inspectionData && typeof XLSX !== 'undefined') {
          const wb = XLSX.read(inspectionData, { type: 'base64' });
          const sheetName = wb.SheetNames.find(n => n.toLowerCase().includes('inspection')) || wb.SheetNames[0];
          if (sheetName) {
            const sheet = wb.Sheets[sheetName];
            const sheetData = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});
            inspectionReportCount = sheetData.filter((row, idx) => {
              if (idx === 0) return false;
              return row && row.length > 0 && row.some(cell => cell && String(cell).trim());
            }).length;
          }
        }
      } catch (e) {
        inspectionReportCount = 0;
      }
      
      // Count fields loaded for each module - check unified structure
      let unified = {};
      try {
        const unifiedData = localStorage.getItem('unified_master_data');
        if (unifiedData) unified = JSON.parse(unifiedData) || {};
      } catch (e) {}
      
      const moduleFieldCounts = {
        income: Object.keys((unified.income || {})).length || Object.keys((dataForCounting.income || {})).length,
        expense: Object.keys((unified.expense || {})).length || Object.keys((dataForCounting.expense || {})).length,
        investment: Object.keys((unified.investment || {})).length || Object.keys((dataForCounting.investment || {})).length,
        task: Object.keys((unified.task || {})).length || Object.keys((dataForCounting.task || {})).length,
        common: Object.keys((unified.common || {})).length || Object.keys((dataForCounting.common || {})).length
      };
      
      // Build consolidated message
      let message = `Successfully imported master data from Excel file!\n\n`;
      message += `Total sheets in file: ${totalSheets}\n`;
      message += `Transactional sheets skipped: ${transactionalSheets}\n`;
      message += `Master data sheets processed: ${masterDataSheets}${hasPathsSheet ? ' + Paths' : ''}\n\n`;
      message += `Fields Loaded - Income: ${moduleFieldCounts.income}, Expense: ${moduleFieldCounts.expense}, Investment: ${moduleFieldCounts.investment}, Task: ${moduleFieldCounts.task}, Shared Attributes: ${moduleFieldCounts.common}${hasPathsSheet ? ', Paths: 4' : ''}\n\n`;
      message += `For Property-Tenancy Data:\n`;
      message += `Property: ${propertyCount} Records\n`;
      message += `Tenant: ${tenantCount} Records\n`;
      message += `Manager: ${managerCount} Records\n`;
      message += `Lease Records: ${leaseRecordsCount} Records\n`;
      message += `Inspection Report: ${inspectionReportCount} Records`;
      
      const arePathsSet = function() {
        return !!(localStorage.getItem('project_backup_path') && localStorage.getItem('project_documents_path') && localStorage.getItem('project_downloads_path'));
      };
      
      if (!arePathsSet()) {
        message += '\n\n‚ö†Ô∏è Please set Project Paths in the "Set/Change Paths" tab!';
      }
      
      alert(message);
    };
    
    // Early minimal change handler to verify file selection and XLSX availability
    (function attachEarlyChangeHandler(){
      const input = document.getElementById('excelFileInput');
      if (!input) return;
      input.addEventListener('change', function(e){
        const f = e.target.files && e.target.files[0];
        console.log('Early handler: file selected?', !!f, f ? f.name : '');
        if (!window.XLSX) {
          console.warn('Early handler: XLSX not loaded yet');
          return;
        }
        if (!f) return;
        
        // Try to capture folder path from file input (may be limited by browser security)
        let folderPath = '';
        try {
          // File System Access API provides better path info if available
          if (f.path) {
            // Chrome/Edge may provide this
            const fullPath = f.path || '';
            const pathParts = fullPath.split('\\');
            pathParts.pop(); // Remove filename
            folderPath = pathParts.join('\\');
          }
          
          // If path not available, try to get from input value (often stripped but worth trying)
          const inputValue = e.target.value || '';
          if (inputValue && !folderPath) {
            // Extract folder path from input value (format: "C:\path\to\file.xlsx")
            // Skip if it's the fake path browsers show for security
            if (!inputValue.includes('fakepath') && !inputValue.toLowerCase().includes('c:\\fakepath')) {
              const match = inputValue.match(/^(.+)[\\\/][^\\\/]+$/);
              if (match && match[1]) {
                folderPath = match[1];
                // Double check it's not a fake path
                if (folderPath.toLowerCase().includes('fakepath')) {
                  folderPath = '';
                }
              }
            }
          }
          
          // If still no path, prompt user once
          if (!folderPath && !window.lastExcelFolderPath) {
            folderPath = prompt(`File "${f.name}" selected.\n\nEnter the folder path where this file is located:`, 'D:\\');
            if (folderPath) {
              folderPath = folderPath.trim().replace(/[\\\/]+$/, ''); // Remove trailing slashes
            }
          } else if (!folderPath && window.lastExcelFolderPath) {
            // Reuse last known folder path
            folderPath = window.lastExcelFolderPath;
          }
          
          // Store folder path
          if (folderPath) {
            window.lastExcelFolderPath = folderPath;
            localStorage.setItem('last_excel_folder_path', folderPath);
            console.log('Folder path captured:', folderPath);
          }
        } catch (err) {
          console.warn('Could not capture folder path:', err);
        }
        try{
          const reader = new FileReader();
          reader.onload = function(ev){
            try{
              const data = new Uint8Array(ev.target.result);
              const wb = XLSX.read(data, { type: 'array' });
              const sheetNames = wb.SheetNames || [];
              console.log('[Early] Sheets:', sheetNames);
              // Minimal mapping used only as fallback
              const MAP = {
                expense: { Expanse_Category: 'Expanse_Category', Expanse_Ac_Tag: 'Expanse_Ac_Tag' },
                income: { Income_Category: 'Income_Category', Income_Ac_Tag: 'Income_Ac_Tag' },
                investment: { Investment_Category: 'Investment_Category', Investment_Ac_Tag: 'Investment_Ac_Tag' },
                task: { Task_Category: 'Task_Category', Task_Status: 'Task_Status', Task_Assignee: 'Task_Assignee', Task_Priority: 'Task_Priority', Task_Adhoc: 'Task_Adhoc' },
                common: { Currency: 'Currency', Mode: 'Mode', Status_Txn: 'Status_Txn', Ac_Holder: 'Ac_Holder', Frequency: 'Frequency', Ac_Status: 'Ac_Status', Ac_Classification: 'Ac_Classification', Country: 'Country', Institution: 'Institution', Ac_Type: 'Ac_Type' }
              };
              const VARIANTS = {
                Mode_Txn: { module: 'common', key: 'Mode' },
                Txn_Mode: { module: 'common', key: 'Mode' },
                Expense_Category: { module: 'expense', key: 'Expanse_Category' },
                Expense_Ac_Tag: { module: 'expense', key: 'Expanse_Ac_Tag' },
                Expense_Tag: { module: 'expense', key: 'Expanse_Ac_Tag' },
                Investment_Tag: { module: 'investment', key: 'Investment_Ac_Tag' },
                Task_Tag: { module: 'common', key: 'Country' },
                Country: { module: 'common', key: 'Country' }
              };
              let unified = { task:{}, expense:{}, income:{}, investment:{}, common:{}, 'trading-accounts':{} };
              // Merge existing if present
              try{ const existing = JSON.parse(localStorage.getItem('unified_master_data')||'null'); if (existing) unified = existing; }catch(_){ }

              // Handle Paths sheet if it exists
              if (sheetNames.includes('Paths')) {
                const pathsSheet = wb.Sheets['Paths'];
                const pathsData = XLSX.utils.sheet_to_json(pathsSheet);
                pathsData.forEach(row => {
                  const pathType = String(row['Path Type'] || '').trim();
                  const path = String(row['Path'] || '').trim();
                  if (pathType && path) {
                    let storageKey = null;
                    if (pathType === 'Master Data File') storageKey = 'project_master_data_file';
                    else if (pathType === 'Backup Path') storageKey = 'project_backup_path';
                    else if (pathType === 'Documents Path') storageKey = 'project_documents_path';
                    else if (pathType === 'Downloads Path') storageKey = 'project_downloads_path';
                    if (storageKey) localStorage.setItem(storageKey, path);
                  }
                });
              }

              sheetNames.forEach(name => {
                // Skip Txn_* except Mode/Status
                if (name.startsWith('Txn_') && !name.includes('Mode') && !name.includes('Status')) return;
                
                // Handle Tenant sheet with Tenant_ID and Current_Status
                if (name === 'Tenant') {
                  const sheet = wb.Sheets[name];
                  if (sheet) {
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    // Store tenant data in masterDataCache format (will be merged into unified later)
                    if (!window.masterData) window.masterData = {};
                    // Clear existing tenant data
                    Object.keys(window.masterData).forEach(key => {
                      if (key.match(/^Tenant_(.+?)_/)) {
                        delete window.masterData[key];
                      }
                    });
                    
                    rows.forEach((row, index) => {
                      const tenantIdValue = row['Tenant_ID'] || row['Tenant ID'] || row['TENANT_ID'] || row['Tenant_Id'];
                      let tenantId = tenantIdValue !== undefined && tenantIdValue !== null && tenantIdValue !== '' 
                        ? String(tenantIdValue).trim() 
                        : String(index + 1);
                      
                      const tenantData = {
                        id: tenantId,
                        name: String(row['Tenant_Name'] || row['Tenant Name'] || row['TENANT_NAME'] || '').trim(),
                        email: String(row['Tenant_Email'] || row['Tenant Email'] || row['TENANT_EMAIL'] || '').trim(),
                        phone: String(row['Tenant_Phone'] || row['Tenant Phone'] || row['TENANT_PHONE'] || '').trim(),
                        address: String(row['Tenant_Old_Address'] || row['Tenant Old Address'] || row['Old_Address'] || row['TENANT_OLD_ADDRESS'] || '').trim(),
                        job: String(row['Tenant_Job_Desc'] || row['Tenant Job Desc'] || row['Job_Desc'] || row['TENANT_JOB_DESC'] || '').trim(),
                        currentStatus: String(row['Current_Status'] || row['Current Status'] || row['CURRENT_STATUS'] || row['Status'] || 'Active').trim()
                      };
                      
                      window.masterData[`Tenant_${tenantId}_ID`] = tenantData.id;
                      window.masterData[`Tenant_${tenantId}_Name`] = tenantData.name;
                      window.masterData[`Tenant_${tenantId}_Email`] = tenantData.email;
                      window.masterData[`Tenant_${tenantId}_Phone`] = tenantData.phone;
                      window.masterData[`Tenant_${tenantId}_Old_Address`] = tenantData.address;
                      window.masterData[`Tenant_${tenantId}_Job_Desc`] = tenantData.job;
                      window.masterData[`Tenant_${tenantId}_Current_Status`] = tenantData.currentStatus;
                      const statusLower = tenantData.currentStatus.toLowerCase();
                      window.masterData[`Tenant_${tenantId}_Active`] = (statusLower === 'inactive' || statusLower === '0' || statusLower === 'false') ? '0' : '1';
                    });
                    
                    console.log(`[Early] Loaded ${rows.length} tenants`);
                    // Save to masterDataCache for persistence
                    try {
                      localStorage.setItem('masterDataCache', JSON.stringify(window.masterData || {}));
                    } catch(e) {
                      console.error('[Early] Error saving tenant data:', e);
                    }
                  }
                  return;
                }
                
                if (name === 'SQA') {
                  const sheet = wb.Sheets[name];
                  if (sheet) {
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    const extractQ = window.extractSqaQuestion || function(r) { return String(r['Security Question'] || r['Question'] || r[Object.keys(r)[0]] || '').trim(); };
                    const extractA = window.extractSqaAnswer || function(r) { return String(r['Security Answer'] || r['Answer'] || '').trim(); };
                    const items = rows.map(row => {
                      const question = extractQ(row);
                      const answer = extractA(row);
                      if (!question && !answer) return null;
                      return answer ? `${question} ‚Äî ${answer}` : question;
                    }).filter(Boolean);
                    if (items.length) {
                      if (!unified.common.SQA) unified.common.SQA = [];
                      unified.common.SQA = Array.from(new Set([...(unified.common.SQA || []), ...items]));
                      console.log(`[Early] Loaded ${items.length} entries into common.SQA`);
                    }
                  }
                  return;
                }
                
                // NEW: Handle merged sheets (Ac_Category, Ac_Tag)
                if (name === 'Ac_Category' || name === 'Ac_Tag') {
                  const sheet = wb.Sheets[name];
                  const rows = XLSX.utils.sheet_to_json(sheet);
                  if (!rows || !rows.length) return;
                  
                  const mainCol = name === 'Ac_Category' ? 'Ac_Category' : 'Ac_Tag';
                  const classCol = 'Ac_Classification';
                  const cols = Object.keys(rows[0]);
                  
                  if (!cols.includes(mainCol) || !cols.includes(classCol)) return;
                  
                  const incomeVals = [], investVals = [], expVals = [], tenantVals = [];
                  rows.forEach(r => {
                    const val = String(r[mainCol]||'').trim();
                    const cls = String(r[classCol]||'').trim();
                    if (!val) return;
                    if (cls === 'Income') incomeVals.push(val);
                    else if (cls === 'Investment') investVals.push(val);
                    else if (cls === 'Expanse' || cls === 'Expense') expVals.push(val);
                    else if (cls === 'Tenant') tenantVals.push(val);
                  });
                  
                  let incKey, invKey, expKey, tenKey;
                  if (name === 'Ac_Category') {
                    incKey = 'Income_Category'; invKey = 'Investment_Category'; expKey = 'Expanse_Category'; tenKey = 'Tenant_Category';
                  } else {
                    incKey = 'Income_Ac_Tag'; invKey = 'Investment_Ac_Tag'; expKey = 'Expanse_Ac_Tag'; tenKey = 'Tenant_Ac_Tag';
                  }
                  
                  ['income', 'investment', 'expense'].forEach(m => {
                    const v = m === 'income' ? incomeVals : (m === 'investment' ? investVals : (m === 'expense' ? expVals : tenantVals));
                    const k = m === 'income' ? incKey : (m === 'investment' ? invKey : (m === 'expense' ? expKey : tenKey));
                    if (!unified[m][k]) unified[m][k] = [];
                    unified[m][k] = Array.from(new Set([...(unified[m][k]||[]), ...v])).sort();
                    console.log(`[Early] Loaded ${v.length} ${m} from ${name}`);
                  });
                  return;
                }
                
                let mod=null,key=null;
                if (MAP.expense[name]){ mod='expense'; key=name; }
                else if (MAP.income[name]){ mod='income'; key=name; }
                else if (MAP.investment[name]){ mod='investment'; key=name; }
                else if (MAP.task[name]){ mod='task'; key=name; }
                else if (MAP.common[name]){ mod='common'; key=name; }
                else if (VARIANTS[name]){ mod=VARIANTS[name].module; key=VARIANTS[name].key; }
                else if (name === 'Mode' || name === 'Status_Txn' || name === 'Ac_Classification' || name === 'Institution' || name === 'Ac_Type'){ mod='common'; key=name; }
                if (!mod || !key) return;
                const sheet = wb.Sheets[name];
                const rows = XLSX.utils.sheet_to_json(sheet);
                if (!rows || !rows.length) return;
                // Column selection: prefer matching column name else first
                const firstRow = rows[0];
                const cols = Object.keys(firstRow);
                let col = cols.find(c=>c.toLowerCase()===name.toLowerCase()) || cols.find(c=>c.toLowerCase().includes(key.toLowerCase())) || cols[0];
                const values = rows.map(r=>String(r[col]??'').trim()).filter(v=>v);
                if (!unified[mod][key]) unified[mod][key]=[];
                unified[mod][key] = Array.from(new Set([...(unified[mod][key]||[]), ...values])).sort();
                console.log(`[Early] Loaded ${values.length} into ${mod}.${key}`);
              });
              if (typeof window.normalizeSqaValues === 'function') {
                window.normalizeSqaValues(unified);
              }
              localStorage.setItem('unified_master_data', JSON.stringify(unified));
              localStorage.setItem('last_excel_file_loaded', f.name);
              localStorage.setItem('last_excel_file_source', 'D:');
              
              // Store folder path if captured
              if (window.lastExcelFolderPath) {
                localStorage.setItem('last_excel_folder_path', window.lastExcelFolderPath);
              }
              
              // Update display immediately if function exists
              if (typeof updateLastFileDisplay === 'function') {
                updateLastFileDisplay();
              }
              // Build detailed summary
              const totalSheets = sheetNames.length;
              const transactionalSheets = sheetNames.filter(s => s.startsWith('Txn_') && !s.includes('Mode') && !s.includes('Status')).length;
              const hasPathsSheet = sheetNames.includes('Paths');
              const masterDataSheets = sheetNames.length - transactionalSheets - (hasPathsSheet ? 1 : 0);
              const moduleFieldCounts = {
                income: Object.keys(unified.income||{}).length,
                expense: Object.keys(unified.expense||{}).length,
                investment: Object.keys(unified.investment||{}).length,
                task: Object.keys(unified.task||{}).length,
                common: Object.keys(unified.common||{}).length
              };
              const moduleValueCounts = {
                income: Object.values(unified.income||{}).reduce((a,b)=>a+(b?b.length:0),0),
                expense: Object.values(unified.expense||{}).reduce((a,b)=>a+(b?b.length:0),0),
                investment: Object.values(unified.investment||{}).reduce((a,b)=>a+(b?b.length:0),0),
                task: Object.values(unified.task||{}).reduce((a,b)=>a+(b?b.length:0),0),
                common: Object.values(unified.common||{}).reduce((a,b)=>a+(b?b.length:0),0)
              };
              // Set flag to prevent main handler from processing same file
              window.excelProcessedByEarlyHandler = true;
              window.excelProcessedFileName = f.name;
              window.excelProcessedTimestamp = Date.now();
              
              // If main helpers are available, render immediately without reload and show message
              if (typeof window !== 'undefined' && typeof saveMasterData === 'function' && typeof renderTab === 'function') {
                try {
                  window.masterData = unified;
                  saveMasterData();
                  if (typeof updateLastFileDisplay === 'function') updateLastFileDisplay();
                  const currentTab = (document.querySelector('.tab.active')||{getAttribute:()=> 'income'}).getAttribute('data-tab');
                  renderTab(currentTab || 'income');
                  
                  // Show consolidated message after a short delay to ensure all data is saved
                  setTimeout(() => {
                    // Load masterData from cache for counting Property-Tenancy records
                    let dataForCounting = {};
                    try {
                      const cached = localStorage.getItem('masterDataCache');
                      if (cached) dataForCounting = JSON.parse(cached) || {};
                    } catch (e) {}
                    if (typeof window.showConsolidatedImportMessage === 'function') {
                      window.showConsolidatedImportMessage(f.name, sheetNames, dataForCounting);
                    }
                  }, 500);
                } catch (e) {
                  console.warn('Immediate render failed, reloading...', e);
                  location.reload();
                }
              } else {
                location.reload();
              }
            }catch(err){
              console.error('[Early] Parse error:', err);
              alert('Error reading Excel (early): ' + err.message);
            }
          };
          reader.readAsArrayBuffer(f);
        }catch(err){
          console.error('[Early] Reader error:', err);
          alert('Error: '+err.message);
        }
      });
    })();

    // Provide minimal fallback rendering if main script did not attach functions
    (function ensureFallbackRender(){
      if (typeof window.renderTab === 'function') return; // main script present
      console.warn('Main render functions missing; installing fallback renderer');
      
      // Define escapeHtml early for use in fallback renderer
      if (typeof window.escapeHtml === 'undefined') {
        window.escapeHtml = function(text) {
          if (text == null) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        };
      }
      const escapeHtml = window.escapeHtml; // Local reference for convenience
      
      // Basic structure mirrors the confirmed fields
      const FB_STRUCTURE = {
        expense: { 'Expanse_Category':'Expense Category', 'Expanse_Ac_Tag':'Expense Account Tag' },
        income: { 'Income_Category':'Income Category', 'Income_Ac_Tag':'Income Account Tag' },
        investment: { 'Investment_Category':'Investment Category', 'Investment_Ac_Tag':'Investment Account Tag' },
        task: { 'Task_Tag':'Task Tag','Task_Status':'Task Status','Task_Assignee':'Task Assignee','Task_Priority':'Task Priority','Task_Category':'Task Category','Task_Adhoc':'Task Adhoc' },
        common: {
          'Currency':'Currency',
          'Mode':'Mode',
          'Status_Txn':'Transaction Status',
          'Ac_Holder':'Account Holder',
          'Frequency':'Frequency',
          'Ac_Status':'Account Status',
          'Ac_Classification':'Account Classification',
          'Email':'Email Addresses',
          'Phone':'Phone Numbers',
          'SQA':'Security Questions & Answers'
        },
        'trading-accounts': {},
      };
      window.initializeMasterData = function(){
        const data = window.masterData || {};
        ['expense','income','investment','task','common','trading-accounts'].forEach(m => {
          if (!data[m]) data[m] = {};
          Object.keys(FB_STRUCTURE[m] || {}).forEach(k => { if (!Array.isArray(data[m][k])) data[m][k] = []; });
        });
        if (typeof window.normalizeSqaValues === 'function') {
          window.normalizeSqaValues(data);
        }
        window.masterData = data;
      };
      window.saveMasterData = function(){
        localStorage.setItem('unified_master_data', JSON.stringify(window.masterData||{}));
      };
      function createFieldCard(module, fieldKey, label){
        const card = document.createElement('div');
        card.className = 'field-card';
        const header = document.createElement('div');
        header.className = 'field-header';
        const values = ((window.masterData||{})[module]||{})[fieldKey] || [];
        header.innerHTML = `<span class="field-name">${fieldKey} (${values.length}) <--> ${label}</span>`;
        card.appendChild(header);
        const valuesContainer = document.createElement('div');
        valuesContainer.className = 'values-container';
        if (values.length === 0){
          valuesContainer.innerHTML = '<div class="empty-field">No entries yet</div>';
        } else {
          values.forEach((v, idx) => {
            const isSqa = fieldKey === 'SQA';
            const row = document.createElement('div');
            row.className = isSqa ? 'value-row sqa-row' : 'value-row';
            if (isSqa) {
              const parsed = (window.parseSqaValue||defaultParseSqaValue)(v);
              const q = escapeHtml(parsed.question||'');
              const a = escapeHtml(parsed.answer||'');
              row.innerHTML = `
                <span class="value-text sqa-question" title="${q}">${q || '‚Äî'}</span>
                <span class="value-text sqa-answer" title="${a}">${a || '‚Äî'}</span>
                <div class="value-actions">
                  <button class="btn-icon btn-edit" onclick="(window.editValue||window.__fb_editValue)('${module}','${fieldKey}',${idx})">Edit</button>
                  <button class="btn-icon btn-delete" onclick="(window.deleteValue||window.__fb_deleteValue)('${module}','${fieldKey}',${idx})">Delete</button>
                </div>`;
            } else {
              row.innerHTML = `
                <span class="value-text">${escapeHtml(v)}</span>
                <div class="value-actions">
                  <button class="btn-icon btn-edit" onclick="(window.editValue||window.__fb_editValue)('${module}','${fieldKey}',${idx})">Edit</button>
                  <button class="btn-icon btn-delete" onclick="(window.deleteValue||window.__fb_deleteValue)('${module}','${fieldKey}',${idx})">Delete</button>
                </div>`;
            }
            valuesContainer.appendChild(row);
          });
        }
        card.appendChild(valuesContainer);
        // Add form
        const addForm = document.createElement('div');
        if (fieldKey === 'SQA') {
          addForm.className = 'add-form sqa-add';
          addForm.innerHTML = `
            <input type="text" class="add-input sqa-input-question" id="add_${module}_${fieldKey}_question" placeholder="Security question" onkeypress="if(event.key==='Enter')(window.addValue||window.__fb_addValue)('${module}','${fieldKey}')">
            <input type="text" class="add-input sqa-input-answer" id="add_${module}_${fieldKey}_answer" placeholder="Answer (optional)" onkeypress="if(event.key==='Enter')(window.addValue||window.__fb_addValue)('${module}','${fieldKey}')">
            <button class="btn-add" onclick="(window.addValue||window.__fb_addValue)('${module}','${fieldKey}')">Add</button>`;
        } else {
          addForm.className = 'add-form';
          addForm.innerHTML = `
            <input type="text" class="add-input" id="add_${module}_${fieldKey}" placeholder="Add new ${label.toLowerCase()}" onkeypress="if(event.key==='Enter')(window.addValue||window.__fb_addValue)('${module}','${fieldKey}')">
            <button class="btn-add" onclick="(window.addValue||window.__fb_addValue)('${module}','${fieldKey}')">Add</button>`;
        }
        card.appendChild(addForm);
        return card;
      }
      // Fallback add/edit/delete if main ones are missing
      if (typeof window.editValue !== 'function') {
        window.__fb_editValue = function(module, fieldKey, index){
          const arr = ((window.masterData||{})[module]||{})[fieldKey]||[];
          const curr = arr[index] || '';
          let val = '';
          if (fieldKey === 'SQA') {
            const parsed = (window.parseSqaValue||defaultParseSqaValue)(curr);
            const question = prompt('Edit security question', parsed.question||'');
            if (question === null) return;
            const trimmedQuestion = String(question).trim();
            if (!trimmedQuestion) { alert('Question cannot be empty'); return; }
            const answer = prompt('Edit answer (optional)', parsed.answer||'');
            if (answer === null) return;
            val = formatSqaValue(trimmedQuestion, String(answer).trim());
          } else {
            const nv = prompt('Edit value', curr);
            if (nv===null) return; val = String(nv).trim(); if (!val) return;
          }
          if (arr.includes(val) && arr[index] !== val) { alert('This value already exists'); return; }
          arr[index] = val; arr.sort();
          if (!window.masterData[module]) window.masterData[module] = {};
          window.masterData[module][fieldKey] = arr;
          saveMasterData();
          window.renderTab((document.querySelector('.tab.active')||{getAttribute:()=>module}).getAttribute('data-tab')||module);
        };
      }
      if (typeof window.deleteValue !== 'function') {
        window.__fb_deleteValue = function(module, fieldKey, index){
          if (!confirm('Delete this value?')) return;
          const arr = ((window.masterData||{})[module]||{})[fieldKey]||[];
          arr.splice(index,1);
          if (!window.masterData[module]) window.masterData[module] = {};
          window.masterData[module][fieldKey] = arr;
          saveMasterData();
          window.renderTab((document.querySelector('.tab.active')||{getAttribute:()=>module}).getAttribute('data-tab')||module);
        };
      }
      if (typeof window.addValue !== 'function') {
        window.__fb_addValue = function(module, fieldKey){
          let v = '';
          if (fieldKey === 'SQA') {
            const questionInput = document.getElementById(`add_${module}_${fieldKey}_question`);
            const answerInput = document.getElementById(`add_${module}_${fieldKey}_answer`);
            const question = qInput ? qInput.value.trim() : '';
            const answer = aInput ? aInput.value.trim() : '';
            if (!question) { alert('Please enter a security question'); return; }
            v = formatSqaValue(question, answer);
          } else {
            const input = document.getElementById(`add_${module}_${fieldKey}`);
            if (!input) return; v = String(input.value||'').trim(); if (!v) { alert('Please enter a value'); return; }
          }
          if (!window.masterData[module]) window.masterData[module] = {};
          if (!Array.isArray(window.masterData[module][fieldKey])) window.masterData[module][fieldKey] = [];
          if (window.masterData[module][fieldKey].includes(v)) { alert('This value already exists'); return; }
          window.masterData[module][fieldKey].push(v);
          window.masterData[module][fieldKey].sort();
          saveMasterData();
          window.renderTab((document.querySelector('.tab.active')||{getAttribute:()=>module}).getAttribute('data-tab')||module);
          if (fieldKey === 'SQA') {
            const qInput = document.getElementById(`add_${module}_${fieldKey}_question`);
            const aInput = document.getElementById(`add_${module}_${fieldKey}_answer`);
            if (qInput) qInput.value='';
            if (aInput) aInput.value='';
          } else {
            const input = document.getElementById(`add_${module}_${fieldKey}`);
            if (input) input.value='';
          }
        };
      }
      window.renderTab = function(module){
        console.log('[Fallback renderTab] module=', module);
        const container = document.getElementById(`${module}Grid`);
        if (!container) return;
        container.innerHTML = '';
        const fields = FB_STRUCTURE[module] || {};
        console.log('[Fallback renderTab] fields=', Object.keys(fields));
        const keys = Object.keys(fields);
        const mid = Math.ceil(keys.length/2);
        const left = document.createElement('div');
        keys.slice(0,mid).forEach(k => left.appendChild(createFieldCard(module,k,fields[k])));
        const right = document.createElement('div');
        keys.slice(mid).forEach(k => right.appendChild(createFieldCard(module,k,fields[k])));
        container.appendChild(left);
        container.appendChild(right);
      };
      window.switchTab = function(tab){
        console.log('[Fallback switchTab] to', tab);
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const t = document.querySelector(`[data-tab="${tab}"]`);
        if (t) t.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const content = document.getElementById(`${tab}Content`);
        if (content) content.classList.add('active');
        window.renderTab(tab);
      };
      // Define updateLastFileDisplay early so it can be called from file handlers
      window.updateLastFileDisplay = function() {
        const lastExcelFile = localStorage.getItem('last_excel_file_loaded') || '';
        const lastExcelSource = localStorage.getItem('last_excel_file_source') || '';
        const lastExcelFolderPath = localStorage.getItem('last_excel_folder_path') || window.lastExcelFolderPath || '';
        const filePathDisplay = document.getElementById('filePathDisplay');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        
        if (!filePathDisplay || !fileNameDisplay) {
          // Elements not ready yet, retry after a short delay
          setTimeout(function() { window.updateLastFileDisplay(); }, 100);
          return;
        }
        
        if (lastExcelFile) {
          // Display folder path if available and valid (not fake path)
          if (lastExcelFolderPath && 
              !lastExcelFolderPath.toLowerCase().includes('fakepath') && 
              lastExcelFolderPath.trim() !== 'C:\\fakepath' &&
              lastExcelFolderPath.trim() !== 'c:\\fakepath') {
            filePathDisplay.innerHTML = `<span style="color:#64748b;">üìÅ</span> <span style="color:#1e293b;font-weight:500;">${lastExcelFolderPath}</span>`;
          } else {
            // Clear invalid fake path from storage
            if (lastExcelFolderPath && lastExcelFolderPath.toLowerCase().includes('fakepath')) {
              window.lastExcelFolderPath = '';
              localStorage.removeItem('last_excel_folder_path');
            }
            filePathDisplay.innerHTML = `<span style="color:#64748b;">üìÅ</span> <span style="color:#64748b;font-style:italic;">Folder path not available</span>`;
          }
          
          // Display file name on right - same style as file path
          const icon = lastExcelSource === 'Google Drive' ? '‚òÅÔ∏è' : 'üìÑ';
          let sourceLabel = lastExcelSource === 'D:' ? 'Local Drive D:' : lastExcelSource;
          if (lastExcelSource === 'Google Drive') sourceLabel = 'Google Drive';
          fileNameDisplay.innerHTML = `<span style="color:#64748b;">${icon}</span> <span style="color:#1e293b;font-weight:500;">${lastExcelFile}</span> <span style="color:#64748b;font-weight:400;font-size:0.85rem;">(${sourceLabel || 'Unknown source'})</span>`;
        } else {
          filePathDisplay.innerHTML = '<span style="color:#64748b;">‚ö†Ô∏è No file loaded</span>';
          fileNameDisplay.innerHTML = '<span style="color:#64748b;">‚ö†Ô∏è No Excel file loaded yet</span>';
        }
      };
      
      // If we already have data, render immediately
      try{
        const data = JSON.parse(localStorage.getItem('unified_master_data')||'null');
        if (data){ window.masterData = data; normalizeSqaValues(window.masterData); initializeMasterData(); saveMasterData(); }
      }catch(_){ }
      // Render all tabs once then default to task
      ['task','expense','income','investment','common','trading-accounts'].forEach(m => window.renderTab(m));
      window.switchTab('task');
      // Update file display on load
      setTimeout(function() { window.updateLastFileDisplay(); }, 200);
    })();

    // Robust tab click delegation to ensure switching works even if other listeners fail
    (function robustTabDelegation(){
      function onClick(e){
        const t = e.target && e.target.closest && e.target.closest('.tab');
        if (!t) return;
        const tab = t.getAttribute('data-tab');
        if (!tab) return;
        e.preventDefault();
        e.stopPropagation();
        if (typeof window.switchTab === 'function') {
          console.log('[Delegation] switching to', tab);
          window.switchTab(tab);
        }
      }
      document.addEventListener('click', onClick);
    })();

    // Early Clear All fallback
    (function earlyClearAll(){
      const btn = document.getElementById('btnClearData');
      if (!btn) return;
      if (btn.__earlyBound) return; // avoid duplicate
      btn.__earlyBound = true;
      btn.addEventListener('click', function(){
        try{
          if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL master data!\n\nAre you sure you want to proceed?')) return;
          if (!confirm('‚ö†Ô∏è FINAL WARNING: This action cannot be undone!\n\nAll master data for Income, Expense, Investment, Task, and Common fields will be permanently deleted.\n\nClick OK to confirm deletion.')) return;
          localStorage.removeItem('unified_master_data');
          ['task_master_data','expense_master_data','income_master_data','investment_master_data','trading_accounts_master_data','properties_master_data','tenants_master_data'].forEach(k=>localStorage.removeItem(k));
          window.masterData = { task:{}, expense:{}, income:{}, investment:{}, common:{}, 'trading-accounts':{} };
          if (typeof initializeMasterData==='function') initializeMasterData();
          if (typeof saveMasterData==='function') saveMasterData();
          ['income','expense','investment','task','common','trading-accounts'].forEach(m=>{ if (typeof renderTab==='function') renderTab(m); });
          window.switchTab && window.switchTab('task');
          alert('All master data cleared.');
        }catch(err){
          console.error('Early clear error:', err);
          alert('Error clearing data: '+err.message);
        }
      });
    })();
  </script>
  
  <script src="assets/xlsx.full.min.js" 
          onerror="console.error('Failed to load local XLSX library')"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="10_Global_Master_Data_Export.js"></script>
  <script>
    console.log('=== Main script started ===');
    // (Reverted) No inline onchange handler; main listener will process
    // Master data structure - only fields specified by user
    // Sheets with prefix Income_, Investment_, Expense_, Task_ belong to those modules
    // Sheets without these prefixes are common fields (Currency, Frequency, Ac_Holder, Mode, Txn_Status, Ac_Status)
    // Sheets with prefix Txn_ are transactional data (not master data)
    const MASTER_DATA_STRUCTURE = {
      expense: {
        'Expanse_Category': 'Expense Category',
        'Expanse_Ac_Tag': 'Expense Account Tag'
      },
      income: {
        'Income_Category': 'Income Category',
        'Income_Ac_Tag': 'Income Account Tag' // Relates to "Paid From" in Expense and Investment Dashboards
      },
      investment: {
        'Investment_Category': 'Investment Category',
        'Investment_Ac_Tag': 'Investment Account Tag'
      },
      task: {
        'Task_Status': 'Task Status',
        'Task_Assignee': 'Task Assignee',
        'Task_Priority': 'Task Priority',
        'Task_Category': 'Task Category',
        'Task_Adhoc': 'Task Adhoc'
      },
      common: {
        'Currency': 'Currency',
        'Mode': 'Mode',
        'Status_Txn': 'Transaction Status',
        'Ac_Holder': 'Account Holder',
        'Frequency': 'Frequency',
        'Ac_Status': 'Account Status',
        'Ac_Classification': 'Account Classification',
        'Country': 'Country',
        'Institution': 'Institution',
        'Ac_Type': 'Account Type',
        'Email': 'Email Addresses',
        'Phone': 'Phone Numbers',
        'SQA': 'Security Questions & Answers'
      },
      'trading-accounts': {
        // Fields will be added later from Excel
      }
    };

    // Mapping: Excel sheet name variations to unified field keys
    const SHEET_NAME_MAP = {
      // Expense variations ‚Üí expense fields
      'Expanse_Category': { module: 'expense', key: 'Expanse_Category' },
      'Expense_Category': { module: 'expense', key: 'Expanse_Category' }, // Map to Expanse_Category
      'Expanse_Ac_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' },
      'Expense_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' }, // Map to Expanse_Ac_Tag
      'Expense_Ac_Tag': { module: 'expense', key: 'Expanse_Ac_Tag' },
      
      // Income variations ‚Üí income fields
      'Income_Category': { module: 'income', key: 'Income_Category' },
      'Income_Ac_Tag': { module: 'income', key: 'Income_Ac_Tag' },
      'Income_Tag': { module: 'income', key: 'Income_Ac_Tag' }, // Map to Income_Ac_Tag
      
      // Investment variations ‚Üí investment fields
      'Investment_Category': { module: 'investment', key: 'Investment_Category' },
      'Investment_Ac_Tag': { module: 'investment', key: 'Investment_Ac_Tag' },
      'Investment_Tag': { module: 'investment', key: 'Investment_Ac_Tag' }, // Map to Investment_Ac_Tag
      
      // Task fields
      'Task_Category': { module: 'task', key: 'Task_Category' },
      'Task_Tag': { module: 'common', key: 'Country' },  // Map to Country in common
      'Task_Status': { module: 'task', key: 'Task_Status' },
      'Task_Assignee': { module: 'task', key: 'Task_Assignee' },
      'Task_Priority': { module: 'task', key: 'Task_Priority' },
      'Task_Adhoc': { module: 'task', key: 'Task_Adhoc' },
      'Country': { module: 'common', key: 'Country' },  // Direct Country mapping
      
      // Common fields (no prefix)
      'Currency': { module: 'common', key: 'Currency' },
      'Frequency': { module: 'common', key: 'Frequency' },
      'Ac_Holder': { module: 'common', key: 'Ac_Holder' },
      'Expense_Holder': { module: 'common', key: 'Ac_Holder' }, // Map variations to Ac_Holder
      'Income_Holder': { module: 'common', key: 'Ac_Holder' },
      'Investment_Holder': { module: 'common', key: 'Ac_Holder' },
      'Mode_Txn': { module: 'common', key: 'Mode' },
      'Txn_Mode': { module: 'common', key: 'Mode' }, // Normalize to Mode
      'Mode': { module: 'common', key: 'Mode' },
      'Expense_Mode': { module: 'common', key: 'Mode' }, // Map variations to Mode
      'Income_Mode': { module: 'common', key: 'Mode' },
      'Investment_Mode': { module: 'common', key: 'Mode' },
      'Status_Txn': { module: 'common', key: 'Status_Txn' },
      'Txn_Status': { module: 'common', key: 'Status_Txn' }, // Map old name to new
      'Expense_Txn_Status': { module: 'common', key: 'Status_Txn' }, // Map variations to Status_Txn
      'Income_Txn_Status': { module: 'common', key: 'Status_Txn' },
      'Investment_Txn_Status': { module: 'common', key: 'Status_Txn' },
      'Ac_Status': { module: 'common', key: 'Ac_Status' },
      'Expense_Account_Status': { module: 'common', key: 'Ac_Status' }, // Map variations to Ac_Status
      'Income_Account_Status': { module: 'common', key: 'Ac_Status' },
      'Investment_Account_Status': { module: 'common', key: 'Ac_Status' },
      'Institution': { module: 'common', key: 'Institution' },
      'Ac_Type': { module: 'common', key: 'Ac_Type' },
      'Email': { module: 'common', key: 'Email' },
      'Phone': { module: 'common', key: 'Phone' },
      'SQA': { module: 'common', key: 'SQA' }
    };

    // Unified master data container
    let masterData = {};
    let currentEdit = null;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        switchTab(targetTab);
      });
    });

    function switchTab(tabName) {
      // Update active tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      // Update active content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`${tabName}Content`).classList.add('active');

      // If property-tenancy tab is activated, show the first sub-tab
      if (tabName === 'property-tenancy') {
        switchPropertyTenancySubTab('property');
      }

      // Render the tab content (or load paths for paths tab, or skip for property-tenancy)
      if (tabName === 'paths') {
        loadPaths();
      } else if (tabName === 'property-tenancy') {
        // Property-tenancy tab uses modals, not grid rendering - skip renderTab
        console.log('[Delegation] switching to property-tenancy');
      } else {
        renderTab(tabName);
      }
    }

    // Switch Property-Tenancy sub-tabs
    function switchPropertyTenancySubTab(subTabName) {
      // Update active sub-tab
      document.querySelectorAll('.property-tenancy-subtab').forEach(t => t.classList.remove('active'));
      const subTab = document.querySelector(`.property-tenancy-subtab[data-subtab="${subTabName}"]`);
      if (subTab) {
        subTab.classList.add('active');
      }

      // Update active sub-content
      document.querySelectorAll('.property-tenancy-subcontent').forEach(c => c.classList.remove('active'));
      const subContent = document.getElementById(`${subTabName}SubContent`);
      if (subContent) {
        subContent.classList.add('active');
      }
    }

    // Load master data from localStorage
    function loadMasterData() {
      const saved = localStorage.getItem('unified_master_data');
      if (saved) {
        masterData = JSON.parse(saved);
        // Migration: normalize common.Mode_Txn -> common.Mode
        if (masterData.common) {
          const legacy = masterData.common['Mode_Txn'];
          if (legacy && Array.isArray(legacy)) {
            if (!Array.isArray(masterData.common['Mode'])) masterData.common['Mode'] = [];
            const merged = [...masterData.common['Mode'], ...legacy].filter((v, i, a) => v && a.indexOf(v) === i).sort();
            masterData.common['Mode'] = merged;
            delete masterData.common['Mode_Txn'];
          }
        }
      } else {
        // Try to load from legacy format and convert
        masterData = {
          task: JSON.parse(localStorage.getItem('task_master_data') || '{}'),
          expense: JSON.parse(localStorage.getItem('expense_master_data') || '{}'),
          income: JSON.parse(localStorage.getItem('income_master_data') || '{}'),
          investment: JSON.parse(localStorage.getItem('investment_master_data') || '{}'),
          common: {},
          'trading-accounts': JSON.parse(localStorage.getItem('trading_accounts_master_data') || '{}'),
        };
        saveMasterData();
      }
      initializeMasterData();
      renderTab('task'); // Render default tab
    }

    // Save master data to localStorage
    function saveMasterData() {
      localStorage.setItem('unified_master_data', JSON.stringify(masterData));
      // Also save to module-specific keys for backwards compatibility
      localStorage.setItem('task_master_data', JSON.stringify(masterData.task || {}));
      localStorage.setItem('expense_master_data', JSON.stringify(masterData.expense || {}));
      localStorage.setItem('income_master_data', JSON.stringify(masterData.income || {}));
      localStorage.setItem('investment_master_data', JSON.stringify(masterData.investment || {}));
      localStorage.setItem('trading_accounts_master_data', JSON.stringify(masterData['trading-accounts'] || {}));
      
      // Also update masterDataCache with Property, Tenant, and Manager data (flat keys)
      try {
        let masterDataCache = {};
        const cached = localStorage.getItem("masterDataCache");
        if (cached) {
          try {
            masterDataCache = JSON.parse(cached) || {};
          } catch (e) {
            masterDataCache = {};
          }
        }
        
        // Merge Property, Tenant, and Manager data from masterData into masterDataCache
        Object.keys(masterData).forEach(key => {
          if (key.startsWith('Property_') || key.startsWith('Landlord_') || 
              key.startsWith('Tenant_') || 
              key === 'Manager_Name' || key === 'Manager_Phone' || 
              key === 'Superintendent_Name' || key === 'Superintendent_Phone') {
            masterDataCache[key] = masterData[key];
          }
        });
        
        localStorage.setItem("masterDataCache", JSON.stringify(masterDataCache));
      } catch (e) {
        console.error("Error updating masterDataCache in saveMasterData:", e);
      }
    }

    // NEW PATH MANAGEMENT SYSTEM
    // Load all paths from localStorage
    function loadPaths() {
      const masterDataFile = localStorage.getItem('project_master_data_file') || '';
      const masterDataFolder = localStorage.getItem('project_master_data_folder') || '';
      const backupPath = localStorage.getItem('project_backup_path') || '';
      const documentsPath = localStorage.getItem('project_documents_path') || '';
      const downloadsPath = localStorage.getItem('project_downloads_path') || '';
      
      // Update displays
      const masterDataFileDisplay = document.getElementById('masterDataFileDisplay');
      const backupPathDisplay = document.getElementById('backupPathDisplay');
      const documentsPathDisplay = document.getElementById('documentsPathDisplay');
      const downloadsPathDisplay = document.getElementById('downloadsPathDisplay');
      
      if (masterDataFileDisplay) {
        masterDataFileDisplay.textContent = masterDataFile || 'Not set';
      }
      if (backupPathDisplay) {
        backupPathDisplay.textContent = backupPath || 'Not set';
      }
      if (documentsPathDisplay) {
        documentsPathDisplay.textContent = documentsPath || 'Not set';
      }
      if (downloadsPathDisplay) {
        downloadsPathDisplay.textContent = downloadsPath || 'Not set';
      }
      
      // Update input fields
      const masterDataFileInput = document.getElementById('masterDataFileInput');
      const backupPathInput = document.getElementById('backupPathInput');
      const documentsPathInput = document.getElementById('documentsPathInput');
      const downloadsPathInput = document.getElementById('downloadsPathInput');
      
      if (masterDataFileInput) masterDataFileInput.value = masterDataFile;
      if (backupPathInput) backupPathInput.value = backupPath;
      if (documentsPathInput) documentsPathInput.value = documentsPath;
      if (downloadsPathInput) downloadsPathInput.value = downloadsPath;
    }

    // Save path function
    function savePath(type, path) {
      const storageKeys = {
        'master-data-file': 'project_master_data_file',
        'master-data-folder': 'project_master_data_folder',
        'backup': 'project_backup_path',
        'documents': 'project_documents_path',
        'downloads': 'project_downloads_path'
      };
      
      const displayIds = {
        'master-data-file': 'masterDataFileDisplay',
        'master-data-folder': 'masterDataFileDisplay', // Same display for file
        'backup': 'backupPathDisplay',
        'documents': 'documentsPathDisplay',
        'downloads': 'downloadsPathDisplay'
      };
      
      const inputIds = {
        'master-data-file': 'masterDataFileInput',
        'master-data-folder': 'masterDataFileInput',
        'backup': 'backupPathInput',
        'documents': 'documentsPathInput',
        'downloads': 'downloadsPathInput'
      };
      
      if (storageKeys[type]) {
        localStorage.setItem(storageKeys[type], path);
        const displayEl = document.getElementById(displayIds[type]);
        const inputEl = document.getElementById(inputIds[type]);
        if (displayEl) displayEl.textContent = path;
        if (inputEl) inputEl.value = path;
        return true;
      }
      return false;
    }

    // Function to update Manage Master Data tooltip (can be called from index.html)
    window.updateManageMasterDataTooltip = function() {
      const lastExcelFile = localStorage.getItem('last_excel_file_loaded') || '';
      const lastExcelSource = localStorage.getItem('last_excel_file_source') || '';
      // This will be called from index.html to update its tooltip
    };

    // Clear all paths
    function clearAllPaths() {
      localStorage.removeItem('project_master_data_file');
      localStorage.removeItem('project_master_data_folder');
      localStorage.removeItem('project_backup_path');
      localStorage.removeItem('project_documents_path');
      localStorage.removeItem('project_downloads_path');
      loadPaths();
    }

    // Check if paths are set
    function arePathsSet() {
      const backupPath = localStorage.getItem('project_backup_path');
      const documentsPath = localStorage.getItem('project_documents_path');
      const downloadsPath = localStorage.getItem('project_downloads_path');
      return !!(backupPath && documentsPath && downloadsPath);
    }

    // Initialize master data structure
    function initializeMasterData() {
      ['task', 'expense', 'income', 'investment', 'common', 'trading-accounts', 'properties', 'tenants'].forEach(module => {
        if (!masterData[module]) {
          masterData[module] = {};
        }
        if (MASTER_DATA_STRUCTURE[module]) {
          Object.keys(MASTER_DATA_STRUCTURE[module]).forEach(key => {
            // Only initialize if it doesn't exist or is not an array - preserve existing data
            if (!masterData[module][key] || !Array.isArray(masterData[module][key])) {
              masterData[module][key] = [];
            }
          });
        }
      });
      console.log('Master data initialized:', masterData);
    }

    // Render a tab
    function renderTab(module) {
      const container = document.getElementById(`${module}Grid`);
      
      // Skip rendering if container doesn't exist (e.g., property-tenancy, paths tabs)
      if (!container) {
        console.log(`[RenderTab] Skipping render for module "${module}" - no grid container found`);
        return;
      }
      
      container.innerHTML = '';

      // Check if module exists in structure
      if (!MASTER_DATA_STRUCTURE[module]) {
        console.warn(`[RenderTab] No structure defined for module "${module}"`);
        return;
      }

      const fields = MASTER_DATA_STRUCTURE[module];
      const fieldKeys = Object.keys(fields);
      
      // Only show module-specific fields - NO common fields in module tabs
      // Common fields are only shown in the Common tab
      
      // Split fields into two columns
      const midPoint = Math.ceil(fieldKeys.length / 2);
      const leftFields = fieldKeys.slice(0, midPoint);
      const rightFields = fieldKeys.slice(midPoint);

      // Create left column
      const leftCol = document.createElement('div');
      leftFields.forEach(fieldKey => {
        const displayLabel = fields[fieldKey];
        leftCol.appendChild(createFieldCard(module, fieldKey, displayLabel, false));
      });
      container.appendChild(leftCol);

      // Create right column
      const rightCol = document.createElement('div');
      rightFields.forEach(fieldKey => {
        const displayLabel = fields[fieldKey];
        rightCol.appendChild(createFieldCard(module, fieldKey, displayLabel, false));
      });
      container.appendChild(rightCol);
    }

    // Create a field card
    function createFieldCard(module, fieldKey, fieldLabel, isCommonField = false) {
      const card = document.createElement('div');
      card.className = 'field-card';

      const header = document.createElement('div');
      header.className = 'field-header';
      // Get values - if this is a common field being accessed from a module tab
      // Task module does NOT show Status_Txn and Mode
      let values = [];
      if (isCommonField) {
        // Access common field (but exclude Status_Txn and Mode from task module)
        if (module === 'task' && (fieldKey === 'Status_Txn' || fieldKey === 'Mode')) {
          values = [];
        } else {
          values = masterData.common && masterData.common[fieldKey] ? masterData.common[fieldKey] : [];
        }
      } else {
        values = masterData[module] && masterData[module][fieldKey] ? masterData[module][fieldKey] : [];
      }
      // Format: Actual Field Name (count) <--> Mapped Field Name
      const actualFieldName = fieldKey; // Excel sheet name (e.g., Expanse_Category)
      let mappedFieldName = fieldLabel.replace(' ‚Üî', ''); // Display name (e.g., Expense Category)
      
      // Special case: Country field should show alternative names
      if (fieldKey === 'Country') {
        mappedFieldName += ', Task_Tag';
      }
      
      header.innerHTML = `
        <span class="field-name">${actualFieldName} (${values.length}) <--> ${mappedFieldName}</span>
      `;
      card.appendChild(header);

      const valuesContainer = document.createElement('div');
      valuesContainer.className = 'values-container';

      if (values.length === 0) {
        valuesContainer.innerHTML = '<div class="empty-field">No entries yet</div>';
      } else {
          values.forEach((value, index) => {
          const row = document.createElement('div');
          const isSqaField = fieldKey === 'SQA';
          row.className = isSqaField ? 'value-row sqa-row' : 'value-row';
          // Determine save module/key for common fields viewed from module tabs
          let saveModule = module;
          let saveKey = fieldKey;
          if (isCommonField || (module !== 'common' && MASTER_DATA_STRUCTURE.common[fieldKey])) {
            saveModule = 'common';
            saveKey = fieldKey;
          }
          if (isSqaField) {
            const parsed = parseSqaValue(value);
            const question = escapeHtml(parsed.question || '');
            const answer = escapeHtml(parsed.answer || '');
            row.innerHTML = `
              <span class="value-text sqa-question" title="${question}">${question || '‚Äî'}</span>
              <span class="value-text sqa-answer" title="${answer}">${answer || '‚Äî'}</span>
              <div class="value-actions">
                <button class="btn-icon btn-edit" onclick="editValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Edit</button>
                <button class="btn-icon btn-delete" onclick="deleteValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Delete</button>
              </div>
            `;
          } else {
            row.innerHTML = `
              <span class="value-text">${escapeHtml(value)}</span>
              <div class="value-actions">
                <button class="btn-icon btn-edit" onclick="editValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Edit</button>
                <button class="btn-icon btn-delete" onclick="deleteValue('${saveModule}', '${saveKey}', ${index}, '${module}')">Delete</button>
              </div>
            `;
          }
          valuesContainer.appendChild(row);
        });
      }
      card.appendChild(valuesContainer);

      const addForm = document.createElement('div');
      addForm.className = 'add-form';
      // Determine which module to save to for common fields
      let saveModule = module;
      let saveKey = fieldKey;
      if (isCommonField || (module !== 'common' && MASTER_DATA_STRUCTURE.common[fieldKey])) {
        saveModule = 'common';
        saveKey = fieldKey;
      }
      if (fieldKey === 'SQA') {
        addForm.classList.add('sqa-add');
        addForm.innerHTML = `
          <input type="text" class="add-input sqa-input-question" id="add_${module}_${fieldKey}_question" placeholder="Security question" onkeypress="if(event.key==='Enter') addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">
          <input type="text" class="add-input sqa-input-answer" id="add_${module}_${fieldKey}_answer" placeholder="Answer (optional)" onkeypress="if(event.key==='Enter') addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">
          <button class="btn-add" onclick="addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">Add</button>
        `;
      } else {
        addForm.innerHTML = `
          <input type="text" class="add-input" id="add_${module}_${fieldKey}" placeholder="Add new ${fieldLabel.toLowerCase()}" onkeypress="if(event.key==='Enter') addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">
          <button class="btn-add" onclick="addValue('${saveModule}', '${saveKey}', '${module}', '${fieldKey}')">Add</button>
        `;
      }
      card.appendChild(addForm);

      return card;
    }

    // Add value
    function extractSqaQuestion(row){
      const keys = ['Security Question','Security Questions','Security Question(s)','Question','Questions','Security_Q'];
      return extractColumnValue(row, keys, true);
    }
    function extractSqaAnswer(row){
      const keys = ['Security Answer','Security Answers','Security Answer(s)','Answer','Answers','Security_A'];
      return extractColumnValue(row, keys, false);
    }
    function extractColumnValue(row, keyCandidates, fallbackToFirst){
      if (!row) return '';
      const lowerMap = {};
      Object.keys(row).forEach(k=>{
        lowerMap[k.toLowerCase().trim()] = row[k];
      });
      for (const candidate of keyCandidates){
        const val = lowerMap[candidate.toLowerCase().trim()];
        if (val !== undefined && val !== null && String(val).trim() !== '') {
          return String(val).trim();
        }
      }
      if (fallbackToFirst) {
        const firstNonEmpty = Object.values(row).find(v=>String(v||'').trim()!== '');
        return firstNonEmpty ? String(firstNonEmpty).trim() : '';
      }
      return '';
    }
    function normalizeSqaValues(data){
      if (!data || !data.common) return;
      let entries = data.common.SQA;
      if (!entries) return;
      if (Array.isArray(entries)) {
        // use as-is
      } else if (typeof entries === 'object') {
        entries = Object.values(entries);
      } else {
        entries = [entries];
      }
      const normalized = [];
      entries.forEach(item => {
        const parsed = parseSqaValue(item);
        let question = (parsed.question || '').trim();
        let answer = (parsed.answer || '').trim();
        if (!question && answer) {
          question = answer;
          answer = '';
        }
        const formatted = formatSqaValue(question, answer);
        if (formatted) normalized.push(formatted);
      });
      data.common.SQA = Array.from(new Set(normalized));
    }
    const SQA_SEPARATOR = ' ‚Äî ';
    function parseSqaValue(rawValue) {
      const text = String(rawValue || '').trim();
      if (!text) return { question: '', answer: '' };
      const separatorIndex = text.indexOf('‚Äî');
      if (separatorIndex === -1) {
        return { question: text, answer: '' };
      }
      const question = text.slice(0, separatorIndex).trim();
      const answer = text.slice(separatorIndex + 1).replace(/^[\\s‚Äî-]+/, '').trim();
      return { question, answer };
    }
    function defaultParseSqaValue(rawValue){
      return parseSqaValue(rawValue);
    }

    function formatSqaValue(question, answer) {
      const q = String(question || '').trim();
      const a = String(answer || '').trim();
      if (!q && !a) return '';
      return a ? `${q}${SQA_SEPARATOR}${a}` : q;
    }

    function addValue(saveModule, saveKey, displayModule, displayKey) {
      // displayModule and displayKey are for the input element ID when viewing common fields from module tabs
      let value = '';
      let questionInput, answerInput;
      if (saveKey === 'SQA') {
        const questionInputId = displayModule ? `add_${displayModule}_${displayKey}_question` : `add_${saveModule}_${saveKey}_question`;
        const answerInputId = displayModule ? `add_${displayModule}_${displayKey}_answer` : `add_${saveModule}_${saveKey}_answer`;
        questionInput = document.getElementById(questionInputId);
        answerInput = document.getElementById(answerInputId);
        const question = questionInput ? questionInput.value.trim() : '';
        const answer = answerInput ? answerInput.value.trim() : '';
        if (!question) {
          alert('Please enter a security question');
          return;
        }
        value = formatSqaValue(question, answer);
      } else {
        const inputId = displayModule ? `add_${displayModule}_${displayKey}` : `add_${saveModule}_${saveKey}`;
        const input = document.getElementById(inputId);
        value = input.value.trim();
        if (!value) {
          alert('Please enter a value');
          return;
        }
      }
      if (!masterData[saveModule]) masterData[saveModule] = {};
      if (!masterData[saveModule][saveKey]) masterData[saveModule][saveKey] = [];
      if (masterData[saveModule][saveKey].includes(value)) {
        alert('This value already exists');
        return;
      }
      masterData[saveModule][saveKey].push(value);
      masterData[saveModule][saveKey].sort();
      saveMasterData();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
      if (saveKey === 'SQA') {
        if (questionInput) questionInput.value = '';
        if (answerInput) answerInput.value = '';
      } else {
        const inputId = displayModule ? `add_${displayModule}_${displayKey}` : `add_${saveModule}_${saveKey}`;
        const input = document.getElementById(inputId);
        if (input) input.value = '';
      }
    }

    // Edit value
    function editValue(module, fieldKey, index, displayModule) {
      currentEdit = { module, fieldKey, index, displayModule: displayModule || module };
      const value = masterData[module][fieldKey][index];
      const editInput = document.getElementById('editInput');
      const sqaGroup = document.getElementById('editSqaGroup');
      const questionInput = document.getElementById('editQuestionInput');
      const answerInput = document.getElementById('editAnswerInput');
      if (fieldKey === 'SQA') {
        const parsed = parseSqaValue(value);
        editInput.style.display = 'none';
        sqaGroup.style.display = 'flex';
        questionInput.value = parsed.question || '';
        answerInput.value = parsed.answer || '';
      } else {
        editInput.style.display = 'block';
        sqaGroup.style.display = 'none';
        editInput.value = value;
      }
      // Get the display label
      let displayLabel = '';
      if (module === 'common') {
        displayLabel = MASTER_DATA_STRUCTURE.common[fieldKey] || fieldKey;
      } else {
        displayLabel = MASTER_DATA_STRUCTURE[module][fieldKey] || fieldKey;
      }
      document.getElementById('modalTitle').textContent = `Edit ${displayLabel}`;
      document.getElementById('editModal').classList.add('show');
    }

    // Save edited value
    function saveEditedValue() {
      if (!currentEdit) return;
      const { module, fieldKey, index, displayModule } = currentEdit;
      let newValue = '';
      if (fieldKey === 'SQA') {
        const question = document.getElementById('editQuestionInput').value.trim();
        const answer = document.getElementById('editAnswerInput').value.trim();
        if (!question) {
          alert('Please enter a security question');
          return;
        }
        newValue = formatSqaValue(question, answer);
      } else {
        const input = document.getElementById('editInput');
        newValue = input.value.trim();
        if (!newValue) {
          alert('Please enter a value');
          return;
        }
      }
      if (masterData[module][fieldKey].includes(newValue) && masterData[module][fieldKey][index] !== newValue) {
        alert('This value already exists');
        return;
      }
      masterData[module][fieldKey][index] = newValue;
      masterData[module][fieldKey].sort();
      saveMasterData();
      closeEditModal();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
    }

    // Delete value
    function deleteValue(module, fieldKey, index, displayModule) {
      if (!confirm('Are you sure you want to delete this value?')) return;
      masterData[module][fieldKey].splice(index, 1);
      saveMasterData();
      // Re-render the currently displayed tab
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderTab(currentTab);
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      const editInput = document.getElementById('editInput');
      const sqaGroup = document.getElementById('editSqaGroup');
      const questionInput = document.getElementById('editQuestionInput');
      const answerInput = document.getElementById('editAnswerInput');
      if (editInput) {
        editInput.style.display = 'block';
        editInput.value = '';
      }
      if (sqaGroup) {
        sqaGroup.style.display = 'none';
      }
      if (questionInput) questionInput.value = '';
      if (answerInput) answerInput.value = '';
      currentEdit = null;
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Excel import handler - set up when DOM is ready
    function setupExcelFileHandler() {
      const fileInput = document.getElementById('excelFileInput');
      if (!fileInput) {
        console.error('Excel file input not found in DOM');
        return;
      }
      
      fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
        if (!file) {
          console.log('No file selected');
          return;
        }
        
        // Check if early handler already processed this file
        if (window.excelProcessedByEarlyHandler && 
            window.excelProcessedFileName === file.name &&
            Date.now() - window.excelProcessedTimestamp < 5000) {
          console.log('File already processed by early handler, skipping main handler');
          e.target.value = ''; // Reset file input
          return;
        }
        
        console.log('File selected:', file.name, file.type, file.size);
        
        // Proceed to read selected Excel file
      const reader = new FileReader();
        
        reader.onerror = function(error) {
          console.error('FileReader error:', error);
          alert('Error reading file: ' + (error.target.error?.message || 'Unknown error'));
          e.target.value = ''; // Reset file input
        };
        
      reader.onload = function(e) {
        try {
          console.log('File read successfully, size:', e.target.result.byteLength);
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetNames = workbook.SheetNames;

          console.log('Available sheets:', sheetNames);

          // Initialize master data
          initializeMasterData();

          // Extract all master data sheets (exclude Txn_* transactional sheets, but include Mode_Txn and Status_Txn)
          const processedSheets = [];
          
          // FIRST: Handle Paths sheet if it exists
          if (sheetNames.includes('Paths')) {
            console.log('‚úì Processing Paths sheet');
            const pathsSheet = workbook.Sheets['Paths'];
            const pathsData = XLSX.utils.sheet_to_json(pathsSheet);
            
            pathsData.forEach(row => {
              const pathType = String(row['Path Type'] || '').trim();
              const path = String(row['Path'] || '').trim();
              
              if (pathType && path) {
                let storageKey = null;
                if (pathType === 'Master Data File') {
                  storageKey = 'project_master_data_file';
                } else if (pathType === 'Backup Path') {
                  storageKey = 'project_backup_path';
                } else if (pathType === 'Documents Path') {
                  storageKey = 'project_documents_path';
                } else if (pathType === 'Downloads Path') {
                  storageKey = 'project_downloads_path';
                }
                
                if (storageKey) {
                  localStorage.setItem(storageKey, path);
                  console.log(`‚úì Loaded path for ${pathType}: ${path}`);
                }
              }
            });
            
            processedSheets.push('Paths');
            loadPaths(); // Refresh UI display
          }
          
          sheetNames.forEach(sheetName => {
            // Skip transactional data sheets (Txn_Expense, Txn_Income, Txn_Investment, Txn_Task)
            if (sheetName.startsWith('Txn_') && !sheetName.includes('Mode') && !sheetName.includes('Status')) {
              console.log('‚úó Skipping transactional sheet:', sheetName);
              return;
            }
            
            if (sheetName === 'SQA') {
              console.log('‚úì Processing security questions sheet');
              const sheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(sheet);
              if (jsonData.length) {
                const entries = jsonData.map(row => {
                  const question = extractSqaQuestion(row);
                  const answer = extractSqaAnswer(row);
                  if (!question && !answer) return null;
                  return answer ? `${question} ‚Äî ${answer}` : question;
                }).filter(Boolean);
                if (!masterData.common.SQA || !Array.isArray(masterData.common.SQA)) {
                  masterData.common.SQA = [];
                }
                if (entries.length) {
                  masterData.common.SQA = Array.from(new Set([...(masterData.common.SQA || []), ...entries]));
                  console.log(`‚úì Loaded ${entries.length} security Q&A rows`);
                  processedSheets.push(sheetName);
                }
              }
              return;
            }
            
            // Handle Property sheet
            if (sheetName === 'Property') {
              console.log('‚úì Processing Property sheet');
              const sheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(sheet);
              
              if (jsonData.length > 0) {
                // Clear existing property data
                Object.keys(masterData).forEach(key => {
                  if (key.startsWith('Property_') || key.startsWith('Landlord_')) {
                    delete masterData[key];
                  }
                });
                
                // Load property data
                jsonData.forEach((row, index) => {
                  const propertyTag = String(row['Property_Tag'] || row['Property Tag'] || row['Tag'] || '').trim();
                  const propertyAddress = String(row['Property_Address'] || row['Property Address'] || row['Address'] || '').trim();
                  const landlordName = String(row['Landlord_Name'] || row['Landlord Name'] || row['Landlord'] || '').trim();
                  const landlordAddress = String(row['Landlord_Address'] || row['Landlord Address'] || '').trim();
                  const landlordPhone = String(row['Landlord_Phone'] || row['Landlord Phone'] || '').trim();
                  
                  if (propertyTag || propertyAddress || landlordName) {
                    const tagKey = propertyTag ? propertyTag.replace(/[^A-Za-z0-9]/g, '_') : `PROP_${index + 1}`;
                    masterData[`Property_${tagKey}`] = propertyAddress || propertyTag || "";
                    if (propertyAddress) masterData[`Property_${tagKey}_Address`] = propertyAddress;
                    if (propertyTag) masterData[`Property_${tagKey}_Tag`] = propertyTag;
                    if (landlordName) {
                      masterData[`Landlord_${tagKey}_Name`] = landlordName;
                      if (landlordAddress) masterData[`Landlord_${tagKey}_Address`] = landlordAddress;
                      if (landlordPhone) masterData[`Landlord_${tagKey}_Phone`] = landlordPhone;
                    }
                  }
                });
                
                console.log(`‚úì Loaded ${jsonData.length} properties`);
                processedSheets.push(sheetName);
              }
              return;
            }
            
            // Handle Tenant sheet
            if (sheetName === 'Tenant') {
              console.log('‚úì Processing Tenant sheet');
              const sheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(sheet);
              
              if (jsonData.length > 0) {
                // Clear ALL existing tenant data by finding all tenant IDs (support string and numeric IDs)
                const tenantIdsToDelete = new Set();
                Object.keys(masterData).forEach(key => {
                  const match = key.match(/^Tenant_(.+?)_/);
                  if (match) {
                    tenantIdsToDelete.add(match[1]);
                  }
                });
                
                tenantIdsToDelete.forEach(id => {
                  delete masterData[`Tenant_${id}_ID`];
                  delete masterData[`Tenant_${id}_Name`];
                  delete masterData[`Tenant_${id}_Email`];
                  delete masterData[`Tenant_${id}_Phone`];
                  delete masterData[`Tenant_${id}_Old_Address`];
                  delete masterData[`Tenant_${id}_Job_Desc`];
                  delete masterData[`Tenant_${id}_Job`];
                  delete masterData[`Tenant_${id}_Active`];
                  delete masterData[`Tenant_${id}_Current_Status`];
                });
                
                // Load tenant data - use Tenant_ID as unique identifier and Current_Status for active/inactive
                jsonData.forEach((row, index) => {
                  // Get Tenant_ID from Excel - this is the unique identifier
                  let tenantIdValue = row['Tenant_ID'] || row['Tenant ID'] || row['TENANT_ID'] || row['Tenant_Id'];
                  let tenantId = null;
                  
                  if (tenantIdValue !== undefined && tenantIdValue !== null && tenantIdValue !== '') {
                    tenantId = String(tenantIdValue).trim();
                    // If it's a number, keep it as string for consistency
                    if (!tenantId) tenantId = String(index + 1);
                  } else {
                    tenantId = String(index + 1);
                  }
                  
                  // Get all fields - match exact Excel column names
                  const name = String(row['Tenant_Name'] || row['Tenant Name'] || row['TENANT_NAME'] || '').trim();
                  const email = String(row['Tenant_Email'] || row['Tenant Email'] || row['TENANT_EMAIL'] || '').trim();
                  const phone = String(row['Tenant_Phone'] || row['Tenant Phone'] || row['TENANT_PHONE'] || '').trim();
                  const address = String(row['Tenant_Old_Address'] || row['Tenant Old Address'] || row['Old_Address'] || row['TENANT_OLD_ADDRESS'] || '').trim();
                  const job = String(row['Tenant_Job_Desc'] || row['Tenant Job Desc'] || row['Job_Desc'] || row['TENANT_JOB_DESC'] || '').trim();
                  const currentStatus = String(row['Current_Status'] || row['Current Status'] || row['CURRENT_STATUS'] || row['Status'] || 'Active').trim();
                  
                  // Store using Tenant_ID as the key (not index-based)
                  // Store Tenant_ID itself for reference
                  masterData[`Tenant_${tenantId}_ID`] = tenantId;
                  masterData[`Tenant_${tenantId}_Name`] = name;
                  masterData[`Tenant_${tenantId}_Email`] = email;
                  masterData[`Tenant_${tenantId}_Phone`] = phone;
                  masterData[`Tenant_${tenantId}_Old_Address`] = address;
                  masterData[`Tenant_${tenantId}_Job_Desc`] = job;
                  // Store Current_Status (Active/Inactive) instead of Tenant_Active
                  masterData[`Tenant_${tenantId}_Current_Status`] = currentStatus;
                  // Keep backward compatibility with Active field for now
                  const statusLower = currentStatus.toLowerCase();
                  masterData[`Tenant_${tenantId}_Active`] = (statusLower === 'inactive' || statusLower === '0' || statusLower === 'false' || statusLower === 'no') ? '0' : '1';
                });
                
                console.log(`‚úì Loaded ${jsonData.length} tenants from Excel`);
                processedSheets.push(sheetName);
              }
              return;
            }
            
            // Handle Manager_Suprintendent sheet (note: typo in sheet name)
            if (sheetName === 'Manager_Suprintendent' || sheetName === 'Manager_Superintendent') {
              console.log('‚úì Processing Manager/Superintendent sheet');
              const sheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(sheet);
              
              if (jsonData.length > 0) {
                // Clear existing manager data
                delete masterData['Manager_Name'];
                delete masterData['Manager_Phone'];
                delete masterData['Superintendent_Name'];
                delete masterData['Superintendent_Phone'];
                
                // Load manager data (take first row)
                const row = jsonData[0];
                const managerName = String(row['Manager_Name'] || row['Manager Name'] || row['Manager'] || '').trim();
                const managerPhone = String(row['Manager_Phone'] || row['Manager Phone'] || '').trim();
                const superName = String(row['Superintendent_Name'] || row['Superintendent Name'] || row['Superintendent'] || '').trim();
                const superPhone = String(row['Superintendent_Phone'] || row['Superintendent Phone'] || '').trim();
                
                if (managerName) masterData['Manager_Name'] = managerName;
                if (managerPhone) masterData['Manager_Phone'] = managerPhone;
                if (superName) masterData['Superintendent_Name'] = superName;
                if (superPhone) masterData['Superintendent_Phone'] = superPhone;
                
                console.log('‚úì Loaded manager/superintendent data');
                processedSheets.push(sheetName);
              }
              return;
            }
            
            // Handle Lease_Records sheet
            if (sheetName === 'Lease_Records' || sheetName === 'Lease Records') {
              console.log('‚úì Processing Lease Records sheet');
              const sheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(sheet);
              
              if (jsonData.length > 0) {
                const leaseRecords = jsonData.map(row => ({
                  Lease_ID: String(row['Lease_ID'] || row['Lease ID'] || row['ID'] || '').trim(),
                  Property_Tag: String(row['Property_Tag'] || row['Property Tag'] || row['Property'] || '').trim(),
                  Landlord: String(row['Landlord'] || '').trim(),
                  Tenants: String(row['Tenants'] || row['Tenant'] || '').trim(),
                  Lease_Start_Date: String(row['Lease_Start_Date'] || row['Lease Start Date'] || row['Start Date'] || '').trim(),
                  Lease_End_Date: String(row['Lease_End_Date'] || row['Lease End Date'] || row['End Date'] || '').trim(),
                  Monthly_Rent: String(row['Monthly_Rent'] || row['Monthly Rent'] || row['Rent'] || '').trim(),
                  Security_Deposit: String(row['Security_Deposit'] || row['Security Deposit'] || row['Deposit'] || '').trim(),
                  Notes: String(row['Notes'] || row['Note'] || '').trim()
                }));
                
                try {
                  localStorage.setItem('leaseRecords', JSON.stringify(leaseRecords));
                  console.log(`‚úì Loaded ${leaseRecords.length} lease records`);
                  processedSheets.push(sheetName);
                } catch (e) {
                  console.error('Error saving lease records:', e);
                }
              }
              return;
            }
            
            // Handle Inspection_Report sheet
            if (sheetName === 'Inspection_Report' || sheetName === 'Inspection Report') {
              console.log('‚úì Processing Inspection Report sheet');
              const sheet = workbook.Sheets[sheetName];
              
              try {
                // Convert sheet to base64 XLSX format
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, sheet, "Inspection_Report");
                const wbBase64 = XLSX.write(wb, { type: 'base64', bookType: 'xlsx' });
                localStorage.setItem('inspectionReportData', wbBase64);
                console.log('‚úì Loaded inspection report data');
                processedSheets.push(sheetName);
              } catch (e) {
                console.error('Error saving inspection report:', e);
              }
              return;
            }
            
            // NEW: Handle merged sheets (Ac_Category, Ac_Tag)
            if (sheetName === 'Ac_Category' || sheetName === 'Ac_Tag') {
              console.log(`‚úì Processing merged sheet: ${sheetName}`);
              const sheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(sheet);
              
              if (jsonData.length === 0) return;
              
              const firstRow = jsonData[0];
              const columnKeys = Object.keys(firstRow);
              
              // Find the main column (Ac_Category or Ac_Tag) and classification column
              const mainColumn = sheetName === 'Ac_Category' ? 'Ac_Category' : 'Ac_Tag';
              const classColumn = 'Ac_Classification';
              
              if (!columnKeys.includes(mainColumn) || !columnKeys.includes(classColumn)) {
                console.log(`‚ö† Sheet "${sheetName}" missing required columns`);
                return;
              }
              
              // Process data for each account type
              const incomeValues = [];
              const investmentValues = [];
              const expenseValues = [];
              
              jsonData.forEach(row => {
                const value = String(row[mainColumn] || '').trim();
                const classification = String(row[classColumn] || '').trim();
                
                if (!value) return;
                
                if (classification === 'Income') {
                  incomeValues.push(value);
                } else if (classification === 'Investment') {
                  investmentValues.push(value);
                } else if (classification === 'Expanse' || classification === 'Expense') {
                  expenseValues.push(value);
                }
                // Tenant classification is ignored - tenants module removed
              });
              
              // Map to appropriate modules and fields
              let incomeKey = null, investmentKey = null, expenseKey = null;
              
              if (sheetName === 'Ac_Category') {
                incomeKey = 'Income_Category';
                investmentKey = 'Investment_Category';
                expenseKey = 'Expanse_Category';
              } else if (sheetName === 'Ac_Tag') {
                incomeKey = 'Income_Ac_Tag';
                investmentKey = 'Investment_Ac_Tag';
                expenseKey = 'Expanse_Ac_Tag';
              }
              
              // Load data into appropriate modules
              ['income', 'investment', 'expense'].forEach(module => {
                const fieldKey = module === 'income' ? incomeKey : (module === 'investment' ? investmentKey : expenseKey);
                const values = module === 'income' ? incomeValues : (module === 'investment' ? investmentValues : expenseValues);
                
                if (!masterData[module]) masterData[module] = {};
                if (!masterData[module][fieldKey]) masterData[module][fieldKey] = [];
                
                if (values.length > 0) {
                  const existing = masterData[module][fieldKey] || [];
                  const newValues = values.filter(v => v && v !== '' && !existing.includes(v));
                  masterData[module][fieldKey] = [...existing, ...newValues].sort();
                  console.log(`‚úì Loaded ${values.length} ${module} values from "${sheetName}" into ${module}.${fieldKey} (${newValues.length} new)`);
                } else {
                  console.log(`‚ö† No ${module} values found in "${sheetName}"`);
                }
              });
              
              processedSheets.push(sheetName);
              return;
            }
            
            processedSheets.push(sheetName);

            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet);

            if (jsonData.length === 0) return;

            // Try to find the column with the same name as the sheet, or use first column
            let values = [];
            const firstRow = jsonData[0];
            const columnKeys = Object.keys(firstRow);

            // Try to find the column with the same name as the sheet, or use first column
            // Handle case-insensitive matching and variations
            let columnName = sheetName;
            
            // First try exact match
            if (firstRow[sheetName] !== undefined && firstRow[sheetName] !== null && String(firstRow[sheetName]).trim() !== '') {
              columnName = sheetName;
            } else {
              // Try case-insensitive match
              const matchingKey = columnKeys.find(key => key.toLowerCase() === sheetName.toLowerCase());
              if (matchingKey) {
                columnName = matchingKey;
              } else {
                // For common fields, also try common variations
                if (sheetName === 'Mode' || sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode' || sheetName.toLowerCase() === 'mode' || sheetName.toLowerCase() === 'mode_txn' || sheetName.toLowerCase() === 'txn_mode') {
                  const modeVariations = columnKeys.find(key => 
                    key.toLowerCase().includes('mode') || key.toLowerCase().includes('txn_mode') || key.toLowerCase().includes('mode_txn')
                  );
                  if (modeVariations) columnName = modeVariations;
                } else if (sheetName === 'Status_Txn' || sheetName === 'Txn_Status' || sheetName.toLowerCase() === 'status_txn' || sheetName.toLowerCase() === 'txn_status') {
                  const statusVariations = columnKeys.find(key => 
                    key.toLowerCase().includes('status') || key.toLowerCase().includes('txn_status') || key.toLowerCase().includes('status_txn')
                  );
                  if (statusVariations) columnName = statusVariations;
                } else if (sheetName === 'Ac_Classification' || sheetName.toLowerCase() === 'ac_classification') {
                  // For Ac_Classification sheet, try to find column with same name, or use first column
                  const classVariations = columnKeys.find(key => 
                    key.toLowerCase() === 'ac_classification' || key.toLowerCase().includes('classification')
                  );
                  if (classVariations) columnName = classVariations;
                  else columnName = columnKeys[0]; // Use first column if no match
                } else {
                  // Use first column
                  columnName = columnKeys[0];
                }
              }
            }
            
            console.log(`Reading sheet "${sheetName}": Using column "${columnName}" from available columns:`, columnKeys);
            
            values = jsonData.map(row => {
              const val = row[columnName];
              // Handle various data types
              if (val === undefined || val === null) return null;
              const strVal = String(val).trim();
              return strVal === '' ? null : strVal;
            }).filter(v => v !== null && v !== '');
            
            // values extracted

            // Determine which module and field this sheet belongs to
            let foundModule = null;
            let foundKey = null;

            // PRIORITY 1: Check if sheet name is exactly Mode/Mode_Txn/Txn_Mode or Status_Txn or Ac_Classification (common fields) - CHECK FIRST!
            // These must be checked BEFORE checking module prefixes to avoid mis-mapping
            if (sheetName === 'Mode' || sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode') {
              foundModule = 'common';
              foundKey = 'Mode';
              console.log(`‚úì PRIORITY MATCH: Sheet "${sheetName}" -> common.Mode`);
            } else if (sheetName === 'Status_Txn' || sheetName === 'Txn_Status') {
              foundModule = 'common';
              foundKey = 'Status_Txn';
              console.log(`‚úì PRIORITY MATCH: Sheet "${sheetName}" -> common.Status_Txn`);
            } else if (sheetName === 'Ac_Classification') {
              foundModule = 'common';
              foundKey = 'Ac_Classification';
              console.log(`‚úì PRIORITY MATCH: Sheet "${sheetName}" -> common.Ac_Classification`);
            }
            // PRIORITY 2: Check exact mapping dictionary
            else if (SHEET_NAME_MAP[sheetName]) {
              foundModule = SHEET_NAME_MAP[sheetName].module;
              foundKey = SHEET_NAME_MAP[sheetName].key;
              console.log(`‚úì Matched "${sheetName}" via SHEET_NAME_MAP -> ${foundModule}.${foundKey}`);
            } else {
              // PRIORITY 3: Try to determine based on prefix rules
              const lowerSheet = sheetName.toLowerCase();
              
              // Check for module prefixes
              if (sheetName.startsWith('Task_')) {
                // Special case: Task_Tag maps to Country in common, not task
                if (sheetName === 'Task_Tag') {
                  foundModule = 'common';
                  foundKey = 'Country';
                } else {
                  foundModule = 'task';
                  foundKey = sheetName;
                  // Check if it's in our structure
                  if (!MASTER_DATA_STRUCTURE.task[sheetName]) {
                    foundModule = null;
                    foundKey = null;
                  }
                }
              } else if (sheetName.startsWith('Income_')) {
                foundModule = 'income';
                foundKey = sheetName;
                // Check if it's in our structure
                if (!MASTER_DATA_STRUCTURE.income[sheetName]) {
                  foundModule = null;
                  foundKey = null;
                }
              } else if (sheetName.startsWith('Investment_')) {
                foundModule = 'investment';
                foundKey = sheetName;
                // Check if it's in our structure
                if (!MASTER_DATA_STRUCTURE.investment[sheetName]) {
                  foundModule = null;
                  foundKey = null;
                }
              } else if (sheetName.startsWith('Expense_') || sheetName.startsWith('Expanse_')) {
                foundModule = 'expense';
                // Map variations to unified keys
                if (sheetName === 'Expense_Category') {
                  foundKey = 'Expanse_Category';
                } else if (sheetName === 'Expanse_Category') {
                  foundKey = 'Expanse_Category';
                } else if (sheetName === 'Expense_Tag' || sheetName === 'Expense_Ac_Tag') {
                  foundKey = 'Expanse_Ac_Tag';
                } else if (sheetName === 'Expanse_Ac_Tag') {
                  foundKey = 'Expanse_Ac_Tag';
                } else {
                  // Not a valid expense master field - might be a variation that should map to common
                  foundModule = null;
                  foundKey = null;
                }
              } else {
                // No prefix = common field
                // Check if it matches common field names (case-insensitive matching)
                if (lowerSheet === 'currency') {
                  foundModule = 'common';
                  foundKey = 'Currency';
                } else if (lowerSheet === 'frequency') {
                  foundModule = 'common';
                  foundKey = 'Frequency';
                } else if (lowerSheet === 'ac_holder' || lowerSheet === 'account holder' || lowerSheet === 'ac holder') {
                  foundModule = 'common';
                  foundKey = 'Ac_Holder';
                } else if (lowerSheet === 'mode' || lowerSheet === 'mode_txn' || lowerSheet === 'txn_mode' || lowerSheet === 'transaction mode' || lowerSheet === 'txn mode' ||
                           sheetName === 'Mode' || sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode' || sheetName === 'MODE' || sheetName === 'MODE_TXN' || sheetName === 'TXN_MODE' || sheetName === 'txn_mode' || sheetName === 'Txn_MODE') {
                  foundModule = 'common';
                  foundKey = 'Mode';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Mode`);
                } else if (lowerSheet === 'status_txn' || lowerSheet === 'txn_status' || lowerSheet === 'transaction status' || lowerSheet === 'txn status' ||
                           sheetName === 'Status_Txn' || sheetName === 'Txn_Status' || sheetName === 'STATUS_TXN' || sheetName === 'TXN_STATUS' || sheetName === 'txn_status') {
                  foundModule = 'common';
                  foundKey = 'Status_Txn';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Status_Txn`);
                } else if (lowerSheet === 'ac_status' || lowerSheet === 'account status' || lowerSheet === 'ac status') {
                  foundModule = 'common';
                  foundKey = 'Ac_Status';
                } else if (lowerSheet === 'ac_classification' || lowerSheet === 'account classification') {
                  foundModule = 'common';
                  foundKey = 'Ac_Classification';
                } else if (lowerSheet === 'country' || sheetName === 'Country' || sheetName === 'COUNTRY') {
                  foundModule = 'common';
                  foundKey = 'Country';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Country`);
                } else if (lowerSheet === 'email' || sheetName === 'Email' || sheetName === 'EMAIL') {
                  foundModule = 'common';
                  foundKey = 'Email';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Email`);
                } else if (lowerSheet === 'phone' || sheetName === 'Phone' || sheetName === 'PHONE') {
                  foundModule = 'common';
                  foundKey = 'Phone';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.Phone`);
                } else if (lowerSheet === 'sqa' || sheetName === 'SQA') {
                  foundModule = 'common';
                  foundKey = 'SQA';
                  console.log(`‚úì Matched sheet "${sheetName}" to common.SQA`);
                } else if (SHEET_NAME_MAP[sheetName]) {
                  // Check variations mapping
                  foundModule = SHEET_NAME_MAP[sheetName].module;
                  foundKey = SHEET_NAME_MAP[sheetName].key;
                } else {
                  // Try exact case match for common fields
                    if (sheetName === 'Currency' || sheetName === 'FREQUENCY' || sheetName === 'Frequency' ||
                      sheetName === 'Ac_Holder' || sheetName === 'Ac_HOLDER' ||
                      sheetName === 'Mode_Txn' || sheetName === 'Txn_Mode' || sheetName === 'MODE_TXN' || sheetName === 'TXN_MODE' || sheetName === 'Txn_MODE' ||
                      sheetName === 'Status_Txn' || sheetName === 'Txn_Status' || sheetName === 'STATUS_TXN' || sheetName === 'TXN_STATUS' || sheetName === 'Txn_STATUS' ||
                      sheetName === 'Ac_Status' || sheetName === 'AC_STATUS' ||
                      sheetName === 'Ac_Classification' || sheetName === 'AC_CLASSIFICATION' ||
                      sheetName === 'Country' || sheetName === 'COUNTRY') {
                    foundModule = 'common';
                    // Normalize to standard case
                    if (sheetName === 'Mode' || sheetName.toUpperCase() === 'MODE' || sheetName === 'Mode_Txn' || sheetName.toUpperCase() === 'MODE_TXN' || sheetName === 'Txn_Mode' || sheetName.toUpperCase() === 'TXN_MODE' || sheetName === 'Txn_MODE') {
                      foundKey = 'Mode';
                    } else if (sheetName === 'Status_Txn' || sheetName.toUpperCase() === 'STATUS_TXN' || sheetName === 'Txn_Status' || sheetName.toUpperCase() === 'TXN_STATUS' || sheetName === 'Txn_STATUS') {
                      foundKey = 'Status_Txn';
                    } else if (sheetName.toUpperCase() === 'FREQUENCY' || sheetName === 'Frequency') {
                      foundKey = 'Frequency';
                    } else if (sheetName.toUpperCase() === 'AC_STATUS' || sheetName === 'Ac_STATUS') {
                      foundKey = 'Ac_Status';
                    } else if (sheetName.toUpperCase() === 'AC_HOLDER' || sheetName === 'Ac_HOLDER') {
                      foundKey = 'Ac_Holder';
                    } else if (sheetName.toUpperCase() === 'AC_CLASSIFICATION' || sheetName === 'Ac_Classification') {
                      foundKey = 'Ac_Classification';
                    } else if (sheetName.toUpperCase() === 'COUNTRY' || sheetName === 'Country') {
                      foundKey = 'Country';
                    } else {
                      foundKey = sheetName;
                    }
                    console.log(`Matched ${sheetName} to common.${foundKey}`);
                  }
                }
              }
            }

            if (foundModule && foundKey) {
              // Initialize if needed
              if (!masterData[foundModule]) masterData[foundModule] = {};
              if (!masterData[foundModule][foundKey]) masterData[foundModule][foundKey] = [];
              
              if (values.length > 0) {
                // Merge with existing values (avoid duplicates)
                const existing = masterData[foundModule][foundKey] || [];
                const newValues = values.filter(v => v && v !== '' && !existing.includes(v));
                masterData[foundModule][foundKey] = [...existing, ...newValues].sort();
                console.log(`‚úì Loaded ${values.length} values from "${sheetName}" into ${foundModule}.${foundKey} (${newValues.length} new values added)`);
              } else {
                console.log(`‚ö† Sheet "${sheetName}" matched to ${foundModule}.${foundKey} but contains no values`);
              }
            } else {
              console.log(`‚úó Skipping sheet "${sheetName}" - not a master data field`);
            }
          });

          normalizeSqaValues(masterData);
          
          // Ensure masterData structure is properly initialized (without overwriting existing data)
          // This ensures all required module structures exist
          ['task', 'expense', 'income', 'investment', 'common', 'trading-accounts'].forEach(module => {
            if (!masterData[module]) {
              masterData[module] = {};
            }
          });
          
          // Debug: Log data before saving
          console.log('üìä Master data before saving:', masterData);
          console.log('üìä Sample data check - income.Income_Category:', masterData.income?.Income_Category?.length || 0, 'items');
          console.log('üìä Sample data check - expense.Expanse_Category:', masterData.expense?.Expanse_Category?.length || 0, 'items');
          
          // Save to all localStorage keys (unified and module-specific)
          saveMasterData();
          
          // Update masterDataCache with Property, Tenant, and Manager data
          try {
            let masterDataCache = {};
            const cached = localStorage.getItem("masterDataCache");
            if (cached) {
              try {
                masterDataCache = JSON.parse(cached) || {};
              } catch (e) {
                masterDataCache = {};
              }
            }
            
            // Merge Property, Tenant, and Manager data into masterDataCache
            Object.keys(masterData).forEach(key => {
              if (key.startsWith('Property_') || key.startsWith('Landlord_') || 
                  key.startsWith('Tenant_') || 
                  key === 'Manager_Name' || key === 'Manager_Phone' || 
                  key === 'Superintendent_Name' || key === 'Superintendent_Phone') {
                masterDataCache[key] = masterData[key];
              }
            });
            
            localStorage.setItem("masterDataCache", JSON.stringify(masterDataCache));
            console.log('‚úì Updated masterDataCache with Property/Tenant/Manager data');
          } catch (e) {
            console.error("Error updating masterDataCache:", e);
          }
          
          // Verify data was saved
          const saved = JSON.parse(localStorage.getItem('unified_master_data') || '{}');
          console.log('‚úÖ Data saved to localStorage. Verification - income.Income_Category:', saved.income?.Income_Category?.length || 0, 'items');
          
          // Save the Excel file name for tooltip
          localStorage.setItem('last_excel_file_loaded', file.name);
          localStorage.setItem('last_excel_file_source', 'D:');
          
          // Try to capture folder path from file input
          let folderPath = '';
          try {
            const input = document.getElementById('excelFileInput');
            const inputValue = input ? input.value || '' : '';
            
            // Extract folder path from input value if available
            // Skip if it's the fake path browsers show for security
            if (inputValue && !inputValue.includes('fakepath') && !inputValue.toLowerCase().includes('c:\\fakepath')) {
              const match = inputValue.match(/^(.+)[\\\/][^\\\/]+$/);
              if (match && match[1]) {
                folderPath = match[1].replace(/[\\\/]+$/, '');
                // Double check it's not a fake path
                if (folderPath.toLowerCase().includes('fakepath')) {
                  folderPath = '';
                }
              }
            }
            
            // If path not captured and we have a stored folder path, reuse it
            if (!folderPath && window.lastExcelFolderPath) {
              folderPath = window.lastExcelFolderPath;
            }
            
            // If still no path, prompt user once
            if (!folderPath) {
              folderPath = prompt(`File "${file.name}" selected.\n\nEnter the folder path where this file is located:`, window.lastExcelFolderPath || 'D:\\');
              if (folderPath) {
                folderPath = folderPath.trim().replace(/[\\\/]+$/, '');
              }
            }
            
            // Store folder path
            if (folderPath) {
              window.lastExcelFolderPath = folderPath;
              localStorage.setItem('last_excel_folder_path', folderPath);
              console.log('Folder path captured (main handler):', folderPath);
            }
          } catch (err) {
            console.warn('Could not capture folder path:', err);
          }
          
          // Update display immediately
          if (typeof updateLastFileDisplay === 'function') {
            updateLastFileDisplay();
          }
          
          // Update tooltip in index.html if it's open
          if (window.opener && typeof window.opener.updateManageMasterDataTooltip === 'function') {
            window.opener.updateManageMasterDataTooltip();
          }
          
          // Re-render all tabs to show the new data
          const currentTab = document.querySelector('.tab.active')?.getAttribute('data-tab') || 'task';
          renderTab(currentTab);
          
          const totalSheets = sheetNames.length;
          const transactionalSheets = sheetNames.filter(s => s.startsWith('Txn_') && s !== 'Txn_Mode' && s !== 'Txn_Status' && !s.includes('Mode') && !s.includes('Status')).length;
          const hasPathsSheet = sheetNames.includes('Paths');
          const masterDataSheets = processedSheets.length;
          
          // Count Property-Tenancy records - use window.masterData or load from cache
          let dataForCounting = masterData;
          if (!dataForCounting || Object.keys(dataForCounting).length === 0) {
            try {
              const cached = localStorage.getItem('masterDataCache');
              if (cached) dataForCounting = JSON.parse(cached) || {};
            } catch (e) {}
          }
          if (!dataForCounting) dataForCounting = window.masterData || {};
          
          const propertyKeys = new Set();
          Object.keys(dataForCounting).forEach(key => {
            const match = key.match(/^Property_(.+?)_Tag$/);
            if (match) {
              propertyKeys.add(match[1]);
            }
          });
          const propertyCount = propertyKeys.size;
          
          const tenantIds = new Set();
          Object.keys(dataForCounting).forEach(key => {
            const match = key.match(/^Tenant_(.+?)_ID$/);
            if (match) {
              tenantIds.add(match[1]);
            }
          });
          const tenantCount = tenantIds.size;
          
          const managerCount = (dataForCounting['Manager_Name'] || '').trim() ? 1 : 0;
          
          let leaseRecordsCount = 0;
          try {
            const leaseRecords = JSON.parse(localStorage.getItem('leaseRecords') || '[]');
            leaseRecordsCount = Array.isArray(leaseRecords) ? leaseRecords.length : 0;
          } catch (e) {
            leaseRecordsCount = 0;
          }
          
          let inspectionReportCount = 0;
          try {
            const inspectionData = localStorage.getItem('inspectionReportData');
            if (inspectionData && typeof XLSX !== 'undefined') {
              const wb = XLSX.read(inspectionData, { type: 'base64' });
              const sheetName = wb.SheetNames.find(n => n.toLowerCase().includes('inspection')) || wb.SheetNames[0];
              if (sheetName) {
                const sheet = wb.Sheets[sheetName];
                const sheetData = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});
                // Count non-empty rows (skip header and empty rows)
                inspectionReportCount = sheetData.filter((row, idx) => {
                  if (idx === 0) return false; // Skip header
                  return row && row.length > 0 && row.some(cell => cell && String(cell).trim());
                }).length;
              }
            }
          } catch (e) {
            inspectionReportCount = 0;
          }
          
          // Count fields loaded for each module
          const moduleFieldCounts = {
            income: Object.keys((window.masterData && window.masterData.income) || {}).length,
            expense: Object.keys((window.masterData && window.masterData.expense) || {}).length,
            investment: Object.keys((window.masterData && window.masterData.investment) || {}).length,
            task: Object.keys((window.masterData && window.masterData.task) || {}).length,
            common: Object.keys((window.masterData && window.masterData.common) || {}).length
          };
          
          // Use shared function to show consolidated message
          if (typeof window.showConsolidatedImportMessage === 'function') {
            window.showConsolidatedImportMessage(file.name, sheetNames, masterData);
          } else {
            // Fallback if function not available
            let message = `Successfully imported master data from Excel file!\n\n`;
            message += `Total sheets in file: ${totalSheets}\n`;
            message += `Transactional sheets skipped: ${transactionalSheets}\n`;
            message += `Master data sheets processed: ${masterDataSheets}${hasPathsSheet ? ' + Paths' : ''}\n\n`;
            message += `Fields Loaded - Income: ${moduleFieldCounts.income}, Expense: ${moduleFieldCounts.expense}, Investment: ${moduleFieldCounts.investment}, Task: ${moduleFieldCounts.task}, Shared Attributes: ${moduleFieldCounts.common}${hasPathsSheet ? ', Paths: 4' : ''}\n\n`;
            message += `For Property-Tenancy Data:\n`;
            message += `Property: ${propertyCount} Records\n`;
            message += `Tenant: ${tenantCount} Records\n`;
            message += `Manager: ${managerCount} Records\n`;
            message += `Lease Records: ${leaseRecordsCount} Records\n`;
            message += `Inspection Report: ${inspectionReportCount} Records`;
            if (!arePathsSet()) {
              message += '\n\n‚ö†Ô∏è Please set Project Paths in the "Set/Change Paths" tab!';
            }
            alert(message);
          }
          e.target.value = ''; // Reset file input after successful processing
        } catch (error) {
          console.error('Error reading Excel file:', error);
          alert('Error reading Excel file: ' + error.message);
          e.target.value = ''; // Reset file input on error
        }
      };
      reader.readAsArrayBuffer(file);
    });
    }
    
    // Set up the file handler when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupExcelFileHandler);
    } else {
      setupExcelFileHandler();
    }

    // Close modal on outside click
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEditModal();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeEditModal();
      }
    });

    // Clear all data with double confirmation
    document.getElementById('btnClearData').addEventListener('click', function() {
      // First confirmation
      const firstConfirm = confirm('‚ö†Ô∏è WARNING: This will delete ALL master data!\n\nAre you sure you want to proceed?');
      if (!firstConfirm) return;

      // Second confirmation with more details
      const secondConfirm = confirm('‚ö†Ô∏è FINAL WARNING: This action cannot be undone!\n\nAll master data for Income, Expense, Investment, Task, and Common fields will be permanently deleted.\n\nClick OK to confirm deletion.');
      if (!secondConfirm) return;

      // Clear all master data (structured modules only - Property/Tenant/Manager are stored as flat keys in masterDataCache)
      masterData = {
        task: {},
        expense: {},
        income: {},
        investment: {},
        common: {},
        'trading-accounts': {},
      };

      // Clear localStorage
      localStorage.removeItem('unified_master_data');
      localStorage.removeItem('task_master_data');
      localStorage.removeItem('expense_master_data');
      localStorage.removeItem('income_master_data');
      localStorage.removeItem('investment_master_data');
      localStorage.removeItem('trading_accounts_master_data');
      
      // Clear Property-Tenancy Data (stored in masterDataCache)
      localStorage.removeItem('masterDataCache');
      
      // Clear Lease Records
      localStorage.removeItem('leaseRecords');
      
      // Clear Inspection Report
      localStorage.removeItem('inspectionReportData');

      // Clear all paths
      clearAllPaths();

      // Initialize empty structure and re-render
      initializeMasterData();
      saveMasterData();
      const currentTab = document.querySelector('.tab.active').getAttribute('data-tab');
      if (currentTab === 'paths') {
        loadPaths();
      } else if (currentTab === 'property-tenancy') {
        // Property-tenancy tab uses modals, not grid rendering - skip renderTab
      } else {
        renderTab(currentTab);
      }
      
      alert('‚úÖ All master data and paths have been cleared successfully.');
    });

    // Display last loaded Excel file info (if not already defined by fallback)
    if (typeof window.updateLastFileDisplay !== 'function') {
      function updateLastFileDisplay() {
        const lastExcelFile = localStorage.getItem('last_excel_file_loaded') || '';
        const lastExcelSource = localStorage.getItem('last_excel_file_source') || '';
        const lastExcelPath = localStorage.getItem('last_excel_file_path') || '';
        const filePathDisplay = document.getElementById('filePathDisplay');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        
        if (!filePathDisplay || !fileNameDisplay) {
          setTimeout(updateLastFileDisplay, 100);
          return;
        }
        
        if (lastExcelFile) {
          // Browser security prevents access to actual file path
          // Show a clear message that path is not accessible
          filePathDisplay.innerHTML = `<span style="color:#64748b;">üìÅ</span> <span style="color:#64748b;font-style:italic;">Path not accessible (browser security)</span>`;
          
          // Display file name on right
          const icon = lastExcelSource === 'Google Drive' ? '‚òÅÔ∏è' : 'üìÑ';
          let sourceLabel = lastExcelSource === 'D:' ? 'Local Drive D:' : lastExcelSource;
          if (lastExcelSource === 'Google Drive') sourceLabel = 'Google Drive';
          fileNameDisplay.innerHTML = `${icon} <strong>${lastExcelFile}</strong> <span style="color:#64748b;font-weight:400;font-size:0.85rem;">(${sourceLabel || 'Unknown source'})</span>`;
        } else {
          filePathDisplay.innerHTML = '<span style="color:#64748b;">‚ö†Ô∏è No file loaded</span>';
          fileNameDisplay.innerHTML = '<span style="color:#64748b;">‚ö†Ô∏è No Excel file loaded yet</span>';
        }
      }
      window.updateLastFileDisplay = updateLastFileDisplay;
    }

    // Initialize folder path from localStorage on load
    window.lastExcelFolderPath = localStorage.getItem('last_excel_folder_path') || '';
    
    // Download Master Data to Excel function
    async function downloadMasterDataExcel() {
      try {
        // Create a new workbook
        const wb = XLSX.utils.book_new();
        
        // Use global consolidated master data export function
        if (typeof addConsolidatedMasterDataToWorkbook === 'function') {
          addConsolidatedMasterDataToWorkbook(wb);
        } else {
          console.warn('Global master data export function not available, using fallback');
          // Fallback to old method if global function not loaded
          const acCategoryData = [['Ac_Category', 'Ac_Classification']];
          const classifications = ['Income', 'Investment', 'Expanse'];
          const categoryMapping = {
            'Income': 'Income_Category',
            'Investment': 'Investment_Category',
            'Expanse': 'Expanse_Category'
          };
          
          classifications.forEach(cls => {
            const fieldKey = categoryMapping[cls];
            const moduleMap = {'Income': 'income', 'Investment': 'investment', 'Expanse': 'expense'};
            const moduleName = moduleMap[cls] || '';
            const values = (masterData[moduleName] || {})[fieldKey] || [];
            values.forEach(value => {
              acCategoryData.push([value, cls]);
            });
          });
          
          if (acCategoryData.length > 1) {
            const acCategoryWs = XLSX.utils.aoa_to_sheet(acCategoryData);
            XLSX.utils.book_append_sheet(wb, acCategoryWs, 'Ac_Category');
          }
          
          const acTagData = [['Ac_Tag', 'Ac_Classification']];
          const tagMapping = {
            'Income': 'Income_Ac_Tag',
            'Investment': 'Investment_Ac_Tag',
            'Expanse': 'Expanse_Ac_Tag'
          };
          
          classifications.forEach(cls => {
            const fieldKey = tagMapping[cls];
            const moduleMap = {'Income': 'income', 'Investment': 'investment', 'Expanse': 'expense'};
            const moduleName = moduleMap[cls] || '';
            const values = (masterData[moduleName] || {})[fieldKey] || [];
            values.forEach(value => {
              acTagData.push([value, cls]);
            });
          });
          
          if (acTagData.length > 1) {
            const acTagWs = XLSX.utils.aoa_to_sheet(acTagData);
            XLSX.utils.book_append_sheet(wb, acTagWs, 'Ac_Tag');
          }
          
          const acClassificationData = [['Ac_Classification']];
          const classificationValues = (masterData.common || {})['Ac_Classification'] || ['Income', 'Investment', 'Expanse'];
          classificationValues.forEach(value => {
            acClassificationData.push([value]);
          });
          
          const acClassWs = XLSX.utils.aoa_to_sheet(acClassificationData);
          XLSX.utils.book_append_sheet(wb, acClassWs, 'Ac_Classification');
          
          const commonData = masterData.common || {};
          Object.keys(commonData).forEach(fieldKey => {
            if (fieldKey === 'Ac_Classification') return;
            const values = commonData[fieldKey];
            if (values && Array.isArray(values) && values.length > 0) {
              const sheetData = [[fieldKey], ...values.map(v => [v])];
              const ws = XLSX.utils.aoa_to_sheet(sheetData);
              XLSX.utils.book_append_sheet(wb, ws, fieldKey);
            }
          });
        }
        
        // STEP 5: Add Task fields
        const taskData = masterData.task || {};
        Object.keys(MASTER_DATA_STRUCTURE.task || {}).forEach(fieldKey => {
          const values = taskData[fieldKey];
          if (values && Array.isArray(values) && values.length > 0) {
            const sheetData = [];
            sheetData.push([fieldKey]); // Header row
            values.forEach(value => {
              sheetData.push([value]);
            });
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            XLSX.utils.book_append_sheet(wb, ws, fieldKey);
            console.log(`Added ${fieldKey} sheet with ${values.length} items`);
          }
        });
        
        // STEP 6: Add Paths sheet
        const pathsData = [['Path Type', 'Path']]; // Header
        const pathsToExport = [
          ['Master Data File', 'project_master_data_file'],
          ['Backup Path', 'project_backup_path'],
          ['Documents Path', 'project_documents_path'],
          ['Downloads Path', 'project_downloads_path']
        ];
        
        pathsToExport.forEach(([label, key]) => {
          const pathValue = localStorage.getItem(key) || '';
          pathsData.push([label, pathValue]);
        });
        
        const pathsWs = XLSX.utils.aoa_to_sheet(pathsData);
        XLSX.utils.book_append_sheet(wb, pathsWs, 'Paths');
        console.log(`Added Paths sheet with ${pathsData.length - 1} items`);
        
        // Generate Excel file
        const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        
        // Generate filename with timestamp
        const now = new Date();
        const timestamp = now.toISOString().split('T')[0];
        const filename = `ClearView_Master_Data_${timestamp}.xlsx`;
        
        // Traditional download to default Downloads folder
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        
        // Show download path reminder
        const downloadsPath = localStorage.getItem('project_downloads_path') || '';
        const backupPath = localStorage.getItem('project_backup_path') || '';
        
        let message = 'Master data exported successfully!\n\nFile downloaded to your default Downloads folder.';
        if (downloadsPath || backupPath) {
          message += '\n\n';
          if (downloadsPath) {
            message += `üìÅ Recommended: Move to: ${downloadsPath}\n`;
          }
          if (backupPath) {
            message += `üíæ Backup: Copy to: ${backupPath}\n`;
          }
          message += '\n(Note: Use Chrome/Edge to save directly to custom locations)';
        }
        
        setTimeout(() => alert(message), 500);
      } catch (error) {
        console.error('Error exporting master data:', error);
        alert('Error exporting master data: ' + error.message);
      }
    }
    
    // Initialize on load
    loadMasterData();
    loadPaths(); // Load paths on page load
    updateLastFileDisplay(); // Show last loaded file
    renderTab('task'); // Render default tab
    
    // Set up button event listener - multiple attempts to ensure it works
    function setupButton() {
      const btn = document.getElementById('btnLoadFromD');
      if (btn) {
        btn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (window.openFilePicker) {
            window.openFilePicker();
          } else {
            alert('Error: openFilePicker function not available');
          }
        };
        console.log('Button listener attached');
        return true;
      }
      return false;
    }
    
    // Set up download button event
    function setupDownloadButton() {
      const btn = document.getElementById('btnDownloadExcel');
      if (btn) {
        btn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          downloadMasterDataExcel();
        };
        console.log('Download button listener attached');
        return true;
      }
      return false;
    }
    
    // Try multiple times to ensure button is attached
    if (!setupButton()) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          if (!setupButton()) {
            setTimeout(setupButton, 500);
          }
        });
      } else {
        setTimeout(setupButton, 100);
      }
    }
    
    // Try multiple times to ensure download button is attached
    if (!setupDownloadButton()) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          if (!setupDownloadButton()) {
            setTimeout(setupDownloadButton, 500);
          }
        });
      } else {
        setTimeout(setupDownloadButton, 100);
      }
    }
    
    // Update tooltip for Manage Master Data link in index.html
    updateManageMasterDataTooltip();


    // Update sub-button click handler to open modals
    window.switchPropertyTenancySubTab = function(subTabName) {
      // Close all modals first before opening a new one
      if (typeof closeAllModals === 'function') {
        closeAllModals();
      }
      
      // Update active sub-tab
      document.querySelectorAll('.property-tenancy-subtab').forEach(t => t.classList.remove('active'));
      const subTab = document.querySelector(`.property-tenancy-subtab[data-subtab="${subTabName}"]`);
      if (subTab) {
        subTab.classList.add('active');
      }

      // Update active sub-content
      document.querySelectorAll('.property-tenancy-subcontent').forEach(c => c.classList.remove('active'));
      const subContent = document.getElementById(`${subTabName}SubContent`);
      if (subContent) {
        subContent.classList.add('active');
      }

      // Small delay to ensure previous modal is closed before opening new one
      setTimeout(function() {
        // Open corresponding modal
        if (subTabName === 'property') {
          if (typeof openPropertiesCRUD === 'function') {
            openPropertiesCRUD();
          } else {
            console.error('openPropertiesCRUD function not found');
          }
        } else if (subTabName === 'tenant') {
          if (typeof openTenantsCRUD === 'function') {
            openTenantsCRUD();
          } else {
            console.error('openTenantsCRUD function not found');
          }
        } else if (subTabName === 'manager') {
          if (typeof openManagersCRUD === 'function') {
            openManagersCRUD();
          } else {
            console.error('openManagersCRUD function not found');
          }
        } else if (subTabName === 'lease-records') {
          if (typeof openLeasesCRUD === 'function') {
            openLeasesCRUD();
          } else {
            console.error('openLeasesCRUD function not found');
          }
        } else if (subTabName === 'inspection-report') {
          if (typeof openInspectionReportCRUD === 'function') {
            openInspectionReportCRUD();
          } else {
            console.error('openInspectionReportCRUD function not found');
          }
        }
      }, 50);
    };
  </script>

  <!-- Property-Tenancy Modal Scripts -->
  <script>
    // Modal JavaScript functions - extracted from modal files
    // These functions make the modals work when buttons are clicked
    
    // Common helper function (only define once)
    if (typeof window.escapeHtml === 'undefined') {
      window.escapeHtml = function(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      };
    }
    
    // Excel-style column resizer - copied from working 5_Task_Index.html implementation
    if (typeof window.initColumnResizers === 'undefined') {
      const RESIZER_STYLE_ID = 'modal-column-resizer-style';
      const resizeStateMap = new Map(); // Track resize state per table
      
      const ensureResizerStyles = () => {
        if (document.getElementById(RESIZER_STYLE_ID)) return;
        const style = document.createElement('style');
        style.id = RESIZER_STYLE_ID;
        style.textContent = `
          .excel-table thead th.resizable { position: relative; }
          .excel-table thead th.resizable::after {
            display: none !important;
          }
          .excel-table .column-resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 12px;
            height: 100%;
            cursor: col-resize;
            user-select: none;
            touch-action: none;
            z-index: 5;
          }
          .excel-table .column-resizer::after {
            content: '';
            position: absolute;
            right: 4px;
            top: 20%;
            bottom: 20%;
            width: 3px;
            border-radius: 6px;
            background: rgba(26, 79, 176, 0.45);
            transition: background 0.15s ease, transform 0.15s ease;
          }
          body.table-resizing {
            cursor: col-resize !important;
            user-select: none !important;
          }
          .excel-table .column-resizer:hover::after,
          .excel-table .column-resizer:active::after {
            background: rgba(26, 79, 176, 0.85);
            transform: scaleX(1.2);
          }
        `;
        document.head.appendChild(style);
      };

      const parseWidth = (value) => {
        if (value === null || value === undefined) return null;
        if (typeof value === 'number') return value;
        const match = String(value).match(/(\d+)/);
        return match ? parseInt(match[1], 10) : null;
      };

      window.initColumnResizers = function() {
        ensureResizerStyles();
        const tables = document.querySelectorAll('.excel-table');
        
        tables.forEach(table => {
          const tableId = table.id || 'table_' + Math.random().toString(36).substr(2, 9);
          const COLUMN_STORAGE_KEY = `columnWidths_${tableId}`;
          
          // Initialize resize state for this table
          if (!resizeStateMap.has(tableId)) {
            resizeStateMap.set(tableId, {
              active: false,
              startX: 0,
              startWidth: 0,
              columnIndex: -1,
              headerCell: null,
              table: table
            });
          }
          
          const resizeState = resizeStateMap.get(tableId);
          
          const getColumnCells = (index) => {
            if (!table) return [];
            return Array.from(table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`));
          };

          const updateTableWidth = () => {
            if (!table) return;
            const headerCells = table.querySelectorAll('thead tr th');
            const total = Array.from(headerCells).reduce((sum, cell) => {
              const explicit = parseWidth(cell.style.width);
              return sum + (explicit || cell.offsetWidth || 0);
            }, 0);
            if (total > 0) {
              table.style.width = `${total}px`;
              table.style.minWidth = `${total}px`;
            }
          };

          const applyColumnWidth = (index, width) => {
            if (!table) return;
            const normalizedWidth = Math.max(60, parseInt(width, 10) || 0);
            const headerCells = table.querySelectorAll('thead tr th');
            const targetHeader = headerCells[index];
            if (!targetHeader) return;

            const widthPx = `${normalizedWidth}px`;
            targetHeader.style.width = widthPx;
            targetHeader.style.minWidth = widthPx;

            getColumnCells(index).forEach((cell) => {
              cell.style.width = widthPx;
              cell.style.minWidth = widthPx;
            });
            updateTableWidth();
          };

          const saveColumnWidths = () => {
            if (!table) return;
            const widths = Array.from(table.querySelectorAll('thead tr th')).map((th) => {
              const applied = parseWidth(th.style.width);
              return `${applied || th.offsetWidth}px`;
            });
            localStorage.setItem(COLUMN_STORAGE_KEY, JSON.stringify(widths));
          };

          const loadColumnWidths = () => {
            if (!table) return;
            const saved = localStorage.getItem(COLUMN_STORAGE_KEY);
            if (!saved) return;
            try {
              const widths = JSON.parse(saved);
              
              // Handle both array and object formats
              if (Array.isArray(widths)) {
                // New format: array of width strings like ["150px", "200px"]
                widths.forEach((width, index) => {
                  if (width) {
                    applyColumnWidth(index, width);
                  }
                });
              } else if (widths && typeof widths === 'object') {
                // Old format: object with numeric keys like {0: 150, 1: 200}
                Object.keys(widths).forEach((key) => {
                  const index = parseInt(key, 10);
                  if (!isNaN(index) && widths[key]) {
                    const width = typeof widths[key] === 'number' ? `${widths[key]}px` : widths[key];
                    applyColumnWidth(index, width);
                  }
                });
              }
            } catch (err) {
              console.warn('Unable to restore saved column widths:', err);
              // Clear corrupted data
              try {
                localStorage.removeItem(COLUMN_STORAGE_KEY);
              } catch (e) {}
            }
          };

          const handlePointerMove = (event) => {
            if (!resizeState.active || !table) return;
            event.preventDefault();
            const delta = event.pageX - resizeState.startX;
            const newWidth = resizeState.startWidth + delta;
            applyColumnWidth(resizeState.columnIndex, newWidth);
          };

          const stopResizing = () => {
            if (!resizeState.active) return;
            document.removeEventListener('mousemove', handlePointerMove, true);
            document.removeEventListener('mouseup', stopResizing, true);
            document.body.classList.remove('table-resizing');
            resizeState.active = false;
            resizeState.headerCell = null;
            resizeState.columnIndex = -1;
            saveColumnWidths();
          };

          const startResizing = (event, headerCell, index) => {
            if (!table || !headerCell) return;
            event.preventDefault();
            resizeState.active = true;
            resizeState.startX = event.pageX;
            resizeState.startWidth = headerCell.offsetWidth;
            resizeState.columnIndex = index;
            resizeState.headerCell = headerCell;
            document.body.classList.add('table-resizing');
            document.addEventListener('mousemove', handlePointerMove, true);
            document.addEventListener('mouseup', stopResizing, true);
          };

          // Setup resizers for each resizable column
          const headerCells = table.querySelectorAll('thead tr th');
          headerCells.forEach((th, index) => {
            if (!th.classList.contains('resizable')) return;
            if (th.querySelector('.column-resizer')) return; // Already has resizer
            
            const resizer = document.createElement('div');
            resizer.className = 'column-resizer';
            resizer.title = 'Drag to resize column';
            resizer.addEventListener('mousedown', (event) => {
              event.preventDefault();
              event.stopPropagation();
              startResizing(event, th, index);
            });
            th.appendChild(resizer);
          });
          
          loadColumnWidths();
          updateTableWidth();
        });
      };
    }
    
    // Ensure masterData is available globally
    if (typeof window.masterData === 'undefined') {
      window.masterData = {};
    }
    
    // Load masterData from localStorage
    try {
      const cached = localStorage.getItem("masterDataCache");
      if (cached) {
        window.masterData = JSON.parse(cached) || {};
      }
    } catch (e) {
      console.error("Error loading masterData:", e);
    }
  </script>
  
  <!-- Modal JavaScript Functions -->
  <script>
    // Helper function
    if (typeof window.escapeHtml === 'undefined') {
      window.escapeHtml = function(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      };
    }

    // Helper function to close all modals
    function closeAllModals() {
      // Close all modal backdrops
      const backdrops = [
        document.getElementById("propertiesCRUDBackdrop"),
        document.getElementById("tenantsCRUDBackdrop"),
        document.getElementById("managersCRUDBackdrop"),
        document.getElementById("leasesCRUDBackdrop"),
        document.getElementById("inspectionReportCRUDBackdrop")
      ];
      
      // Close all modals
      const modals = [
        document.getElementById("propertiesCRUDModal"),
        document.getElementById("tenantsCRUDModal"),
        document.getElementById("managersCRUDModal"),
        document.getElementById("leasesCRUDModal"),
        document.getElementById("inspectionReportCRUDModal")
      ];
      
      backdrops.forEach(backdrop => {
        if (backdrop) backdrop.style.display = "none";
      });
      
      modals.forEach(modal => {
        if (modal) modal.style.display = "none";
      });
    }

    // Helper function to position modals below the page header
    function positionModalBelowHeader(modalElement) {
      const header = document.querySelector('header.header');
      const lastFileInfo = document.getElementById('lastFileInfo');
      
      if (modalElement) {
        let headerBottom = 0;
        
        if (header) {
          const headerRect = header.getBoundingClientRect();
          headerBottom = headerRect.bottom;
        }
        
        // Add space for lastFileInfo if visible
        if (lastFileInfo && lastFileInfo.offsetParent !== null) {
          const fileInfoRect = lastFileInfo.getBoundingClientRect();
          headerBottom = fileInfoRect.bottom;
        }
        
        const padding = 20; // Space between header and modal
        const modalTop = headerBottom + padding;
        
        // Ensure modal doesn't go off screen - adjust if needed
        const maxTop = window.innerHeight - 100; // Leave some space at bottom
        const finalTop = Math.min(modalTop, maxTop);
        
        modalElement.style.top = finalTop + 'px';
        modalElement.style.transform = 'translate(-50%, 0)'; // Only center horizontally
        modalElement.style.maxHeight = (window.innerHeight - finalTop - 40) + 'px'; // Adjust max height
      }
    }

    // Reposition modals on window resize if they're open
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        const openModals = [
          document.getElementById("propertiesCRUDModal"),
          document.getElementById("tenantsCRUDModal"),
          document.getElementById("managersCRUDModal"),
          document.getElementById("leasesCRUDModal"),
          document.getElementById("inspectionReportCRUDModal")
        ];
        
        openModals.forEach(modal => {
          if (modal && modal.style.display !== 'none') {
            positionModalBelowHeader(modal);
          }
        });
      }, 100);
    });

    // Property Modal Functions
    function openPropertiesCRUD() {
      // Close all other modals first
      closeAllModals();
      
      try {
        const cached = localStorage.getItem("masterDataCache");
        if (cached) window.masterData = JSON.parse(cached) || {};
      } catch (e) {}
      if (!window.masterData || typeof window.masterData !== 'object') window.masterData = {};
      
      const tbody = document.getElementById("propertiesCRUDBody");
      if (!tbody) return;
      tbody.innerHTML = "";
      
      const props = [];
      const propertyKeys = Object.keys(window.masterData).filter(k => 
        k.startsWith('Property_') && !k.includes('_Tag') && !k.includes('_Address')
      );
      
      propertyKeys.forEach(propKey => {
        const tagKey = propKey.replace('Property_', '');
        const propTag = window.masterData[`Property_${tagKey}_Tag`] || tagKey;
        const propAddress = window.masterData[`Property_${tagKey}_Address`] || window.masterData[propKey] || "";
        props.push({
          tagKey: tagKey, tag: propTag, address: propAddress,
          landlordName: window.masterData[`Landlord_${tagKey}_Name`] || "",
          landlordAddress: window.masterData[`Landlord_${tagKey}_Address`] || "",
          landlordPhone: window.masterData[`Landlord_${tagKey}_Phone`] || ""
        });
      });
      
      if (props.length === 0) {
        props.push({ tagKey: "", tag: "", address: "", landlordName: "", landlordAddress: "", landlordPhone: "" });
      }
      
      // Count actual records (excluding empty placeholder)
      const actualPropsCount = props.filter(p => p.tag || p.address || p.landlordName).length;
      
      props.forEach(prop => {
        const tr = document.createElement("tr");
        tr.dataset.tagKey = prop.tagKey || '';
        tr.innerHTML = `
          <td><input type="text" value="${window.escapeHtml(prop.tag || "")}" placeholder="Property_Tag" class="prop-tag"></td>
          <td><input type="text" value="${window.escapeHtml(prop.address || "")}" placeholder="Property_Address" class="prop-address"></td>
          <td><input type="text" value="${window.escapeHtml(prop.landlordName || "")}" placeholder="Landlord_Name" class="prop-landlord-name"></td>
          <td><input type="text" value="${window.escapeHtml(prop.landlordAddress || "")}" placeholder="Landlord_Address" class="prop-landlord-addr"></td>
          <td><input type="text" value="${window.escapeHtml(prop.landlordPhone || "")}" placeholder="Landlord_Phone" class="prop-landlord-phone"></td>
          <td style="text-align:center;"><button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove(); updatePropertiesModalCount();">üóë</button></td>`;
        tbody.appendChild(tr);
      });
      
      // Update modal title with count
      const titleEl = document.getElementById("propertiesModalTitle");
      if (titleEl) titleEl.textContent = `üè† Manage Properties (${actualPropsCount})`;
      
      document.getElementById("propertiesCRUDBackdrop").style.display = "block";
      const propertiesModal = document.getElementById("propertiesCRUDModal");
      propertiesModal.style.display = "block";
      positionModalBelowHeader(propertiesModal);
      setTimeout(() => {
        if (typeof window.initColumnResizers === 'function') {
          window.initColumnResizers();
        }
      }, 100);
    }

    function addPropertyRow() {
      const tbody = document.getElementById("propertiesCRUDBody");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" placeholder="Property_Tag" class="prop-tag"></td>
        <td><input type="text" placeholder="Property_Address" class="prop-address"></td>
        <td><input type="text" placeholder="Landlord_Name" class="prop-landlord-name"></td>
        <td><input type="text" placeholder="Landlord_Address" class="prop-landlord-addr"></td>
        <td><input type="text" placeholder="Landlord_Phone" class="prop-landlord-phone"></td>
        <td style="text-align:center;"><button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove(); updatePropertiesModalCount();">üóë</button></td>`;
      tbody.appendChild(tr);
      updatePropertiesModalCount();
    }

    function savePropertiesCRUD() {
      const rows = Array.from(document.querySelectorAll("#propertiesCRUDBody tr"));
      const propertyKeys = Object.keys(window.masterData).filter(k => 
        k.startsWith('Property_') || k.startsWith('Landlord_')
      );
      propertyKeys.forEach(key => delete window.masterData[key]);
      
      rows.forEach((row) => {
        const tag = row.querySelector(".prop-tag").value.trim();
        const address = row.querySelector(".prop-address").value.trim();
        const landlordName = row.querySelector(".prop-landlord-name").value.trim();
        const landlordAddr = row.querySelector(".prop-landlord-addr").value.trim();
        const landlordPhone = row.querySelector(".prop-landlord-phone").value.trim();
        if (tag || address || landlordName) {
          const tagKey = tag ? tag.replace(/[^A-Za-z0-9]/g, '_') : `PROP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          window.masterData[`Property_${tagKey}`] = address || tag || "";
          if (address) window.masterData[`Property_${tagKey}_Address`] = address;
          if (tag) window.masterData[`Property_${tagKey}_Tag`] = tag;
          if (landlordName) {
            window.masterData[`Landlord_${tagKey}_Name`] = landlordName;
            if (landlordAddr) window.masterData[`Landlord_${tagKey}_Address`] = landlordAddr;
            if (landlordPhone) window.masterData[`Landlord_${tagKey}_Phone`] = landlordPhone;
          }
        }
      });
      
      try { localStorage.setItem("masterDataCache", JSON.stringify(window.masterData)); } catch (e) {}
      closePropertiesCRUD();
      alert("‚úì Properties saved!");
    }

    function closePropertiesCRUD() {
      const backdrop = document.getElementById("propertiesCRUDBackdrop");
      const modal = document.getElementById("propertiesCRUDModal");
      if (backdrop) backdrop.style.display = "none";
      if (modal) modal.style.display = "none";
    }

    document.getElementById("propertiesCRUDBackdrop")?.addEventListener('click', function(e) {
      if (e.target === this) closePropertiesCRUD();
    });

    // Tenant Modal Functions
    function addSuperscriptsToDuplicateNames(tenants) {
      if (!tenants || tenants.length === 0) return tenants;
      const nameCount = {};
      const nameIndex = {};
      tenants.forEach(tenant => {
        const name = (tenant.name || "").trim();
        if (name) nameCount[name] = (nameCount[name] || 0) + 1;
      });
      const superscriptChars = ['¬π', '¬≤', '¬≥', '‚Å¥', '‚Åµ', '‚Å∂', '‚Å∑', '‚Å∏', '‚Åπ', '¬π‚Å∞', '¬π¬π', '¬π¬≤'];
      return tenants.map(tenant => {
        const originalName = (tenant.name || "").trim();
        if (!originalName || nameCount[originalName] <= 1) return tenant;
        if (nameIndex[originalName] === undefined) nameIndex[originalName] = 0;
        nameIndex[originalName]++;
        const superscript = superscriptChars[nameIndex[originalName] - 1] || `‚ÅΩ${nameIndex[originalName]}‚Åæ`;
        return { ...tenant, name: originalName + superscript };
      });
    }

    function openTenantsCRUD() {
      // Close all other modals first
      closeAllModals();
      
      try {
        const cached = localStorage.getItem("masterDataCache");
        if (cached) window.masterData = JSON.parse(cached) || {};
      } catch (e) {}
      if (!window.masterData || typeof window.masterData !== 'object') window.masterData = {};
      
      const tbody = document.getElementById("tenantsCRUDBody");
      if (!tbody) return;
      tbody.innerHTML = "";
      
      const tenants = [];
      // Find all tenant IDs by scanning all masterData keys - use Tenant_ID as unique identifier
      const tenantIds = new Set();
      Object.keys(window.masterData).forEach(key => {
        // Match any tenant field to extract the ID part
        const match = key.match(/^Tenant_(.+?)_(ID|Name|Email|Phone|Old_Address|Job_Desc|Job|Active|Current_Status)$/);
        if (match) {
          tenantIds.add(match[1]); // Use the ID part (could be number or string)
        }
      });
      
      // Convert to array and process each tenant - sort by Tenant_ID if it's numeric, otherwise by ID string
      Array.from(tenantIds).sort((a, b) => {
        const numA = parseFloat(a);
        const numB = parseFloat(b);
        if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
        return String(a).localeCompare(String(b));
      }).forEach(tenantId => {
        const id = window.masterData[`Tenant_${tenantId}_ID`] || tenantId;
        const name = window.masterData[`Tenant_${tenantId}_Name`] || "";
        const email = window.masterData[`Tenant_${tenantId}_Email`] || "";
        const phone = window.masterData[`Tenant_${tenantId}_Phone`] || "";
        const address = window.masterData[`Tenant_${tenantId}_Old_Address`] || "";
        const job = window.masterData[`Tenant_${tenantId}_Job_Desc`] || window.masterData[`Tenant_${tenantId}_Job`] || "";
        // Use Current_Status if available, otherwise fall back to Active
        const currentStatus = window.masterData[`Tenant_${tenantId}_Current_Status`] || "";
        const activeValue = window.masterData[`Tenant_${tenantId}_Active`];
        
        // Determine status from Current_Status field (Active/Inactive)
        let status = "Active";
        if (currentStatus) {
          const statusLower = String(currentStatus).toLowerCase();
          status = (statusLower === 'inactive' || statusLower === '0' || statusLower === 'false') ? "Inactive" : "Active";
        } else if (activeValue !== undefined && activeValue !== null) {
          // Fallback to Active field if Current_Status not available
          const activeLower = String(activeValue).toLowerCase();
          status = (activeLower === '0' || activeLower === 'false' || activeLower === 'inactive') ? "Inactive" : "Active";
        }
        
        tenants.push({
          id: tenantId, tenantId: id, name: name, email: email, phone: phone, address: address, job: job, currentStatus: status
        });
      });
      
      tenants.sort((a, b) => ((a.name || "").toLowerCase()).localeCompare((b.name || "").toLowerCase()));
      if (tenants.length === 0) tenants.push({ id: 1, name: "", email: "", phone: "", address: "", job: "", active: true });
      
      // Count actual Active records based on Current_Status
      const actualTenantsCount = tenants.filter(t => t.name || t.email || t.phone || t.address || t.job).length;
      const activeTenantsCount = tenants.filter(t => t.currentStatus === "Active").length;
      
      // Display tenants without superscript logic - Tenant_ID is the unique identifier
      tenants.forEach(tenant => {
        const tr = document.createElement("tr");
        tr.dataset.tenantId = tenant.id || '';
        tr.dataset.tenantUniqueId = tenant.tenantId || tenant.id || '';
        const currentStatus = tenant.currentStatus || "Active";
        tr.innerHTML = `
          <td><input type="text" value="${window.escapeHtml(tenant.tenantId || tenant.id || "")}" placeholder="Tenant_ID" class="tenant-id" readonly style="background:#f9fafb;"></td>
          <td><input type="text" value="${window.escapeHtml(tenant.name || "")}" placeholder="Tenant_Name" class="tenant-name"></td>
          <td><input type="email" value="${window.escapeHtml(tenant.email || "")}" placeholder="Tenant_Email" class="tenant-email"></td>
          <td><input type="tel" value="${window.escapeHtml(tenant.phone || "")}" placeholder="Tenant_Phone" class="tenant-phone"></td>
          <td><input type="text" value="${window.escapeHtml(tenant.address || "")}" placeholder="Tenant_Old_Address" class="tenant-address"></td>
          <td><input type="text" value="${window.escapeHtml(tenant.job || "")}" placeholder="Tenant_Job_Desc" class="tenant-job"></td>
          <td style="text-align:center;"><select class="tenant-current-status" style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
            <option value="Active" ${currentStatus === "Active" ? 'selected' : ''}>Active</option>
            <option value="Inactive" ${currentStatus === "Inactive" ? 'selected' : ''}>Inactive</option>
          </select></td>
          <td style="text-align:center;"><button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove(); updateTenantsModalCount();">üóë</button></td>`;
        tbody.appendChild(tr);
      });
      
      // Update modal title with count (show Active count)
      const titleEl = document.getElementById("tenantsModalTitle");
      if (titleEl) titleEl.textContent = `üë• Manage Tenants (${actualTenantsCount} total, ${activeTenantsCount} Active)`;
      
      document.getElementById("tenantsCRUDBackdrop").style.display = "block";
      const tenantsModal = document.getElementById("tenantsCRUDModal");
      tenantsModal.style.display = "flex";
      positionModalBelowHeader(tenantsModal);
      setTimeout(() => {
        if (typeof window.initColumnResizers === 'function') {
          window.initColumnResizers();
        }
      }, 100);
    }

    function addTenantRow() {
      const tbody = document.getElementById("tenantsCRUDBody");
      // Find the highest numeric Tenant_ID or use timestamp for new ones
      const existingIds = Array.from(tbody.querySelectorAll("tr"))
        .map(tr => {
          const idInput = tr.querySelector(".tenant-id");
          if (idInput && idInput.value) {
            const numId = parseFloat(idInput.value);
            return isNaN(numId) ? 0 : numId;
          }
          return 0;
        })
        .filter(id => id > 0);
      const nextId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : Date.now();
      const tr = document.createElement("tr");
      tr.dataset.tenantId = nextId;
      tr.dataset.tenantUniqueId = nextId;
      tr.innerHTML = `
        <td><input type="text" value="${nextId}" placeholder="Tenant_ID" class="tenant-id" readonly style="background:#f9fafb;"></td>
        <td><input type="text" placeholder="Tenant_Name" class="tenant-name"></td>
        <td><input type="email" placeholder="Tenant_Email" class="tenant-email"></td>
        <td><input type="tel" placeholder="Tenant_Phone" class="tenant-phone"></td>
        <td><input type="text" placeholder="Tenant_Old_Address" class="tenant-address"></td>
        <td><input type="text" placeholder="Tenant_Job_Desc" class="tenant-job"></td>
        <td style="text-align:center;"><select class="tenant-current-status" style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
          <option value="Active" selected>Active</option>
          <option value="Inactive">Inactive</option>
        </select></td>
        <td style="text-align:center;"><button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove(); updateTenantsModalCount();">üóë</button></td>`;
      tbody.appendChild(tr);
      updateTenantsModalCount();
    }

    function saveTenantsCRUD() {
      const rows = Array.from(document.querySelectorAll("#tenantsCRUDBody tr"));
      
      // Clear all existing tenant data by finding all tenant IDs (support string and numeric IDs)
      const tenantIdsToDelete = new Set();
      Object.keys(window.masterData).forEach(key => {
        const match = key.match(/^Tenant_(.+?)_/);
        if (match) {
          tenantIdsToDelete.add(match[1]);
        }
      });
      
      tenantIdsToDelete.forEach(id => {
        delete window.masterData[`Tenant_${id}_ID`];
        delete window.masterData[`Tenant_${id}_Name`];
        delete window.masterData[`Tenant_${id}_Email`];
        delete window.masterData[`Tenant_${id}_Phone`];
        delete window.masterData[`Tenant_${id}_Old_Address`];
        delete window.masterData[`Tenant_${id}_Job_Desc`];
        delete window.masterData[`Tenant_${id}_Job`];
        delete window.masterData[`Tenant_${id}_Active`];
        delete window.masterData[`Tenant_${id}_Current_Status`];
      });
      
      rows.forEach(row => {
        // Use Tenant_ID from the row (stored in dataset or input field)
        const tenantIdInput = row.querySelector(".tenant-id");
        let tenantId = tenantIdInput ? tenantIdInput.value.trim() : '';
        
        // If no Tenant_ID in input, use the stored one from dataset
        if (!tenantId) {
          tenantId = row.dataset.tenantUniqueId || row.dataset.tenantId || '';
        }
        
        // If still no ID, generate one (shouldn't happen if Excel loaded correctly)
        if (!tenantId) {
          tenantId = Date.now().toString();
        }
        
        const name = row.querySelector(".tenant-name").value.trim();
        const email = row.querySelector(".tenant-email").value.trim();
        const phone = row.querySelector(".tenant-phone").value.trim();
        const address = row.querySelector(".tenant-address").value.trim();
        const job = row.querySelector(".tenant-job").value.trim();
        const currentStatus = row.querySelector(".tenant-current-status").value || "Active";
        
        // Save using Tenant_ID as key
        window.masterData[`Tenant_${tenantId}_ID`] = tenantId;
        if (name) window.masterData[`Tenant_${tenantId}_Name`] = name;
        if (email) window.masterData[`Tenant_${tenantId}_Email`] = email;
        if (phone) window.masterData[`Tenant_${tenantId}_Phone`] = phone;
        if (address) window.masterData[`Tenant_${tenantId}_Old_Address`] = address;
        if (job) window.masterData[`Tenant_${tenantId}_Job_Desc`] = job;
        // Save Current_Status
        window.masterData[`Tenant_${tenantId}_Current_Status`] = currentStatus;
        // Also save Active for backward compatibility
        window.masterData[`Tenant_${tenantId}_Active`] = (currentStatus === "Inactive") ? "0" : "1";
      });
      
      try { localStorage.setItem("masterDataCache", JSON.stringify(window.masterData)); } catch (e) {}
      closeTenantsCRUD();
      alert("‚úì Tenants saved!");
    }

    function closeTenantsCRUD() {
      const backdrop = document.getElementById("tenantsCRUDBackdrop");
      const modal = document.getElementById("tenantsCRUDModal");
      if (backdrop) backdrop.style.display = "none";
      if (modal) modal.style.display = "none";
    }

    document.getElementById("tenantsCRUDBackdrop")?.addEventListener('click', function(e) {
      if (e.target === this) closeTenantsCRUD();
    });

    // Manager Modal Functions
    function openManagersCRUD() {
      // Close all other modals first
      closeAllModals();
      
      try {
        const cached = localStorage.getItem("masterDataCache");
        if (cached) window.masterData = JSON.parse(cached) || {};
      } catch (e) {}
      if (!window.masterData || typeof window.masterData !== 'object') window.masterData = {};
      
      const tbody = document.getElementById("managersCRUDBody");
      if (!tbody) return;
      tbody.innerHTML = "";
      
      const manager = {
        managerName: window.masterData["Manager_Name"] || "",
        managerPhone: window.masterData["Manager_Phone"] || "",
        superName: window.masterData["Superintendent_Name"] || "",
        superPhone: window.masterData["Superintendent_Phone"] || ""
      };
      
      // Count non-empty records
      const hasManagerData = manager.managerName || manager.managerPhone || manager.superName || manager.superPhone;
      const managersCount = hasManagerData ? 1 : 0;
      
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" value="${window.escapeHtml(manager.managerName || "")}" placeholder="Manager_Name" class="manager-name"></td>
        <td><input type="text" value="${window.escapeHtml(manager.managerPhone || "")}" placeholder="Manager_Phone" class="manager-phone"></td>
        <td><input type="text" value="${window.escapeHtml(manager.superName || "")}" placeholder="Superintendent_Name" class="super-name"></td>
        <td><input type="text" value="${window.escapeHtml(manager.superPhone || "")}" placeholder="Superintendent_Phone" class="super-phone"></td>
        <td style="text-align:center;"><button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove(); updateManagersModalCount();">üóë</button></td>`;
      tbody.appendChild(tr);
      
      // Update modal title with count
      const titleEl = document.getElementById("managersModalTitle");
      if (titleEl) titleEl.textContent = `üëî Manage Managers & Superintendents (${managersCount})`;
      
      document.getElementById("managersCRUDBackdrop").style.display = "block";
      const managersModal = document.getElementById("managersCRUDModal");
      managersModal.style.display = "block";
      positionModalBelowHeader(managersModal);
      setTimeout(() => {
        if (typeof window.initColumnResizers === 'function') {
          window.initColumnResizers();
        }
      }, 100);
    }

    function addManagerRow() {
      const tbody = document.getElementById("managersCRUDBody");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" placeholder="Manager_Name" class="manager-name"></td>
        <td><input type="text" placeholder="Manager_Phone" class="manager-phone"></td>
        <td><input type="text" placeholder="Superintendent_Name" class="super-name"></td>
        <td><input type="text" placeholder="Superintendent_Phone" class="super-phone"></td>
        <td style="text-align:center;"><button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove(); updateManagersModalCount();">üóë</button></td>`;
      tbody.appendChild(tr);
      updateManagersModalCount();
    }

    function saveManagersCRUD() {
      const rows = Array.from(document.querySelectorAll("#managersCRUDBody tr"));
      delete window.masterData["Manager_Name"];
      delete window.masterData["Manager_Phone"];
      delete window.masterData["Superintendent_Name"];
      delete window.masterData["Superintendent_Phone"];
      
      if (rows.length > 0) {
        const row = rows[0];
        const managerName = row.querySelector(".manager-name").value.trim();
        const managerPhone = row.querySelector(".manager-phone").value.trim();
        const superName = row.querySelector(".super-name").value.trim();
        const superPhone = row.querySelector(".super-phone").value.trim();
        if (managerName) window.masterData["Manager_Name"] = managerName;
        if (managerPhone) window.masterData["Manager_Phone"] = managerPhone;
        if (superName) window.masterData["Superintendent_Name"] = superName;
        if (superPhone) window.masterData["Superintendent_Phone"] = superPhone;
      }
      
      try { localStorage.setItem("masterDataCache", JSON.stringify(window.masterData)); } catch (e) {}
      closeManagersCRUD();
      alert("‚úì Managers & Superintendents saved!");
    }

    function closeManagersCRUD() {
      const backdrop = document.getElementById("managersCRUDBackdrop");
      const modal = document.getElementById("managersCRUDModal");
      if (backdrop) backdrop.style.display = "none";
      if (modal) modal.style.display = "none";
    }

    document.getElementById("managersCRUDBackdrop")?.addEventListener('click', function(e) {
      if (e.target === this) closeManagersCRUD();
    });

    // Lease Records Modal Functions
    function getLeaseRecords() {
      try {
        return JSON.parse(localStorage.getItem("leaseRecords") || "[]");
      } catch (e) {
        return [];
      }
    }

    function setLeaseRecords(records) {
      try {
        localStorage.setItem("leaseRecords", JSON.stringify(records || []));
      } catch (e) {}
    }

    function openLeasesCRUD() {
      // Close all other modals first
      closeAllModals();
      
      try {
        const cached = localStorage.getItem("masterDataCache");
        if (cached) window.masterData = JSON.parse(cached) || {};
      } catch (e) {}
      
      const tbody = document.getElementById("leasesCRUDBody");
      if (!tbody) return;
      tbody.innerHTML = "";
      
      const records = getLeaseRecords();
      const leasesCount = records.length;
      
      // Update modal title with count
      const titleEl = document.getElementById("leasesModalTitle");
      if (titleEl) titleEl.textContent = `üìã Manage Leases (${leasesCount})`;
      
      if (records.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:20px; color:#666;">No lease records found. Finalize a lease to create a record.</td></tr>`;
      } else {
        records.forEach((record, index) => {
          const tr = document.createElement("tr");
          tr.dataset.leaseIndex = index;
          tr.innerHTML = `
            <td style="padding: 4px; border: 1px solid #d1d5db;"><input type="text" value="${window.escapeHtml(record.Lease_ID || "")}" readonly style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" class="lease-id"></td>
            <td style="padding: 4px; border: 1px solid #d1d5db;"><input type="text" value="${window.escapeHtml(record.Property_Tag || "")}" readonly style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" class="lease-property-tag"></td>
            <td style="padding: 4px; border: 1px solid #d1d5db;"><input type="text" value="${window.escapeHtml(record.Landlord || "")}" readonly style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" class="lease-landlord"></td>
            <td style="padding: 4px; border: 1px solid #d1d5db;"><textarea readonly style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; min-height: 40px; resize: vertical; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; box-sizing: border-box; font-family: inherit;" class="lease-tenants">${window.escapeHtml(record.Tenants || "")}</textarea></td>
            <td style="padding: 4px; border: 1px solid #d1d5db;"><input type="text" value="${window.escapeHtml(record.Lease_Start_Date || "")}" readonly style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" class="lease-start"></td>
            <td style="padding: 4px; border: 1px solid #d1d5db;"><input type="text" value="${window.escapeHtml(record.Lease_End_Date || "")}" readonly style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" class="lease-end"></td>
            <td style="padding: 4px; border: 1px solid #d1d5db;"><input type="text" value="${window.escapeHtml(record.Monthly_Rent || "")}" readonly style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" class="lease-rent"></td>
            <td style="padding: 4px; border: 1px solid #d1d5db;"><input type="text" value="${window.escapeHtml(record.Security_Deposit || "")}" readonly style="width: 100%; border: none; background: #f9fafb; padding: 4px; font-size: 13px; box-sizing: border-box;" class="lease-deposit"></td>
            <td style="padding: 4px; border: 1px solid #d1d5db;"><textarea placeholder="Notes" style="width: 100%; border: none; background: #fff; padding: 4px; font-size: 13px; min-height: 40px; resize: vertical; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; box-sizing: border-box; font-family: inherit;" class="lease-notes">${window.escapeHtml(record.Notes || "")}</textarea></td>
            <td style="padding: 4px; border: 1px solid #d1d5db; text-align: center;"><button class="pdf-button" style="background:#ef4444; padding: 4px 8px; font-size: 11px; border: none; cursor: pointer;" onclick="deleteLeaseRow(this)">üóë</button></td>`;
          tbody.appendChild(tr);
        });
      }
      
      document.getElementById("leasesCRUDBackdrop").style.display = "block";
      const leasesModal = document.getElementById("leasesCRUDModal");
      leasesModal.style.display = "flex";
      positionModalBelowHeader(leasesModal);
      setTimeout(() => {
        if (typeof window.initColumnResizers === 'function') {
          window.initColumnResizers();
        }
      }, 100);
    }

    function deleteLeaseRow(btn) {
      if (!confirm("Are you sure you want to delete this lease record?")) return;
      const tr = btn.closest("tr");
      const index = parseInt(tr.dataset.leaseIndex);
      const records = getLeaseRecords();
      records.splice(index, 1);
      setLeaseRecords(records);
      openLeasesCRUD();
    }
    
    // Helper functions to update modal titles with counts
    function updatePropertiesModalCount() {
      const tbody = document.getElementById("propertiesCRUDBody");
      if (!tbody) return;
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const count = rows.filter(row => {
        const tag = row.querySelector(".prop-tag")?.value.trim();
        const address = row.querySelector(".prop-address")?.value.trim();
        const landlordName = row.querySelector(".prop-landlord-name")?.value.trim();
        return tag || address || landlordName;
      }).length;
      const titleEl = document.getElementById("propertiesModalTitle");
      if (titleEl) titleEl.textContent = `üè† Manage Properties (${count})`;
    }
    
    function updateTenantsModalCount() {
      const tbody = document.getElementById("tenantsCRUDBody");
      if (!tbody) return;
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const totalCount = rows.filter(row => {
        const name = row.querySelector(".tenant-name")?.value.trim();
        const email = row.querySelector(".tenant-email")?.value.trim();
        const phone = row.querySelector(".tenant-phone")?.value.trim();
        const address = row.querySelector(".tenant-address")?.value.trim();
        const job = row.querySelector(".tenant-job")?.value.trim();
        return name || email || phone || address || job;
      }).length;
      const activeCount = rows.filter(row => {
        const statusSelect = row.querySelector(".tenant-current-status");
        return statusSelect && statusSelect.value === "Active";
      }).length;
      const titleEl = document.getElementById("tenantsModalTitle");
      if (titleEl) titleEl.textContent = `üë• Manage Tenants (${totalCount} total, ${activeCount} Active)`;
    }
    
    function updateManagersModalCount() {
      const tbody = document.getElementById("managersCRUDBody");
      if (!tbody) return;
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const count = rows.filter(row => {
        const managerName = row.querySelector(".manager-name")?.value.trim();
        const managerPhone = row.querySelector(".manager-phone")?.value.trim();
        const superName = row.querySelector(".super-name")?.value.trim();
        const superPhone = row.querySelector(".super-phone")?.value.trim();
        return managerName || managerPhone || superName || superPhone;
      }).length;
      const titleEl = document.getElementById("managersModalTitle");
      if (titleEl) titleEl.textContent = `üëî Manage Managers & Superintendents (${count})`;
    }
    
    function updateInspectionModalCount() {
      const tbody = document.getElementById("inspectionReportCRUDBody");
      if (!tbody) return;
      const rows = tbody.querySelectorAll("tr[data-is-section-header='false']");
      const count = rows.length;
      const titleEl = document.getElementById("inspectionModalTitle");
      if (titleEl) titleEl.textContent = `üìã Manage Inspection Report (${count})`;
    }

    function saveLeasesCRUD() {
      const rows = Array.from(document.querySelectorAll("#leasesCRUDBody tr"));
      const records = getLeaseRecords();
      rows.forEach(row => {
        const index = parseInt(row.dataset.leaseIndex);
        if (index >= 0 && index < records.length) {
          const notesTextarea = row.querySelector(".lease-notes");
          if (notesTextarea) records[index].Notes = notesTextarea.value.trim();
        }
      });
      setLeaseRecords(records);
      closeLeasesCRUD();
      alert("‚úì Lease records updated!");
    }

    function clearAllLeaseRecords() {
      if (confirm("Are you sure you want to delete ALL lease records? This cannot be undone.")) {
        setLeaseRecords([]);
        openLeasesCRUD();
        alert("All lease records cleared!");
      }
    }

    function closeLeasesCRUD() {
      const backdrop = document.getElementById("leasesCRUDBackdrop");
      const modal = document.getElementById("leasesCRUDModal");
      if (backdrop) backdrop.style.display = "none";
      if (modal) modal.style.display = "none";
    }

    document.getElementById("leasesCRUDBackdrop")?.addEventListener('click', function(e) {
      if (e.target === this) closeLeasesCRUD();
    });

    // Inspection Report Modal Functions
    function openInspectionReportCRUD() {
      // Close all other modals first
      closeAllModals();
      
      const tbody = document.getElementById("inspectionReportCRUDBody");
      if (!tbody) return;
      tbody.innerHTML = "";
      
      try {
        const savedData = localStorage.getItem("inspectionReportData");
        if (savedData && typeof XLSX !== 'undefined') {
          const wb = XLSX.read(savedData, { type: 'base64' });
          const sheetName = wb.SheetNames.find(n => n.toLowerCase().includes("inspection")) || wb.SheetNames[0];
          const sheet = wb.Sheets[sheetName];
          if (sheet) {
            const sheetData = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});
            loadInspectionReportData(sheetData);
          }
        } else {
          appendInspectionRow({section: "", comment1: "", code1: "", comment2: "", code2: "", isSectionHeader: false});
        }
      } catch (e) {
        console.error("Error loading inspection report:", e);
        appendInspectionRow({section: "", comment1: "", code1: "", comment2: "", code2: "", isSectionHeader: false});
      }
      
      // Update modal title with count (count non-section header rows)
      setTimeout(() => {
        const tbody = document.getElementById("inspectionReportCRUDBody");
        if (tbody) {
          const rows = tbody.querySelectorAll("tr[data-is-section-header='false']");
          const inspectionCount = rows.length;
          const titleEl = document.getElementById("inspectionModalTitle");
          if (titleEl) titleEl.textContent = `üìã Manage Inspection Report (${inspectionCount})`;
        }
      }, 50);
      
      document.getElementById("inspectionReportCRUDBackdrop").style.display = "block";
      const inspectionModal = document.getElementById("inspectionReportCRUDModal");
      inspectionModal.style.display = "flex";
      positionModalBelowHeader(inspectionModal);
      setTimeout(() => {
        if (typeof window.initColumnResizers === 'function') {
          window.initColumnResizers();
        }
      }, 100);
    }

    function loadInspectionReportData(sheetData) {
      const tbody = document.getElementById("inspectionReportCRUDBody");
      if (!sheetData || sheetData.length === 0) return;
      
      let headerRowIndex = 5;
      if (sheetData.length <= headerRowIndex) {
        for (let i = 0; i < Math.min(10, sheetData.length); i++) {
          const row = sheetData[i];
          if (row && row.length >= 5) {
            const firstCell = String(row[0] || "").trim().toLowerCase();
            const secondCell = String(row[1] || "").trim().toLowerCase();
            if (firstCell.includes("section") && (secondCell.includes("comment") || secondCell.includes("code"))) {
              headerRowIndex = i;
              break;
            }
          }
        }
      }
      
      let currentSection = "";
      for (let i = headerRowIndex + 1; i < sheetData.length; i++) {
        const row = sheetData[i];
        if (!row || row.length === 0) continue;
        const section = String(row[0] || "").trim();
        const comment1 = String(row[1] || "").trim();
        const code1 = String(row[2] || "").trim();
        const comment2 = String(row[3] || "").trim();
        const code2 = String(row[4] || "").trim();
        const isSectionHeader = section && section.length > 0 && (!comment1 && !code1 && !comment2 && !code2) && (section.toLowerCase().includes("overall") || section.toLowerCase().includes("kitchen") || section.toLowerCase().includes("bathroom") || section.toLowerCase().includes("furniture") || section.toLowerCase().includes("refrigerator"));
        if (isSectionHeader) {
          currentSection = section;
          appendInspectionRow({section: section, comment1: "", code1: "", comment2: "", code2: "", isSectionHeader: true});
        } else if (section || comment1 || code1 || comment2 || code2) {
          const fullSection = section || currentSection;
          appendInspectionRow({section: fullSection, comment1: comment1, code1: code1, comment2: comment2, code2: code2, isSectionHeader: false});
        }
      }
      
      if (tbody.children.length === 0) {
        appendInspectionRow({section: "", comment1: "", code1: "", comment2: "", code2: "", isSectionHeader: false});
      }
    }

    function appendInspectionRow(data) {
      const tbody = document.getElementById("inspectionReportCRUDBody");
      const tr = document.createElement("tr");
      tr.dataset.isSectionHeader = data.isSectionHeader ? "true" : "false";
      
      if (data.isSectionHeader) {
        tr.style.backgroundColor = "#000080";
        tr.style.color = "#fff";
        tr.innerHTML = `
          <td><input type="text" value="${window.escapeHtml(data.section || "")}" placeholder="Section Name" style="background:#000080; color:#fff; font-weight:bold; border:1px solid #fff;" class="inspection-section"></td>
          <td colspan="4" style="font-style:italic; padding:4px 6px;">Section Header</td>
          <td style="text-align:center;"><button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove(); updateInspectionModalCount();">üóë</button></td>`;
      } else {
        tr.innerHTML = `
          <td><input type="text" value="${window.escapeHtml(data.section || "")}" placeholder="Sections" class="inspection-section"></td>
          <td><textarea placeholder="Comment" class="inspection-comment1">${window.escapeHtml(data.comment1 || "")}</textarea></td>
          <td><input type="text" value="${window.escapeHtml(data.code1 || "")}" placeholder="Code" style="text-align:center;" class="inspection-code1"></td>
          <td><textarea placeholder="Comment" class="inspection-comment2">${window.escapeHtml(data.comment2 || "")}</textarea></td>
          <td><input type="text" value="${window.escapeHtml(data.code2 || "")}" placeholder="Code" style="text-align:center;" class="inspection-code2"></td>
          <td style="text-align:center;"><button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove(); updateInspectionModalCount();">üóë</button></td>`;
      }
      tbody.appendChild(tr);
      if (!data.isSectionHeader) {
        updateInspectionModalCount();
      }
    }

    function addInspectionRow() {
      appendInspectionRow({section: "", comment1: "", code1: "", comment2: "", code2: "", isSectionHeader: false});
    }

    function saveInspectionReportCRUD() {
      if (typeof XLSX === 'undefined') {
        alert("XLSX library not loaded. Cannot save inspection report.");
        return;
      }
      const rows = Array.from(document.querySelectorAll("#inspectionReportCRUDBody tr"));
      const sheetData = [];
      for (let i = 0; i < 5; i++) sheetData.push(["", "", "", "", ""]);
      sheetData.push(["Sections", "Comment", "Code", "Comment", "Code"]);
      
      rows.forEach(row => {
        const isSectionHeader = row.dataset.isSectionHeader === "true";
        const section = row.querySelector(".inspection-section").value.trim();
        if (isSectionHeader) {
          if (section) sheetData.push([section, "", "", "", ""]);
        } else {
          const comment1 = row.querySelector(".inspection-comment1").value.trim();
          const code1 = row.querySelector(".inspection-code1").value.trim();
          const comment2 = row.querySelector(".inspection-comment2").value.trim();
          const code2 = row.querySelector(".inspection-code2").value.trim();
          if (section || comment1 || code1 || comment2 || code2) {
            sheetData.push([section, comment1, code1, comment2, code2]);
          }
        }
      });
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(sheetData);
      ws['!cols'] = [{wch: 40}, {wch: 15}, {wch: 30}, {wch: 15}, {wch: 30}];
      XLSX.utils.book_append_sheet(wb, ws, "Inspection_Report");
      
      try {
        const wbBase64 = XLSX.write(wb, { type: 'base64', bookType: 'xlsx' });
        localStorage.setItem("inspectionReportData", wbBase64);
      } catch (e) {
        console.error("Error saving inspection report:", e);
      }
      
      closeInspectionReportCRUD();
      alert("‚úì Inspection Report saved!");
    }

    function closeInspectionReportCRUD() {
      const backdrop = document.getElementById("inspectionReportCRUDBackdrop");
      const modal = document.getElementById("inspectionReportCRUDModal");
      if (backdrop) backdrop.style.display = "none";
      if (modal) modal.style.display = "none";
    }

    document.getElementById("inspectionReportCRUDBackdrop")?.addEventListener('click', function(e) {
      if (e.target === this) closeInspectionReportCRUD();
    });
  </script>
</body>
</html>
