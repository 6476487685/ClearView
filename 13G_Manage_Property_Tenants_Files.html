<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Property Tenants Files - Tenancy Data Manager</title>
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1600px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 40px);
    }

    .header {
        padding: 20px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .header h1 {
        margin: 0;
        font-size: 24px;
    }

    .header button {
        background: #ef4444;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .header button:hover {
        background: #dc2626;
        transform: translateY(-1px);
    }

    .main-content {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        padding: 20px;
    }

    .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e5e7eb;
        flex-shrink: 0;
        flex-wrap: wrap;
    }

    .tab-btn {
        padding: 10px 20px;
        border: none;
        background: #e5e7eb;
        color: #374151;
        border-radius: 6px 6px 0 0;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .tab-btn.active {
        background: #3b82f6;
        color: white;
    }

    .tab-btn:hover:not(.active) {
        background: #d1d5db;
    }

    .upload-area {
        margin-bottom: 6px;
        padding: 6px 10px;
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        border: 2px dashed #3b82f6;
        border-radius: 5px;
        display: flex;
        align-items: center;
        flex-shrink: 0;
        gap: 10px;
        cursor: pointer;
        min-height: 36px;
    }

    .upload-area:hover {
        border-color: #1d4ed8;
    }

    .path-bar {
        margin-bottom: 8px;
        padding: 6px 12px;
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        font-size: 12px;
        color: #1e40af;
        font-weight: 500;
    }

    .tab-content {
        flex: 1;
        overflow: hidden;
        min-height: 0;
        display: none;
        flex-direction: column;
    }

    .tab-content.active {
        display: flex;
    }

    .content-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: auto;
        min-height: 0;
        padding: 20px;
        background: #f9fafb;
    }

    .content-container.no-padding {
        padding: 0;
    }

    button.pdf-button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    button.pdf-button:hover {
        background: #2563eb;
        transform: translateY(-1px);
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèòÔ∏è Manage Property Tenants Files</h1>
            <button onclick="window.location.href='index.html'">‚Üê Back to Main Dashboard</button>
        </div>
        
        <div class="main-content">
            <!-- Tabs -->
            <div id="tenancyMainTabs" class="tabs">
                <button class="tab-btn active" onclick="switchTenancyTab('leases')" data-tab="leases">üìã Leases</button>
                <button class="tab-btn" onclick="switchTenancyTab('personalIds')" data-tab="personalIds">üÜî Personal IDs</button>
                <button class="tab-btn" onclick="switchTenancyTab('communications')" data-tab="communications">üìß Communications</button>
                <!-- Property Image Tabs will be dynamically added here -->
            </div>

            <!-- Upload Area (shown for non-image tabs) -->
            <div id="tenancyUploadArea" class="upload-area" onclick="document.getElementById('tenancyFileUpload').click()" ondrop="handleTenancyFileDrop(event)" ondragover="event.preventDefault(); this.style.borderColor='#1d4ed8';" ondragleave="this.style.borderColor='#3b82f6';">
                <div style="font-size: 24px; color: #3b82f6; flex-shrink: 0; line-height: 1;">üìÅ</div>
                <div style="flex: 1; display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; min-width: 0;">
                    <span style="font-size: 12px; font-weight: 500; color: #1e40af; white-space: nowrap;">Drag & drop files here or click to browse</span>
                    <span style="font-size: 10px; color: #1e3a8a; white-space: nowrap;">‚Ä¢ Supports: PDF, DOC, DOCX, XLS, XLSX, TXT, Images</span>
                </div>
                <button class="pdf-button" onclick="event.stopPropagation(); document.getElementById('tenancyFileUpload').click()" style="padding: 5px 14px; font-size: 12px; white-space: nowrap; height: 28px; line-height: 1;">Choose Files</button>
                <input type="file" id="tenancyFileUpload" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.gif" style="display:none;" onchange="handleTenancyFileUpload(event)">
            </div>
            
            <!-- Project Documents Path Bar -->
            <div id="tenancyPathBar" class="path-bar">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 14px;">üìÇ</span>
                    <span>Project Documents Path: <span id="tenancyDocumentsPath" style="color: #1e3a8a;">D:\My_Programs\NS_Lease_Generator</span></span>
                </div>
                <div>
                    Your Documents (<span id="tenancyDocumentsCount">0</span>)
                </div>
            </div>

            <!-- Tab Content: Leases -->
            <div id="tenancyTabLeases" class="tab-content active">
                <div id="tenancyLeasesContainer" class="content-container no-padding">
                    <!-- Table will be rendered here -->
                </div>
            </div>

            <!-- Tab Content: Personal IDs -->
            <div id="tenancyTabPersonalIds" class="tab-content">
                <div id="tenancyPersonalIdsContainer" class="content-container">
                    <!-- Grid will be rendered here -->
                </div>
            </div>

            <!-- Property Image Tabs Content (dynamically generated) -->

            <!-- Tab Content: Communications -->
            <div id="tenancyTabCommunications" class="tab-content">
                <div id="tenancyCommunicationsContainer" class="content-container">
                    <!-- Grid will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <script>
// ====== TENANCY DATA MANAGER ======
let tenancyData = {
    leases: [],
    personalIds: [],
    images: [],
    communications: []
};

let masterData = {};

// Load masterData from localStorage on page load
try {
    const cached = localStorage.getItem("masterDataCache");
    if (cached) {
        masterData = JSON.parse(cached) || {};
    }
} catch (e) {
    console.error("Error loading masterData:", e);
}

function initializeTenancyDataManager() {
    loadTenancyData();
    createPropertyImageTabs();
    switchTenancyTab('leases');
}

function createPropertyImageTabs() {
    const propertyTags = [];
    const propertyKeys = Object.keys(masterData).filter(k => k.startsWith('Property_') && k.endsWith('_Tag'));
    
    propertyKeys.forEach(key => {
        const tag = masterData[key];
        if (tag && !propertyTags.includes(tag)) {
            propertyTags.push(tag);
        }
    });
    
    propertyTags.sort();
    
    const mainTabsContainer = document.getElementById('tenancyMainTabs');
    if (!mainTabsContainer) return;
    
    // Remove existing property image tabs
    const existingPropertyTabs = mainTabsContainer.querySelectorAll('[data-tab^="images_"]');
    existingPropertyTabs.forEach(tab => tab.remove());
    
    const existingPropertyContent = document.querySelectorAll('[id^="tenancyTabImages_"]');
    existingPropertyContent.forEach(content => content.remove());
    
    // Create tabs and content for each property
    propertyTags.forEach(tag => {
        const tabButton = document.createElement('button');
        tabButton.className = 'tab-btn';
        tabButton.setAttribute('data-tab', `images_${tag}`);
        tabButton.setAttribute('onclick', `switchTenancyTab('images_${tag}')`);
        tabButton.textContent = `üè† Images - ${tag}`;
        mainTabsContainer.appendChild(tabButton);
        
        const tabContent = document.createElement('div');
        tabContent.id = `tenancyTabImages_${tag}`;
        tabContent.className = 'tab-content';
        
        const uploadArea = document.createElement('div');
        uploadArea.style.cssText = 'margin-bottom: 10px; padding: 8px 12px; background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; gap: 10px; flex-wrap: wrap;';
        uploadArea.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 200px;">
                <span style="font-size: 20px;">üì§</span>
                <div>
                    <span style="font-size: 13px; font-weight: 500; color: #374151;">Property: <strong style="color: #3b82f6;">${escapeHtml(tag)}</strong></span>
                    <span style="font-size: 11px; color: #6b7280; margin-left: 8px;">(JPG, PNG, GIF)</span>
                    <div id="storageInfo_${tag}" style="font-size: 10px; color: #6b7280; margin-top: 2px;"></div>
                </div>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="pdf-button" onclick="deleteAllPropertyImages('${escapeHtml(tag)}')" style="background:#dc2626; padding: 6px 12px; font-size: 12px; white-space: nowrap;" title="Delete all images for this property">üóëÔ∏è Delete All</button>
                <button class="pdf-button" onclick="removeDuplicateImages('${escapeHtml(tag)}')" style="background:#f59e0b; padding: 6px 12px; font-size: 12px; white-space: nowrap;" title="Remove duplicate images">üóëÔ∏è Remove Duplicates</button>
                <button class="pdf-button" onclick="document.getElementById('tenancyFileUpload_${tag}').click()" style="padding: 6px 16px; font-size: 13px; white-space: nowrap;">Choose Images</button>
            </div>
            <input type="file" id="tenancyFileUpload_${tag}" multiple accept=".jpg,.jpeg,.png,.gif" style="display:none;" onchange="handlePropertyImageUpload(event, '${escapeHtml(tag)}')">
        `;
        tabContent.appendChild(uploadArea);
        
        setTimeout(() => updateStorageInfo(tag), 100);
        
        const imagesContainer = document.createElement('div');
        imagesContainer.id = `tenancyImagesContainer_${tag}`;
        imagesContainer.className = 'content-container';
        imagesContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9ca3af;">
                <div style="font-size: 48px; margin-bottom: 10px;">üè†</div>
                <p>No images for ${escapeHtml(tag)} yet. Upload your first image above!</p>
            </div>
        `;
        tabContent.appendChild(imagesContainer);
        
        const communicationsTab = document.getElementById('tenancyTabCommunications');
        if (communicationsTab && communicationsTab.parentNode) {
            communicationsTab.parentNode.insertBefore(tabContent, communicationsTab);
        } else {
            const lastTabContent = document.querySelector('.tab-content:last-of-type');
            if (lastTabContent && lastTabContent.parentNode) {
                lastTabContent.parentNode.appendChild(tabContent);
            }
        }
    });
}

function switchTenancyTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const uploadArea = document.getElementById('tenancyUploadArea');
    if (uploadArea) {
        if (tabName.startsWith('images_')) {
            uploadArea.style.display = 'none';
        } else {
            uploadArea.style.display = 'flex';
        }
    }
    
    let tabId = '';
    if (tabName.startsWith('images_')) {
        const propertyTag = tabName.replace('images_', '');
        tabId = `tenancyTabImages_${propertyTag}`;
    } else if (tabName === 'personalIds') {
        tabId = 'tenancyTabPersonalIds';
    } else {
        tabId = `tenancyTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`;
    }
    
    const tabContent = document.getElementById(tabId);
    const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
    
    if (tabContent) {
        tabContent.style.display = 'flex';
        tabContent.classList.add('active');
    }
    
    if (tabButton) {
        tabButton.classList.add('active');
    }
    
    refreshTenancyTab(tabName);
}

function refreshTenancyTab(tabName) {
    if (tabName.startsWith('images_')) {
        const propertyTag = tabName.replace('images_', '');
        renderPropertyImagesGrid(propertyTag);
        updateStorageInfo(propertyTag);
    } else {
        switch(tabName) {
            case 'leases':
                renderLeasesTable();
                break;
            case 'personalIds':
                renderPersonalIdsTable();
                break;
            case 'communications':
                renderCommunicationsTable();
                break;
        }
    }
}

function loadTenancyData() {
    try {
        const stored = localStorage.getItem('tenancyData');
        if (stored) {
            const loaded = JSON.parse(stored);
            tenancyData = {
                leases: loaded.leases || [],
                personalIds: loaded.personalIds || [],
                images: (loaded.images || []).map(item => {
                    if (item.base64 && !item.file) {
                        try {
                            let base64Data = item.base64;
                            if (base64Data.includes(',')) {
                                base64Data = base64Data.split(',')[1];
                            }
                            const byteCharacters = atob(base64Data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const mimeType = item.type || item.base64.match(/data:([^;]+)/)?.[1] || 'image/jpeg';
                            const blob = new Blob([byteArray], { type: mimeType });
                            item.file = blob;
                        } catch (e) {
                            console.error('Error converting base64 to blob:', e);
                        }
                    }
                    return item;
                }),
                communications: loaded.communications || []
            };
        }
    } catch (e) {
        console.error('Error loading tenancy data:', e);
        tenancyData = { leases: [], personalIds: [], images: [], communications: [] };
    }
}

function saveTenancyData() {
    try {
        const dataToSave = {
            leases: tenancyData.leases.map(item => {
                const { file, ...rest } = item;
                return rest;
            }),
            personalIds: tenancyData.personalIds.map(item => {
                const { file, ...rest } = item;
                return rest;
            }),
            images: tenancyData.images.map(item => {
                const { file, ...rest } = item;
                return rest;
            }),
            communications: tenancyData.communications.map(item => {
                const { file, ...rest } = item;
                return rest;
            })
        };
        localStorage.setItem('tenancyData', JSON.stringify(dataToSave));
        console.log('Tenancy data saved successfully. Images:', dataToSave.images.length);
    } catch (e) {
        console.error('Error saving tenancy data:', e);
        if (e.name === 'QuotaExceededError') {
            const totalItems = tenancyData.leases.length + tenancyData.personalIds.length + 
                             tenancyData.images.length + tenancyData.communications.length;
            
            if (totalItems > 10) {
                const imagesToRemove = Math.max(1, Math.floor(tenancyData.images.length * 0.2));
                tenancyData.images.sort((a, b) => {
                    const dateA = new Date(a.added || 0);
                    const dateB = new Date(b.added || 0);
                    return dateA - dateB;
                });
                tenancyData.images.splice(0, imagesToRemove);
                
                try {
                    const dataToSave = {
                        leases: tenancyData.leases.map(item => {
                            const { file, ...rest } = item;
                            return rest;
                        }),
                        personalIds: tenancyData.personalIds.map(item => {
                            const { file, ...rest } = item;
                            return rest;
                        }),
                        images: tenancyData.images.map(item => {
                            const { file, ...rest } = item;
                            return rest;
                        }),
                        communications: tenancyData.communications.map(item => {
                            const { file, ...rest } = item;
                            return rest;
                        })
                    };
                    localStorage.setItem('tenancyData', JSON.stringify(dataToSave));
                    showUploadNotification(`‚ö†Ô∏è Storage full. Automatically removed ${imagesToRemove} old image(s) to make space.`, 'warning');
                    return;
                } catch (e2) {
                    showUploadNotification('‚ö†Ô∏è Storage quota exceeded. Please delete some old files manually.', 'warning');
                }
            } else {
                showUploadNotification('‚ö†Ô∏è Storage quota exceeded. Please delete some old files.', 'warning');
            }
        }
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function isImageFile(filename) {
    const imageExts = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    return imageExts.some(ext => filename.toLowerCase().endsWith(ext));
}

function getFileType(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const types = {
        'pdf': 'PDF',
        'doc': 'DOC',
        'docx': 'DOCX',
        'xls': 'XLS',
        'xlsx': 'XLSX',
        'jpg': 'JPG',
        'jpeg': 'JPEG',
        'png': 'PNG',
        'gif': 'GIF'
    };
    return types[ext] || ext.toUpperCase();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function getFileTypeDisplay(fileName, mimeType) {
    if (!fileName && !mimeType) return 'Unknown';
    const name = (fileName || '').toLowerCase();
    const type = (mimeType || '').toLowerCase();
    
    if (name.endsWith('.pdf') || type.includes('pdf')) return 'PDF Document';
    if (name.endsWith('.doc') || name.endsWith('.docx') || type.includes('word') || type.includes('document')) return 'Word Document';
    if (name.endsWith('.xls') || name.endsWith('.xlsx') || type.includes('excel') || type.includes('spreadsheet')) return 'Excel Spreadsheet';
    if (name.endsWith('.txt') || type.includes('text')) return 'Text File';
    if (name.endsWith('.jpg') || name.endsWith('.jpeg') || type.includes('jpeg')) return 'JPEG Image';
    if (name.endsWith('.png') || type.includes('png')) return 'PNG Image';
    if (name.endsWith('.gif') || type.includes('gif')) return 'GIF Image';
    
    return 'Document';
}

function getStorageUsage() {
    let totalSize = 0;
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key) {
            const value = localStorage.getItem(key);
            totalSize += value ? value.length : 0;
        }
    }
    return totalSize;
}

function formatStorageSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function showUploadNotification(message, type = 'info') {
    let notification = document.getElementById('uploadNotification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'uploadNotification';
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #3b82f6; color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; font-weight: 500; max-width: 300px;';
        document.body.appendChild(notification);
    }
    
    if (type === 'success') {
        notification.style.background = '#10b981';
    } else if (type === 'warning') {
        notification.style.background = '#f59e0b';
    } else {
        notification.style.background = '#3b82f6';
    }
    
    notification.textContent = message;
    notification.style.display = 'block';
}

function hideUploadNotification() {
    const notification = document.getElementById('uploadNotification');
    if (notification) {
        notification.style.display = 'none';
    }
}

function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.6) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                const originalSize = file.size;
                const compressedSize = Math.round((compressedBase64.length - 22) * 0.75);
                const compressionRatio = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                
                resolve({
                    base64: compressedBase64,
                    originalSize: originalSize,
                    compressedSize: compressedSize,
                    compressionRatio: compressionRatio
                });
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function handleTenancyFileUpload(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    const activeTab = document.querySelector('.tab-btn.active');
    const tabName = activeTab ? activeTab.dataset.tab : 'leases';
    
    const imageFiles = files.filter(f => isImageFile(f.name));
    const hasImages = imageFiles.length > 0;
    showUploadNotification(`${hasImages ? 'Compressing and ' : ''}Uploading ${files.length} file(s)...`);
    
    let processedCount = 0;
    let uploadedCount = 0;
    let totalOriginalSize = 0;
    let totalCompressedSize = 0;
    const uploadedFileIds = [];
    
    files.forEach((file, index) => {
        totalOriginalSize += file.size;
        const isImage = isImageFile(file.name);
        const fileId = Date.now() + Math.random() + index;
        uploadedFileIds.push(fileId);
        
        if (isImage && (tabName === 'personalIds' || tabName === 'leases' || tabName === 'communications')) {
            compressImage(file, 800, 600, 0.6).then(result => {
                const fileData = {
                    id: fileId,
                    name: file.name,
                    type: 'image/jpeg',
                    size: formatFileSize(result.compressedSize),
                    sizeBytes: result.compressedSize,
                    originalSizeBytes: result.originalSize,
                    added: new Date().toLocaleString(),
                    base64: result.base64
                };
                
                if (tabName === 'personalIds') {
                    fileData.category = 'personalIds';
                    fileData.tenantName = '';
                    tenancyData.personalIds.push(fileData);
                } else if (tabName === 'communications') {
                    fileData.category = 'communications';
                    fileData.commType = '';
                    fileData.recipient = '';
                    tenancyData.communications.push(fileData);
                } else {
                    fileData.category = 'leases';
                    fileData.leaseId = '';
                    tenancyData.leases.push(fileData);
                }
                
                totalCompressedSize += result.compressedSize;
                uploadedCount++;
                processedCount++;
                
                if (processedCount === files.length) {
                    try {
                        saveTenancyData();
                        refreshTenancyTab(tabName);
                        const savedSpace = hasImages ? ((1 - totalCompressedSize / totalOriginalSize) * 100).toFixed(1) : 0;
                        const storageUsed = formatStorageSize(getStorageUsage());
                        const message = hasImages 
                            ? `‚úì Uploaded ${uploadedCount} file(s)! Saved ${savedSpace}% space. Storage: ${storageUsed}`
                            : `‚úì Successfully uploaded ${uploadedCount} file(s)! Storage: ${storageUsed}`;
                        showUploadNotification(message, 'success');
                        setTimeout(() => hideUploadNotification(), 4000);
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            if (tabName === 'personalIds') {
                                tenancyData.personalIds = tenancyData.personalIds.filter(item => !uploadedFileIds.includes(item.id));
                            } else if (tabName === 'communications') {
                                tenancyData.communications = tenancyData.communications.filter(item => !uploadedFileIds.includes(item.id));
                            } else {
                                tenancyData.leases = tenancyData.leases.filter(item => !uploadedFileIds.includes(item.id));
                            }
                            showUploadNotification(`‚ö†Ô∏è Storage quota exceeded! Please delete some old files. Current storage: ${formatStorageSize(getStorageUsage())}`, 'warning');
                            setTimeout(() => hideUploadNotification(), 5000);
                        } else {
                            showUploadNotification('‚ö†Ô∏è Error saving files: ' + e.message, 'warning');
                            setTimeout(() => hideUploadNotification(), 3000);
                        }
                    }
                }
            }).catch(error => {
                console.error('Error compressing file:', file.name, error);
                processedCount++;
                if (processedCount === files.length) {
                    saveTenancyData();
                    refreshTenancyTab(tabName);
                    showUploadNotification('‚ö† Some files may not have uploaded correctly', 'warning');
                    setTimeout(() => hideUploadNotification(), 3000);
                }
            });
        } else {
            const fileData = {
                id: fileId,
                name: file.name,
                type: file.type || getFileType(file.name),
                size: formatFileSize(file.size),
                sizeBytes: file.size,
                added: new Date().toLocaleString(),
                base64: null,
                file: file
            };
            
            if (tabName === 'personalIds') {
                fileData.category = 'personalIds';
                fileData.tenantName = '';
                tenancyData.personalIds.push(fileData);
            } else if (tabName === 'communications') {
                fileData.category = 'communications';
                fileData.commType = '';
                fileData.recipient = '';
                tenancyData.communications.push(fileData);
            } else {
                fileData.category = 'leases';
                fileData.leaseId = '';
                tenancyData.leases.push(fileData);
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                fileData.base64 = e.target.result;
                totalCompressedSize += file.size * 1.33;
                uploadedCount++;
                processedCount++;
                
                if (processedCount === files.length) {
                    try {
                        saveTenancyData();
                        refreshTenancyTab(tabName);
                        const storageUsed = formatStorageSize(getStorageUsage());
                        showUploadNotification(`‚úì Successfully uploaded ${uploadedCount} file(s)! Storage: ${storageUsed}`, 'success');
                        setTimeout(() => hideUploadNotification(), 4000);
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            if (tabName === 'personalIds') {
                                tenancyData.personalIds = tenancyData.personalIds.filter(item => !uploadedFileIds.includes(item.id));
                            } else if (tabName === 'communications') {
                                tenancyData.communications = tenancyData.communications.filter(item => !uploadedFileIds.includes(item.id));
                            } else {
                                tenancyData.leases = tenancyData.leases.filter(item => !uploadedFileIds.includes(item.id));
                            }
                            showUploadNotification(`‚ö†Ô∏è Storage quota exceeded! Please delete some old files. Current storage: ${formatStorageSize(getStorageUsage())}`, 'warning');
                            setTimeout(() => hideUploadNotification(), 5000);
                        } else {
                            showUploadNotification('‚ö†Ô∏è Error saving files: ' + e.message, 'warning');
                            setTimeout(() => hideUploadNotification(), 3000);
                        }
                    }
                }
            };
            reader.onerror = function(error) {
                console.error('Error reading file:', file.name, error);
                processedCount++;
                if (processedCount === files.length) {
                    saveTenancyData();
                    refreshTenancyTab(tabName);
                    showUploadNotification('‚ö† Some files may not have uploaded correctly', 'warning');
                    setTimeout(() => hideUploadNotification(), 3000);
                }
            };
            reader.readAsDataURL(file);
        }
    });
    
    refreshTenancyTab(tabName);
    event.target.value = '';
}

function handleTenancyFileDrop(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const uploadArea = document.getElementById('tenancyUploadArea');
    if (uploadArea) {
        uploadArea.style.borderColor = '#3b82f6';
    }
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const input = document.getElementById('tenancyFileUpload');
        if (input) {
            const dataTransfer = new DataTransfer();
            Array.from(files).forEach(file => dataTransfer.items.add(file));
            input.files = dataTransfer.files;
            handleTenancyFileUpload({ target: input });
        }
    }
}

function updateStorageInfo(propertyTag) {
    const storageInfoEl = document.getElementById(`storageInfo_${propertyTag}`);
    if (!storageInfoEl) return;
    
    const storageUsed = getStorageUsage();
    const maxStorage = 5 * 1024 * 1024;
    const percentUsed = ((storageUsed / maxStorage) * 100).toFixed(1);
    const propertyImages = tenancyData.images.filter(img => (img.propertyTag || '') === propertyTag);
    const propertySize = propertyImages.reduce((sum, img) => sum + (img.sizeBytes || 0), 0);
    
    let color = '#10b981';
    if (percentUsed > 80) color = '#ef4444';
    else if (percentUsed > 60) color = '#f59e0b';
    
    storageInfoEl.innerHTML = `
        Storage: <strong style="color: ${color};">${formatStorageSize(storageUsed)} / ${formatStorageSize(maxStorage)} (${percentUsed}%)</strong> | 
        This property: ${propertyImages.length} images (${formatStorageSize(propertySize)})
    `;
}

function handlePropertyImageUpload(event, propertyTag) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    const imageFiles = files.filter(f => isImageFile(f.name));
    if (imageFiles.length === 0) {
        alert('Please select image files only (JPG, PNG, GIF)');
        return;
    }
    
    showUploadNotification(`Compressing and uploading ${imageFiles.length} image(s) for ${propertyTag}...`);
    
    let processedCount = 0;
    let totalOriginalSize = 0;
    let totalCompressedSize = 0;
    
    imageFiles.forEach((file, index) => {
        totalOriginalSize += file.size;
        
        compressImage(file, 800, 600, 0.6).then(result => {
            const fileData = {
                id: Date.now() + Math.random() + index,
                name: file.name,
                type: 'image/jpeg',
                size: formatFileSize(result.compressedSize),
                sizeBytes: result.compressedSize,
                originalSizeBytes: result.originalSize,
                added: new Date().toLocaleString(),
                base64: result.base64,
                propertyTag: propertyTag
            };
            
            tenancyData.images.push(fileData);
            totalCompressedSize += result.compressedSize;
            processedCount++;
            
            if (processedCount === imageFiles.length) {
                try {
                    saveTenancyData();
                    renderPropertyImagesGrid(propertyTag);
                    updateStorageInfo(propertyTag);
                    const savedSpace = ((1 - totalCompressedSize / totalOriginalSize) * 100).toFixed(1);
                    const storageUsed = formatStorageSize(getStorageUsage());
                    showUploadNotification(`‚úì Uploaded ${imageFiles.length} image(s)! Saved ${savedSpace}% space. Storage: ${storageUsed}`, 'success');
                    setTimeout(() => hideUploadNotification(), 4000);
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        tenancyData.images = tenancyData.images.filter(img => !imageFiles.some((f, i) => img.id === Date.now() + Math.random() + i));
                        showUploadNotification(`‚ö†Ô∏è Storage quota exceeded! Please delete some old images. Current storage: ${formatStorageSize(getStorageUsage())}`, 'warning');
                        setTimeout(() => hideUploadNotification(), 5000);
                    } else {
                        showUploadNotification('‚ö†Ô∏è Error saving images: ' + e.message, 'warning');
                        setTimeout(() => hideUploadNotification(), 3000);
                    }
                }
            }
        }).catch(error => {
            console.error('Error compressing image:', file.name, error);
            processedCount++;
            if (processedCount === imageFiles.length) {
                saveTenancyData();
                renderPropertyImagesGrid(propertyTag);
                showUploadNotification('‚ö† Some images may not have uploaded correctly', 'warning');
                setTimeout(() => hideUploadNotification(), 3000);
            }
        });
    });
    
    renderPropertyImagesGrid(propertyTag);
    event.target.value = '';
}

function renderLeasesTable() {
    const container = document.getElementById('tenancyLeasesContainer');
    if (!container) return;
    
    const countElement = document.getElementById('tenancyDocumentsCount');
    if (countElement) {
        countElement.textContent = tenancyData.leases.length;
    }
    
    if (tenancyData.leases.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9ca3af; width: 100%;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
                <p>No lease documents yet. Upload your first document above!</p>
            </div>
        `;
        return;
    }
    
    const rowsHTML = tenancyData.leases.map((item, index) => {
        const itemId = String(item.id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const itemName = escapeHtml(item.name);
        const itemSize = escapeHtml(item.size);
        const itemTypeDisplay = getFileTypeDisplay(item.name, item.type);
        const itemAdded = escapeHtml(item.added || new Date().toLocaleString());
        const isFirst = index === 0;
        const isLast = index === tenancyData.leases.length - 1;
        
        return `
            <tr style="border-bottom: 1px solid #e5e7eb; background: #fff;" onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='#fff';">
                <td style="padding: 12px 15px; font-size: 14px; color: #111827; font-weight: 500;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 18px;">üìÑ</span>
                        <span style="cursor: pointer; text-decoration: underline; color: #3b82f6;" onclick="previewTenancyFile('leases', '${itemId}')" title="${itemName}">${itemName}</span>
                    </div>
                </td>
                <td style="padding: 12px 15px; font-size: 14px; color: #374151;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">üìÑ</span>
                        <span>${itemTypeDisplay}</span>
                    </div>
                </td>
                <td style="padding: 12px 15px; font-size: 14px; color: #374151;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">üõçÔ∏è</span>
                        <span>${itemSize}</span>
                    </div>
                </td>
                <td style="padding: 12px 15px; font-size: 14px; color: #374151;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">üìÖ</span>
                        <span>${itemAdded}</span>
                    </div>
                </td>
                <td style="padding: 12px 15px; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                        <button onclick="downloadTenancyFile('leases', '${itemId}')" style="background: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;" title="Download">‚¨áÔ∏è</button>
                        <button onclick="moveLeaseItem('${itemId}', 'up')" style="background: ${isFirst ? '#d1d5db' : '#10b981'}; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: ${isFirst ? 'not-allowed' : 'pointer'}; font-size: 16px; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; opacity: ${isFirst ? '0.5' : '1'};" title="Move Up" ${isFirst ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                        <button onclick="moveLeaseItem('${itemId}', 'down')" style="background: ${isLast ? '#d1d5db' : '#10b981'}; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: ${isLast ? 'not-allowed' : 'pointer'}; font-size: 16px; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; opacity: ${isLast ? '0.5' : '1'};" title="Move Down" ${isLast ? 'disabled' : ''}>‚¨áÔ∏è</button>
                        <button onclick="deleteTenancyItem('leases', '${itemId}')" style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;" title="Delete">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="padding: 0; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                        <th style="padding: 12px 15px; text-align: left; font-size: 14px; font-weight: 600;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">üìÑ</span>
                                <span>NAME</span>
                            </div>
                        </th>
                        <th style="padding: 12px 15px; text-align: left; font-size: 14px; font-weight: 600;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">üìÑ</span>
                                <span>TYPE</span>
                            </div>
                        </th>
                        <th style="padding: 12px 15px; text-align: left; font-size: 14px; font-weight: 600;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">üõçÔ∏è</span>
                                <span>SIZE</span>
                            </div>
                        </th>
                        <th style="padding: 12px 15px; text-align: left; font-size: 14px; font-weight: 600;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">üìÖ</span>
                                <span>ADDED</span>
                            </div>
                        </th>
                        <th style="padding: 12px 15px; text-align: center; font-size: 14px; font-weight: 600;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span style="font-size: 16px;">‚öôÔ∏è</span>
                                <span>ACTIONS</span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    ${rowsHTML}
                </tbody>
            </table>
        </div>
    `;
}

function renderPersonalIdsTable() {
    const container = document.getElementById('tenancyPersonalIdsContainer');
    if (!container) return;
    
    if (tenancyData.personalIds.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9ca3af; width: 100%;">
                <div style="font-size: 48px; margin-bottom: 10px;">üÜî</div>
                <p>No personal ID documents yet. Upload your first document above!</p>
            </div>
        `;
        return;
    }
    
    const filesHTML = tenancyData.personalIds.map(item => {
        const itemId = String(item.id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const itemName = escapeHtml(item.name);
        const itemSize = escapeHtml(item.size);
        const itemType = escapeHtml(item.type || '');
        const itemAdded = escapeHtml(item.added || '');
        const itemTenantName = escapeHtml(item.tenantName || '');
        const isImage = isImageFile(item.name);
        
        let previewUrl = '';
        if (item.file && (item.file instanceof Blob || item.file instanceof File)) {
            previewUrl = URL.createObjectURL(item.file);
        } else if (item.base64) {
            previewUrl = item.base64;
        }
        
        const safePreviewUrl = previewUrl.replace(/'/g, "&#39;").replace(/"/g, '&quot;');
        
        let previewHTML = '';
        if (isImage && previewUrl) {
            previewHTML = `<img src="${safePreviewUrl}" alt="${itemName}" style="width: 100%; height: 100%; object-fit: cover; display: block;">`;
        } else if (item.type && item.type.toLowerCase().includes('pdf')) {
            previewHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #ef4444; color: white; font-size: 48px;">üìÑ</div>`;
        } else {
            previewHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #3b82f6; color: white; font-size: 48px;">üÜî</div>`;
        }
        
        return `
            <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                <div style="position: relative; margin-bottom: 10px; height: 180px; background: #f3f4f6; border-radius: 8px; overflow: hidden; cursor: pointer;" onclick="previewTenancyFile('personalIds', '${itemId}')">
                    ${previewHTML}
                </div>
                <div style="font-size: 13px; color: #374151; font-weight: 500; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${itemName}">${itemName}</div>
                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 5px;">${itemType} ‚Ä¢ ${itemSize}</div>
                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 10px;">${itemAdded}</div>
                <input type="text" value="${itemTenantName}" placeholder="Tenant Name" onchange="updateTenancyItem('personalIds', '${itemId}', 'tenantName', this.value)" style="width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                <div style="display: flex; gap: 5px;">
                    <button class="pdf-button" onclick="event.stopPropagation(); downloadTenancyFile('personalIds', '${itemId}')" style="background:#3b82f6; padding:6px 12px; font-size:12px; flex: 1; border-radius: 6px;">‚¨áÔ∏è</button>
                    <button class="pdf-button" onclick="event.stopPropagation(); deleteTenancyItem('personalIds', '${itemId}')" style="background:#ef4444; padding:6px 12px; font-size:12px; border-radius: 6px;">üóë</button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
            ${filesHTML}
        </div>
    `;
}

function renderCommunicationsTable() {
    const container = document.getElementById('tenancyCommunicationsContainer');
    if (!container) return;
    
    if (tenancyData.communications.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9ca3af; width: 100%;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìß</div>
                <p>No communications yet. Upload your first document above!</p>
            </div>
        `;
        return;
    }
    
    const filesHTML = tenancyData.communications.map(item => {
        const itemId = String(item.id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const itemName = escapeHtml(item.name);
        const itemSize = escapeHtml(item.size);
        const itemType = escapeHtml(item.type || '');
        const itemAdded = escapeHtml(item.added || '');
        const isImage = isImageFile(item.name);
        
        let previewUrl = '';
        if (item.file && (item.file instanceof Blob || item.file instanceof File)) {
            previewUrl = URL.createObjectURL(item.file);
        } else if (item.base64) {
            previewUrl = item.base64;
        }
        
        const safePreviewUrl = previewUrl.replace(/'/g, "&#39;").replace(/"/g, '&quot;');
        
        let previewHTML = '';
        if (isImage && previewUrl) {
            previewHTML = `<img src="${safePreviewUrl}" alt="${itemName}" style="width: 100%; height: 100%; object-fit: cover; display: block;">`;
        } else if (item.type && item.type.toLowerCase().includes('pdf')) {
            previewHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #ef4444; color: white; font-size: 48px;">üìÑ</div>`;
        } else {
            previewHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #8b5cf6; color: white; font-size: 48px;">üìß</div>`;
        }
        
        return `
            <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                <div style="position: relative; margin-bottom: 10px; height: 180px; background: #f3f4f6; border-radius: 8px; overflow: hidden; cursor: pointer;" onclick="previewTenancyFile('communications', '${itemId}')">
                    ${previewHTML}
                </div>
                <div style="font-size: 13px; color: #374151; font-weight: 500; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${itemName}">${itemName}</div>
                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 5px;">${itemType} ‚Ä¢ ${itemSize}</div>
                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 10px;">${itemAdded}</div>
                <div style="display: flex; gap: 5px;">
                    <button class="pdf-button" onclick="event.stopPropagation(); downloadTenancyFile('communications', '${itemId}')" style="background:#3b82f6; padding:6px 12px; font-size:12px; flex: 1; border-radius: 6px;">‚¨áÔ∏è</button>
                    <button class="pdf-button" onclick="event.stopPropagation(); deleteTenancyItem('communications', '${itemId}')" style="background:#ef4444; padding:6px 12px; font-size:12px; border-radius: 6px;">üóë</button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
            ${filesHTML}
        </div>
    `;
}

function renderPropertyImagesGrid(propertyTag) {
    const container = document.getElementById(`tenancyImagesContainer_${propertyTag}`);
    if (!container) {
        console.error('Image container not found for property:', propertyTag);
        return;
    }
    
    const filteredImages = (tenancyData.images || []).filter(img => (img.propertyTag || '') === propertyTag);
    
    if (filteredImages.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9ca3af; width: 100%;">
                <div style="font-size: 48px; margin-bottom: 10px;">üè†</div>
                <p>No images for ${escapeHtml(propertyTag)} yet. Upload your first image above!</p>
            </div>
        `;
        return;
    }
    
    const imagesHTML = filteredImages.map((item, idx) => {
        let imageUrl = '';
        try {
            if (item.file) {
                if (item.file instanceof Blob || item.file instanceof File) {
                    imageUrl = URL.createObjectURL(item.file);
                } else {
                    if (item.base64) {
                        imageUrl = item.base64;
                    }
                }
            } else if (item.base64) {
                imageUrl = item.base64;
            } else {
                imageUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlPC90ZXh0Pjwvc3ZnPg==';
            }
            
            if (!imageUrl || imageUrl === '#') {
                imageUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlPC90ZXh0Pjwvc3ZnPg==';
            }
        } catch (e) {
            console.error('Error creating image URL:', e, item);
            imageUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlPC90ZXh0Pjwvc3ZnPg==';
        }
        
        const itemId = String(item.id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const itemName = escapeHtml(item.name);
        const itemSize = escapeHtml(item.size);
        const safeImageUrl = imageUrl.replace(/'/g, "&#39;").replace(/"/g, '&quot;');
        
        return `
            <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                <div style="position: relative; margin-bottom: 10px; height: 180px; background: #f3f4f6; border-radius: 8px; overflow: hidden;">
                    <img src="${safeImageUrl}" alt="${itemName}" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer; display: block;" onclick="viewImageFullscreen('${itemId}')" onerror="console.error('Image failed to load:', '${itemName}'); this.style.display='none'; this.parentElement.innerHTML='<div style=display:flex;align-items:center;justify-content:center;height:100%;color:#9ca3af;>Image Error</div>';">
                </div>
                <div style="font-size: 13px; color: #374151; font-weight: 500; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${itemName}">${itemName}</div>
                <div style="font-size: 11px; color: #9ca3af; margin-bottom: 10px;">${itemSize}</div>
                <div style="display: flex; gap: 5px;">
                    <button class="pdf-button" onclick="downloadTenancyFile('images', '${itemId}')" style="background:#3b82f6; padding:6px 12px; font-size:12px; flex: 1; border-radius: 6px;">‚¨áÔ∏è</button>
                    <button class="pdf-button" onclick="deleteTenancyItem('images', '${itemId}')" style="background:#ef4444; padding:6px 12px; font-size:12px; border-radius: 6px;">üóë</button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px;">
            ${imagesHTML}
        </div>
    `;
}

function updateTenancyItem(category, id, field, value) {
    const item = tenancyData[category].find(i => i.id == id);
    if (item) {
        item[field] = value;
        saveTenancyData();
    }
}

function moveLeaseItem(id, direction) {
    const index = tenancyData.leases.findIndex(item => String(item.id) === String(id));
    if (index === -1) return;
    
    if (direction === 'up' && index > 0) {
        [tenancyData.leases[index - 1], tenancyData.leases[index]] = [tenancyData.leases[index], tenancyData.leases[index - 1]];
        saveTenancyData();
        renderLeasesTable();
    } else if (direction === 'down' && index < tenancyData.leases.length - 1) {
        [tenancyData.leases[index], tenancyData.leases[index + 1]] = [tenancyData.leases[index + 1], tenancyData.leases[index]];
        saveTenancyData();
        renderLeasesTable();
    }
}

function deleteTenancyItem(category, id) {
    if (!confirm('Are you sure you want to delete this item?')) return;
    
    if (category === 'images') {
        const item = tenancyData.images.find(i => i.id == id);
        const propertyTag = item ? item.propertyTag : null;
        tenancyData.images = tenancyData.images.filter(i => i.id != id);
        saveTenancyData();
        if (propertyTag) {
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab && activeTab.dataset.tab === `images_${propertyTag}`) {
                renderPropertyImagesGrid(propertyTag);
                updateStorageInfo(propertyTag);
            }
        }
    } else {
        tenancyData[category] = tenancyData[category].filter(i => i.id != id);
        saveTenancyData();
        refreshTenancyTab(category === 'personalIds' ? 'personalIds' : category);
    }
}

function deleteAllPropertyImages(propertyTag) {
    const propertyImages = tenancyData.images.filter(img => (img.propertyTag || '') === propertyTag);
    const imageCount = propertyImages.length;
    
    if (imageCount === 0) {
        alert(`No images found for property "${propertyTag}".`);
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ALL ${imageCount} image(s) for property "${propertyTag}"? This action cannot be undone!`)) {
        return;
    }
    
    if (!confirm(`Final confirmation: Delete all ${imageCount} image(s) for "${propertyTag}"?`)) {
        return;
    }
    
    tenancyData.images = tenancyData.images.filter(img => (img.propertyTag || '') !== propertyTag);
    saveTenancyData();
    renderPropertyImagesGrid(propertyTag);
    updateStorageInfo(propertyTag);
    alert(`Successfully deleted all ${imageCount} image(s) for property "${propertyTag}".`);
}

function removeDuplicateImages(propertyTag) {
    if (!confirm(`Remove duplicate images for property "${propertyTag}"? This will keep only unique images based on file content.`)) {
        return;
    }
    
    const propertyImages = tenancyData.images.filter(img => (img.propertyTag || '') === propertyTag);
    
    if (propertyImages.length === 0) {
        alert('No images found for this property.');
        return;
    }
    
    const seen = new Map();
    const duplicates = [];
    const unique = [];
    
    propertyImages.forEach(img => {
        let contentHash = '';
        
        if (img.base64) {
            const base64Data = img.base64.includes(',') ? img.base64.split(',')[1] : img.base64;
            if (base64Data.length > 10000) {
                const mid = Math.floor(base64Data.length / 2);
                contentHash = base64Data.substring(0, 500) + base64Data.substring(mid - 250, mid + 250) + base64Data.substring(base64Data.length - 500);
            } else {
                contentHash = base64Data;
            }
        } else {
            contentHash = `${(img.name || '').toLowerCase()}_${img.sizeBytes || 0}`;
        }
        
        if (seen.has(contentHash)) {
            duplicates.push(img.id);
        } else {
            seen.set(contentHash, img);
            unique.push(img);
        }
    });
    
    if (duplicates.length === 0) {
        alert('No duplicate images found. All images are unique.');
        return;
    }
    
    tenancyData.images = tenancyData.images.filter(img => !duplicates.includes(img.id));
    saveTenancyData();
    renderPropertyImagesGrid(propertyTag);
    updateStorageInfo(propertyTag);
    alert(`Removed ${duplicates.length} duplicate image(s). Kept ${unique.length} unique image(s).`);
}

function downloadTenancyFile(category, id) {
    const item = tenancyData[category].find(i => i.id == id);
    if (!item) {
        alert('File not available for download.');
        return;
    }
    
    let url = '';
    let shouldRevoke = false;
    
    if (item.file) {
        url = URL.createObjectURL(item.file);
        shouldRevoke = true;
    } else if (item.base64) {
        url = item.base64;
    } else {
        alert('File not available for download.');
        return;
    }
    
    const a = document.createElement('a');
    a.href = url;
    a.download = item.name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    if (shouldRevoke) {
        URL.revokeObjectURL(url);
    }
}

function viewImageFullscreen(imageId) {
    const item = tenancyData.images.find(i => i.id == imageId);
    if (!item) return;
    
    const propertyTag = item.propertyTag || '';
    const propertyImages = tenancyData.images.filter(img => (img.propertyTag || '') === propertyTag);
    const currentIndex = propertyImages.findIndex(img => img.id == imageId);
    
    if (currentIndex === -1) {
        alert('Image not found');
        return;
    }
    
    let currentImageIndex = currentIndex;
    let currentImageUrl = '';
    let currentShouldRevoke = false;
    let currentItem = item;
    
    const modal = document.createElement('div');
    modal.id = 'fullscreenImageModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
    
    const getImageUrl = (imgItem) => {
        let url = '';
        let shouldRevoke = false;
        if (imgItem.file) {
            url = URL.createObjectURL(imgItem.file);
            shouldRevoke = true;
        } else if (imgItem.base64) {
            url = imgItem.base64;
        }
        return { url, shouldRevoke };
    };
    
    let img, imgName, prevBtn, nextBtn;
    
    const updateImage = () => {
        currentItem = propertyImages[currentImageIndex];
        const { url, shouldRevoke } = getImageUrl(currentItem);
        
        if (currentShouldRevoke && currentImageUrl.startsWith('blob:')) {
            URL.revokeObjectURL(currentImageUrl);
        }
        
        currentImageUrl = url;
        currentShouldRevoke = shouldRevoke;
        
        img.src = currentImageUrl;
        img.alt = currentItem.name || 'Fullscreen image';
        imgName.textContent = `${currentImageIndex + 1} / ${propertyImages.length} - ${currentItem.name || ''}`;
        
        prevBtn.style.opacity = currentImageIndex === 0 ? '0.3' : '1';
        prevBtn.style.cursor = currentImageIndex === 0 ? 'not-allowed' : 'pointer';
        nextBtn.style.opacity = currentImageIndex === propertyImages.length - 1 ? '0.3' : '1';
        nextBtn.style.cursor = currentImageIndex === propertyImages.length - 1 ? 'not-allowed' : 'pointer';
    };
    
    const showPrevious = (e) => {
        if (e) e.stopPropagation();
        if (currentImageIndex > 0) {
            currentImageIndex--;
            updateImage();
        }
    };
    
    const showNext = (e) => {
        if (e) e.stopPropagation();
        if (currentImageIndex < propertyImages.length - 1) {
            currentImageIndex++;
            updateImage();
        }
    };
    
    const closeModal = () => {
        if (document.body.contains(modal)) {
            document.body.removeChild(modal);
        }
        if (currentShouldRevoke && currentImageUrl.startsWith('blob:')) {
            URL.revokeObjectURL(currentImageUrl);
        }
        document.removeEventListener('keydown', keyHandler);
    };
    
    const keyHandler = (e) => {
        if (e.key === 'Escape' || e.keyCode === 27) {
            closeModal();
        } else if (e.key === 'ArrowLeft' || e.keyCode === 37) {
            showPrevious(e);
        } else if (e.key === 'ArrowRight' || e.keyCode === 39) {
            showNext(e);
        }
    };
    
    modal.onclick = (e) => {
        if (e.target === modal) {
            closeModal();
        }
    };
    
    document.addEventListener('keydown', keyHandler);
    
    const { url, shouldRevoke } = getImageUrl(currentItem);
    currentImageUrl = url;
    currentShouldRevoke = shouldRevoke;
    
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '‚úï';
    closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); color: #000; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s;';
    closeBtn.onclick = (e) => {
        e.stopPropagation();
        closeModal();
    };
    
    prevBtn = document.createElement('button');
    prevBtn.innerHTML = '‚Äπ';
    prevBtn.style.cssText = 'position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); color: #000; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 36px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s; line-height: 1;';
    prevBtn.onclick = showPrevious;
    if (currentImageIndex === 0) {
        prevBtn.style.opacity = '0.3';
        prevBtn.style.cursor = 'not-allowed';
    }
    
    nextBtn = document.createElement('button');
    nextBtn.innerHTML = '‚Ä∫';
    nextBtn.style.cssText = 'position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); color: #000; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 36px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s; line-height: 1;';
    nextBtn.onclick = showNext;
    if (currentImageIndex === propertyImages.length - 1) {
        nextBtn.style.opacity = '0.3';
        nextBtn.style.cursor = 'not-allowed';
    }
    
    const imgContainer = document.createElement('div');
    imgContainer.style.cssText = 'position: relative; max-width: 90vw; max-height: 90vh; display: flex; align-items: center; justify-content: center;';
    imgContainer.onclick = (e) => e.stopPropagation();
    
    img = document.createElement('img');
    img.src = currentImageUrl;
    img.style.cssText = 'max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); transition: opacity 0.3s;';
    img.alt = currentItem.name || 'Fullscreen image';
    
    imgName = document.createElement('div');
    imgName.textContent = `${currentImageIndex + 1} / ${propertyImages.length} - ${currentItem.name || ''}`;
    imgName.style.cssText = 'position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%); color: white; font-size: 14px; text-align: center; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 4px; white-space: nowrap; max-width: 90vw; overflow: hidden; text-overflow: ellipsis;';
    
    imgContainer.appendChild(img);
    imgContainer.appendChild(imgName);
    modal.appendChild(closeBtn);
    modal.appendChild(prevBtn);
    modal.appendChild(nextBtn);
    modal.appendChild(imgContainer);
    document.body.appendChild(modal);
}

function previewTenancyFile(category, fileId) {
    const item = tenancyData[category].find(i => i.id == fileId);
    if (!item) return;
    
    const categoryFiles = (tenancyData[category] || []).filter(f => {
        return isImageFile(f.name) || (f.type && f.type.toLowerCase().includes('pdf'));
    });
    const currentIndex = categoryFiles.findIndex(f => f.id == fileId);
    
    if (currentIndex === -1) {
        alert('File not found');
        return;
    }
    
    let currentFileIndex = currentIndex;
    let currentFileUrl = '';
    let currentShouldRevoke = false;
    let currentItem = item;
    let currentImg = null;
    let currentIframe = null;
    let currentMessage = null;
    
    const modal = document.createElement('div');
    modal.id = 'previewFileModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
    
    const content = document.createElement('div');
    content.style.cssText = 'position: relative; max-width: 95vw; max-height: 95vh; cursor: default; display: flex; align-items: center; justify-content: center;';
    content.onclick = (e) => e.stopPropagation();
    
    const fileName = document.createElement('div');
    fileName.style.cssText = 'position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; font-size: 14px; text-align: center; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 4px; white-space: nowrap; max-width: 90vw; overflow: hidden; text-overflow: ellipsis; z-index: 10001;';
    
    const prevBtn = document.createElement('button');
    prevBtn.innerHTML = '‚Äπ';
    prevBtn.style.cssText = 'position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); color: #000; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 36px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s; line-height: 1;';
    
    const nextBtn = document.createElement('button');
    nextBtn.innerHTML = '‚Ä∫';
    nextBtn.style.cssText = 'position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); color: #000; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 36px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s; line-height: 1;';
    
    const getFileUrl = (fileItem) => {
        let url = '';
        let shouldRevoke = false;
        if (fileItem.file && (fileItem.file instanceof Blob || fileItem.file instanceof File)) {
            url = URL.createObjectURL(fileItem.file);
            shouldRevoke = true;
        } else if (fileItem.base64) {
            url = fileItem.base64;
        }
        return { url, shouldRevoke };
    };
    
    const updateFile = () => {
        currentItem = categoryFiles[currentFileIndex];
        const isImage = isImageFile(currentItem.name);
        const isPDF = currentItem.type && currentItem.type.toLowerCase().includes('pdf');
        
        const { url, shouldRevoke } = getFileUrl(currentItem);
        
        if (currentShouldRevoke && currentFileUrl.startsWith('blob:')) {
            URL.revokeObjectURL(currentFileUrl);
        }
        
        currentFileUrl = url;
        currentShouldRevoke = shouldRevoke;
        
        fileName.textContent = `${currentFileIndex + 1} / ${categoryFiles.length} - ${currentItem.name || 'Preview'}`;
        
        prevBtn.style.opacity = currentFileIndex === 0 ? '0.3' : '1';
        prevBtn.style.cursor = currentFileIndex === 0 ? 'not-allowed' : 'pointer';
        nextBtn.style.opacity = currentFileIndex === categoryFiles.length - 1 ? '0.3' : '1';
        nextBtn.style.cursor = currentFileIndex === categoryFiles.length - 1 ? 'not-allowed' : 'pointer';
        
        if (currentImg) {
            currentImg.remove();
            currentImg = null;
        }
        if (currentIframe) {
            currentIframe.remove();
            currentIframe = null;
        }
        if (currentMessage) {
            currentMessage.remove();
            currentMessage = null;
        }
        
        if (isImage && currentFileUrl) {
            currentImg = document.createElement('img');
            currentImg.src = currentFileUrl;
            currentImg.style.cssText = 'max-width: 90vw; max-height: 90vh; object-fit: contain; display: block; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); transition: opacity 0.3s;';
            currentImg.alt = currentItem.name || 'Preview';
            content.appendChild(currentImg);
        } else if (isPDF && currentFileUrl) {
            currentIframe = document.createElement('iframe');
            currentIframe.src = currentFileUrl;
            currentIframe.style.cssText = 'width: 90vw; height: 90vh; border: none; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
            content.appendChild(currentIframe);
        } else {
            currentMessage = document.createElement('div');
            currentMessage.style.cssText = 'background: white; padding: 40px; border-radius: 8px; text-align: center; max-width: 500px;';
            currentMessage.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 20px;">üìÑ</div>
                <h3 style="margin: 0 0 10px 0; color: #374151;">${escapeHtml(currentItem.name)}</h3>
                <p style="color: #6b7280; margin: 0 0 20px 0;">Preview not available for this file type. Please download to view.</p>
            `;
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = '‚¨áÔ∏è Download File';
            downloadBtn.style.cssText = 'background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;';
            downloadBtn.onclick = () => {
                downloadTenancyFile(category, currentItem.id);
            };
            currentMessage.appendChild(downloadBtn);
            content.appendChild(currentMessage);
        }
    };
    
    const showPrevious = (e) => {
        if (e) e.stopPropagation();
        if (currentFileIndex > 0) {
            currentFileIndex--;
            updateFile();
        }
    };
    
    const showNext = (e) => {
        if (e) e.stopPropagation();
        if (currentFileIndex < categoryFiles.length - 1) {
            currentFileIndex++;
            updateFile();
        }
    };
    
    prevBtn.onclick = showPrevious;
    nextBtn.onclick = showNext;
    
    const closeModal = () => {
        if (document.body.contains(modal)) {
            document.body.removeChild(modal);
        }
        if (currentShouldRevoke && currentFileUrl.startsWith('blob:')) {
            URL.revokeObjectURL(currentFileUrl);
        }
        document.removeEventListener('keydown', keyHandler);
    };
    
    const keyHandler = (e) => {
        if (e.key === 'Escape' || e.keyCode === 27) {
            closeModal();
        } else if (e.key === 'ArrowLeft' || e.keyCode === 37) {
            showPrevious(e);
        } else if (e.key === 'ArrowRight' || e.keyCode === 39) {
            showNext(e);
        }
    };
    
    document.addEventListener('keydown', keyHandler);
    
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '‚úï';
    closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); color: #000; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s;';
    closeBtn.onclick = (e) => {
        e.stopPropagation();
        closeModal();
    };
    
    modal.onclick = (e) => {
        if (e.target === modal) {
            closeModal();
        }
    };
    
    content.appendChild(fileName);
    modal.appendChild(closeBtn);
    modal.appendChild(prevBtn);
    modal.appendChild(nextBtn);
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    updateFile();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeTenancyDataManager();
});
    </script>
</body>
</html>

