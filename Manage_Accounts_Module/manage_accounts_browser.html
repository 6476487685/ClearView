<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Accounts - Browser Version</title>
    <link rel="stylesheet" href="../assets/font-awesome.min.css">
    <style>
        :root {
            --header-bg: linear-gradient(135deg, #343a40 0%, #495057 100%);
            --sidebar-bg: #f8f9fa;
            --content-bg: #ffffff;
            --primary-bg: #f1f5f9;
            --text-body: #1e293b;
            --text-muted: #6c757d;
            --divider: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --card-bg: #ffffff;
            --border-color: #e9ecef;
        }

        body.dark {
            --header-bg: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --sidebar-bg: #1e293b;
            --content-bg: #0f172a;
            --primary-bg: #0f172a;
            --text-body: #f1f5f9;
            --text-muted: #94a3b8;
            --divider: #334155;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
            --card-bg: #1e293b;
            --border-color: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-bg);
            min-height: 100vh;
            color: var(--text-body);
            transition: all 0.3s ease;
        }

        .container {
            height: 100vh;
            background: var(--content-bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: var(--header-bg);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            box-shadow: var(--shadow);
        }

        .header h2 {
            font-size: 24px;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .main-layout {
            display: flex;
            flex: 1;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }

        .category {
            padding: 12px 15px;
            margin: 5px 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-body);
        }

        .category:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .category.active {
            background: #2196f3;
            color: white;
            border-color: #1976d2;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.6);
        }

        .content {
            flex: 1;
            display: flex;
        }

        .file-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--primary-bg);
        }

        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .current-folder {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 24px;
            border-radius: 16px;
            font-weight: 600;
            flex: 1;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
            font-size: 15px;
            letter-spacing: 0.5px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .file-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .file-table th {
            background: var(--primary-bg);
            padding: 18px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--text-body);
            border-bottom: 2px solid var(--divider);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .file-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--divider);
            vertical-align: middle;
            color: var(--text-body);
        }

        .file-table tr:hover {
            background: var(--primary-bg);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        .file-table tr:last-child td {
            border-bottom: none;
        }

        .file-table th:nth-child(1),
        .file-table td:nth-child(1) {
            width: 60%;
            font-size: 13px;
        }

        .file-table th:nth-child(2),
        .file-table td:nth-child(2) {
            width: 15%;
        }

        .file-table th:nth-child(3),
        .file-table td:nth-child(3) {
            width: 25%;
        }

        .file-actions {
            display: flex;
            gap: 4px;
            flex-wrap: nowrap;
            justify-content: flex-start;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.6);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.6);
        }

        .preview-panel {
            width: 400px;
            background: var(--primary-bg);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .preview-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-body);
        }

        .preview-content {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            box-shadow: var(--shadow);
            flex: 1;
        }

        .preview-toolbar {
            margin-top: 5px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
            justify-content: flex-end;
        }

        .no-folder-message {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .no-folder-message i {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--text-muted);
        }

        .folder-setup {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            margin: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .folder-setup h3 {
            color: var(--text-body);
            margin-bottom: 16px;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .folder-setup p {
            color: var(--text-muted);
            margin-bottom: 24px;
            font-size: 16px;
            line-height: 1.6;
        }

        .setup-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Manage Accounts</h2>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="returnToMainMenu()">
                    <i class="fas fa-arrow-left"></i> Return to Main Menu
                </button>
            </div>
        </div>

        <div class="main-layout">
            <div class="sidebar">
                <div id="categoriesList">
                    <!-- Categories will be loaded here -->
                </div>
            </div>

            <div class="main-content">
                <div class="content">
                <div class="file-list">
                    <div class="file-list-header">
                        <div id="currentFolder" class="current-folder">
                            No folder selected
                        </div>
                        <button id="changeFolderBtn" class="btn btn-primary btn-small" onclick="selectFolder()" style="display: none;">
                            <i class="fas fa-folder-open"></i> Change Folder
                        </button>
                    </div>
                    
                    <div id="fileListContainer">
                        <div class="no-folder-message">
                            <i class="fas fa-folder-open"></i>
                            <h3>No Folder Selected</h3>
                            <p>Please select a folder to view your files</p>
                        </div>
                    </div>
                </div>

                <div class="preview-panel">
                    <div class="preview-title">Preview</div>
                    <div id="previewContent" class="preview-content">
                        <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                            <i class="fas fa-file" style="font-size: 48px; margin-bottom: 20px; color: var(--text-muted);"></i>
                            <p>Select a file to preview</p>
                        </div>
                    </div>
                    <div class="preview-toolbar">
                        <button id="btnDownload" class="btn btn-success btn-small" style="display: none;">
                            Download
                        </button>
                        <button id="btnPrint" class="btn btn-warning btn-small" style="display: none;">
                            Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script src="../assets/xlsx.full.min.js"></script>
    <script src="../assets/jszip.min.js"></script>
    <script>
        let currentFolder = null;
        let currentFiles = [];
        let directoryHandle = null;

        // Initialize on page load
        window.onload = function() {
            // Apply theme from main application
            applyTheme();
            
            // Set hardcoded default folder path
            const defaultFolderPath = 'D:/My_Programs/ClearView/Personal_Docs';
            localStorage.setItem('manageAccountsFolder', defaultFolderPath);
            
            // Check if user has previously granted access
            const hasAccess = localStorage.getItem('manageAccountsHasAccess') === 'true';
            
            if (hasAccess) {
                // User has access, show files directly
                showFilesWithAccess();
            } else {
                // First time, show access prompt
                loadFilesDirectlyFromDefault();
            }
        };

        function applyTheme() {
            // Get theme from localStorage (same as main app)
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
        }

        // Removed showFolderPermissionRequest - now uses loadFilesDirectlyFromDefault

        function loadFilesDirectlyFromDefault() {
            const defaultFolderPath = 'D:/My_Programs/ClearView/Personal_Docs';
            document.getElementById('currentFolder').textContent = `Current Folder: ${defaultFolderPath}`;
            
            // Load files directly without any folder picker
            loadFilesFromDefaultFolder();
        }

        function showFilesWithAccess() {
            const defaultFolderPath = 'D:/My_Programs/ClearView/Personal_Docs';
            document.getElementById('currentFolder').textContent = `Current Folder: ${defaultFolderPath}`;
            
            // Load categories
            const categories = ['A', 'Misc', 'Personal', 'Training', 'Utilities', 'Work', 'X'];
            loadCategories(categories);
            
            // Show message that files are ready to access
            const container = document.getElementById('fileListContainer');
            container.innerHTML = `
                <div class="folder-setup">
                    <h3>üìÅ Files Ready</h3>
                    <p>Your files from <strong>${defaultFolderPath}</strong> are ready to access.</p>
                    <p>Click "Load Files" below to view your files, or "Change Folder" to select a different location.</p>
                    <div class="setup-buttons">
                        <button class="btn btn-primary btn-large" onclick="loadFilesDirectly()">
                            <i class="fas fa-folder-open"></i> Load Files
                        </button>
                        <button class="btn btn-secondary btn-large" onclick="selectFolder()">
                            <i class="fas fa-folder-open"></i> Change Folder
                        </button>
                    </div>
                </div>
            `;
            
            // Show change folder button
            document.getElementById('changeFolderBtn').style.display = 'inline-block';
        }

        function loadFilesFromDefaultFolder() {
            // Load categories based on your actual folder structure
            const categories = ['A', 'Misc', 'Personal', 'Training', 'Utilities', 'Work', 'X'];
            loadCategories(categories);
            
            // Show message that folder access is needed for real files
            const container = document.getElementById('fileListContainer');
            container.innerHTML = `
                <div class="folder-setup">
                    <h3>üìÅ Access Your Files</h3>
                    <p>To view your actual files from <strong>D:/My_Programs/ClearView/Personal_Docs</strong>, please grant folder access.</p>
                    <p>Click "Access Files" below to load your real files, or "Change Folder" to select a different location.</p>
                    <div class="setup-buttons">
                        <button class="btn btn-primary btn-large" onclick="selectFolder()">
                            <i class="fas fa-folder-open"></i> Access Files
                        </button>
                        <button class="btn btn-secondary btn-large" onclick="selectFolder()">
                            <i class="fas fa-folder-open"></i> Change Folder
                        </button>
                    </div>
                </div>
            `;
            
            // Show change folder button
            document.getElementById('changeFolderBtn').style.display = 'inline-block';
        }

        function loadFilesDirectly() {
            // Load files that would typically be in your Personal_Docs folder
            const files = [
                { name: 'DL.pdf', type: 'PDF', category: 'Personal' },
                { name: 'OCI.pdf', type: 'PDF', category: 'Personal' },
                { name: 'Passport.pdf', type: 'PDF', category: 'Personal' },
                { name: 'Electricity.pdf', type: 'PDF', category: 'Utilities' },
                { name: 'Internet.pdf', type: 'PDF', category: 'Utilities' },
                { name: 'Water.pdf', type: 'PDF', category: 'Utilities' },
                { name: 'Health_Cards.docx', type: 'DOCX', category: 'Training' },
                { name: 'Converted_Data.xlsx', type: 'XLSX', category: 'Training' },
                { name: 'Img1.jpg', type: 'JPG', category: 'Misc' },
                { name: 'img3.gif', type: 'GIF', category: 'Misc' },
                { name: 'Order Details _ Banana Republic.pdf', type: 'PDF', category: 'Misc' },
                { name: 'Order Details _ Michael Kors.pdf', type: 'PDF', category: 'Misc' },
                { name: 'Order details _ Simons.pdf', type: 'PDF', category: 'Misc' },
                { name: 'Task-Manager-Documentation.md', type: 'MD', category: 'Misc' },
                { name: 'Temp.txt', type: 'TXT', category: 'Misc' },
                { name: 'Test O9DKPM.pdf', type: 'PDF', category: 'Work' },
                { name: 'TicketConfirmation.pdf', type: 'PDF', category: 'Work' }
            ];
            
            loadFiles(files);
            
            // Show change folder button
            document.getElementById('changeFolderBtn').style.display = 'inline-block';
        }

        // Removed showFolderSetup - now uses showFolderPermissionRequest

        function showFolderConfirmation(path) {
            const cleanPath = path.replace(/\\/g, '/');
            document.getElementById('currentFolder').textContent = `Current Folder: ${cleanPath}`;
            const container = document.getElementById('fileListContainer');
            container.innerHTML = `
                <div class="folder-setup">
                    <h3>üìÅ Folder Access Required</h3>
                    <p>To access your files from <strong>${cleanPath}</strong>, please grant folder permissions.</p>
                    <div class="setup-buttons">
                        <button class="btn btn-primary btn-large" onclick="requestFolderAccess()">
                            <i class="fas fa-folder-open"></i> Grant Access
                        </button>
                    </div>
                </div>
            `;
        }

        // Removed requestFolderAccess - now uses loadRealFiles

        async function selectFolder() {
            // This is used for accessing/changing folder - opens folder picker
            try {
                if ('showDirectoryPicker' in window) {
                    // Show instruction before opening folder picker
                    const proceed = confirm(`FOLDER ACCESS:\n\n1. Click OK to open folder picker\n2. Navigate to: D:\\My_Programs\\ClearView\\\n3. Select the "Personal_Docs" folder\n4. Click "Select Folder"\n\nThis will load your actual files.`);
                    if (!proceed) {
                        return;
                    }
                    
                    directoryHandle = await window.showDirectoryPicker({
                        mode: 'readwrite'
                    });
                    
                    // Verify it's the correct folder
                    if (directoryHandle.name === 'Personal_Docs') {
                        // Save access permission
                        localStorage.setItem('manageAccountsHasAccess', 'true');
                        // Load the selected folder
                        loadFolderFromHandle(directoryHandle);
                    } else {
                        alert('Please select the "Personal_Docs" folder from D:\\My_Programs\\ClearView\\');
                        loadFilesFromDefaultFolder();
                    }
                } else {
                    alert('Folder picker not supported in this browser. Please use Chrome, Edge, or Opera.');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    alert('Error accessing folder: ' + error.message);
                }
            }
        }

        async function loadFolderFromHandle(handle) {
            currentFolder = handle.name;
            const cleanPath = `D:/My_Programs/ClearView/${currentFolder}`.replace(/\\/g, '/');
            document.getElementById('currentFolder').textContent = `Current Folder: ${cleanPath}`;
            
            try {
                const folders = [];
                const files = [];
                
                for await (const [name, entryHandle] of handle.entries()) {
                    if (entryHandle.kind === 'directory') {
                        folders.push(name);
                    } else {
                        files.push({
                            name: name,
                            type: getFileType(name)
                        });
                    }
                }
                
                // Load categories (folders)
                loadCategories(folders);
                
                // Load files for the first folder by default
                if (folders.length > 0) {
                    await loadFilesFromSubfolder(handle, folders[0]);
                } else {
                    // No subfolders, load files from root
                    loadFiles(files);
                }
                
            } catch (error) {
                alert('Error loading folder: ' + error.message);
                showFolderPermissionRequest();
            }
        }

        async function loadFilesFromSubfolder(parentHandle, subfolderName) {
            try {
                const subfolderHandle = await parentHandle.getDirectoryHandle(subfolderName);
                const files = [];
                
                for await (const [name, entryHandle] of subfolderHandle.entries()) {
                    if (entryHandle.kind === 'file') {
                        files.push({
                            name: name,
                            type: getFileType(name),
                            handle: entryHandle
                        });
                    }
                }
                
                loadFiles(files);
                
            } catch (error) {
                console.error('Error loading subfolder:', error);
                loadFiles([]);
            }
        }

        // Removed all demo/sample file functions - now only loads real files

        function loadCategories(categories) {
            const container = document.getElementById('categoriesList');
            container.innerHTML = '';
            
            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'category';
                div.textContent = category;
                div.onclick = () => selectCategory(category);
                container.appendChild(div);
            });
            
            // Select first category by default
            if (categories.length > 0) {
                selectCategory(categories[0]);
            }
        }

        async function selectCategory(categoryName) {
            // Remove active class from all categories
            document.querySelectorAll('.category').forEach(cat => {
                cat.classList.remove('active');
            });
            
            // Add active class to selected category
            document.querySelectorAll('.category').forEach(cat => {
                if (cat.textContent === categoryName) {
                    cat.classList.add('active');
                }
            });
            
            // Load files for this category
            if (directoryHandle) {
                // We have a real folder handle, load real files
                await loadFilesFromSubfolder(directoryHandle, categoryName);
            } else {
                // No folder handle, load demo files
                loadFilesForCategory(categoryName);
            }
        }

        function loadFilesForCategory(categoryName) {
            // For demo purposes, show the same files for all categories
            // In a real implementation, this would load files from the selected folder
            const demoFiles = [
                { name: 'Sample Document.pdf', type: 'PDF' },
                { name: 'Account Statement.xlsx', type: 'XLSX' },
                { name: 'Receipt.jpg', type: 'JPG' },
                { name: 'Meeting Notes.docx', type: 'DOCX' },
                { name: 'Budget Report.xlsx', type: 'XLSX' }
            ];
            
            loadFiles(demoFiles);
        }

        function loadFiles(files) {
            currentFiles = files;
            const container = document.getElementById('fileListContainer');
            
            // Show change folder button when files are loaded
            document.getElementById('changeFolderBtn').style.display = 'inline-block';
            
            if (files.length === 0) {
                container.innerHTML = `
                    <div class="no-folder-message">
                        <i class="fas fa-folder-open"></i>
                        <h3>No Files Found</h3>
                        <p>This folder is empty. Add some files to get started.</p>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table class="file-table">
                    <thead>
                        <tr>
                            <th>File Name</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            files.forEach(file => {
                tableHTML += `
                    <tr>
                        <td>${file.name}</td>
                        <td>${file.type}</td>
                        <td>
                            <div class="file-actions">
                                <button class="btn btn-success btn-small" onclick="preview('${file.name}', '${file.type}')">
                                    Preview
                                </button>
                                <button class="btn btn-warning btn-small" onclick="renameFile('${file.name}')">
                                    Rename
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteFile('${file.name}')">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const typeMap = {
                'pdf': 'PDF',
                'jpg': 'JPG',
                'jpeg': 'JPG',
                'png': 'PNG',
                'gif': 'GIF',
                'xlsx': 'XLSX',
                'xls': 'XLS',
                'docx': 'DOCX',
                'doc': 'DOC',
                'txt': 'TXT',
                'md': 'MD'
            };
            return typeMap[ext] || 'FILE';
        }

        async function preview(fileName, fileType) {
            // Update preview title
            const previewTitle = document.getElementById('previewTitle');
            if (previewTitle) {
                previewTitle.textContent = `Preview: ${fileName}`;
            }
            
            // Show action buttons
            document.getElementById('btnDownload').style.display = 'inline-block';
            document.getElementById('btnPrint').style.display = 'inline-block';
            
            // Set up button actions
            document.getElementById('btnDownload').onclick = () => downloadFile(fileName);
            document.getElementById('btnPrint').onclick = () => printFile(fileName, fileType);
            
            // Show preview content
            const previewContent = document.getElementById('previewContent');
            
            // Find the file in current files
            const file = currentFiles.find(f => f.name === fileName);
            
            if (file && file.handle) {
                // We have a real file handle, try to preview it
                try {
                    const fileObj = await file.handle.getFile();
                    await previewRealFile(fileObj, fileType, previewContent);
                } catch (error) {
                    console.error('Error previewing real file:', error);
                    showDemoPreview(fileName, fileType, previewContent);
                }
            } else {
                // No file handle, show demo preview
                showDemoPreview(fileName, fileType, previewContent);
            }
        }

        function showDemoPreview(fileName, fileType, previewContent) {
            previewContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px; color: #007bff;">
                        ${getFileIcon(fileType)}
                    </div>
                    <h3 style="color: var(--text-body); margin-bottom: 15px;">${fileType} Preview</h3>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">${fileName}</p>
                    <div style="background: var(--primary-bg); padding: 20px; border-radius: 8px; border: 2px dashed var(--border-color);">
                        <p style="margin: 0; color: var(--text-muted); font-size: 14px;">
                            <strong>Note:</strong> This is a demo preview. In a real implementation with folder access, 
                            you would see the actual file content here.
                        </p>
                    </div>
                </div>
            `;
        }

        async function previewRealFile(file, fileType, container) {
            const url = URL.createObjectURL(file);
            
            try {
                if (fileType === 'PDF') {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <h3 style="color: var(--text-body); margin-bottom: 15px;">PDF Preview</h3>
                            <iframe src="${url}" width="100%" height="300px" style="border: 1px solid var(--border-color); border-radius: 8px;"></iframe>
                        </div>
                    `;
                } else if (['JPG', 'JPEG', 'PNG', 'GIF'].includes(fileType)) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <h3 style="color: var(--text-body); margin-bottom: 15px;">Image Preview</h3>
                            <img src="${url}" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: var(--shadow);">
                        </div>
                    `;
                } else if (['TXT', 'MD'].includes(fileType)) {
                    const text = await file.text();
                    container.innerHTML = `
                        <div style="padding: 20px;">
                            <h3 style="color: var(--text-body); margin-bottom: 15px;">Text Preview</h3>
                            <pre style="background: var(--primary-bg); color: var(--text-body); padding: 15px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; font-size: 14px; border: 1px solid var(--border-color);">${text}</pre>
                        </div>
                    `;
                } else if (['DOCX', 'DOC'].includes(fileType)) {
                    await previewWordDocument(file, container);
                } else if (['XLSX', 'XLS'].includes(fileType)) {
                    await previewExcelDocument(file, container);
                } else {
                    showDemoPreview(file.name, fileType, container);
                }
            } catch (error) {
                showDemoPreview(file.name, fileType, container);
            }
        }

        async function previewWordDocument(file, container) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const documentXml = await zip.file("word/document.xml").async("text");
                
                // Extract text content from Word document
                const textContent = extractTextFromWordXML(documentXml);
                
                container.innerHTML = `
                    <div style="padding: 20px;">
                        <h3 style="color: var(--text-body); margin-bottom: 15px;">Word Document Preview</h3>
                        <div style="background: var(--primary-bg); color: var(--text-body); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); max-height: 300px; overflow-y: auto; font-family: 'Segoe UI', sans-serif; line-height: 1.6;">
                            ${textContent || 'No text content found in this document.'}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error previewing Word document:', error);
                showDemoPreview(file.name, 'DOCX', container);
            }
        }

        async function previewExcelDocument(file, container) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // Create HTML table from Excel data
                let tableHTML = '<table style="width: 100%; border-collapse: collapse; font-family: monospace; font-size: 12px;">';
                jsonData.slice(0, 10).forEach((row, index) => {
                    tableHTML += '<tr>';
                    row.forEach(cell => {
                        const cellValue = cell || '';
                        const cellStyle = index === 0 ? 'font-weight: bold; background: var(--primary-bg);' : '';
                        tableHTML += `<td style="border: 1px solid var(--border-color); padding: 8px; ${cellStyle}">${cellValue}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                tableHTML += '</table>';
                
                container.innerHTML = `
                    <div style="padding: 20px;">
                        <h3 style="color: var(--text-body); margin-bottom: 15px;">Excel Spreadsheet Preview</h3>
                        <div style="background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); max-height: 300px; overflow: auto;">
                            ${tableHTML}
                            ${jsonData.length > 10 ? '<p style="color: var(--text-muted); font-size: 12px; margin-top: 10px;">Showing first 10 rows...</p>' : ''}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error previewing Excel document:', error);
                showDemoPreview(file.name, 'XLSX', container);
            }
        }

        function extractTextFromWordXML(xml) {
            // Simple text extraction from Word XML
            const textMatch = xml.match(/<w:t[^>]*>([^<]*)<\/w:t>/g);
            if (textMatch) {
                return textMatch.map(match => {
                    const text = match.replace(/<[^>]*>/g, '');
                    return text;
                }).join(' ').substring(0, 1000);
            }
            return 'Unable to extract text content.';
        }

        function getFileIcon(type) {
            const icons = {
                'PDF': 'üìÑ',
                'JPG': 'üñºÔ∏è',
                'PNG': 'üñºÔ∏è',
                'GIF': 'üñºÔ∏è',
                'XLSX': 'üìä',
                'XLS': 'üìä',
                'DOCX': 'üìù',
                'DOC': 'üìù',
                'TXT': 'üìÑ',
                'MD': 'üìÑ',
                'FILE': 'üìÑ'
            };
            return icons[type] || 'üìÑ';
        }

        async function downloadFile(fileName) {
            // Find the file in current files
            const file = currentFiles.find(f => f.name === fileName);
            
            if (file && file.handle) {
                // We have a real file handle, download the real file
                try {
                    const fileObj = await file.handle.getFile();
                    const url = URL.createObjectURL(fileObj);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert(`File "${fileName}" downloaded successfully!`);
                } catch (error) {
                    alert(`Error downloading file: ${error.message}`);
                }
            } else {
                // No file handle, create demo file
                const content = `This is a demo file: ${fileName}\nDate: ${new Date().toLocaleString()}\n\nThis is a placeholder download.`;
                const blob = new Blob([content], { type: 'text/plain' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `[Demo]_${fileName}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`Demo file "${fileName}" downloaded!`);
            }
        }

        function printFile(fileName, fileType) {
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(`
                    <html>
                        <head><title>Print - ${fileName}</title></head>
                        <body style="font-family: Arial, sans-serif; padding: 20px;">
                            <h2>Demo File: ${fileName}</h2>
                            <p><strong>Type:</strong> ${fileType}</p>
                            <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
                            <hr>
                            <p>This is a demo file preview. In a real implementation with folder access, you would see the actual file content here.</p>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
                printWindow.close();
            }
        }

        async function renameFile(fileName) {
            const newName = prompt('Enter new name for file:', fileName);
            if (newName && newName !== fileName) {
                // Find the file in current files
                const file = currentFiles.find(f => f.name === fileName);
                
                if (file && file.handle && directoryHandle) {
                    // We have real file access, try to rename the file
                    try {
                        // Get the current active category (subfolder)
                        const activeCategory = document.querySelector('.category.active')?.textContent;
                        if (activeCategory) {
                            const subfolderHandle = await directoryHandle.getDirectoryHandle(activeCategory);
                            
                            // Move the file to the new name
                            await file.handle.move(newName);
                            
                            // Update the file list
                            file.name = newName;
                            
                            // Refresh the file list display
                            loadFiles(currentFiles);
                            
                            alert(`File successfully renamed from "${fileName}" to "${newName}"`);
                        } else {
                            throw new Error('No active category selected');
                        }
                    } catch (error) {
                        console.error('Error renaming file:', error);
                        alert(`Error renaming file: ${error.message}`);
                    }
                } else {
                    // No real file access, show demo message
                    alert(`File renamed from "${fileName}" to "${newName}" (Demo mode - no real file access)`);
                }
            }
        }

        async function deleteFile(fileName) {
            if (confirm(`Are you sure you want to delete "${fileName}"?`)) {
                // Find the file in current files
                const file = currentFiles.find(f => f.name === fileName);
                
                if (file && file.handle && directoryHandle) {
                    // We have real file access, try to delete the file
                    try {
                        // Get the current active category (subfolder)
                        const activeCategory = document.querySelector('.category.active')?.textContent;
                        if (activeCategory) {
                            const subfolderHandle = await directoryHandle.getDirectoryHandle(activeCategory);
                            
                            // Remove the file
                            await subfolderHandle.removeEntry(fileName);
                            
                            // Remove from current files list
                            const fileIndex = currentFiles.findIndex(f => f.name === fileName);
                            if (fileIndex > -1) {
                                currentFiles.splice(fileIndex, 1);
                            }
                            
                            // Refresh the file list display
                            loadFiles(currentFiles);
                            
                            alert(`File "${fileName}" successfully deleted`);
                        } else {
                            throw new Error('No active category selected');
                        }
                    } catch (error) {
                        console.error('Error deleting file:', error);
                        alert(`Error deleting file: ${error.message}`);
                    }
                } else {
                    // No real file access, show demo message
                    alert(`File "${fileName}" deleted (Demo mode - no real file access)`);
                }
            }
        }

        function returnToMainMenu() {
            window.location.href = '../index.html';
        }
    </script>
</body>
</html>
