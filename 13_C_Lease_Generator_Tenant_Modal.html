<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tenants Modal - NS Lease Generator</title>
<style>
    * {
        box-sizing: border-box;
    }

    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 0; 
        padding: 20px; 
        background: #f5f5f5;
    }

    .pdf-button {
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin: 5px;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .pdf-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
    }

    .excel-table-container {
        border: 1px solid #d1d5db;
        border-radius: 4px;
        overflow: auto;
        background: #fff;
        position: relative;
    }
    
    .excel-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 13px;
        font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    .excel-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #f3f4f6;
    }
    
    .excel-table th {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-bottom: 2px solid #9ca3af;
        padding: 6px 8px;
        text-align: left;
        font-weight: 600;
        color: #111827;
        position: relative;
        user-select: none;
        white-space: nowrap;
        min-width: 80px;
    }
    
    .excel-table th.resizable {
        padding-right: 18px;
    }
    
    .excel-table td {
        border: 1px solid #d1d5db;
        padding: 4px 6px;
        background: #fff;
        vertical-align: middle;
    }
    
    .excel-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .excel-table tbody tr:nth-child(even) {
        background: #fafafa;
    }
    
    .excel-table input {
        width: 100%;
        border: none;
        padding: 4px 6px;
        background: transparent;
        font-size: 13px;
        font-family: inherit;
        outline: none;
    }
    
    .excel-table input:focus {
        background: #fff3cd;
        border: 1px solid #ffc107;
    }
    
    .column-resizer {
        position: absolute;
        top: 0;
        right: 0;
        width: 4px;
        height: 100%;
        cursor: col-resize;
        background: transparent;
        z-index: 1;
    }

    .column-resizer:hover {
        background: #3b82f6;
    }

    .column-resizer.active {
        background: #2563eb;
    }
</style>
</head>
<body>
    <h1>Tenants Modal Test</h1>
    <button class="pdf-button" onclick="openTenantsCRUD()">Open Tenants Modal</button>

    <!-- TENANTS CRUD MODAL -->
    <div id="tenantsCRUDBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 50;"></div>
    <div id="tenantsCRUDModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95vw; max-width: 1400px; max-height: 75vh; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 51; padding: 18px; flex-direction: column; overflow: hidden;">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 15px; flex-shrink: 0;">
            <h3 style="margin:0;">ðŸ‘¥ Manage Tenants</h3>
            <button class="pdf-button" onclick="closeTenantsCRUD()" style="background:#ef4444;">âœ– Close</button>
        </div>
        <div class="excel-table-container" style="flex: 1; overflow: auto; margin-bottom: 10px; min-height: 0;">
            <table class="excel-table" id="tenantsTable">
                <thead>
                    <tr>
                        <th class="resizable" style="width: 120px; text-align: center;">Active</th>
                        <th class="resizable" style="width: 200px;">Tenant_Name</th>
                        <th class="resizable" style="width: 200px;">Tenant_Email</th>
                        <th class="resizable" style="width: 150px;">Tenant_Phone</th>
                        <th class="resizable" style="width: 250px;">Tenant_Old_Address</th>
                        <th class="resizable" style="width: 200px;">Tenant_Job_Desc</th>
                        <th style="width: 100px; text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody id="tenantsCRUDBody"></tbody>
            </table>
        </div>
        <div style="display:flex; justify-content: space-between; align-items:center; margin-top:15px; flex-shrink: 0;">
            <button class="pdf-button" onclick="addTenantRow()" style="background:#10b981;">ï¼‹ Add Tenant</button>
            <div style="display:flex; gap:8px;">
                <button class="pdf-button" onclick="saveTenantsCRUD()" style="background:#3b82f6;">âœ” Save & Apply</button>
            </div>
        </div>
    </div>

<script>
let masterData = {};

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper function to add superscripts to duplicate tenant names
function addSuperscriptsToDuplicateNames(tenants) {
    if (!tenants || tenants.length === 0) return tenants;
    
    const nameCount = {};
    const nameIndex = {};
    
    tenants.forEach(tenant => {
        const name = (tenant.name || "").trim();
        if (name) {
            nameCount[name] = (nameCount[name] || 0) + 1;
        }
    });
    
    const superscriptChars = ['Â¹', 'Â²', 'Â³', 'â´', 'âµ', 'â¶', 'â·', 'â¸', 'â¹', 'Â¹â°', 'Â¹Â¹', 'Â¹Â²'];
    
    return tenants.map(tenant => {
        const originalName = (tenant.name || "").trim();
        if (!originalName) return tenant;
        
        if (nameCount[originalName] > 1) {
            if (nameIndex[originalName] === undefined) {
                nameIndex[originalName] = 0;
            }
            nameIndex[originalName]++;
            
            const superscriptIndex = nameIndex[originalName] - 1;
            const superscript = superscriptIndex < superscriptChars.length 
                ? superscriptChars[superscriptIndex] 
                : `â½${nameIndex[originalName]}â¾`;
            
            return {
                ...tenant,
                name: originalName + superscript
            };
        }
        
        return tenant;
    });
}

// Initialize column resizers
function initColumnResizers() {
    const tables = document.querySelectorAll('.excel-table');
    tables.forEach(table => {
        const tableId = table.id || 'default';
        const headers = table.querySelectorAll('thead th.resizable');
        
        try {
            const savedWidths = JSON.parse(localStorage.getItem(`columnWidths_${tableId}`) || '{}');
            headers.forEach((header, index) => {
                if (savedWidths[index]) {
                    const width = savedWidths[index];
                    header.style.width = width + 'px';
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const cell = row.children[index];
                        if (cell) {
                            cell.style.width = width + 'px';
                        }
                    });
                }
            });
        } catch (e) {
            console.error("Error loading column widths:", e);
        }
        
        headers.forEach((header, index) => {
            const existingResizer = header.querySelector('.column-resizer');
            if (existingResizer) {
                existingResizer.remove();
            }
            
            const resizer = document.createElement('div');
            resizer.className = 'column-resizer';
            header.appendChild(resizer);
            
            let startX, startWidth, th;
            
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                th = header;
                startX = e.pageX;
                startWidth = th.offsetWidth;
                resizer.classList.add('active');
                
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
            });
            
            function resize(e) {
                if (!th) return;
                const width = startWidth + (e.pageX - startX);
                if (width >= 50) {
                    th.style.width = width + 'px';
                    const colIndex = Array.from(th.parentElement.children).indexOf(th);
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const cell = row.children[colIndex];
                        if (cell) {
                            cell.style.width = width + 'px';
                        }
                    });
                }
            }
            
            function stopResize() {
                resizer.classList.remove('active');
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
                
                try {
                    const savedWidths = {};
                    headers.forEach((h, idx) => {
                        savedWidths[idx] = parseInt(h.style.width) || h.offsetWidth;
                    });
                    localStorage.setItem(`columnWidths_${tableId}`, JSON.stringify(savedWidths));
                } catch (e) {
                    console.error("Error saving column widths:", e);
                }
            }
        });
    });
}

function openTenantsCRUD() {
    // Ensure masterData is loaded from localStorage
    try {
        const cached = localStorage.getItem("masterDataCache");
        if (cached) {
            masterData = JSON.parse(cached) || {};
        }
    } catch (e) {
        console.error("Error loading masterData:", e);
    }
    
    // Ensure masterData is an object
    if (!masterData || typeof masterData !== 'object') {
        masterData = {};
    }
    
    const tbody = document.getElementById("tenantsCRUDBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    
    // Load existing tenants from masterData
    const tenants = [];
    for (let i = 1; i <= 50; i++) {
        const name = masterData[`Tenant_${i}_Name`];
        if (name || masterData[`Tenant_${i}_Email`] || masterData[`Tenant_${i}_Phone`]) {
            const activeValue = masterData[`Tenant_${i}_Active`];
            const isActive = activeValue === undefined || activeValue === "1" || activeValue === 1 || activeValue === true;
            tenants.push({
                id: i,
                name: name || "",
                email: masterData[`Tenant_${i}_Email`] || "",
                phone: masterData[`Tenant_${i}_Phone`] || "",
                address: masterData[`Tenant_${i}_Old_Address`] || "",
                job: masterData[`Tenant_${i}_Job_Desc`] || masterData[`Tenant_${i}_Job`] || "",
                active: isActive
            });
        }
    }
    
    // Sort tenants by name (case-insensitive)
    tenants.sort((a, b) => {
        const nameA = (a.name || "").toLowerCase();
        const nameB = (b.name || "").toLowerCase();
        return nameA.localeCompare(nameB);
    });
    
    // If no tenants, add one empty row
    if (tenants.length === 0) {
        tenants.push({ id: 1, name: "", email: "", phone: "", address: "", job: "", active: true });
    }
    
    // Add superscripts to duplicate tenant names for display
    const tenantsWithSuperscripts = addSuperscriptsToDuplicateNames(tenants);
    
    tenantsWithSuperscripts.forEach(tenant => {
        appendTenantRow(tenant);
    });
    
    document.getElementById("tenantsCRUDBackdrop").style.display = "block";
    document.getElementById("tenantsCRUDModal").style.display = "flex";
    setTimeout(initColumnResizers, 100);
}

function appendTenantRow(tenant) {
    const tbody = document.getElementById("tenantsCRUDBody");
    const tr = document.createElement("tr");
    tr.dataset.tenantId = tenant.id || '';
    const isActive = tenant.active !== undefined ? tenant.active : true;
    tr.innerHTML = `
        <td style="text-align:center;">
            <input type="checkbox" class="tenant-active" ${isActive ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;">
        </td>
        <td><input type="text" value="${escapeHtml(tenant.name || "")}" placeholder="Tenant_Name" class="tenant-name"></td>
        <td><input type="email" value="${escapeHtml(tenant.email || "")}" placeholder="Tenant_Email" class="tenant-email"></td>
        <td><input type="tel" value="${escapeHtml(tenant.phone || "")}" placeholder="Tenant_Phone" class="tenant-phone"></td>
        <td><input type="text" value="${escapeHtml(tenant.address || "")}" placeholder="Tenant_Old_Address" class="tenant-address"></td>
        <td><input type="text" value="${escapeHtml(tenant.job || "")}" placeholder="Tenant_Job_Desc" class="tenant-job"></td>
        <td style="text-align:center;">
            <button class="pdf-button" style="background:#ef4444; padding:4px 8px; font-size:11px;" onclick="this.closest('tr').remove()">ðŸ—‘</button>
        </td>`;
    tbody.appendChild(tr);
}

function addTenantRow() {
    const tbody = document.getElementById("tenantsCRUDBody");
    const existingIds = Array.from(tbody.querySelectorAll("tr")).map(tr => parseInt(tr.dataset.tenantId) || 0).filter(id => id > 0);
    const nextId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
    
    appendTenantRow({
        id: nextId,
        name: "", email: "", phone: "", address: "", job: "", active: true
    });
}

function saveTenantsCRUD() {
    const rows = Array.from(document.querySelectorAll("#tenantsCRUDBody tr"));
    
    // Clear existing tenant data
    for (let i = 1; i <= 50; i++) {
        delete masterData[`Tenant_${i}_Name`];
        delete masterData[`Tenant_${i}_Email`];
        delete masterData[`Tenant_${i}_Phone`];
        delete masterData[`Tenant_${i}_Old_Address`];
        delete masterData[`Tenant_${i}_Job_Desc`];
        delete masterData[`Tenant_${i}_Job`];
        delete masterData[`Tenant_${i}_Active`];
    }
    
    // Helper function to strip superscripts from names
    function stripSuperscripts(name) {
        if (!name) return name;
        return name.replace(/[Â¹Â²Â³â´âµâ¶â·â¸â¹â°â½â¾]/g, '').trim();
    }
    
    // Save tenant data
    let nextId = 1;
    rows.forEach(row => {
        let name = row.querySelector(".tenant-name").value.trim();
        name = stripSuperscripts(name);
        const email = row.querySelector(".tenant-email").value.trim();
        const phone = row.querySelector(".tenant-phone").value.trim();
        const address = row.querySelector(".tenant-address").value.trim();
        const job = row.querySelector(".tenant-job").value.trim();
        const active = row.querySelector(".tenant-active").checked;
        
        if (name || email || phone || address || job) {
            if (name) masterData[`Tenant_${nextId}_Name`] = name;
            if (email) masterData[`Tenant_${nextId}_Email`] = email;
            if (phone) masterData[`Tenant_${nextId}_Phone`] = phone;
            if (address) masterData[`Tenant_${nextId}_Old_Address`] = address;
            if (job) masterData[`Tenant_${nextId}_Job_Desc`] = job;
            masterData[`Tenant_${nextId}_Active`] = active ? "1" : "0";
            nextId++;
        }
    });
    
    try { localStorage.setItem("masterDataCache", JSON.stringify(masterData)); } catch (e) {}
    closeTenantsCRUD();
    alert("âœ“ Tenants saved to localStorage!");
}

function closeTenantsCRUD() {
    document.getElementById("tenantsCRUDBackdrop").style.display = "none";
    document.getElementById("tenantsCRUDModal").style.display = "none";
}

// Close modal when clicking backdrop
document.getElementById("tenantsCRUDBackdrop").addEventListener('click', function(e) {
    if (e.target === this) {
        closeTenantsCRUD();
    }
});
</script>
</body>
</html>






