<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ClearView 1.0 ‚Äî Transaction Manager</title>
<style>
:root {
 --header-bg:linear-gradient(135deg, #667eea 0%, #764ba2 100%);--sidebar-bg:#f8fafc;--content-bg:#ffffff;--primary-bg:#f1f5f9;
 --accent-blue:#3b82f6;--accent-blue-hover:#2563eb;--accent-gold:#f59e0b;
 --text-body:#1e293b;--divider:#e2e8f0;--shadow:0 4px 6px -1px rgba(0,0,0,0.1);
 --gradient-primary:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
body.dark {
 --header-bg:linear-gradient(135deg, #1e293b 0%, #334155 100%);--sidebar-bg:#1e293b;--content-bg:#0f172a;--primary-bg:#0f172a;
 --accent-blue:#60a5fa;--accent-blue-hover:#3b82f6;--accent-gold:#fbbf24;
 --text-body:#f1f5f9;--divider:#334155;--shadow:0 4px 6px -1px rgba(0,0,0,0.3);
}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--primary-bg);color:var(--text-body);line-height:1.6;}
header{
 height:60px;background:var(--header-bg);border-bottom:1px solid var(--divider);
 display:flex;align-items:center;justify-content:space-between;
 padding:0 20px;position:fixed;top:0;left:0;right:0;z-index:1000;
 box-shadow:var(--shadow);
}
header h1{margin:0;font-size:1.4rem;font-weight:700;flex:1;text-align:center;display:flex;justify-content:center;align-items:center;gap:8px;color:#ffffff;text-shadow:0 2px 4px rgba(0,0,0,0.1);}
.theme-switch{position:relative;width:44px;height:22px;}
.theme-switch input{opacity:0;width:0;height:0;}
.slider{
 position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;
 background-color:#ccc;transition:.4s;border-radius:34px;
}
.slider:before{
 position:absolute;content:"";height:16px;width:16px;left:3px;bottom:3px;
 background-color:white;transition:.4s;border-radius:50%;
}
input:checked + .slider{background-color:var(--accent-blue);}
input:checked + .slider:before{transform:translateX(22px);}
#logoutBtn{
 background:linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
 color:#fff;border:1px solid rgba(255,255,255,0.2);padding:10px 18px;border-radius:12px;
 font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
 backdrop-filter:blur(15px);box-shadow:0 4px 15px rgba(0,0,0,0.1);font-size:0.9rem;position:relative;overflow:hidden;
}
#logoutBtn::before{
 content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
 background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
 transition:left 0.5s;
}
#logoutBtn:hover{
 background:linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.1) 100%);
 border-color:rgba(255,255,255,0.4);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.15);
}
#logoutBtn:hover::before{left:100%;}
#logoutBtn:active{transform:translateY(0px);box-shadow:0 2px 10px rgba(0,0,0,0.1);}
#sidebar{
 position:fixed;top:60px;left:0;width:260px;bottom:0;background:var(--sidebar-bg);
 border-right:1px solid var(--divider);overflow-y:auto;padding:20px 15px;box-shadow:var(--shadow);
}
.nav-link{display:block;padding:12px 16px;margin:4px 0;border-radius:8px;text-decoration:none;color:var(--text-body);transition:all 0.3s ease;font-weight:500;}
.nav-link:hover{background:var(--accent-blue);color:#fff;transform:translateX(4px);box-shadow:var(--shadow);}
.nav-link.disabled{opacity:.5;pointer-events:none;}
.nav-link span.icon{margin-right:10px;font-size:1.1em;}
#content{margin-left:260px;margin-top:60px;padding:30px;min-height:calc(100vh - 60px);}
.modal{
 display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;
 background-color:rgba(0,0,0,0.4);
}
.modal-content{
 background:var(--content-bg);margin:10% auto;padding:30px;border:1px solid var(--divider);
 width:80%;max-width:600px;border-radius:12px;animation:fadein .25s;box-shadow:var(--shadow);
}
@keyframes fadein{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}}
.close{float:right;font-size:20px;font-weight:bold;cursor:pointer;}
.table thead{background:var(--accent-blue);color:#fff;}
.table td,.table th{padding:6px 10px;border-bottom:1px solid var(--divider);}

/* Enhanced Documents Modal Styles */
.docs-modal{max-width:800px;width:70%;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;position:fixed;top:calc(60px + (100vh - 60px) / 2 - 192px);left:calc(260px + (100vw - 260px) / 2);transform:translate(-50%, -50%);z-index:1001;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--divider);flex-shrink:0;}
.modal-header h4{margin:0;color:var(--text-body);font-size:16px;font-weight:600;}

.upload-section{margin-bottom:12px;flex-shrink:0;}
.upload-area{border:2px dashed var(--accent-blue);border-radius:8px;padding:20px;text-align:center;background:linear-gradient(135deg, rgba(66,133,244,0.05) 0%, rgba(66,133,244,0.02) 100%);transition:all 0.3s ease;cursor:pointer;position:relative;height:80px;display:flex;align-items:center;justify-content:center;}
.upload-area:hover{border-color:var(--accent-blue-hover);background:linear-gradient(135deg, rgba(66,133,244,0.1) 0%, rgba(66,133,244,0.05) 100%);transform:translateY(-1px);box-shadow:var(--shadow-xs);}
.upload-area.dragover{border-color:var(--success);background:linear-gradient(135deg, rgba(52,168,83,0.1) 0%, rgba(52,168,83,0.05) 100%);}
.upload-icon{font-size:24px;margin-right:10px;opacity:0.7;}
.upload-text{font-size:14px;font-weight:600;color:var(--text-body);margin:0 8px 0 0;}
.upload-subtext{font-size:11px;color:var(--text-secondary);margin:0 12px 0 0;}
.upload-btn{background:var(--accent-blue);color:#fff;border:none;padding:8px 16px;border-radius:6px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:var(--shadow-xs);font-size:12px;margin-left:12px;}
.upload-btn:hover{background:var(--accent-blue-hover);transform:translateY(-1px);box-shadow:var(--shadow-sm);}
#docUpload{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;}

.documents-section{background:var(--surface);border-radius:6px;overflow:hidden;box-shadow:var(--shadow-xs);flex:1;display:flex;flex-direction:column;min-height:0;}
.section-header{display:flex;justify-content:space-between;align-items:center;padding:10px 15px;background:var(--bg);border-bottom:1px solid var(--divider);flex-shrink:0;}
.section-header h5{margin:0;color:var(--text-body);font-size:13px;font-weight:600;}
.doc-stats{font-size:11px;background:var(--accent-blue);color:#fff;padding:3px 8px;border-radius:10px;font-weight:500;}

.table-container{flex:1;overflow-y:auto;max-height:350px;}
.docs-table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed;}
.docs-table th{background:var(--accent-blue);color:#fff;padding:10px 12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;position:sticky;top:0;z-index:1;}
.docs-table th:nth-child(1){width:30%;}
.docs-table th:nth-child(2){width:15%;}
.docs-table th:nth-child(3){width:10%;}
.docs-table th:nth-child(4){width:20%;}
.docs-table th:nth-child(5){width:25%;}
.docs-table td{padding:10px 12px;border-bottom:1px solid var(--divider);font-size:12px;word-wrap:break-word;}
.docs-table tbody tr:hover{background:var(--bg);transition:background 0.2s ease;}
.docs-table tbody tr:last-child td{border-bottom:none;}

.empty-state td{padding:30px 15px;text-align:center;}
.empty-message{color:var(--text-secondary);}
.empty-icon{font-size:32px;margin-bottom:10px;opacity:0.5;}
.empty-message p{margin:0;font-size:12px;}

.doc-actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-start;}
.doc-btn{background:var(--danger);color:#fff;border:none;padding:6px 10px;border-radius:4px;font-size:11px;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;gap:3px;white-space:nowrap;font-weight:500;}
.doc-btn:hover{background:#d32f2f;transform:translateY(-1px);}
.doc-btn.download{background:var(--success);}
.doc-btn.download:hover{background:#2e7d32;}
.doc-btn.rename{background:var(--accent-blue);}
.doc-btn.rename:hover{background:var(--accent-blue-hover);}

/* File name display and editing */
.file-name-display{font-size:12px;font-weight:500;color:var(--text-body);cursor:pointer;transition:color 0.2s ease;}
.file-name-display:hover{color:var(--accent-blue);}
.file-name-edit{background:transparent;border:1px solid var(--accent-blue);border-radius:3px;padding:4px 6px;font-size:12px;font-weight:500;color:var(--text-body);width:100%;min-width:150px;}
.file-name-edit:focus{outline:none;border-color:var(--accent-blue-hover);box-shadow:0 0 0 2px rgba(66,133,244,0.1);}

</style>
</head>
<body>
<header>
  <label class="theme-switch"><input type="checkbox" id="themeSwitch"><span class="slider"></span></label>
  <h1>üîç ClearView 1.0</h1>
  <button id="logoutBtn">üöÄ Sign Out</button>
</header>

<nav id="sidebar">
  <a href="#" class="nav-link" data-target="masters"><span class="icon">üß©</span>Manage Master Data</a>
  <a href="#" class="nav-link" data-target="tasks"><span class="icon">‚úÖ</span>Manage Tasks</a>
  <a href="#" class="nav-link" data-target="accounts"><span class="icon">üóÇÔ∏è</span>Manage Accounts</a>
  <a href="#" class="nav-link" data-target="load"><span class="icon">üìÅ</span>Load Local Data</a>
  <a href="#" class="nav-link disabled" title="Coming soon"><span class="icon">‚òÅÔ∏è</span>Google Drive</a>
  <a href="#" class="nav-link" data-target="expense"><span class="icon">üí∏</span>Expense Transactions</a>
  <a href="#" class="nav-link" data-target="income"><span class="icon">üí∞</span>Income Transactions</a>
  <a href="#" class="nav-link" data-target="investments"><span class="icon">üìà</span>Investments</a>
  <a href="#" class="nav-link" data-target="analytics"><span class="icon">üìä</span>Analytics</a>
  <a href="#" class="nav-link" data-target="backup"><span class="icon">üíæ</span>Backup & Export</a>
  <a href="#" class="nav-link" data-target="docs"><span class="icon">üìë</span>Documents</a>
</nav>

<main id="content"></main>

<!-- ========== MODALS ========== -->

<!-- Documents Modal -->
<div id="modal-docs" class="modal">
  <div class="modal-content docs-modal">
    <div class="modal-header">
      <h4>üìë Document Manager</h4>
    <span class="close" data-close="modal-docs">&times;</span>
    </div>
    
    <div class="upload-section">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÅ</div>
        <p class="upload-text">Drag & drop files here or click to browse</p>
        <p class="upload-subtext">Supports: PDF, DOC, DOCX, XLS, XLSX, TXT, Images</p>
        <button class="upload-btn" id="uploadBtn">Choose Files</button>
        <input type="file" id="docUpload" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.gif">
      </div>
    </div>
    
    <div class="documents-section">
      <div class="section-header">
        <h5>üìã Your Documents</h5>
        <div class="doc-stats" id="docStats">0 documents</div>
      </div>
      
      <div class="table-container">
        <table class="table docs-table" width="100%">
          <thead>
            <tr>
              <th>üìÑ Name</th>
              <th>üìÇ Type</th>
              <th>üìè Size</th>
              <th>üìÖ Added</th>
              <th>‚ö° Actions</th>
            </tr>
          </thead>
          <tbody id="docsTbody">
            <tr class="empty-state">
              <td colspan="5" class="empty-message">
                <div class="empty-icon">üì≠</div>
                <p>No documents yet. Upload your first document above!</p>
              </td>
            </tr>
          </tbody>
    </table>
      </div>
    </div>
  </div>
</div>

<!-- Placeholder Modal (used for all other menu items) -->
<div id="modal-generic" class="modal">
  <div class="modal-content">
    <span class="close" data-close="modal-generic">&times;</span>
    <h4 id="genericTitle"></h4>
    <p>Coming soon‚Ä¶</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ---------- Theme ---------- */
const themeSwitch=document.getElementById('themeSwitch');
const savedTheme=localStorage.getItem('theme')||'light';
if(savedTheme==='dark'){document.body.classList.add('dark');themeSwitch.checked=true;}
themeSwitch.addEventListener('change',()=>{
  document.body.classList.toggle('dark');
  localStorage.setItem('theme',themeSwitch.checked?'dark':'light');
});

/* ---------- Logout ---------- */
document.getElementById('logoutBtn').addEventListener('click',()=>{
  if(confirm('Are you sure you want to logout?')) location.reload();
});

/* ---------- Modal Logic ---------- */
function openModal(id){
  document.getElementById(id).style.display='block';
  
  // Update document stats when Documents modal is opened
  if(id === 'modal-docs'){
    updateStats();
  }
}
function closeModal(id){
  document.getElementById(id).style.display='none';
}
document.querySelectorAll('.close').forEach(x=>x.onclick=()=>closeModal(x.dataset.close));
window.onclick=function(e){
  document.querySelectorAll('.modal').forEach(m=>{if(e.target===m)m.style.display='none';});
};

/* ---------- Sidebar Clicks ---------- */
document.querySelectorAll('.nav-link').forEach(link=>{
  link.addEventListener('click',e=>{
    e.preventDefault();
    const t=link.dataset.target;
    if(!t) return;
    if(t==='load'){showOverwriteWarning();}
    else if(t==='docs'){openModal('modal-docs');}
    else if(t==='expense'){
      window.location.href='2_Expanse_Index.html';
    }
    else if(t==='income'){
      window.location.href='3_Income_Index.html';
    }
    else if(['masters','tasks','accounts','investments','analytics','backup'].includes(t)){
      document.getElementById('genericTitle').textContent=link.textContent;
      openModal('modal-generic');
    }
  });
});

/* ---------- Load Local Data - Complete Implementation ---------- */

// Step 1: Overwrite Warning First
function showOverwriteWarning(){
  const existingData=localStorage.getItem('txnData')||localStorage.getItem('expense_records')||localStorage.getItem('income_records');
  
  if(existingData){
    // Show warning popup
    const confirmed=confirm('‚ö†Ô∏è OVERWRITE WARNING\n\nLoading new data will overwrite all existing application data.\n\nThis action cannot be undone.\n\nDo you want to continue?');
    if(confirmed){
      openFilePicker();
    }
  }else{
    // No existing data, proceed directly to file picker
    openFilePicker();
  }
}

// Step 2: File Picker After Confirmation
function openFilePicker(){
  const fileInput=document.createElement('input');
  fileInput.type='file';
  fileInput.accept='.xlsx,.json,.sqlite,.db';
  fileInput.style.display='none';
  document.body.appendChild(fileInput);
  
  fileInput.addEventListener('change',(e)=>{
    const file=e.target.files[0];
    if(!file)return;
    
    // Validate file type
    const validExtensions=['.xlsx','.json','.sqlite','.db'];
    const fileName=file.name.toLowerCase();
    const isValid=validExtensions.some(ext=>fileName.endsWith(ext));
    
    if(!isValid){
      alert('‚ùå Invalid file type!\n\nPlease select a valid data file:\n‚Ä¢ .xlsx (Excel)\n‚Ä¢ .json (JSON)\n‚Ä¢ .sqlite (SQLite)\n‚Ä¢ .db (Database)');
      document.body.removeChild(fileInput);
      return;
    }
    
    // Process the file
    processFile(file);
    document.body.removeChild(fileInput);
  });
  
  fileInput.click();
}

// Step 3: Process File and Show Toast Notification
function processFile(file){
  try{
    // Save file info to localStorage
    localStorage.setItem('localDataPath',file.name);
    localStorage.setItem('txnData','loaded');
    
    // Step 3: Toast Notification
    showToast('‚úÖ Data loaded successfully!');
    
    // Update tooltip
    updateLoadLocalTooltip();
    
    // Step 4: Backup Folder Setup
    setTimeout(()=>{
      setupBackupFolder();
    },1000);
    
  }catch(error){
    alert('‚ùå Error loading file: '+error.message);
  }
}

// Step 4: Backup Folder Setup - Fresh Implementation
function setupBackupFolder(){
  const setupBackup=confirm('üìÅ BACKUP FOLDER SETUP\n\nWould you like to set a default backup folder for downloads?\n\n‚Ä¢ Click OK to set backup folder\n‚Ä¢ Click Cancel to skip');
  
  if(setupBackup){
    showSimpleBackupDialog();
  }
}

// Simple backup folder dialog - no complex folder picker
function showSimpleBackupDialog(){
  const overlay=document.createElement('div');
  overlay.style.cssText=`
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);
    display:flex;justify-content:center;align-items:center;z-index:10001;
    backdrop-filter:blur(8px);
  `;
  
  const modal=document.createElement('div');
  modal.style.cssText=`
    background:var(--content-bg);padding:32px;border-radius:20px;
    box-shadow:0 32px 64px rgba(0,0,0,0.2);max-width:420px;width:90%;
    border:1px solid var(--divider);backdrop-filter:blur(15px);
    position:relative;
  `;
  
  modal.innerHTML=`
    <div style="text-align:center;margin-bottom:24px;">
      <div style="font-size:56px;margin-bottom:12px;">üìÅ</div>
      <h3 style="margin:0 0 8px 0;color:var(--text-body);font-size:20px;font-weight:700;">Choose Backup Folder</h3>
      <p style="margin:0;color:var(--text-secondary);font-size:14px;line-height:1.5;">Select a folder where downloads will be saved</p>
    </div>
    
    <div style="margin-bottom:24px;">
      <label style="display:block;margin-bottom:12px;color:var(--text-body);font-weight:600;font-size:15px;">Folder Name:</label>
      <input type="text" id="folderNameInput" placeholder="Enter folder name (e.g., ClearView_Backups)" 
             style="width:calc(100% - 36px);padding:16px 18px;border:2px solid var(--divider);border-radius:12px;
             font-size:15px;background:var(--content-bg);color:var(--text-body);
             transition:all 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.08);
             margin-bottom:20px;outline:none;" />
      
      <button id="pastePathBtn" style="
        width:100%;padding:14px 18px;background:var(--accent-blue);color:#fff;border:none;
        border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;
        box-shadow:0 4px 12px rgba(66,133,244,0.3);font-size:15px;
        display:flex;align-items:center;justify-content:center;gap:10px;
        text-align:center;margin-bottom:16px;
      ">
        <span style="font-size:20px;">üìã</span>
        <span>Paste Custom Path</span>
      </button>
      
      <div style="font-size:12px;color:var(--text-secondary);text-align:center;line-height:1.4;padding:12px;background:var(--primary-bg);border-radius:8px;">
        üí° <strong>Copy your Custom Folder Path using File Explorer and hit Paste Button</strong>
      </div>
    </div>
    
    <div style="display:flex;gap:12px;justify-content:center;">
      <button id="cancelBackupBtn" style="
        padding:14px 24px;background:#6b7280;color:#fff;border:none;
        border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;
        box-shadow:0 4px 12px rgba(107,114,128,0.2);font-size:15px;
        min-width:100px;
      ">Cancel</button>
      <button id="saveBackupBtn" style="
        padding:14px 24px;background:#34a853;color:#ffffff;border:none;
        border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;
        box-shadow:0 4px 12px rgba(52,168,83,0.2);font-size:15px;
        min-width:100px;
      ">Save</button>
    </div>
  `;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  const folderInput=modal.querySelector('#folderNameInput');
  const pasteBtn=modal.querySelector('#pastePathBtn');
  const cancelBtn=modal.querySelector('#cancelBackupBtn');
  const saveBtn=modal.querySelector('#saveBackupBtn');
  
  // Paste custom path
  pasteBtn.addEventListener('click',async ()=>{
    try{
      const text=await navigator.clipboard.readText();
      if(text.trim()){
        folderInput.value=text.trim();
        console.log('Pasted custom path:', text.trim());
        showToast('üìã Custom path pasted from clipboard');
      }else{
        alert('üìã CLIPBOARD EMPTY\n\nYour clipboard is empty.\n\nCopy a folder path and try again, or type a folder name manually.');
      }
    }catch(error){
      console.error('Error reading clipboard:', error);
      alert('üìã CLIPBOARD ACCESS DENIED\n\nUnable to access clipboard.\n\nPlease type the folder name or path manually.');
    }
  });
  
  // Cancel button
  cancelBtn.addEventListener('click',()=>{
    document.body.removeChild(overlay);
  });
  
  // Save button
  saveBtn.addEventListener('click',()=>{
    const folderPath=folderInput.value.trim();
    console.log('Save button clicked, folder path:', folderPath);
    
    if(folderPath){
      localStorage.setItem('backupFolderPath',folderPath);
      console.log('Backup folder saved to localStorage:', folderPath);
      showToast('üíæ Backup folder set successfully!');
      
      // Update tooltip immediately
      setTimeout(()=>{
        updateBackupTooltip();
      },100);
      
      document.body.removeChild(overlay);
    }else{
      alert('Please enter a folder name.\n\nYou can:\n‚Ä¢ Type a custom folder name\n‚Ä¢ Use "Paste Custom Path" to paste a folder path from clipboard');
      folderInput.focus();
    }
  });
  
  // Close on overlay click
  overlay.addEventListener('click',(e)=>{
    if(e.target===overlay){
      document.body.removeChild(overlay);
    }
  });
  
  // Focus on input
  setTimeout(()=>folderInput.focus(),100);
}

// Native folder picker function
async function showFolderPicker(folderInput){
  try{
    // Check if File System Access API is supported
    if('showDirectoryPicker' in window){
      console.log('Using File System Access API for folder selection');
      
      // Show native folder picker
      const directoryHandle = await window.showDirectoryPicker({
        mode: 'readwrite',
        startIn: 'documents'
      });
      
      // Get folder name
      const folderName = directoryHandle.name;
      console.log('Selected folder:', folderName);
      
      // Set the folder name in the input
      folderInput.value = folderName;
      
      // Show success message
      showToast(`üìÅ Folder selected: ${folderName}`);
      
    }else{
      // Fallback for browsers that don't support File System Access API
      console.log('File System Access API not supported, using fallback');
      showFolderFallback(folderInput);
    }
  }catch(error){
    if(error.name === 'AbortError'){
      console.log('User cancelled folder selection');
      // User cancelled, do nothing
    }else{
      console.error('Error selecting folder:', error);
      // Fallback to manual selection
      showFolderFallback(folderInput);
    }
  }
}

// Fallback folder selection for older browsers
function showFolderFallback(folderInput){
  const overlay=document.createElement('div');
  overlay.style.cssText=`
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);
    display:flex;justify-content:center;align-items:center;z-index:10002;
    backdrop-filter:blur(5px);
  `;
  
  const modal=document.createElement('div');
  modal.style.cssText=`
    background:var(--content-bg);padding:30px;border-radius:12px;
    box-shadow:0 20px 40px rgba(0,0,0,0.3);max-width:400px;width:90%;
    border:1px solid var(--divider);
  `;
  
  modal.innerHTML=`
    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:36px;margin-bottom:10px;">üìÇ</div>
      <h3 style="margin:0 0 10px 0;color:var(--text-body);font-size:16px;">Choose Folder Location</h3>
      <p style="margin:0;color:var(--text-secondary);font-size:14px;">Select a folder for downloads</p>
    </div>
    
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;">
      <button class="folder-option" data-path="Downloads" style="
        padding:12px 16px;background:var(--primary-bg);color:var(--text-body);
        border:2px solid var(--divider);border-radius:6px;text-align:left;
        cursor:pointer;transition:all 0.3s ease;font-size:14px;
        display:flex;align-items:center;gap:10px;
      ">
        <span style="font-size:20px;">üì•</span>
        <div>
          <div style="font-weight:600;">Downloads</div>
          <div style="font-size:12px;color:var(--text-secondary);">Default download folder</div>
        </div>
      </button>
      
      <button class="folder-option" data-path="Documents" style="
        padding:12px 16px;background:var(--primary-bg);color:var(--text-body);
        border:2px solid var(--divider);border-radius:6px;text-align:left;
        cursor:pointer;transition:all 0.3s ease;font-size:14px;
        display:flex;align-items:center;gap:10px;
      ">
        <span style="font-size:20px;">üìÑ</span>
        <div>
          <div style="font-weight:600;">Documents</div>
          <div style="font-size:12px;color:var(--text-secondary);">Documents folder</div>
        </div>
      </button>
      
      <button class="folder-option" data-path="Desktop" style="
        padding:12px 16px;background:var(--primary-bg);color:var(--text-body);
        border:2px solid var(--divider);border-radius:6px;text-align:left;
        cursor:pointer;transition:all 0.3s ease;font-size:14px;
        display:flex;align-items:center;gap:10px;
      ">
        <span style="font-size:20px;">üñ•Ô∏è</span>
        <div>
          <div style="font-weight:600;">Desktop</div>
          <div style="font-size:12px;color:var(--text-secondary);">Desktop folder</div>
        </div>
      </button>
    </div>
    
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="cancelFolderOptions" style="
        padding:8px 16px;background:#6b7280;color:#fff;border:none;
        border-radius:6px;font-weight:600;cursor:pointer;transition:all 0.3s ease;
      ">Cancel</button>
    </div>
  `;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  // Add click handlers to folder options
  const folderOptions=modal.querySelectorAll('.folder-option');
  folderOptions.forEach(option=>{
    // Hover effects
    option.addEventListener('mouseenter',()=>{
      option.style.background='var(--accent-blue)';
      option.style.color='#fff';
      option.style.borderColor='var(--accent-blue)';
      option.style.transform='translateY(-2px)';
      option.style.boxShadow='0 4px 12px rgba(66,133,244,0.3)';
    });
    
    option.addEventListener('mouseleave',()=>{
      option.style.background='var(--primary-bg)';
      option.style.color='var(--text-body)';
      option.style.borderColor='var(--divider)';
      option.style.transform='translateY(0)';
      option.style.boxShadow='none';
    });
    
    // Click handler
    option.addEventListener('click',(e)=>{
      e.preventDefault();
      e.stopPropagation();
      
      const path=option.dataset.path;
      console.log('Folder option clicked:', path);
      
      folderInput.value=path;
      console.log('Folder path set:', path);
      document.body.removeChild(overlay);
    });
  });
  
  // Cancel button
  modal.querySelector('#cancelFolderOptions').addEventListener('click',()=>{
    document.body.removeChild(overlay);
  });
  
  // Close on overlay click
  overlay.addEventListener('click',(e)=>{
    if(e.target===overlay){
      document.body.removeChild(overlay);
    }
  });
}

// Folder picker function
function showFolderPicker(){
  // Create a modal overlay for the folder picker
  const overlay=document.createElement('div');
  overlay.style.cssText=`
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);
    display:flex;justify-content:center;align-items:center;z-index:10001;
    backdrop-filter:blur(5px);
  `;
  
  const modal=document.createElement('div');
  modal.style.cssText=`
    background:var(--content-bg);padding:28px;border-radius:16px;
    box-shadow:0 24px 48px rgba(0,0,0,0.15);max-width:480px;width:90%;
    border:1px solid var(--divider);backdrop-filter:blur(10px);
  `;
  
  modal.innerHTML=`
    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:48px;margin-bottom:10px;">üìÅ</div>
      <h3 style="margin:0 0 10px 0;color:var(--text-body);font-size:18px;">Choose Backup Folder</h3>
      <p style="margin:0;color:var(--text-secondary);font-size:14px;">Select a folder where downloads will be saved</p>
    </div>
    
    <div style="margin-bottom:24px;">
      <label style="display:block;margin-bottom:10px;color:var(--text-body);font-weight:600;font-size:15px;">Folder Path:</label>
      <input type="text" id="folderPathInput" placeholder="Select folder or paste path here" 
             style="width:100%;padding:14px 16px;border:2px solid var(--divider);border-radius:8px;
             font-size:15px;background:var(--content-bg);color:var(--text-body);
             transition:border-color 0.3s ease;box-shadow:0 2px 6px rgba(0,0,0,0.08);
             margin-bottom:16px;" />
      
      <div style="display:flex;gap:10px;margin-bottom:12px;">
        <button id="browseBtn" style="
          flex:2;padding:14px 20px;background:var(--accent-blue);color:#fff;border:none;
          border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;
          box-shadow:0 3px 6px rgba(66,133,244,0.25);font-size:15px;
          display:flex;align-items:center;justify-content:center;gap:10px;
          text-align:center;
        ">
          <span style="font-size:20px;">üìÇ</span>
          <span>Select Folder</span>
        </button>
        <button id="defaultBtn" style="
          flex:1;padding:14px 16px;background:var(--text-secondary);color:#fff;border:none;
          border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;
          box-shadow:0 3px 6px rgba(107,114,128,0.25);font-size:15px;
          display:flex;align-items:center;justify-content:center;gap:8px;
          text-align:center;
        ">
          <span style="font-size:20px;">üìã</span>
          <span>Paste</span>
        </button>
      </div>
      
      <button id="downloadsBtn" style="
        width:100%;padding:14px 20px;background:var(--success);color:#fff;border:none;
        border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;
        box-shadow:0 3px 6px rgba(52,168,83,0.25);font-size:15px;
        display:flex;align-items:center;justify-content:center;gap:10px;
        text-align:center;margin-bottom:12px;
      ">
        <span style="font-size:20px;">üì•</span>
        <span>Use Downloads Folder</span>
      </button>
      
      <div style="font-size:12px;color:var(--text-secondary);text-align:center;line-height:1.4;">
        üí° <strong>Select Folder:</strong> Browse your computer | <strong>Paste:</strong> Paste copied path | <strong>Downloads:</strong> Default location
      </div>
    </div>
    
    <div style="display:flex;gap:10px;justify-content:center;margin-top:16px;">
      <button id="cancelFolderBtn" style="
        padding:12px 20px;background:#6b7280;color:#fff;border:none;
        border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;
        box-shadow:0 3px 6px rgba(107,114,128,0.2);font-size:14px;
        min-width:90px;
      ">Cancel</button>
      <button id="saveFolderBtn" style="
        padding:12px 20px;background:var(--success);color:#fff;border:none;
        border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;
        box-shadow:0 3px 6px rgba(52,168,83,0.2);font-size:14px;
        min-width:90px;
      ">Save</button>
    </div>
  `;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  const folderInput=modal.querySelector('#folderPathInput');
  const browseBtn=modal.querySelector('#browseBtn');
  const defaultBtn=modal.querySelector('#defaultBtn');
  const downloadsBtn=modal.querySelector('#downloadsBtn');
  const cancelBtn=modal.querySelector('#cancelFolderBtn');
  const saveBtn=modal.querySelector('#saveFolderBtn');
  
  // Browse button - show native folder picker
  browseBtn.addEventListener('click',async (e)=>{
    e.preventDefault();
    e.stopPropagation();
    console.log('Select Folder button clicked');
    
    // Add visual feedback immediately
    browseBtn.style.background='var(--accent-blue-hover)';
    browseBtn.style.transform='scale(0.98)';
    
    try{
      // Check if File System Access API is supported
      if('showDirectoryPicker' in window){
        console.log('Using File System Access API');
        
        // Show instruction to user
        const proceed = confirm('üìÅ FOLDER PICKER INSTRUCTIONS\n\n1. Click "Allow" in the browser permission dialog\n2. Browse and select your desired folder\n3. The folder name will be saved as your backup location\n\nClick OK to proceed with folder selection.');
        
        if(!proceed){
          console.log('User cancelled folder selection');
          return;
        }
        
        const directoryHandle = await window.showDirectoryPicker({
          mode: 'readwrite',
          startIn: 'documents'
        });
        
        const folderName = directoryHandle.name;
        console.log('Selected folder:', folderName);
        
        folderInput.value = folderName;
        console.log('Folder input set to:', folderName);
        showToast(`üìÅ Folder selected: ${folderName}`);
        
      }else{
        console.log('File System Access API not supported');
        alert('Native folder picker not supported in this browser. Using fallback options.');
        showFolderFallback(folderInput);
      }
    }catch(error){
      if(error.name === 'AbortError'){
        console.log('User cancelled folder selection');
      }else if(error.name === 'NotAllowedError'){
        console.log('User denied permission');
        alert('‚ùå Permission Denied\n\nYou denied permission to access folders. You can:\n‚Ä¢ Try again and click "Allow"\n‚Ä¢ Use the "Paste" button to manually enter a folder path\n‚Ä¢ Use "Use Downloads Folder" for default location');
      }else{
        console.error('Error in folder picker:', error);
        alert('‚ùå Error opening folder picker\n\nPlease try:\n‚Ä¢ Click "Paste" to manually enter a folder path\n‚Ä¢ Click "Use Downloads Folder" for default location\n‚Ä¢ Make sure your browser supports folder selection');
      }
    }finally{
      // Reset button style
      browseBtn.style.background='var(--accent-blue)';
      browseBtn.style.transform='scale(1)';
    }
  });
  
  // Add visual feedback to buttons
  browseBtn.addEventListener('mousedown',()=>{
    browseBtn.style.transform='translateY(1px)';
    browseBtn.style.boxShadow='0 2px 4px rgba(66,133,244,0.2)';
  });
  
  browseBtn.addEventListener('mouseup',()=>{
    browseBtn.style.transform='translateY(0)';
    browseBtn.style.boxShadow='0 3px 6px rgba(66,133,244,0.3)';
  });

  // Paste button
  defaultBtn.addEventListener('click',async ()=>{
    try{
      const text = await navigator.clipboard.readText();
      if(text.trim()){
        folderInput.value = text.trim();
        console.log('Pasted folder path:', text.trim());
        showToast('üìã Folder path pasted from clipboard');
      }else{
        alert('üìã CLIPBOARD EMPTY\n\nYour clipboard is empty or contains no text.\n\nTo use this feature:\n1. Copy a folder path from Windows Explorer\n2. Click "Paste" again\n\nOr use "Use Downloads Folder" for default location.');
      }
    }catch(error){
      console.error('Error reading clipboard:', error);
      alert('üìã CLIPBOARD ACCESS DENIED\n\nUnable to access clipboard. You can:\n‚Ä¢ Copy a folder path and paste it manually in the input field\n‚Ä¢ Use "Use Downloads Folder" for default location\n‚Ä¢ Try the "Select Folder" button for native folder picker');
    }
  });

  // Downloads button
  downloadsBtn.addEventListener('click',()=>{
    folderInput.value='Downloads';
    console.log('Downloads button clicked, set to:', 'Downloads');
    
    // Add visual feedback
    downloadsBtn.style.background='#2e7d32';
    downloadsBtn.style.transform='scale(0.98)';
    setTimeout(()=>{
      downloadsBtn.style.background='var(--success)';
      downloadsBtn.style.transform='scale(1)';
    },200);
    
    showToast('üì• Downloads folder selected');
  });
  
  // Cancel button
  cancelBtn.addEventListener('click',()=>{
    document.body.removeChild(overlay);
  });
  
  // Save button
  saveBtn.addEventListener('click',()=>{
    const folderPath=folderInput.value.trim();
    console.log('Save button clicked, folder path:', folderPath);
    
    if(folderPath){
      localStorage.setItem('backupFolderPath',folderPath);
      console.log('Backup folder saved to localStorage:', folderPath);
      showToast('üíæ Backup folder set successfully!');
      
      // Update tooltip immediately
      setTimeout(()=>{
        updateBackupTooltip();
      },100);
      
      document.body.removeChild(overlay);
    }else{
      alert('Please enter a folder path or use the default Downloads folder.\n\nYou can:\n‚Ä¢ Click "Select Folder" to browse and select a folder\n‚Ä¢ Click "Use Downloads Folder" to use the default folder\n‚Ä¢ Click "Paste" to paste a folder path from clipboard');
      folderInput.focus();
      return;
    }
  });
  
  // Close on overlay click
  overlay.addEventListener('click',(e)=>{
    if(e.target===overlay){
      document.body.removeChild(overlay);
    }
  });
  
  // Focus on input
  setTimeout(()=>folderInput.focus(),100);
}

// Step 5 & 6: Tooltip Update Functions
function updateLoadLocalTooltip(){
  const loadLocalLink=document.querySelector('nav a[data-target="load"]');
  if(loadLocalLink){
    const dataPath=localStorage.getItem('localDataPath');
    loadLocalLink.title=dataPath?`Current data: ${dataPath}`:'Click to load local data files';
  }
}

function updateBackupTooltip(){
  const backupLink=document.querySelector('nav a[data-target="backup"]');
  if(backupLink){
    const backupPath=localStorage.getItem('backupFolderPath');
    backupLink.title=backupPath?`Backup folder: ${backupPath}`:'Click to set backup folder';
  }
}

// Initialize tooltips on page load
document.addEventListener('DOMContentLoaded',()=>{
  updateLoadLocalTooltip();
  updateBackupTooltip();
});

// Toast notification function
function showToast(message){
  // Remove any existing toast
  const existingToast=document.querySelector('.toast-notification');
  if(existingToast){
    existingToast.remove();
  }
  
  const toast=document.createElement('div');
  toast.className='toast-notification';
  toast.style.cssText=`
    position:fixed;top:20px;right:20px;background:var(--success);color:#fff;
    padding:12px 20px;border-radius:6px;box-shadow:var(--shadow);
    z-index:10000;font-weight:600;font-size:14px;opacity:0;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);transform:translateX(100%);
    border:1px solid rgba(255,255,255,0.2);
    backdrop-filter:blur(10px);
  `;
  toast.textContent=message;
  document.body.appendChild(toast);
  
  // Force reflow to ensure initial styles are applied
  toast.offsetHeight;
  
  // Show toast
  setTimeout(()=>{
    toast.style.opacity='1';
    toast.style.transform='translateX(0)';
  },100);
  
  // Hide toast after 3 seconds
  setTimeout(()=>{
    toast.style.opacity='0';
    toast.style.transform='translateX(100%)';
    setTimeout(()=>{
      if(document.body.contains(toast)){
        document.body.removeChild(toast);
      }
    },300);
  },3000);
}


/* ---------- Enhanced Documents ---------- */
const docUpload=document.getElementById('docUpload');
const docsTbody=document.getElementById('docsTbody');
const uploadArea=document.getElementById('uploadArea');
const uploadBtn=document.getElementById('uploadBtn');
const docStats=document.getElementById('docStats');
let docs=JSON.parse(localStorage.getItem('docsList')||'[]');
let isFilePickerOpen = false;

// Initialize
renderDocs();
updateStats();

// Upload button click - ONLY way to open file picker
// Clear any existing event listeners and add only one
if(uploadBtn.onclick){
  uploadBtn.onclick = null;
}
uploadBtn.onclick = function(e){
  e.preventDefault();
  e.stopPropagation();
  
  if(isFilePickerOpen){
    console.log('File picker already open - ignoring click');
    return;
  }
  
  console.log('Upload button clicked - opening file picker ONCE');
  isFilePickerOpen = true;
  docUpload.click();
  
  // Reset flag after a short delay
  setTimeout(() => {
    isFilePickerOpen = false;
  }, 1000);
};

// File input change
docUpload.addEventListener('change',handleFileUpload);

// Drag and drop functionality
uploadArea.addEventListener('dragover',e=>{
  e.preventDefault();
  uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave',()=>{
  uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop',e=>{
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  const files=e.dataTransfer.files;
  handleFiles(files);
});

// NO upload area click event - removed to prevent double file picker

function handleFileUpload(e){
  const files=e.target.files;
  isFilePickerOpen = false; // Reset flag when files are selected
  handleFiles(files);
}

function handleFiles(files){
  let addedCount = 0;
  let skippedCount = 0;
  let duplicateCount = 0;
  
  Array.from(files).forEach(file=>{
    if(isValidFileType(file)){
      // Check for duplicate files
      const existingFile = docs.find(doc => doc.name === file.name);
      
      if(existingFile){
        // Duplicate file found - offer to save with different name
        handleDuplicateFile(file, existingFile);
        duplicateCount++;
      }else{
        // No duplicate - add file normally
        const entry=createDocumentEntry(file);
        docs.push(entry);
        addedCount++;
      }
    }else{
      alert(`File type not supported: ${file.name}`);
      skippedCount++;
    }
  });
  
  localStorage.setItem('docsList',JSON.stringify(docs));
  renderDocs();
  updateStats();
  
  // Show appropriate toast notification
  if(addedCount > 0){
    if(addedCount === 1){
      showToast(`üìÅ File uploaded successfully`);
    }else{
      showToast(`üìÅ ${addedCount} files uploaded successfully`);
    }
  }
  
  if(skippedCount > 0){
    setTimeout(() => {
      showToast(`‚ö†Ô∏è ${skippedCount} file(s) skipped due to unsupported format`);
    }, 1500);
  }
  
  if(duplicateCount > 0){
    setTimeout(() => {
      showToast(`üîÑ ${duplicateCount} duplicate file(s) detected - check for rename options`);
    }, 2000);
  }
}

function handleDuplicateFile(newFile, existingFile){
  // Create modal for duplicate file handling
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.6); display: flex; justify-content: center; 
    align-items: center; z-index: 10002; backdrop-filter: blur(5px);
  `;
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    background: var(--content-bg); padding: 24px; border-radius: 12px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3); max-width: 500px; width: 90%;
    border: 1px solid var(--divider);
  `;
  
  modal.innerHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="font-size: 48px; margin-bottom: 10px;">üîÑ</div>
      <h3 style="margin: 0 0 10px 0; color: var(--text-body); font-size: 18px;">Duplicate File Detected</h3>
      <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">A file with the same name already exists</p>
    </div>
    
    <div style="margin-bottom: 20px; padding: 16px; background: var(--primary-bg); border-radius: 8px;">
      <div style="font-weight: 600; color: var(--text-body); margin-bottom: 8px;">File Name:</div>
      <div style="color: var(--text-secondary); font-size: 14px;">"${newFile.name}"</div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; color: var(--text-body); font-weight: 600;">What would you like to do?</label>
      
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <button id="skipFileBtn" style="
          padding: 12px 16px; background: var(--primary-bg); color: var(--text-body);
          border: 2px solid var(--divider); border-radius: 8px; text-align: left;
          cursor: pointer; transition: all 0.3s ease; font-size: 14px;
          display: flex; align-items: center; gap: 10px;
        ">
          <span style="font-size: 20px;">‚è≠Ô∏è</span>
          <div>
            <div style="font-weight: 600;">Skip this file</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Don't upload the duplicate file</div>
          </div>
        </button>
        
        <button id="replaceFileBtn" style="
          padding: 12px 16px; background: var(--primary-bg); color: var(--text-body);
          border: 2px solid var(--divider); border-radius: 8px; text-align: left;
          cursor: pointer; transition: all 0.3s ease; font-size: 14px;
          display: flex; align-items: center; gap: 10px;
        ">
          <span style="font-size: 20px;">üîÑ</span>
          <div>
            <div style="font-weight: 600;">Replace existing file</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Overwrite the existing file</div>
          </div>
        </button>
        
        <button id="renameFileBtn" style="
          padding: 12px 16px; background: var(--primary-bg); color: var(--text-body);
          border: 2px solid var(--divider); border-radius: 8px; text-align: left;
          cursor: pointer; transition: all 0.3s ease; font-size: 14px;
          display: flex; align-items: center; gap: 10px;
        ">
          <span style="font-size: 20px;">‚úèÔ∏è</span>
          <div>
            <div style="font-weight: 600;">Save with different name</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Create a new file with a modified name</div>
          </div>
        </button>
      </div>
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button id="cancelDuplicateBtn" style="
        padding: 10px 20px; background: #6b7280; color: #fff; border: none;
        border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
      ">Cancel</button>
    </div>
  `;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  // Event handlers
  const skipBtn = modal.querySelector('#skipFileBtn');
  const replaceBtn = modal.querySelector('#replaceFileBtn');
  const renameBtn = modal.querySelector('#renameFileBtn');
  const cancelBtn = modal.querySelector('#cancelDuplicateBtn');
  
  // Skip file
  skipBtn.addEventListener('click', () => {
    document.body.removeChild(overlay);
    showToast(`‚è≠Ô∏è File "${newFile.name}" skipped (duplicate)`);
  });
  
  // Replace existing file
  replaceBtn.addEventListener('click', () => {
    // Find and replace the existing file
    const existingIndex = docs.findIndex(doc => doc.name === existingFile.name);
    if(existingIndex !== -1){
      docs[existingIndex] = createDocumentEntry(newFile);
      localStorage.setItem('docsList', JSON.stringify(docs));
      renderDocs();
      updateStats();
      document.body.removeChild(overlay);
      showToast(`üîÑ File "${newFile.name}" replaced successfully`);
    }
  });
  
  // Rename and save file
  renameBtn.addEventListener('click', () => {
    const newName = prompt(`Enter a new name for the file:`, `${newFile.name.split('.')[0]} (Copy).${newFile.name.split('.').pop()}`);
    if(newName && newName.trim()){
      const entry = createDocumentEntry(newFile);
      entry.name = newName.trim();
      docs.push(entry);
      localStorage.setItem('docsList', JSON.stringify(docs));
      renderDocs();
      updateStats();
      document.body.removeChild(overlay);
      showToast(`‚úèÔ∏è File saved as "${newName.trim()}"`);
    }
  });
  
  // Cancel
  cancelBtn.addEventListener('click', () => {
    document.body.removeChild(overlay);
    showToast(`‚ùå File upload cancelled`);
  });
  
  // Close on overlay click
  overlay.addEventListener('click', (e) => {
    if(e.target === overlay){
      document.body.removeChild(overlay);
    }
  });
  
  // Add hover effects to buttons
  [skipBtn, replaceBtn, renameBtn].forEach(btn => {
    btn.addEventListener('mouseenter', () => {
      btn.style.background = 'var(--accent-blue)';
      btn.style.color = '#fff';
      btn.style.borderColor = 'var(--accent-blue)';
      btn.style.transform = 'translateY(-2px)';
      btn.style.boxShadow = '0 4px 12px rgba(66,133,244,0.3)';
    });
    
    btn.addEventListener('mouseleave', () => {
      btn.style.background = 'var(--primary-bg)';
      btn.style.color = 'var(--text-body)';
      btn.style.borderColor = 'var(--divider)';
      btn.style.transform = 'translateY(0)';
      btn.style.boxShadow = 'none';
    });
  });
}

function isValidFileType(file){
  const validTypes=['.pdf','.doc','.docx','.xls','.xlsx','.txt','.jpg','.jpeg','.png','.gif'];
  return validTypes.some(type=>file.name.toLowerCase().endsWith(type));
}

function createDocumentEntry(file){
  return {
    name:file.name,
    type:getFileType(file.name),
    size:formatFileSize(file.size),
    date:new Date().toLocaleString(),
    id:Date.now()+Math.random()
  };
}

function getFileType(filename){
  const ext=filename.split('.').pop().toLowerCase();
  const typeMap={
    'pdf':'PDF Document',
    'doc':'Word Document',
    'docx':'Word Document',
    'xls':'Excel Spreadsheet',
    'xlsx':'Excel Spreadsheet',
    'txt':'Text File',
    'jpg':'JPEG Image',
    'jpeg':'JPEG Image',
    'png':'PNG Image',
    'gif':'GIF Image'
  };
  return typeMap[ext]||'Unknown';
}

function formatFileSize(bytes){
  if(bytes===0)return'0 B';
  const k=1024;
  const sizes=['B','KB','MB','GB'];
  const i=Math.floor(Math.log(bytes)/Math.log(k));
  return parseFloat((bytes/Math.pow(k,i)).toFixed(1))+' '+sizes[i];
}

function updateStats(){
  const count=docs.length;
  console.log('Updating stats - document count:', count);
  if(docStats){
    docStats.textContent=`${count} document${count!==1?'s':''}`;
    console.log('Stats updated to:', docStats.textContent);
  }else{
    console.error('docStats element not found');
  }
}

function renderDocs(){
  docsTbody.innerHTML='';
  if(docs.length===0){
    docsTbody.innerHTML=`<tr class="empty-state">
      <td colspan="5" class="empty-message">
        <div class="empty-icon">üì≠</div>
        <p>No documents yet. Upload your first document above!</p>
      </td>
    </tr>`;
    return;
  }
  
  docs.forEach((d,i)=>{
    const r=document.createElement('tr');
    r.innerHTML=`<td>
      <div style="display:flex;align-items:center;gap:6px;">
        <span style="font-size:14px;">${getFileIcon(d.type)}</span>
        <span class="file-name-display" data-i="${i}" style="font-weight:500;cursor:pointer;" title="Click to rename">${d.name}</span>
      </div>
    </td>
    <td><span class="file-type">${d.type}</span></td>
    <td><span class="file-size">${d.size}</span></td>
    <td><span class="file-date">${d.date}</span></td>
    <td>
      <div class="doc-actions">
        <button class="doc-btn download" data-i="${i}" title="Download">
          <span>üì•</span> Download
        </button>
        <button class="doc-btn rename" data-i="${i}" title="Rename">
          <span>‚úèÔ∏è</span> Rename
        </button>
        <button class="doc-btn" data-i="${i}" title="Delete">
          <span>üóëÔ∏è</span> Delete
        </button>
      </div>
    </td>`;
    docsTbody.appendChild(r);
  });
  
  // Event listeners for action buttons
  docsTbody.querySelectorAll('.doc-btn').forEach(btn=>{
    btn.addEventListener('click',e=>{
      const i=parseInt(e.target.closest('.doc-btn').dataset.i);
      if(e.target.closest('.doc-btn').classList.contains('download')){
        downloadDocument(i);
      }else if(e.target.closest('.doc-btn').classList.contains('rename')){
        renameDocument(i);
      }else{
        deleteDocument(i);
      }
    });
  });
  
  // Event listeners for file name clicks
  docsTbody.querySelectorAll('.file-name-display').forEach(span=>{
    span.addEventListener('click',e=>{
      const i=parseInt(e.target.dataset.i);
      renameDocument(i);
    });
  });
}

function getFileIcon(type){
  const iconMap={
    'PDF Document':'üìÑ',
    'Word Document':'üìù',
    'Excel Spreadsheet':'üìä',
    'Text File':'üìÑ',
    'JPEG Image':'üñºÔ∏è',
    'PNG Image':'üñºÔ∏è',
    'GIF Image':'üñºÔ∏è'
  };
  return iconMap[type]||'üìÅ';
}

function downloadDocument(index){
  const doc=docs[index];
  showToast(`üì• Downloading "${doc.name}"...`);
  // Note: This is a demo. In a real application, this would download the actual file.
  setTimeout(() => {
    showToast(`üì• Download completed: "${doc.name}"`);
  }, 1000);
}

function renameDocument(index){
  const doc=docs[index];
  const span=document.querySelector(`.file-name-display[data-i="${index}"]`);
  if(!span) return;
  
  // Create input field
  const input=document.createElement('input');
  input.type='text';
  input.className='file-name-edit';
  input.value=doc.name;
  input.style.width='100%';
  
  // Replace span with input
  span.style.display='none';
  span.parentNode.insertBefore(input,span.nextSibling);
  input.focus();
  input.select();
  
  // Save on Enter or blur
  function saveRename(){
    const newName=input.value.trim();
    if(newName && newName!==doc.name){
      const oldName = doc.name;
      doc.name=newName;
      localStorage.setItem('docsList',JSON.stringify(docs));
      renderDocs();
      updateStats();
      showToast(`üìù File renamed from "${oldName}" to "${newName}"`);
    }else{
      span.style.display='inline';
      input.remove();
    }
  }
  
  // Cancel on Escape
  function cancelRename(){
    span.style.display='inline';
    input.remove();
  }
  
  input.addEventListener('blur',saveRename);
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
      e.preventDefault();
      saveRename();
    }else if(e.key==='Escape'){
      e.preventDefault();
      cancelRename();
    }
  });
}

function deleteDocument(index){
  const fileName = docs[index].name;
  if(confirm(`Are you sure you want to delete "${fileName}"?`)){
    docs.splice(index,1);
    localStorage.setItem('docsList',JSON.stringify(docs));
    renderDocs();
    updateStats();
    showToast(`üóëÔ∏è File "${fileName}" deleted successfully`);
  }
}
</script>
</body>
</html>